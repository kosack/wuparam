<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>wuparam: GainFinder.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>GainFinder.cpp</h1><div class="fragment"><pre>00001 <span class="comment">//</span>
00002 <span class="comment">// GainFinder.cpp</span>
00003 <span class="comment">//</span>
00004 <span class="comment">// Karl Kosack &lt;kosack@hbar.wustl.edu&gt;</span>
00005 
00006 <span class="preprocessor">#include &lt;list&gt;</span>
00007 <span class="preprocessor">#include &lt;vector&gt;</span>
00008 
00009 <span class="preprocessor">#include "Exceptions.h"</span>
00010 <span class="preprocessor">#include "DataReader.h"</span>
00011 <span class="preprocessor">#include "Config.h"</span>
00012 <span class="preprocessor">#include "PedestalFinder.h"</span>
00013 <span class="preprocessor">#include "ProgressBar.h"</span>
00014 <span class="preprocessor">#include "Camera.h"</span>
00015 <span class="preprocessor">#include "PlotMaker.h"</span>
00016 
00017 <span class="preprocessor">#include "GainFinder.h"</span>
00018 
00019 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00020 
00029 <span class="keywordtype">void</span>
<a name="l00030"></a><a class="code" href="classGainFinder.html#a3">00030</a> <a class="code" href="classGainFinder.html#a3">GainFinder::setThresholds</a>( <span class="keywordtype">double</span> min, <span class="keywordtype">double</span> max, <span class="keywordtype">double</span> percent ) {
00031 
00032     _minadc = min;
00033     _maxadc = max;
00034     _minpercent = percent;
00035 
00036 }
00037 
00047 <span class="keywordtype">void</span>
<a name="l00048"></a><a class="code" href="classGainFinder.html#a2">00048</a> <a class="code" href="classGainFinder.html#a2">GainFinder::getGains</a>( <a class="code" href="classRunInfo.html">RunInfo</a> &amp;ri, Array_t &amp;gains, <span class="keywordtype">int</span> telescope_id ) {
00049 
00050 
00051     <a class="code" href="classPedestalFinder.html">PedestalFinder</a> ped;
00052     <a class="code" href="classRawDataReader.html">RawDataReader</a> *data = NULL;
00053     <span class="keywordtype">char</span> telstring[50];
00054     sprintf( telstring, <span class="stringliteral">"%03d"</span>, telescope_id );
00055     string n2filename = ri.<a class="code" href="classRunInfo.html#o2">cachedir</a>+ri.<a class="code" href="classRunInfo.html#o6">n2id</a>+<span class="stringliteral">"-"</span>+telstring+<span class="stringliteral">".gains"</span>;
00056     vector&lt;Pedestal&gt; peds;
00057     Array_t adc;
00058     Array_t ngains;
00059     <span class="keywordtype">double</span> meanadc=0.0;
00060     <span class="keywordtype">int</span> nadc = 0;
00061     <span class="keywordtype">int</span> nlow=0, nhigh=0, nmean=0;
00062     RawHeaderRecord header;
00063     <a class="code" href="structRawEventRecord.html">RawEventRecord</a> event;
00064     list&lt;int&gt; badgains;
00065     list&lt;int&gt;::iterator tube;
00066     <span class="keywordtype">int</span> n=0, cnt=0;
00067     <span class="keywordtype">int</span> skipped = 0;
00068     string temp;
00069     
00070     <span class="comment">//=======================================================</span>
00071     <span class="comment">// First, we need to fetch the pedestals for the N2 run need to</span>
00072     <span class="comment">// change the offset thresholds since N2 runs have very few events</span>
00073     <span class="comment">// and thus large variances.</span>
00074     
00075     ped.<a class="code" href="classPedestalFinder.html#a5">setTubeOffThresholds</a>( 0.3, 3.0 );
00076     ped.<a class="code" href="classPedestalFinder.html#a4">getPeds</a>( ri, ri.<a class="code" href="classRunInfo.html#o6">n2id</a>, peds ); 
00077     
00078     <span class="comment">//=======================================================</span>
00079     <span class="comment">// Check if nitrogen gains exist in database...</span>
00080 
00081     ifstream infile( n2filename.c_str() );
00082     <span class="keywordflow">if</span> (infile) {
00083         <span class="comment">// Gains exist, so read them in</span>
00084 
00085         readGains( n2filename, gains );
00086 
00087         infile.close();
00088         <span class="keywordflow">return</span>;
00089 
00090     }
00091     <span class="keywordflow">else</span> {
00092 
00093         <span class="comment">// Gains don't exist, so calculate them</span>
00094 
00095         <span class="comment">//---------------------------------------------</span>
00096         <span class="comment">// Open the datafile</span>
00097 
00098         <a class="code" href="classRawDataReaderFactory.html">RawDataReaderFactory</a> *datafactory = <a class="code" href="classRawDataReaderFactory.html#e0">RawDataReaderFactory::instance</a>();
00099         
00100         <span class="keywordflow">try</span> {
00101             
00102             data = datafactory-&gt;<a class="code" href="classRawDataReaderFactory.html#a0">getReader</a>( ri, ri.<a class="code" href="classRunInfo.html#o6">n2id</a> );
00103             
00104         }
00105         <span class="keywordflow">catch</span> (<a class="code" href="classAnalysisException.html">AnalysisException</a> &amp;e) {
00106             <span class="keyword">delete</span> data;
00107             <span class="keywordflow">throw</span> (e);
00108         } 
00109 
00110         cout &lt;&lt; <span class="stringliteral">"GainFinder: Calculating telescope "</span> &lt;&lt; telescope_id 
00111              &lt;&lt; <span class="stringliteral">" gains for "</span> &lt;&lt; ri.<a class="code" href="classRunInfo.html#o6">n2id</a>  
00112              &lt;&lt; <span class="stringliteral">" in "</span> &lt;&lt; ri.<a class="code" href="classRunInfo.html#o2">cachedir</a>
00113              &lt;&lt;<span class="stringliteral">"..."</span> &lt;&lt; endl;
00114         
00115         <span class="comment">//======================================================= </span>
00116         <span class="comment">// Check if this is simulation data and just return an array of</span>
00117         <span class="comment">// 1.0's (kind of a hack, so should be implemented better</span>
00118         <span class="comment">// later...)</span>
00119         
00120         <span class="keywordflow">if</span> (data-&gt;<a class="code" href="classRawDataReader.html#a5">getType</a>() == RawDataReader::SIM) {
00121             cout &lt;&lt; <span class="stringliteral">"GainFinder: simulation data, using 1.0 for all"</span>&lt;&lt; endl;
00122             gains.resize(490);
00123             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;(<span class="keywordtype">int</span>)gains.size(); i++)
00124                 gains[i] = 1.0;
00125             writeGains( n2filename, gains );
00126             <span class="keyword">delete</span> data;
00127             <span class="keywordflow">return</span>;
00128         }
00129         
00130 
00131         <a class="code" href="classProgressBar.html">ProgressBar</a> progress( data-&gt;<a class="code" href="classRawDataReader.html#a3">size</a>(), <span class="stringliteral">"Gains"</span> );
00132 
00133         <span class="comment">//---------------------------------------------</span>
00134         <span class="comment">// Go through each event in data...</span>
00135 
00136         data-&gt;<a class="code" href="classRawDataReader.html#a1">getHeaderRecord</a>( header );
00137 
00138         <span class="keywordflow">if</span> (telescope_id &gt;= header.num_telescopes ) {
00139             cout &lt;&lt; <span class="stringliteral">"GainFinder: WARNING: telescope "</span>&lt;&lt;telescope_id
00140                  &lt;&lt; <span class="stringliteral">" is not in the data file's header!"</span>&lt;&lt;endl;
00141             cout &lt;&lt; <span class="stringliteral">"Since the number is pixels is unknown, I'll try 490."</span>
00142                  &lt;&lt; endl;
00143             nadc = 490;
00144         }
00145         <span class="keywordflow">else</span> {
00146             nadc = header.nadc[telescope_id];
00147         }
00148 
00149 
00150         gains.resize(nadc);
00151         ngains.resize(nadc);
00152         adc.resize(nadc);
00153         
00154         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;nadc; i++) {
00155             ngains[i] = 0;
00156             gains[i] = 0.0;
00157         }
00158 
00159         <span class="keywordflow">if</span> (nadc == 492) nadc = 379; <span class="comment">// hack to ignore outter tubes </span>
00160 
00161         <span class="comment">// for debugging:</span>
00162 <span class="comment">//      Camera cam( "490.camera" );</span>
00163 <span class="comment">//      vector&lt;int&gt; cleanpixels;</span>
00164 <span class="comment">//      PlotMaker *pm  = new PlotMaker( "X", "x.out",</span>
00165 <span class="comment">//                                      cam.getMinX() - 0.4, </span>
00166 <span class="comment">//                                      cam.getMinY() - 0.4, </span>
00167 <span class="comment">//                                      cam.getMaxX() + 0.4, </span>
00168 <span class="comment">//                                      cam.getMaxY() + 0.4 </span>
00169 <span class="comment">//                                      );</span>
00170 <span class="comment">//      pm-&gt;setAxisBox( cam );</span>
00171 <span class="comment">//      pm-&gt;setPixelScale( 1024 );</span>
00172         
00173 
00174         <span class="keywordflow">while</span> ( data-&gt;<a class="code" href="classRawDataReader.html#a6">isDone</a>() == <span class="keyword">false</span> ) {
00175 
00176             <span class="comment">// get next event</span>
00177 
00178             <span class="keywordflow">try</span> {
00179                 data-&gt;<a class="code" href="classRawDataReader.html#a2">getNextEventRecord</a>( event );
00180             }
00181             <span class="keywordflow">catch</span> (<a class="code" href="classMildAnalysisException.html">MildAnalysisException</a> &amp;e) {
00182                 <span class="keywordflow">break</span>;
00183             }
00184 
00185             
00186             <span class="keywordflow">if</span> ( event.<a class="code" href="structRawEventRecord.html#o0">type</a> == RawDataReader::EVENT 
00187                  &amp;&amp; event.<a class="code" href="structRawEventRecord.html#o6">telescope_id</a> == telescope_id) {
00188                 
00189 
00190                 <span class="comment">// debugging:</span>
00191 <span class="comment">//              pm-&gt;plot( cam, event.adc, peds, cleanpixels );</span>
00192 <span class="comment">//              pm-&gt;newPage();</span>
00193 <span class="comment">//              cout &lt;&lt; "NEXT EVENT?";</span>
00194 <span class="comment">//              cin &gt;&gt; temp;</span>
00195 
00196 
00197                 <span class="comment">// Subtract pedestals</span>
00198 
00199                 Array_t &amp;a = event.<a class="code" href="structRawEventRecord.html#o7">adc</a>;
00200                 
00201                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;nadc; i++) {
00202                     
00203                     <span class="comment">//check for tube off</span>
00204                     <span class="keywordflow">if</span> (peds[i].type == Pedestal::GOOD ) {
00205                         adc[i] = a[i] - peds[i].pedestal;
00206                     }
00207                     <span class="keywordflow">else</span> adc[i] = 0.0;
00208                 }
00209 
00210 
00211                 <span class="comment">// debugging:</span>
00212 <span class="comment">//              pm-&gt;plot( cam, adc, peds, cleanpixels );</span>
00213 <span class="comment">//              pm-&gt;newPage();</span>
00214 <span class="comment">//              cout &lt;&lt; "NEXT EVENT?";</span>
00215 <span class="comment">//              cin &gt;&gt; temp;</span>
00216 
00217 
00218                 <span class="comment">// Get the mean adc value</span>
00219 
00220                 meanadc = 0;
00221                 nmean = 0;
00222                 nlow = 0; 
00223                 nhigh = 0;
00224                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;nadc; i++) {
00225                     <span class="keywordflow">if</span> (adc[i] &lt; _minadc) nlow++;
00226                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (adc[i] &gt; _maxadc) nhigh++;
00227                     <span class="keywordflow">else</span> {
00228                         meanadc += adc[i];
00229                         nmean++;
00230                     }
00231                 }
00232                 
00233                 <span class="comment">// Accumulate the adc values</span>
00234 
00235                 <span class="keywordflow">if</span> (nmean &gt; (<span class="keywordtype">int</span>)(nadc*_minpercent)) {
00236                     <span class="comment">// Tubes are unsaturated, calculate</span>
00237                     <span class="comment">// the flat field values</span>
00238                     
00239                     meanadc /= (<span class="keywordtype">double</span>) nmean;
00240 
00241                     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;nadc; i++) {
00242                         <span class="keywordflow">if</span> ((adc[i] &gt; _minadc) &amp;&amp; (adc[i] &lt; _maxadc)) {
00243                             gains[i] += (meanadc / adc[i]);
00244                             ngains[i] += 1.0;
00245                         }
00246                     }
00247                             
00248                 }
00249                 <span class="keywordflow">else</span> {
00250                     <span class="comment">// tubes are saturated or off</span>
00251                     skipped++;
00252                 }
00253             }
00254 
00255             <span class="comment">// Update progressbar</span>
00256             n++;
00257             cnt++;
00258             <span class="keywordflow">if</span> (cnt == 128 || cnt==0) {
00259                 cnt = 0;
00260                 progress.<a class="code" href="classProgressBar.html#a2">print</a>( n );
00261             }
00262 
00263 
00264         }
00265 
00266         <span class="keyword">delete</span> data;
00267 
00268         progress.<a class="code" href="classProgressBar.html#a3">printClear</a>();
00269         cout &lt;&lt; <span class="stringliteral">"GainFinder: Skipped "</span> &lt;&lt; skipped 
00270              &lt;&lt; <span class="stringliteral">" events with too small a signal"</span> &lt;&lt; endl;
00271 
00272        
00273         <span class="comment">//---------------------------------------------</span>
00274         <span class="comment">// now calculate the gains:</span>
00275 
00276         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;nadc; i++) {
00277 
00278             <span class="comment">// normalize gains</span>
00279             <span class="keywordflow">if</span> (ngains[i] &gt; 0.5) {
00280                 gains[i] /= ngains[i];
00281             }
00282             <span class="keywordflow">else</span> {
00283                 <span class="comment">// KPK: changed this from =1.0 to =0.0 to avoid</span>
00284                 <span class="comment">// tubes with bad gains</span>
00285                 gains[i] = 0.0;
00286                 badgains.push_back(i);
00287             }
00288         }
00289 
00290         <span class="keywordflow">if</span> (badgains.size() &gt; 0) {
00291             
00292             cout &lt;&lt;endl;
00293             cout &lt;&lt; <span class="stringliteral">"There wasn't enough data to determine gains for the "</span>
00294                  &lt;&lt; <span class="stringliteral">"following tubes:"</span> &lt;&lt; endl;
00295             cout &lt;&lt; <span class="stringliteral">"-----------------------------------------"</span>
00296                  &lt;&lt; <span class="stringliteral">"-----------------------------"</span> &lt;&lt; endl;
00297             <span class="keywordflow">for</span> (tube=badgains.begin(); tube!=badgains.end(); tube++) 
00298                 cout &lt;&lt; *tube &lt;&lt; <span class="stringliteral">" "</span>;
00299             cout &lt;&lt; endl;
00300         }
00301 
00302         <span class="comment">//--------------------------------------</span>
00303         <span class="comment">// Write the gains to disk</span>
00304 
00305         writeGains( n2filename, gains );
00306 
00307         cout &lt;&lt; <span class="stringliteral">"GainFinder: Done calculating gains for "</span> 
00308              &lt;&lt; ri.<a class="code" href="classRunInfo.html#o6">n2id</a> &lt;&lt; endl;        
00309 
00310     }
00311 
00312 }
00313 
00314 
00315 <span class="keywordtype">void</span>
00316 GainFinder::readGains( string &amp;filename, Array_t &amp;gains ) {
00317 
00318     ifstream infile( filename.c_str() );
00319     <span class="keywordtype">int</span> n, id;
00320 
00321     <span class="keywordflow">if</span> (!infile) {
00322         
00323         <span class="comment">// shouldn't ever get here since we already tried opening,</span>
00324         <span class="comment">// but just to be safe...</span>
00325         cout &lt;&lt; <span class="stringliteral">"GainFinder::readGains() Couldn't read gains file:"</span>
00326              &lt;&lt; filename &lt;&lt; endl;
00327         exit(1);
00328 
00329     }
00330     
00331 
00332     infile &gt;&gt; n;
00333     gains.resize(n);
00334     
00335     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;n; i++) {
00336 
00337         infile &gt;&gt; id &gt;&gt; gains[i];
00338         
00339         <span class="keywordflow">if</span> (id != i) {
00340             cout &lt;&lt; <span class="stringliteral">"\t*** WARNING: tube "</span> &lt;&lt; id 
00341                  &lt;&lt; <span class="stringliteral">" seems to be misnumbered in "</span> 
00342                  &lt;&lt; filename &lt;&lt; endl;    
00343         }
00344 
00345     }
00346 
00347     infile.close();
00348 
00349 }
00350 
00351 <span class="keywordtype">void</span>
00352 GainFinder::writeGains( string &amp;filename, Array_t &amp;gains ) {
00353 
00354     ofstream outfile( filename.c_str() );
00355 
00356     <span class="keywordflow">if</span> (!outfile) {
00357         cout &lt;&lt; <span class="stringliteral">"** Warning: Couldn't write to gains file: "</span> 
00358              &lt;&lt; filename &lt;&lt; endl;
00359     }
00360     <span class="keywordflow">else</span> {
00361         
00362         outfile &lt;&lt; gains.size() &lt;&lt; endl;
00363 
00364         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt; (<span class="keywordtype">int</span>)gains.size(); i++){
00365             outfile &lt;&lt; i &lt;&lt; <span class="stringliteral">"\t"</span> &lt;&lt; gains[i] &lt;&lt; endl;
00366         }
00367 
00368         outfile.close();
00369         
00370     }
00371 
00372 }
00373 
00374 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Apr 21 10:22:45 2007 for wuparam by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
