<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>wuparam: ZCutter.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>ZCutter.cpp</h1><div class="fragment"><pre>00001 <span class="preprocessor">#include &lt;iostream&gt;</span>
00002 <span class="preprocessor">#include &lt;stdexcept&gt;</span>
00003 
00004 <span class="preprocessor">#include "Camera.h"</span>
00005 <span class="preprocessor">#include "ZCutter.h"</span>
00006 
00007 
00008 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00009 
00010 
00011 ZCutter::ZCutter() : <a class="code" href="classSuperCutter.html">SuperCutter</a>() {
00012 
00013     _cam = <span class="keyword">new</span> <a class="code" href="classCamera.html">Camera</a>(490);
00014 
00015 }
00016 
00017 
00022 <span class="keywordtype">void</span>
<a name="l00023"></a><a class="code" href="classZCutter.html#a2">00023</a> <a class="code" href="classZCutter.html#a2">ZCutter::setCamera</a>( <span class="keywordtype">int</span> npix, <span class="keywordtype">int</span> utdate ) {
00024 
00025     <span class="keyword">delete</span> _cam;
00026     _cam = <span class="keyword">new</span> <a class="code" href="classCamera.html">Camera</a>(npix,utdate);
00027 
00028 }
00029 
00030 
00038 <span class="keywordtype">void</span>
00039 <a class="code" href="classZCutter.html#a1">ZCutter::</a>
<a name="l00040"></a><a class="code" href="classZCutter.html#a1">00040</a> <a class="code" href="classZCutter.html#a1">applyCorrections</a>(<a class="code" href="structHillasParameterization.html">HillasParameterization</a> &amp;param) {
00041 
00042     <span class="keyword">const</span> <span class="keywordtype">int</span> NOMINAL_SIZE = 1100;
00043     <span class="keywordtype">double</span> zwidth2, zlength2;
00044     <span class="keywordtype">double</span> sig2_w0, sig2_l0;
00045     <span class="keywordtype">double</span> sig_w0, sig_l0 ;
00046     <span class="keywordtype">double</span> zwidth, zlength;
00047     <span class="keywordtype">double</span> dx,dy, cfact;
00048 
00049     <span class="keywordtype">double</span> zen; 
00050     <span class="keywordtype">double</span> cos2_zen; 
00051     <span class="keywordtype">double</span> sig2_psf;
00052     <span class="keywordtype">double</span> sig2_pix;
00053     <span class="keywordtype">double</span> dlog;
00054 
00055     <a class="code" href="structHillasParameterization.html">HillasParameterization</a> oldparam = param; <span class="comment">//for debugging</span>
00056     
00057     zen = param.<a class="code" href="structHillasParameterization.html#o19">zenith</a>;
00058     
00059 <span class="comment">//     if(param.event_number &lt; 10) </span>
00060 <span class="comment">//      cout &lt;&lt; "DEBUG: zenith angle="&lt;&lt; zen*180.0/M_PI &lt;&lt; endl;</span>
00061 
00062     cos2_zen = cos(zen) ; cos2_zen *= cos2_zen;
00063     sig2_psf = _cam-&gt;<a class="code" href="classCamera.html#a6">getSigmaPSF</a>( zen ) ; sig2_psf *= sig2_psf;
00064     sig2_pix = _cam-&gt;<a class="code" href="classCamera.html#a7">getSigmaPixel</a>() ; sig2_pix *= sig2_pix;
00065 
00066 <span class="comment">//     cout &lt;&lt; "DEBUG: zen = "&lt;&lt; zen &lt;&lt; endl;</span>
00067 <span class="comment">//     cout &lt;&lt; "DEBUG: sigmapsf2 = "&lt;&lt; sig2_psf &lt;&lt; endl;</span>
00068 <span class="comment">//     cout &lt;&lt; "DEBUG: sigmapix2 = "&lt;&lt; sig2_pix &lt;&lt; endl;</span>
00069 
00070     <span class="comment">//============================================================</span>
00071     <span class="comment">// First, apply camera gain correction (PE/DC)</span>
00072     <span class="comment">//============================================================</span>
00073 
00074     <span class="comment">// l/s must be corrected after PE to DC correction, but before</span>
00075     <span class="comment">// zenith angle</span>
00076 
00077     param.<a class="code" href="structHillasParameterization.html#o13">max</a>[0] *= _cam-&gt;<a class="code" href="classCamera.html#a8">getPEToDC</a>();
00078     param.<a class="code" href="structHillasParameterization.html#o13">max</a>[1] *= _cam-&gt;<a class="code" href="classCamera.html#a8">getPEToDC</a>();
00079     param.<a class="code" href="structHillasParameterization.html#o13">max</a>[2] *= _cam-&gt;<a class="code" href="classCamera.html#a8">getPEToDC</a>();
00080     param.<a class="code" href="structHillasParameterization.html#o5">size</a>   *= _cam-&gt;<a class="code" href="classCamera.html#a8">getPEToDC</a>();
00081     param.<a class="code" href="structHillasParameterization.html#o10">length_over_size</a> = (param.<a class="code" href="structHillasParameterization.html#o3">length</a>/(<span class="keywordtype">double</span>)(param.<a class="code" href="structHillasParameterization.html#o5">size</a>)); 
00082 
00083     <span class="comment">//============================================================</span>
00084     <span class="comment">// Calculate zwidth </span>
00085     <span class="comment">//============================================================</span>
00086 
00087     sig2_w0 = (param.<a class="code" href="structHillasParameterization.html#o4">width</a> * param.<a class="code" href="structHillasParameterization.html#o4">width</a>) - (sig2_pix + sig2_psf);    
00088     dlog = log(param.<a class="code" href="structHillasParameterization.html#o5">size</a>/0.449) - 8.0; <span class="comment">// the 8.0 is hand fit</span>
00089 
00090     if (sig2_w0 &gt; 0.0) {
00091         sig2_w0  /= pow(cos(zen),1.5) ;
00092         
00093         sig_w0 = sqrt(sig2_w0) - 0.023 * dlog ;
00094         sig2_w0 = sig_w0 * sig_w0 ;
00095 <span class="comment">//      cout &lt;&lt; "DEBUG: SATURATED" &lt;&lt; endl;</span>
00096     }
00097     <span class="keywordflow">else</span> sig2_w0 = 0.0;
00098  
00099     zwidth2 = sig2_w0 + sig2_pix + sig2_psf;
00100     zwidth = sqrt(zwidth2);
00101     
00102 
00103     <span class="comment">//============================================================</span>
00104     <span class="comment">// Calculate zlength </span>
00105     <span class="comment">//============================================================</span>
00106 
00107 <span class="comment">//     sig2_l0 = (param.length*param.length - (sig2_pix + sig2_psf));    </span>
00108 <span class="comment">//     if (sig2_l0 &gt; 0.0) sig2_l0  /= cos2_zen ;</span>
00109 <span class="comment">//     else sig2_l0 = 0.0;</span>
00110 
00111 <span class="comment">//     sig_l0 = sqrt(sig2_l0) - 0.020 * dlog ;</span>
00112 <span class="comment">//     sig2_l0 = sig_l0 * sig_l0 ;</span>
00113 
00114 <span class="comment">//     zlength2 = sig2_l0 + sig2_pix + sig2_psf;</span>
00115 <span class="comment">//     zlength = sqrt(zlength2);</span>
00116 
00117     sig2_l0 = (param.<a class="code" href="structHillasParameterization.html#o3">length</a>*param.<a class="code" href="structHillasParameterization.html#o3">length</a> - (sig2_pix + sig2_psf));    
00118     if (sig2_l0 &gt; 0.0) {
00119         sig2_l0  /= pow(cos(zen),1.2) ;
00120         sig_l0 = sqrt(sig2_l0) - 0.020 * dlog ;
00121         sig2_l0 = sig_l0 * sig_l0 ;
00122     }
00123     <span class="keywordflow">else</span> sig2_l0 = 0.0;
00124 
00125 
00126     zlength2 = sig2_l0 + sig2_pix + sig2_psf;
00127     zlength = sqrt(zlength2);
00128 
00129 
00130 
00131     <span class="comment">//============================================================    </span>
00132     <span class="comment">// Correct the 2D points </span>
00133     <span class="comment">//============================================================</span>
00134 
00135     <span class="comment">// First calculate the distance between the point of origin and</span>
00136     <span class="comment">// centroid</span>
00137 
00138     dx = param.<a class="code" href="structHillasParameterization.html#o1">point_of_origin_a</a>.<a class="code" href="structCoordinate__t.html#o0">x</a> - param.<a class="code" href="structHillasParameterization.html#o0">centroid</a>.<a class="code" href="structCoordinate__t.html#o0">x</a>;
00139     dy = param.<a class="code" href="structHillasParameterization.html#o1">point_of_origin_a</a>.<a class="code" href="structCoordinate__t.html#o1">y</a> - param.<a class="code" href="structHillasParameterization.html#o0">centroid</a>.<a class="code" href="structCoordinate__t.html#o1">y</a>;
00140 
00141     <span class="comment">// Now calculate the correction factor including two terms: the</span>
00142     <span class="comment">// first ratio corrects the elongation factor, the second replaces</span>
00143     <span class="comment">// the width/length (elongation) dependence with the intrinsic</span>
00144     <span class="comment">// elongation given by zwidth/zlength</span>
00145 
00146     cfact = (_cuts.<a class="code" href="structCutInfo.html#o1">elongation</a> / 1.68) *  <span class="comment">// TODO: shouldn't be hardcoded!</span>
00147         ((1.0-zwidth/zlength)/(1.0-param.<a class="code" href="structHillasParameterization.html#o4">width</a>/param.<a class="code" href="structHillasParameterization.html#o3">length</a>));
00148     
00149     <span class="comment">// Modified by JB 030201 should just add the rescaled distance</span>
00150     <span class="comment">// from centroid to point of origin to the orignal centroid</span>
00151     <span class="comment">// position for point a, subtract fo point b</span>
00152 
00153     param.<a class="code" href="structHillasParameterization.html#o1">point_of_origin_a</a>.<a class="code" href="structCoordinate__t.html#o0">x</a> = param.<a class="code" href="structHillasParameterization.html#o0">centroid</a>.<a class="code" href="structCoordinate__t.html#o0">x</a> + cfact*dx;
00154     param.<a class="code" href="structHillasParameterization.html#o1">point_of_origin_a</a>.<a class="code" href="structCoordinate__t.html#o1">y</a> = param.<a class="code" href="structHillasParameterization.html#o0">centroid</a>.<a class="code" href="structCoordinate__t.html#o1">y</a> + cfact*dy;
00155 
00156     param.<a class="code" href="structHillasParameterization.html#o2">point_of_origin_b</a>.<a class="code" href="structCoordinate__t.html#o0">x</a> = param.<a class="code" href="structHillasParameterization.html#o0">centroid</a>.<a class="code" href="structCoordinate__t.html#o0">x</a> - cfact*dx;
00157     param.<a class="code" href="structHillasParameterization.html#o2">point_of_origin_b</a>.<a class="code" href="structCoordinate__t.html#o1">y</a> = param.<a class="code" href="structHillasParameterization.html#o0">centroid</a>.<a class="code" href="structCoordinate__t.html#o1">y</a> - cfact*dy;
00158 
00159     <span class="comment">//============================================================</span>
00160     <span class="comment">// set all the values</span>
00161     <span class="comment">//============================================================</span>
00162     
00163     <span class="comment">// note miss is also scaled by cos(theta) in case somebody wants</span>
00164     <span class="comment">// to re-calculate alpha from miss and distance later.</span>
00165     
00166     param.<a class="code" href="structHillasParameterization.html#o4">width</a> = zwidth;
00167     param.<a class="code" href="structHillasParameterization.html#o3">length</a> = zlength;
00168     param.<a class="code" href="structHillasParameterization.html#o7">distance</a> /= cos(zen);
00169     param.<a class="code" href="structHillasParameterization.html#o6">miss</a> /= cos(zen);
00170 
00171 
00172     <span class="comment">// DEBUG: try undoing the transformation and comparing...</span>
00173 
00174 <span class="comment">//  double unzwidth2 =  pow( ( sqrt(zwidth*zwidth - (sig2_pix+sig2_psf)) </span>
00175 <span class="comment">//                             + 0.023*(log(param.size/0.449)-8.0)),2 ) </span>
00176 <span class="comment">//      * pow(cos(zen),1.5) + (sig2_pix+sig2_psf);</span>
00177     
00178 <span class="comment">//     cout &lt;&lt; "DEBUG: width="&lt;&lt;oldparam.width</span>
00179 <span class="comment">//       &lt;&lt;"\t unzwidth="&lt;&lt;sqrt(unzwidth2)</span>
00180 <span class="comment">//       &lt;&lt;"\t zwidth=" &lt;&lt;zwidth</span>
00181 <span class="comment">//       &lt;&lt; "\t diff="&lt;&lt;oldparam.width-sqrt(unzwidth2)&lt;&lt; endl;</span>
00182 
00183 
00184 }
00185 
00186 
00187 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Apr 21 10:22:46 2007 for wuparam by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
