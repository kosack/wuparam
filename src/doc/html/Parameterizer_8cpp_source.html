<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>wuparam: Parameterizer.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">wuparam&#160;<span id="projectnumber">0.1</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">Parameterizer.cpp</div>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">//</span>
<a name="l00002"></a>00002 <span class="comment">//</span>
<a name="l00003"></a>00003 <span class="comment">// Parameterizer.cpp</span>
<a name="l00004"></a>00004 <span class="comment">// Karl Kosack &lt;kosack@hbar.wustl.edu&gt;</span>
<a name="l00005"></a>00005 <span class="comment">//</span>
<a name="l00006"></a>00006 <span class="comment">// Modified 030201 by JB to correct some bugs in 2-d analys</span>
<a name="l00007"></a>00007 <span class="comment">// save some computation time and correct a bug where zenith</span>
<a name="l00008"></a>00008 <span class="comment">// corrections were applied twice when display was enabled</span>
<a name="l00009"></a>00009 <span class="comment">// </span>
<a name="l00010"></a>00010 <span class="comment">//</span>
<a name="l00011"></a>00011 <span class="comment">// Modified July 2005 by KPK - Adding functionality to work with</span>
<a name="l00012"></a>00012 <span class="comment">// multiple telescopes (i.e. VERITAS).  Since the original code really wan&#39;t designed to do that, it&#39;s somewhat of a messy situation</span>
<a name="l00013"></a>00013 
<a name="l00014"></a>00014 <span class="preprocessor">#include &lt;iostream&gt;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &lt;cmath&gt;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &lt;iomanip&gt;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &lt;list&gt;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &lt;cctype&gt;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>          <span class="comment">// For POSIX mkdir</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>           <span class="comment">// For POSIX mkdir</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &lt;gsl/gsl_rng.h&gt;</span>        <span class="comment">// Random num generators </span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;gsl/gsl_randist.h&gt;</span>    <span class="comment">// Random distributions </span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;gsl/gsl_sf_trig.h&gt;</span>
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;Camera.h&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;DataReader.h&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;DataRecords.h&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;DataWriter.h&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;ImageAnalyzer.h&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;MuonImageAnalyzer.h&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;ImageCleaner.h&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;PedestalFinder.h&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;GainFinder.h&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;ProgressBar.h&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;Parameterizer.h&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;Histogram.h&quot;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;GaussianDeviate.h&quot;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;SuperCutter.h&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;ZCutter.h&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;SpectralCutter.h&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;Image2D.h&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;PlotMaker.h&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;Log.h&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;AngleConverters.h&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;ImageFilter.h&quot;</span>
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="keyword">using namespace </span>std;
<a name="l00048"></a>00048 <span class="keyword">using namespace </span>Cuts;
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 Parameterizer::
<a name="l00051"></a>00051 Parameterizer()
<a name="l00052"></a>00052     : _is_verbose_enabled(true), _is_display_enabled(false),
<a name="l00053"></a>00053       _is_interactive(false),_is_first_run(true) , _is_cleanup_enabled(true),
<a name="l00054"></a>00054       _latitude(.553065751136), _longitude(1.935190) , _event_number(0) {
<a name="l00055"></a>00055 
<a name="l00056"></a>00056     _wupdir = getSupportDir();
<a name="l00057"></a>00057 
<a name="l00058"></a>00058 }
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 Parameterizer::
<a name="l00061"></a>00061 ~Parameterizer() {
<a name="l00062"></a>00062 
<a name="l00063"></a>00063     <span class="keyword">delete</span> _gaussdev;
<a name="l00064"></a>00064     
<a name="l00065"></a>00065 }
<a name="l00066"></a>00066 
<a name="l00070"></a>00070 <span class="keywordtype">void</span>
<a name="l00071"></a>00071 <a class="code" href="classParameterizer.html#ab02d91aaed1db3a62a098d72fd64ea63" title="Parametrize the specified run.">Parameterizer::</a>
<a name="l00072"></a><a class="code" href="classParameterizer.html#ab02d91aaed1db3a62a098d72fd64ea63">00072</a> <a class="code" href="classParameterizer.html#ab02d91aaed1db3a62a098d72fd64ea63" title="Parametrize the specified run.">process</a>(  <a class="code" href="classRunInfo.html" title="Basic structure returned by a Config object.">RunInfo</a> &amp;ri ) {
<a name="l00073"></a>00073 
<a name="l00074"></a>00074     <a class="code" href="classPedestalFinder.html" title="Class to generate pedestal values for a series of runs.">PedestalFinder</a> ped;
<a name="l00075"></a>00075     <a class="code" href="classRunInfo.html" title="Basic structure returned by a Config object.">RunInfo</a> ri2 = ri;
<a name="l00076"></a>00076 
<a name="l00077"></a>00077     cout &lt;&lt; endl;
<a name="l00078"></a>00078 
<a name="l00079"></a>00079     <span class="keywordflow">if</span> (_is_first_run) {
<a name="l00080"></a>00080         _gaussdev = <span class="keyword">new</span> <a class="code" href="classGaussianDeviate.html">GaussianDeviate</a>(ri.<a class="code" href="classRunInfo.html#ae87a6169dbd7e2cf46acb700179410bc" title="directory to write ped/gain data">cachedir</a>);
<a name="l00081"></a>00081     }
<a name="l00082"></a>00082 
<a name="l00083"></a>00083     <span class="keywordflow">switch</span> ( ri.<a class="code" href="classRunInfo.html#aaf1aeb4420afcc27e4b1bbd684329fc5" title="type of run (on/off vs tracking)">type</a> ) {
<a name="l00084"></a>00084 
<a name="l00085"></a>00085       <span class="keywordflow">case</span> Config::ONOFF:
<a name="l00086"></a>00086 
<a name="l00087"></a>00087           <span class="keywordflow">if</span> (_is_verbose_enabled) {
<a name="l00088"></a>00088               cout &lt;&lt;<span class="stringliteral">&quot;----------------------------------&quot;</span>
<a name="l00089"></a>00089                    &lt;&lt;<span class="stringliteral">&quot;--------------------------------------&quot;</span>&lt;&lt; endl;
<a name="l00090"></a>00090               cout &lt;&lt;<span class="stringliteral">&quot;---- ON/OFF PAIR ---- &quot;</span> &lt;&lt;ri.<a class="code" href="classRunInfo.html#a75fe835214afa525cc0a5bced31cbe57" title="id of on/tracking run">onid</a>&lt;&lt;<span class="stringliteral">&quot;/&quot;</span>&lt;&lt;ri.<a class="code" href="classRunInfo.html#adc491683f873f002dcfa423f6d0f5bb2" title="id of off run for padding">offid</a>&lt;&lt;<span class="stringliteral">&quot; &quot;</span>;
<a name="l00091"></a>00091               <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k=0; k&lt; 70-(int)(ri.<a class="code" href="classRunInfo.html#a75fe835214afa525cc0a5bced31cbe57" title="id of on/tracking run">onid</a>.size()
<a name="l00092"></a>00092                                        +(int)ri.<a class="code" href="classRunInfo.html#adc491683f873f002dcfa423f6d0f5bb2" title="id of off run for padding">offid</a>.size()+1+21); k++)
<a name="l00093"></a>00093                   cout &lt;&lt; <span class="stringliteral">&quot;-&quot;</span>;
<a name="l00094"></a>00094               cout &lt;&lt; endl;
<a name="l00095"></a>00095               cout &lt;&lt;<span class="stringliteral">&quot;----------------------------------&quot;</span>
<a name="l00096"></a>00096                    &lt;&lt;<span class="stringliteral">&quot;--------------------------------------&quot;</span>&lt;&lt; endl;
<a name="l00097"></a>00097           }
<a name="l00098"></a>00098 
<a name="l00099"></a>00099           ri2 = ri;
<a name="l00100"></a>00100 
<a name="l00101"></a>00101           <span class="comment">// Process on padded with off note padpeds is really</span>
<a name="l00102"></a>00102           <span class="comment">// off-source pedestals and must be loaded even if padding</span>
<a name="l00103"></a>00103           <span class="comment">// is off (for the skybrightness map)</span>
<a name="l00104"></a>00104 
<a name="l00105"></a>00105           <span class="comment">//      ped.getOffSourcePeds( ri, _padpeds );</span>
<a name="l00106"></a>00106           processOne( ri, ri.<a class="code" href="classRunInfo.html#a75fe835214afa525cc0a5bced31cbe57" title="id of on/tracking run">onid</a> );
<a name="l00107"></a>00107           
<a name="l00108"></a>00108           <span class="comment">// Process off padded with on</span>
<a name="l00109"></a>00109           <span class="comment">//      ped.getOnSourcePeds( ri, _padpeds );</span>
<a name="l00110"></a>00110           processOne( ri2, ri2.<a class="code" href="classRunInfo.html#adc491683f873f002dcfa423f6d0f5bb2" title="id of off run for padding">offid</a> );
<a name="l00111"></a>00111           <span class="keywordflow">break</span>;
<a name="l00112"></a>00112           
<a name="l00113"></a>00113       <span class="keywordflow">case</span> Config::TRACK:
<a name="l00114"></a>00114           <span class="keywordflow">if</span> (_is_verbose_enabled) {
<a name="l00115"></a>00115               cout &lt;&lt;<span class="stringliteral">&quot;----------------------------------&quot;</span>
<a name="l00116"></a>00116                    &lt;&lt;<span class="stringliteral">&quot;--------------------------------------&quot;</span>&lt;&lt; endl;
<a name="l00117"></a>00117               cout &lt;&lt;<span class="stringliteral">&quot;---- TRACKING RUN ---- &quot;</span> &lt;&lt;ri.<a class="code" href="classRunInfo.html#a75fe835214afa525cc0a5bced31cbe57" title="id of on/tracking run">onid</a>&lt;&lt;<span class="stringliteral">&quot; &quot;</span>;
<a name="l00118"></a>00118               <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k=0; k&lt; 70-(int)(ri.<a class="code" href="classRunInfo.html#a75fe835214afa525cc0a5bced31cbe57" title="id of on/tracking run">onid</a>.size()+21+1); (int)k++)
<a name="l00119"></a>00119                   cout &lt;&lt; <span class="stringliteral">&quot;-&quot;</span>;
<a name="l00120"></a>00120               cout &lt;&lt; endl;
<a name="l00121"></a>00121               cout &lt;&lt;<span class="stringliteral">&quot;----------------------------------&quot;</span>
<a name="l00122"></a>00122                    &lt;&lt;<span class="stringliteral">&quot;--------------------------------------&quot;</span>&lt;&lt; endl;
<a name="l00123"></a>00123           }
<a name="l00124"></a>00124           
<a name="l00125"></a>00125           processOne( ri, ri.<a class="code" href="classRunInfo.html#a75fe835214afa525cc0a5bced31cbe57" title="id of on/tracking run">onid</a> );
<a name="l00126"></a>00126           <span class="keywordflow">break</span>;
<a name="l00127"></a>00127           
<a name="l00128"></a>00128       <span class="keywordflow">default</span>:
<a name="l00129"></a>00129           cerr &lt;&lt; <span class="stringliteral">&quot;*** Parameterizer: unknown run type: &quot;</span> &lt;&lt; ri.<a class="code" href="classRunInfo.html#aaf1aeb4420afcc27e4b1bbd684329fc5" title="type of run (on/off vs tracking)">type</a>&lt;&lt;endl;
<a name="l00130"></a>00130           <span class="keywordflow">break</span>;
<a name="l00131"></a>00131     }
<a name="l00132"></a>00132     
<a name="l00133"></a>00133     _is_first_run = <span class="keyword">false</span>;
<a name="l00134"></a>00134     
<a name="l00135"></a>00135 
<a name="l00136"></a>00136 }
<a name="l00137"></a>00137 
<a name="l00138"></a>00138 
<a name="l00142"></a>00142 <span class="keywordtype">void</span>
<a name="l00143"></a><a class="code" href="classParameterizer.html#a8416f32994c05ffcdf0c27c93ff0d34b">00143</a> <a class="code" href="classParameterizer.html#a8416f32994c05ffcdf0c27c93ff0d34b" title="Print out run summary information in human readable format.">Parameterizer::printSummary</a>( ostream &amp;stream, <a class="code" href="classRunInfo.html" title="Basic structure returned by a Config object.">RunInfo</a> &amp;ri, 
<a name="l00144"></a>00144                              <span class="keywordtype">string</span> &amp;<span class="keywordtype">id</span>, <a class="code" href="structRawHeaderRecord.html">RawHeaderRecord</a> &amp;header,
<a name="l00145"></a>00145                              <a class="code" href="classParamDataWriter.html" title="Base class for writing HillasParameterizations to disk.">ParamDataWriter</a> *writer, <a class="code" href="classRawDataReader.html" title="Reads raw telescope data and produces coresponding records...">RawDataReader</a> *data, 
<a name="l00146"></a>00146                              <a class="code" href="classTelescopeArray.html" title="Stores information for an array of telescopes, including Camera objects.">TelescopeArray</a> &amp;array ){
<a name="l00147"></a>00147 
<a name="l00148"></a>00148     stream &lt;&lt;<span class="stringliteral">&quot;Run information: &quot;</span> &lt;&lt; endl;
<a name="l00149"></a>00149     stream &lt;&lt; <span class="stringliteral">&quot;\tUTDATE      : &quot;</span> &lt;&lt; ri.<a class="code" href="classRunInfo.html#a01b54d7d93bb39aa3eefaf1bc80e82c2" title="UT date.">utdate</a> &lt;&lt; endl;
<a name="l00150"></a>00150     stream &lt;&lt; <span class="stringliteral">&quot;\tRUN ID      : &quot;</span> &lt;&lt; <span class="keywordtype">id</span> &lt;&lt; endl;
<a name="l00151"></a>00151     stream &lt;&lt; <span class="stringliteral">&quot;\tNITROGEN ID : &quot;</span> &lt;&lt; ri.<a class="code" href="classRunInfo.html#a4ed3be46e78ed8c602635ea1397d43e5" title="id of nitrogen gain run">n2id</a> &lt;&lt; endl;
<a name="l00152"></a>00152     stream &lt;&lt; <span class="stringliteral">&quot;\tPADDING     : &quot;</span>;
<a name="l00153"></a>00153     <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#a169dac601c7f6f1be162e95faf0aa83a" title="flag to enable padding">padding</a>) {
<a name="l00154"></a>00154         <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#aaf1aeb4420afcc27e4b1bbd684329fc5" title="type of run (on/off vs tracking)">type</a> == Config::ONOFF) {
<a name="l00155"></a>00155             <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == ri.<a class="code" href="classRunInfo.html#a75fe835214afa525cc0a5bced31cbe57" title="id of on/tracking run">onid</a>)
<a name="l00156"></a>00156                 stream &lt;&lt; ri.<a class="code" href="classRunInfo.html#adc491683f873f002dcfa423f6d0f5bb2" title="id of off run for padding">offid</a> &lt;&lt; endl;
<a name="l00157"></a>00157             <span class="keywordflow">else</span>
<a name="l00158"></a>00158                 stream &lt;&lt; ri.<a class="code" href="classRunInfo.html#a75fe835214afa525cc0a5bced31cbe57" title="id of on/tracking run">onid</a> &lt;&lt; endl;
<a name="l00159"></a>00159         }
<a name="l00160"></a>00160         <span class="keywordflow">else</span> {
<a name="l00161"></a>00161             stream &lt;&lt; ri.<a class="code" href="classRunInfo.html#a3b3285030501c689d84a3dd6d04feaa0" title="pedvar to pad to if there is no off run">padlevel</a> &lt;&lt; <span class="stringliteral">&quot; (fixed level)&quot;</span>&lt;&lt; endl;
<a name="l00162"></a>00162         }
<a name="l00163"></a>00163     }
<a name="l00164"></a>00164     <span class="keywordflow">else</span> 
<a name="l00165"></a>00165         stream &lt;&lt; <span class="stringliteral">&quot;disabled&quot;</span> &lt;&lt; endl;
<a name="l00166"></a>00166     
<a name="l00167"></a>00167     stream &lt;&lt; <span class="stringliteral">&quot;\tINPUT FILE  : &quot;</span> &lt;&lt; data-&gt;getFilename() &lt;&lt; endl;
<a name="l00168"></a>00168     stream &lt;&lt; <span class="stringliteral">&quot;\tINPUT TYPE  : &quot;</span> &lt;&lt; data-&gt;getTypeString()&lt;&lt; endl;
<a name="l00169"></a>00169     stream &lt;&lt; <span class="stringliteral">&quot;\tOUTPUT      : &quot;</span> &lt;&lt; writer-&gt;getFilename() &lt;&lt; endl;
<a name="l00170"></a>00170     stream &lt;&lt; <span class="stringliteral">&quot;\tOUTPUT TYPE : &quot;</span> &lt;&lt; writer-&gt;getTypeString() &lt;&lt; endl;
<a name="l00171"></a>00171     stream &lt;&lt; <span class="stringliteral">&quot;\tSOURCENAME  : \&quot;&quot;</span> &lt;&lt; header.<a class="code" href="structHeaderRecord.html#abe54c31e39ebf8b8b6e642aa9eb1d33e" title="name of the source">sourcename</a> &lt;&lt; <span class="stringliteral">&quot;\&quot;&quot;</span>&lt;&lt; endl
<a name="l00172"></a>00172            &lt;&lt; <span class="stringliteral">&quot;\tRA          : &quot;</span> &lt;&lt; getHMSString(header.<a class="code" href="structHeaderRecord.html#a2f8307833dbe6f23944903cd21ea78b6" title="ra of run">ra</a>) &lt;&lt;endl
<a name="l00173"></a>00173            &lt;&lt; <span class="stringliteral">&quot;\tDEC         : &quot;</span> &lt;&lt; getDMSString(header.<a class="code" href="structHeaderRecord.html#a85927153a843227a279beac0c4fbd99a" title="dec of run">dec</a>) &lt;&lt;endl
<a name="l00174"></a>00174            &lt;&lt; <span class="stringliteral">&quot;\tSTART TIME  : &quot;</span> &lt;&lt; setprecision(10) 
<a name="l00175"></a>00175            &lt;&lt; header.<a class="code" href="structHeaderRecord.html#ac62dff93f075263fe5b4ba6898821778" title="starting time (MJD)">starttime</a> &lt;&lt; endl
<a name="l00176"></a>00176            &lt;&lt; <span class="stringliteral">&quot;\tPICTURE     : &quot;</span> &lt;&lt; ri.<a class="code" href="classRunInfo.html#ac25ba9471cf4ddbf4e48c8ec9646ece2" title="picture threshold value">picthresh</a> &lt;&lt; endl
<a name="l00177"></a>00177            &lt;&lt; <span class="stringliteral">&quot;\tBOUNDARY    : &quot;</span> &lt;&lt; ri.<a class="code" href="classRunInfo.html#a225661a33c3efe5332083a9372be66a4" title="boundary threshold value">bndthresh</a> &lt;&lt; endl;
<a name="l00178"></a>00178     stream &lt;&lt; <span class="stringliteral">&quot;\tDEROTATION  : &quot;</span>;
<a name="l00179"></a>00179     <span class="keywordflow">if</span>(ri.<a class="code" href="classRunInfo.html#a16057cde5b36b7c77e7ea7549049e540" title="flag to enable derotation">derotation</a>) 
<a name="l00180"></a>00180         stream &lt;&lt; <span class="stringliteral">&quot;enabled&quot;</span> &lt;&lt; endl;
<a name="l00181"></a>00181     <span class="keywordflow">else</span>
<a name="l00182"></a>00182         stream &lt;&lt; <span class="stringliteral">&quot;disabled&quot;</span> &lt;&lt; endl;
<a name="l00183"></a>00183     
<a name="l00184"></a>00184     
<a name="l00185"></a>00185     <span class="keywordtype">int</span> ntel = array.getNumTelescopes();
<a name="l00186"></a>00186     stream &lt;&lt; <span class="stringliteral">&quot;\tTELESCOPES  : &quot;</span> &lt;&lt; ntel &lt;&lt;endl;
<a name="l00187"></a>00187 
<a name="l00188"></a>00188     stream &lt;&lt; <span class="stringliteral">&quot;\tNADC        : &quot;</span>;
<a name="l00189"></a>00189     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;header.<a class="code" href="structHeaderRecord.html#aa5aaa915ec137ce6510c4ed9802dd713" title="number of pixels in each camera">nadc</a>.size(); i++) 
<a name="l00190"></a>00190         stream &lt;&lt;  header.<a class="code" href="structHeaderRecord.html#aa5aaa915ec137ce6510c4ed9802dd713" title="number of pixels in each camera">nadc</a>.at(i) &lt;&lt; <span class="stringliteral">&quot; &quot;</span>;
<a name="l00191"></a>00191     stream &lt;&lt; endl;
<a name="l00192"></a>00192 
<a name="l00193"></a>00193     stream &lt;&lt; <span class="stringliteral">&quot;\tCAMERA ID   : &quot;</span>;
<a name="l00194"></a>00194     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;ntel; i++) 
<a name="l00195"></a>00195         stream &lt;&lt; array.getCamera(i)-&gt;<a class="code" href="classCamera.html#ac105d042bd3d5d7bad73ce3b2d8e7fb6" title="last pixel # to use">getCameraID</a>() &lt;&lt;<span class="stringliteral">&quot; &quot;</span>;
<a name="l00196"></a>00196     stream &lt;&lt; endl;
<a name="l00197"></a>00197 
<a name="l00198"></a>00198 
<a name="l00199"></a>00199     stream &lt;&lt; <span class="stringliteral">&quot;\tPIXELS      : &quot;</span>;
<a name="l00200"></a>00200     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;ntel; i++) 
<a name="l00201"></a>00201         stream &lt;&lt; array.getCamera(i)-&gt;<a class="code" href="classCamera.html#a4f2750f42d18cc49f5aa703466a64268" title="Number of pixels in camera.">getNumPixels</a>() &lt;&lt;<span class="stringliteral">&quot; &quot;</span>;
<a name="l00202"></a>00202     stream &lt;&lt; endl;
<a name="l00203"></a>00203 
<a name="l00204"></a>00204     stream &lt;&lt; <span class="stringliteral">&quot;\tSIGMA_PIX   : &quot;</span>;
<a name="l00205"></a>00205     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;ntel; i++) 
<a name="l00206"></a>00206         stream &lt;&lt; array.getCamera(i)-&gt;<a class="code" href="classCamera.html#aa01bd8754f3f024237a094911c847798" title="Finite pix size dispersion.">getSigmaPixel</a>() &lt;&lt;<span class="stringliteral">&quot; &quot;</span>;
<a name="l00207"></a>00207     stream &lt;&lt; endl;
<a name="l00208"></a>00208 
<a name="l00209"></a>00209     stream &lt;&lt; <span class="stringliteral">&quot;\tPE TO DC    : &quot;</span>;
<a name="l00210"></a>00210     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;ntel; i++) 
<a name="l00211"></a>00211         stream &lt;&lt; array.getCamera(i)-&gt;<a class="code" href="classCamera.html#a80e6c96d875b9d8145b87378beb41b9d" title="pe/dc ratio">getPEToDC</a>() &lt;&lt;<span class="stringliteral">&quot; &quot;</span>;
<a name="l00212"></a>00212     stream &lt;&lt; endl;
<a name="l00213"></a>00213     
<a name="l00214"></a>00214     stream &lt;&lt; <span class="stringliteral">&quot;\tMASKED TUBES: &quot;</span>;
<a name="l00215"></a>00215     vector&lt;int&gt; masked;
<a name="l00216"></a>00216     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;1024; i++) {
<a name="l00217"></a>00217         <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#a8b754c6ff0b16fc81132e60fc4ae5e11" title="bitmask of tubes to turn off manually">tubemask</a>[i] == <span class="keyword">true</span>)
<a name="l00218"></a>00218             masked.push_back(i);
<a name="l00219"></a>00219     }
<a name="l00220"></a>00220     <span class="keywordflow">if</span> (masked.size() &gt;0) {
<a name="l00221"></a>00221         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;(int)(masked.size()); i++)
<a name="l00222"></a>00222             stream &lt;&lt; masked[i] &lt;&lt; <span class="stringliteral">&quot; &quot;</span>;
<a name="l00223"></a>00223     }
<a name="l00224"></a>00224     <span class="keywordflow">else</span> {
<a name="l00225"></a>00225         stream &lt;&lt; <span class="stringliteral">&quot;none&quot;</span>;
<a name="l00226"></a>00226     }
<a name="l00227"></a>00227     stream &lt;&lt; endl;
<a name="l00228"></a>00228 
<a name="l00229"></a>00229     stream &lt;&lt; <span class="stringliteral">&quot;\tCAM OFFSET  : &quot;</span>;
<a name="l00230"></a>00230     <span class="keywordflow">if</span>(ri.<a class="code" href="classRunInfo.html#afc3b0da63379c3f6cc459774145f6765" title="perform parameterization with offset">camera_offset_analysis</a>==<span class="keyword">true</span>) {
<a name="l00231"></a>00231         stream &lt;&lt; ri.camera_offset.<a class="code" href="structCoordinate__t.html#a4e83334eabbe707ae5433ff65f60a475" title="X coordinate.">x</a> &lt;&lt; <span class="stringliteral">&quot; , &quot;</span>&lt;&lt;ri.camera_offset.<a class="code" href="structCoordinate__t.html#abbc494db10b22a87bede79c5b62be604" title="Y coordinate.">y</a>&lt;&lt;endl;
<a name="l00232"></a>00232     }
<a name="l00233"></a>00233     <span class="keywordflow">else</span> {
<a name="l00234"></a>00234         stream &lt;&lt; <span class="stringliteral">&quot;disabled &quot;</span> &lt;&lt; endl;
<a name="l00235"></a>00235     }
<a name="l00236"></a>00236 
<a name="l00237"></a>00237     stream &lt;&lt; <span class="stringliteral">&quot;\tIMAGE FILTER: &quot;</span>;
<a name="l00238"></a>00238     <span class="keywordflow">if</span>(ri.<a class="code" href="classRunInfo.html#a5536266accd3a3aae79224e8db27941d" title="Smooth images during.">image_filter</a>==<span class="keyword">true</span>) {
<a name="l00239"></a>00239         stream &lt;&lt; <span class="stringliteral">&quot;amt=&quot;</span>&lt;&lt;ri.<a class="code" href="classRunInfo.html#a75082b7b3261dccc40a5ea526c91e68b" title="afiltr">filter_amount</a> 
<a name="l00240"></a>00240                &lt;&lt; <span class="stringliteral">&quot; sub=&quot;</span>&lt;&lt;ri.<a class="code" href="classRunInfo.html#a399514a56d3e8aa99d8a84778107f3c7" title="msub">filter_subdivide</a>
<a name="l00241"></a>00241                &lt;&lt; <span class="stringliteral">&quot; pct=&quot;</span>&lt;&lt;ri.filter_percent
<a name="l00242"></a>00242                &lt;&lt; <span class="stringliteral">&quot; thr=&quot;</span>&lt;&lt;ri.<a class="code" href="classRunInfo.html#a28a6b7962b55bfdf725979206e9c86fe" title="Filter picture threshold (in sigma)">filter_threshold</a>
<a name="l00243"></a>00243                &lt;&lt; endl; 
<a name="l00244"></a>00244     }
<a name="l00245"></a>00245     <span class="keywordflow">else</span> {
<a name="l00246"></a>00246         stream &lt;&lt; <span class="stringliteral">&quot; disabled &quot;</span> &lt;&lt; endl;
<a name="l00247"></a>00247     }
<a name="l00248"></a>00248 
<a name="l00249"></a>00249 }
<a name="l00250"></a>00250 
<a name="l00251"></a>00251 
<a name="l00272"></a>00272 <span class="keywordtype">void</span>
<a name="l00273"></a>00273 Parameterizer::
<a name="l00274"></a>00274 processOne(  <a class="code" href="classRunInfo.html" title="Basic structure returned by a Config object.">RunInfo</a> &amp;ri, <span class="keywordtype">string</span> &amp;<span class="keywordtype">id</span> ) {
<a name="l00275"></a>00275 
<a name="l00276"></a>00276     <span class="keyword">register</span> <span class="keywordtype">int</span> i;
<a name="l00277"></a>00277 
<a name="l00278"></a>00278 
<a name="l00279"></a>00279     <a class="code" href="classPedestalFinder.html" title="Class to generate pedestal values for a series of runs.">PedestalFinder</a> ped;
<a name="l00280"></a>00280     <a class="code" href="classGainFinder.html" title="Retrieve or calculate nitrogen gains, given a nitrogen run ID.">GainFinder</a> gf;
<a name="l00281"></a>00281     <a class="code" href="classRawDataReader.html" title="Reads raw telescope data and produces coresponding records...">RawDataReader</a> *data =NULL;
<a name="l00282"></a>00282     <a class="code" href="classParamDataWriter.html" title="Base class for writing HillasParameterizations to disk.">ParamDataWriter</a> *writer=NULL;
<a name="l00283"></a>00283     <a class="code" href="classImageCleaner.html" title="Abstract interface to all cleaning routines.">ImageCleaner</a> *threshcleaner = NULL;
<a name="l00284"></a>00284     <a class="code" href="structHillasParameterization.html" title="Parameterization of an image, produced by the ImageAnalyzer object.">HillasParameterization</a> param;
<a name="l00285"></a>00285     <a class="code" href="structMuonParameterization.html" title="Describes the muon-like characteristics of an image.">MuonParameterization</a> mparam;
<a name="l00286"></a>00286     <a class="code" href="structRawHeaderRecord.html">RawHeaderRecord</a> header;
<a name="l00287"></a>00287     <a class="code" href="structRawEventRecord.html" title="One event from a raw data file.">RawEventRecord</a>  event;
<a name="l00288"></a>00288     Array_t adc;
<a name="l00289"></a>00289     ofstream muonfile;
<a name="l00290"></a>00290     ofstream goodmuons;
<a name="l00291"></a>00291 
<a name="l00292"></a>00292     vector&lt;TelescopeData&gt; tel(1);
<a name="l00293"></a>00293 
<a name="l00294"></a>00294     vector&lt;int&gt; cleanpixels;
<a name="l00295"></a>00295     cleanpixels.reserve(100);
<a name="l00296"></a>00296 
<a name="l00297"></a>00297     <span class="keywordtype">string</span> filename;
<a name="l00298"></a>00298     <span class="keywordtype">string</span> fname;
<a name="l00299"></a>00299     <span class="keywordtype">double</span> start_el;
<a name="l00300"></a>00300 
<a name="l00301"></a>00301     <span class="keywordtype">int</span> datasize=0;
<a name="l00302"></a>00302     <span class="keywordtype">string</span> tempstr;
<a name="l00303"></a>00303     <span class="keywordtype">string</span> answer;
<a name="l00304"></a>00304     <span class="keywordtype">double</span> gpstime_start=0;
<a name="l00305"></a>00305     <span class="keywordtype">double</span> gpstime_last=0;
<a name="l00306"></a>00306     <span class="keywordtype">double</span> deviate;
<a name="l00307"></a>00307     <span class="keywordtype">int</span> dtype;
<a name="l00308"></a>00308     <span class="keywordtype">double</span> zen;
<a name="l00309"></a>00309 
<a name="l00310"></a>00310     <a class="code" href="structSimShowerRecord.html">SimShowerRecord</a> cursimshower;
<a name="l00311"></a>00311 
<a name="l00312"></a>00312     <a class="code" href="classCutFactory.html" title="Responsible for locating files and creating the correct data reader object for the detected file type...">CutFactory</a> *cutfactory = <a class="code" href="classCutFactory.html#a457083853ded569db341d1b8603e021c" title="Returns pointer to the global CutFactory instance.">CutFactory::instance</a>();
<a name="l00313"></a>00313     <a class="code" href="classSuperCutter.html" title="Applies SuperCuts to a given HillasParameterization.">SuperCutter</a> *cutter;
<a name="l00314"></a>00314     cutter = cutfactory-&gt;newCutter( ri );    
<a name="l00315"></a>00315     cutter-&gt;setCuts( ri.<a class="code" href="classRunInfo.html#ae9dfa75fa8232187d96bb0e66d57b963" title="How this file should be cut.">cuts</a> );
<a name="l00316"></a>00316 
<a name="l00317"></a>00317     <a class="code" href="classLogger.html" title="Error log singleton.">Logger</a> *logger = Logger::instance();
<a name="l00318"></a>00318 
<a name="l00319"></a>00319     <span class="comment">// for interactive mode:</span>
<a name="l00320"></a>00320     <span class="keywordtype">bool</span> interactive_cuts=<span class="keyword">false</span>;
<a name="l00321"></a>00321     <span class="keywordtype">bool</span> interactive_triplet_centers=<span class="keyword">false</span>;
<a name="l00322"></a>00322     <span class="keywordtype">bool</span> interactive_hold=<span class="keyword">false</span>;
<a name="l00323"></a>00323     <span class="keywordtype">bool</span> interactive_muon=<span class="keyword">false</span>;
<a name="l00324"></a>00324     <span class="keywordtype">bool</span> interactive_rotate=<span class="keyword">false</span>;
<a name="l00325"></a>00325     <span class="keywordtype">bool</span> interactive_correct=<span class="keyword">true</span>;
<a name="l00326"></a>00326     <span class="keywordtype">bool</span> interactive_clean = <span class="keyword">true</span>;
<a name="l00327"></a>00327     <span class="keywordtype">bool</span> interactive_params = <span class="keyword">true</span>;
<a name="l00328"></a>00328     PlotMaker::CameraPlotType interactive_disptype=PlotMaker::CAMERA_IMAGE;
<a name="l00329"></a>00329 
<a name="l00330"></a>00330     <span class="keywordtype">int</span> ison;
<a name="l00331"></a>00331     <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#a75fe835214afa525cc0a5bced31cbe57" title="id of on/tracking run">onid</a> == <span class="keywordtype">id</span>) ison = 1;
<a name="l00332"></a>00332     <span class="keywordflow">else</span> ison=0;
<a name="l00333"></a>00333 
<a name="l00334"></a>00334     <span class="comment">// DEBUGGING: write out raw data</span>
<a name="l00335"></a>00335 <span class="comment">//     ofstream rawfile( string(id+&quot;-rawdata.txt&quot;).c_str() );</span>
<a name="l00336"></a>00336     
<a name="l00337"></a>00337     
<a name="l00338"></a>00338     <span class="comment">//=========================================================================</span>
<a name="l00339"></a>00339     <span class="comment">// Set up output directory:</span>
<a name="l00340"></a>00340 
<a name="l00341"></a>00341     <span class="keywordtype">string</span> dir = <span class="keywordtype">id</span> + <span class="stringliteral">&quot;/&quot;</span>;
<a name="l00342"></a>00342     <span class="keywordflow">if</span> (mkdir(dir.c_str(), S_IRUSR | S_IWUSR | S_IXUSR | S_IXGRP | S_IRGRP )) {
<a name="l00343"></a>00343         <span class="keywordflow">if</span> (errno != EEXIST) {
<a name="l00344"></a>00344             perror(<span class="stringliteral">&quot;mkdir&quot;</span>);
<a name="l00345"></a>00345             <span class="keywordflow">throw</span> <a class="code" href="classCriticalAnalysisException.html" title="Thrown on errors in the analysis where the program cannot recover.">CriticalAnalysisException</a>(<span class="stringliteral">&quot;Couldn&#39;t create output directory!&quot;</span>);
<a name="l00346"></a>00346         }
<a name="l00347"></a>00347     }
<a name="l00348"></a>00348 
<a name="l00349"></a>00349     <span class="comment">//=========================================================================</span>
<a name="l00350"></a>00350     <span class="comment">// Open the output files:</span>
<a name="l00351"></a>00351 
<a name="l00352"></a>00352     <span class="keywordflow">try</span> {
<a name="l00353"></a>00353 
<a name="l00354"></a>00354         <span class="keywordflow">switch</span> ( ri.<a class="code" href="classRunInfo.html#ab14a9c15485b7aa14bd5aa99f88d2dcf" title="(see Config::OutType)">outtype</a> ) {
<a name="l00355"></a>00355           <span class="keywordflow">case</span> Config::NTUPLE:
<a name="l00356"></a>00356               writer = <span class="keyword">new</span> <a class="code" href="classParamDataWriterNtuple.html" title="Outputs parameterized events to an N-Tuple (for use in for example, PAW).">ParamDataWriterNtuple</a>( dir+<span class="keywordtype">id</span>+<span class="stringliteral">&quot;-param.ntuple&quot;</span>,
<a name="l00357"></a>00357                                                   _is_overwrite_enabled);
<a name="l00358"></a>00358               <span class="keywordflow">break</span>;
<a name="l00359"></a>00359           <span class="keywordflow">case</span> Config::TEXT:
<a name="l00360"></a>00360               writer = <span class="keyword">new</span> <a class="code" href="classParamDataWriterText.html" title="Outputs parameterized events to a text file.">ParamDataWriterText</a>( dir+<span class="keywordtype">id</span>+<span class="stringliteral">&quot;-param.txt&quot;</span>,
<a name="l00361"></a>00361                                                 _is_overwrite_enabled );
<a name="l00362"></a>00362               <span class="keywordflow">break</span>;
<a name="l00363"></a>00363         }
<a name="l00364"></a>00364 
<a name="l00365"></a>00365         <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#a4bdb5240f8897d53b71ea7bb1beb1393" title="flag to enable muon calibration">muoncalibrate</a>) {
<a name="l00366"></a>00366             
<a name="l00367"></a>00367             <span class="keywordtype">string</span> muonfilename = dir+<span class="keywordtype">id</span>+<span class="stringliteral">&quot;-muons.txt&quot;</span>;
<a name="l00368"></a>00368             muonfile.open( muonfilename.c_str() );
<a name="l00369"></a>00369 
<a name="l00370"></a>00370             muonfilename = dir+<span class="keywordtype">id</span>+<span class="stringliteral">&quot;-goodmuons.txt&quot;</span>;
<a name="l00371"></a>00371             goodmuons.open( muonfilename.c_str() );
<a name="l00372"></a>00372 
<a name="l00373"></a>00373         }
<a name="l00374"></a>00374 
<a name="l00375"></a>00375 
<a name="l00376"></a>00376     }
<a name="l00377"></a>00377     <span class="keywordflow">catch</span> (<a class="code" href="classMildAnalysisException.html" title="Thrown for warnings and recoverable errors.">MildAnalysisException</a> &amp;e) {
<a name="l00378"></a>00378         cerr &lt;&lt; <span class="stringliteral">&quot;Skipping run since &quot;</span>&lt;&lt;e.what() &lt;&lt; endl;
<a name="l00379"></a>00379         <span class="keywordflow">return</span>;
<a name="l00380"></a>00380     }
<a name="l00381"></a>00381 
<a name="l00382"></a>00382     <span class="comment">//=========================================================================</span>
<a name="l00383"></a>00383     <span class="comment">// Open the input file:</span>
<a name="l00384"></a>00384 
<a name="l00385"></a>00385 
<a name="l00386"></a>00386     <a class="code" href="classRawDataReaderFactory.html" title="Responsible for locating files and creating the correct data reader object for the detected file type...">RawDataReaderFactory</a> *datafactory = <a class="code" href="classRawDataReaderFactory.html#a31ce95b89ad844dfc81a9157ef6ba4e7" title="Returns pointer to the global RawDataReaderFactory instance.">RawDataReaderFactory::instance</a>();
<a name="l00387"></a>00387     
<a name="l00388"></a>00388     <span class="keywordflow">try</span> {
<a name="l00389"></a>00389 
<a name="l00390"></a>00390         data = datafactory-&gt;<a class="code" href="classRawDataReaderFactory.html#ad71f80e5d4c526804c7feedec2368f83" title="Returns a pointer to a data reader for the given id.">getReader</a>( ri, <span class="keywordtype">id</span> );
<a name="l00391"></a>00391 
<a name="l00392"></a>00392     }
<a name="l00393"></a>00393     <span class="keywordflow">catch</span> (<a class="code" href="classAnalysisException.html" title="Standard exception thrown by analysis routines.">AnalysisException</a> &amp;e) {
<a name="l00394"></a>00394         <span class="keyword">delete</span> data;
<a name="l00395"></a>00395         <span class="keywordflow">throw</span> (e);
<a name="l00396"></a>00396     } 
<a name="l00397"></a>00397 
<a name="l00398"></a>00398     dtype = data-&gt;getType();
<a name="l00399"></a>00399     
<a name="l00400"></a>00400     <span class="comment">//=========================================================================</span>
<a name="l00401"></a>00401     <span class="comment">// Get some information: </span>
<a name="l00402"></a>00402 
<a name="l00403"></a>00403     datasize = data-&gt;size();
<a name="l00404"></a>00404     <span class="keywordflow">if</span> (datasize == 0) {
<a name="l00405"></a>00405         <span class="keyword">delete</span> data;
<a name="l00406"></a>00406         <span class="keywordflow">throw</span> <a class="code" href="classAnalysisException.html" title="Standard exception thrown by analysis routines.">AnalysisException</a>(<span class="stringliteral">&quot;There is no data in &quot;</span>+<span class="keywordtype">id</span>
<a name="l00407"></a>00407                                 +<span class="stringliteral">&quot;! Check that the file is not corrupt, &quot;</span>
<a name="l00408"></a>00408                                 +<span class="stringliteral">&quot;or remove it from the conf file&quot;</span>);
<a name="l00409"></a>00409     }
<a name="l00410"></a>00410 
<a name="l00411"></a>00411 
<a name="l00412"></a>00412     
<a name="l00413"></a>00413     <span class="comment">// fetch the header from the data</span>
<a name="l00414"></a>00414 
<a name="l00415"></a>00415     data-&gt;getHeaderRecord( header );
<a name="l00416"></a>00416 
<a name="l00417"></a>00417     cout &lt;&lt; <span class="stringliteral">&quot;DEBUG: header.nadc.size() = &quot;</span>&lt;&lt;header.<a class="code" href="structHeaderRecord.html#aa5aaa915ec137ce6510c4ed9802dd713" title="number of pixels in each camera">nadc</a>.size()&lt;&lt;endl;
<a name="l00418"></a>00418 
<a name="l00419"></a>00419     <span class="comment">// Fill in unknown values from data file  and check for misinformation:</span>
<a name="l00420"></a>00420 
<a name="l00421"></a>00421     removeWhiteSpace(header.<a class="code" href="structHeaderRecord.html#abe54c31e39ebf8b8b6e642aa9eb1d33e" title="name of the source">sourcename</a>);
<a name="l00422"></a>00422     removeWhiteSpace(ri.<a class="code" href="classRunInfo.html#a3910f7bc30936f0f0a5ffa5c46e74ca7" title="name of source">sourcename</a>);
<a name="l00423"></a>00423     transform( header.<a class="code" href="structHeaderRecord.html#abe54c31e39ebf8b8b6e642aa9eb1d33e" title="name of the source">sourcename</a>.begin(),header.<a class="code" href="structHeaderRecord.html#abe54c31e39ebf8b8b6e642aa9eb1d33e" title="name of the source">sourcename</a>.end(), 
<a name="l00424"></a>00424                header.<a class="code" href="structHeaderRecord.html#abe54c31e39ebf8b8b6e642aa9eb1d33e" title="name of the source">sourcename</a>.begin(), (int(*)(int))tolower);
<a name="l00425"></a>00425 
<a name="l00426"></a>00426     <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#a3910f7bc30936f0f0a5ffa5c46e74ca7" title="name of source">sourcename</a> != <span class="stringliteral">&quot;&quot;</span>) {
<a name="l00427"></a>00427         <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#a3910f7bc30936f0f0a5ffa5c46e74ca7" title="name of source">sourcename</a> != header.<a class="code" href="structHeaderRecord.html#abe54c31e39ebf8b8b6e642aa9eb1d33e" title="name of the source">sourcename</a>) {
<a name="l00428"></a>00428             logger-&gt;<a class="code" href="classLogger.html#a97d14a6dbc7c4490cbe590a0925bc42d" title="Writes warning string to the log and to stdout.">printf</a>(<span class="stringliteral">&quot;Sourcename may be bad for &#39;%s&#39;: conf says &#39;%s&#39;, &quot;</span>
<a name="l00429"></a>00429                            <span class="stringliteral">&quot;data says &#39;%s&#39;&quot;</span>, <span class="keywordtype">id</span>.c_str(),
<a name="l00430"></a>00430                            ri.<a class="code" href="classRunInfo.html#a3910f7bc30936f0f0a5ffa5c46e74ca7" title="name of source">sourcename</a>.c_str(), header.<a class="code" href="structHeaderRecord.html#abe54c31e39ebf8b8b6e642aa9eb1d33e" title="name of the source">sourcename</a>.c_str() );
<a name="l00431"></a>00431             
<a name="l00432"></a>00432         }
<a name="l00433"></a>00433         header.<a class="code" href="structHeaderRecord.html#abe54c31e39ebf8b8b6e642aa9eb1d33e" title="name of the source">sourcename</a> = ri.<a class="code" href="classRunInfo.html#a3910f7bc30936f0f0a5ffa5c46e74ca7" title="name of source">sourcename</a>;
<a name="l00434"></a>00434     }
<a name="l00435"></a>00435 
<a name="l00436"></a>00436     <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#ad1332c18766a891c9e94cacb70c0a634" title="override value source RA">ra</a> != 0.0)  {        <span class="comment">// if there&#39;s an ra override</span>
<a name="l00437"></a>00437         <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#ad1332c18766a891c9e94cacb70c0a634" title="override value source RA">ra</a> != header.<a class="code" href="structHeaderRecord.html#a2f8307833dbe6f23944903cd21ea78b6" title="ra of run">ra</a>) {
<a name="l00438"></a>00438             logger-&gt;<a class="code" href="classLogger.html#a97d14a6dbc7c4490cbe590a0925bc42d" title="Writes warning string to the log and to stdout.">printf</a>(<span class="stringliteral">&quot;RA may be incorrect for &#39;%s&#39;: conf says &#39;%f&#39;,&quot;</span>
<a name="l00439"></a>00439                            <span class="stringliteral">&quot; data says &#39;%f&#39;&quot;</span>,
<a name="l00440"></a>00440                            <span class="keywordtype">id</span>.c_str(), ri.<a class="code" href="classRunInfo.html#ad1332c18766a891c9e94cacb70c0a634" title="override value source RA">ra</a>, header.<a class="code" href="structHeaderRecord.html#a2f8307833dbe6f23944903cd21ea78b6" title="ra of run">ra</a>);           
<a name="l00441"></a>00441             logger-&gt;<a class="code" href="classLogger.html#a97d14a6dbc7c4490cbe590a0925bc42d" title="Writes warning string to the log and to stdout.">printf</a>(<span class="stringliteral">&quot;RA Override currently assumes ON before OFF &quot;</span>
<a name="l00442"></a>00442                           <span class="stringliteral">&quot;and 30minute offset&quot;</span>);
<a name="l00443"></a>00443         }
<a name="l00444"></a>00444         <span class="keywordflow">if</span> ( <span class="keywordtype">id</span> == ri.<a class="code" href="classRunInfo.html#adc491683f873f002dcfa423f6d0f5bb2" title="id of off run for padding">offid</a>) 
<a name="l00445"></a>00445             header.<a class="code" href="structHeaderRecord.html#a2f8307833dbe6f23944903cd21ea78b6" title="ra of run">ra</a> = ri.<a class="code" href="classRunInfo.html#ad1332c18766a891c9e94cacb70c0a634" title="override value source RA">ra</a> + (30*((M_PI/12.0)/60.0));  <span class="comment">// offset 30 minutes</span>
<a name="l00446"></a>00446         <span class="keywordflow">else</span>
<a name="l00447"></a>00447             header.<a class="code" href="structHeaderRecord.html#a2f8307833dbe6f23944903cd21ea78b6" title="ra of run">ra</a>   = ri.<a class="code" href="classRunInfo.html#ad1332c18766a891c9e94cacb70c0a634" title="override value source RA">ra</a>;
<a name="l00448"></a>00448     }
<a name="l00449"></a>00449     <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#a8540d80a23f779c35c2d55b569562f65" title="override value source declination">dec</a> != 0.0) {        <span class="comment">// if there is a dec override</span>
<a name="l00450"></a>00450         <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#a8540d80a23f779c35c2d55b569562f65" title="override value source declination">dec</a> != header.<a class="code" href="structHeaderRecord.html#a85927153a843227a279beac0c4fbd99a" title="dec of run">dec</a>) {
<a name="l00451"></a>00451             logger-&gt;<a class="code" href="classLogger.html#a97d14a6dbc7c4490cbe590a0925bc42d" title="Writes warning string to the log and to stdout.">printf</a>( <span class="stringliteral">&quot;DEC may be incorrect for %s: &quot;</span>
<a name="l00452"></a>00452                             <span class="stringliteral">&quot;conf says &#39;%f&#39;, data says &#39;%f&#39;&quot;</span>, 
<a name="l00453"></a>00453                             <span class="keywordtype">id</span>.c_str(), ri.<a class="code" href="classRunInfo.html#a8540d80a23f779c35c2d55b569562f65" title="override value source declination">dec</a>, header.<a class="code" href="structHeaderRecord.html#a85927153a843227a279beac0c4fbd99a" title="dec of run">dec</a>);
<a name="l00454"></a>00454         }
<a name="l00455"></a>00455         header.<a class="code" href="structHeaderRecord.html#a85927153a843227a279beac0c4fbd99a" title="dec of run">dec</a>  = ri.<a class="code" href="classRunInfo.html#a8540d80a23f779c35c2d55b569562f65" title="override value source declination">dec</a>;
<a name="l00456"></a>00456     }
<a name="l00457"></a>00457     <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#a80bc9fd9b345c07cad754210d744eb4e" title="override for number of tubes">ntubes</a> != 0)      header.<a class="code" href="structHeaderRecord.html#aa5aaa915ec137ce6510c4ed9802dd713" title="number of pixels in each camera">nadc</a>[0] = ri.<a class="code" href="classRunInfo.html#a80bc9fd9b345c07cad754210d744eb4e" title="override for number of tubes">ntubes</a>;
<a name="l00458"></a>00458 
<a name="l00459"></a>00459     <span class="comment">// warn if ra and dec are 0 (usually means there was a problem with</span>
<a name="l00460"></a>00460     <span class="comment">// the tracking computer when the run was being taken:</span>
<a name="l00461"></a>00461 
<a name="l00462"></a>00462     <span class="keywordflow">if</span> (header.<a class="code" href="structHeaderRecord.html#a2f8307833dbe6f23944903cd21ea78b6" title="ra of run">ra</a>==0 &amp;&amp; header.<a class="code" href="structHeaderRecord.html#a85927153a843227a279beac0c4fbd99a" title="dec of run">dec</a>==0) {
<a name="l00463"></a>00463         logger-&gt;<a class="code" href="classLogger.html#a97d14a6dbc7c4490cbe590a0925bc42d" title="Writes warning string to the log and to stdout.">printf</a>(<span class="stringliteral">&quot;RA and Dec are 0 for %s! &quot;</span>
<a name="l00464"></a>00464                        <span class="stringliteral">&quot;Maybe you need to specify them?&quot;</span>, <span class="keywordtype">id</span>.c_str());
<a name="l00465"></a>00465     } 
<a name="l00466"></a>00466 
<a name="l00467"></a>00467     <span class="comment">// set up progress bar</span>
<a name="l00468"></a>00468 
<a name="l00469"></a>00469     <a class="code" href="classProgressBar.html" title="Displays a text-based progress bar with estimated time to finish for a particular task...">ProgressBar</a> progress( datasize,<span class="keywordtype">id</span> );
<a name="l00470"></a>00470 
<a name="l00471"></a>00471     <span class="comment">//=========================================================================</span>
<a name="l00472"></a>00472     <span class="comment">// Now that the header has been loaded, we can get the array</span>
<a name="l00473"></a>00473     <span class="comment">// information.  The array object will automatically load the</span>
<a name="l00474"></a>00474     <span class="comment">// correct cameras.  Right now, there&#39;s just one &quot;nadc&quot; value</span>
<a name="l00475"></a>00475     <span class="comment">// stored in the header, so I assume all cameras are the same.</span>
<a name="l00476"></a>00476     <span class="comment">// Eventually, there needs to be a mechanism to detect different</span>
<a name="l00477"></a>00477     <span class="comment">// cameras in the data. In principle, there&#39;s no reason that there</span>
<a name="l00478"></a>00478     <span class="comment">// can&#39;t be mixed cameras.</span>
<a name="l00479"></a>00479 
<a name="l00480"></a>00480     <a class="code" href="classTelescopeArray.html" title="Stores information for an array of telescopes, including Camera objects.">TelescopeArray</a> array(ri.<a class="code" href="classRunInfo.html#a90970312ece33b627b1f3aee3776b61b" title="name of array config file">arrayconfig</a>, 
<a name="l00481"></a>00481                          header.<a class="code" href="structHeaderRecord.html#aa5aaa915ec137ce6510c4ed9802dd713" title="number of pixels in each camera">nadc</a>, atoi(ri.<a class="code" href="classRunInfo.html#a01b54d7d93bb39aa3eefaf1bc80e82c2" title="UT date.">utdate</a>.c_str()) );
<a name="l00482"></a>00482 
<a name="l00483"></a>00483     <span class="keywordtype">int</span> numtel = array.getNumTelescopes();
<a name="l00484"></a>00484     <span class="keywordtype">int</span> curtel = 0; <span class="comment">// current telescope</span>
<a name="l00485"></a>00485 
<a name="l00486"></a>00486     tel.resize(array.getNumTelescopes());
<a name="l00487"></a>00487 
<a name="l00488"></a>00488     <span class="comment">// KPK: NOTE: header.nadc[k] is the number of adc values that the data</span>
<a name="l00489"></a>00489     <span class="comment">// file is reporting while array.getCamera(k)-&gt;getNumPixels() is</span>
<a name="l00490"></a>00490     <span class="comment">// the number of pixels in the camera according to the camera</span>
<a name="l00491"></a>00491     <span class="comment">// definition file.  These numbers really should be the same, but</span>
<a name="l00492"></a>00492     <span class="comment">// in some cases there nadc is larger than numPixels when extra</span>
<a name="l00493"></a>00493     <span class="comment">// adc channels are installed on the telescope for monitoring</span>
<a name="l00494"></a>00494     <span class="comment">// other data. Hopefully, I&#39;ve used the correct one in each case</span>
<a name="l00495"></a>00495     <span class="comment">// to resize arrays, but if not it may cause things to crash in</span>
<a name="l00496"></a>00496     <span class="comment">// certain circumstances.</span>
<a name="l00497"></a>00497 
<a name="l00498"></a>00498 
<a name="l00499"></a>00499     <span class="keywordflow">if</span> (numtel != header.<a class="code" href="structHeaderRecord.html#a39755fe6ecf64facbd51589bcb66d451" title="number of telescopes in the array">num_telescopes</a>) 
<a name="l00500"></a>00500         logger-&gt;<a class="code" href="classLogger.html#a97d14a6dbc7c4490cbe590a0925bc42d" title="Writes warning string to the log and to stdout.">printf</a>( <span class="stringliteral">&quot;The data file (%s) contains %d telescopes, while &quot;</span>
<a name="l00501"></a>00501                         <span class="stringliteral">&quot;the array config (%s) specifies %d. &quot;</span>
<a name="l00502"></a>00502                         <span class="stringliteral">&quot;Are you sure you are using the correct array &quot;</span>
<a name="l00503"></a>00503                         <span class="stringliteral">&quot;configuration?&quot;</span>, 
<a name="l00504"></a>00504                         <span class="keywordtype">id</span>.c_str(), header.<a class="code" href="structHeaderRecord.html#a39755fe6ecf64facbd51589bcb66d451" title="number of telescopes in the array">num_telescopes</a>, 
<a name="l00505"></a>00505                         ri.<a class="code" href="classRunInfo.html#a90970312ece33b627b1f3aee3776b61b" title="name of array config file">arrayconfig</a>.c_str(), numtel);
<a name="l00506"></a>00506 
<a name="l00507"></a>00507 
<a name="l00508"></a>00508     <span class="comment">//=========================================================================</span>
<a name="l00509"></a>00509     <span class="comment">// Fetch the pedestal/gain information for each telescope in the array</span>
<a name="l00510"></a>00510 
<a name="l00511"></a>00511     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel; k++) {
<a name="l00512"></a>00512 
<a name="l00513"></a>00513         ped.<a class="code" href="classPedestalFinder.html#a2f74e3e8ba1b0531f69949adb46d0657" title="Returns the pedestal values as an array of Pedestal structs.">getPeds</a>( ri, <span class="keywordtype">id</span>, tel[k].peds, k );
<a name="l00514"></a>00514         gf.<a class="code" href="classGainFinder.html#a093922ed07e211199e2e3afdc4b6b2d4" title="Fetch the gains for the specified nitrogen run.">getGains</a>( ri, tel[k].gains, k );
<a name="l00515"></a>00515     
<a name="l00516"></a>00516         <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#aaf1aeb4420afcc27e4b1bbd684329fc5" title="type of run (on/off vs tracking)">type</a> == Config::ONOFF) {
<a name="l00517"></a>00517             <span class="keywordflow">if</span> (ison) 
<a name="l00518"></a>00518                 ped.getOffSourcePeds( ri, tel[k].padpeds,k );
<a name="l00519"></a>00519             <span class="keywordflow">else</span> 
<a name="l00520"></a>00520                 ped.getOnSourcePeds( ri, tel[k].padpeds,k );
<a name="l00521"></a>00521         }
<a name="l00522"></a>00522         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#aaf1aeb4420afcc27e4b1bbd684329fc5" title="type of run (on/off vs tracking)">type</a> == Config::TRACK &amp;&amp; ri.<a class="code" href="classRunInfo.html#a2fb22fc388c3892c01a9939d5034420b" title="flag to enable real padding for track runs">pad_track_with_run</a>==<span class="keyword">true</span>) {
<a name="l00523"></a>00523             ped.getOffSourcePeds( ri, tel[k].padpeds,k );
<a name="l00524"></a>00524         }
<a name="l00525"></a>00525         
<a name="l00526"></a>00526     
<a name="l00527"></a>00527 
<a name="l00528"></a>00528         <span class="comment">// Pad to fixed value if a tracking run and no padding run is specfied</span>
<a name="l00529"></a>00529         <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#a169dac601c7f6f1be162e95faf0aa83a" title="flag to enable padding">padding</a> == <span class="keyword">true</span> &amp;&amp; ri.<a class="code" href="classRunInfo.html#aaf1aeb4420afcc27e4b1bbd684329fc5" title="type of run (on/off vs tracking)">type</a> == Config::TRACK 
<a name="l00530"></a>00530             &amp;&amp; ri.<a class="code" href="classRunInfo.html#a2fb22fc388c3892c01a9939d5034420b" title="flag to enable real padding for track runs">pad_track_with_run</a> == <span class="keyword">false</span>) {
<a name="l00531"></a>00531             
<a name="l00532"></a>00532             tel[k].padpeds.resize( tel[k].peds.size() );
<a name="l00533"></a>00533             <span class="keywordflow">for</span> (i=0; i&lt;(int)(tel[k].padpeds.size()); i++) {
<a name="l00534"></a>00534                 tel[k].padpeds[i].dispersion = ri.<a class="code" href="classRunInfo.html#a3b3285030501c689d84a3dd6d04feaa0" title="pedvar to pad to if there is no off run">padlevel</a>;
<a name="l00535"></a>00535                 tel[k].padpeds[i].pedestal = 0;
<a name="l00536"></a>00536             }
<a name="l00537"></a>00537         }
<a name="l00538"></a>00538 
<a name="l00539"></a>00539     }
<a name="l00540"></a>00540 
<a name="l00541"></a>00541 
<a name="l00542"></a>00542 
<a name="l00543"></a>00543 
<a name="l00544"></a>00544     <span class="comment">//=========================================================================</span>
<a name="l00545"></a>00545     <span class="comment">//  HillasImageAnalyzer, ImageCleaner, etc.</span>
<a name="l00546"></a>00546 
<a name="l00547"></a>00547     <a class="code" href="classCamera.html" title="Contains all operations pertaining to camera data.">Camera</a> *curcam = array.getCamera(0);
<a name="l00548"></a>00548 
<a name="l00549"></a>00549     <span class="comment">// if the user requests analysis centered around a position other</span>
<a name="l00550"></a>00550     <span class="comment">// than 0,0, we need to shift the point of origin of the camera before</span>
<a name="l00551"></a>00551     <span class="comment">// parameterization:</span>
<a name="l00552"></a>00552 
<a name="l00553"></a>00553     <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#afc3b0da63379c3f6cc459774145f6765" title="perform parameterization with offset">camera_offset_analysis</a> == <span class="keyword">true</span>) {
<a name="l00554"></a>00554         
<a name="l00555"></a>00555         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel; k++) {
<a name="l00556"></a>00556             array.getCamera(k)-&gt;<a class="code" href="classCamera.html#a9b60c76986e0da3dd1a5f5764d718faa" title="translate the camera coordinates by the specified amount.">shiftCameraCoordinates</a>( ri.camera_offset.<a class="code" href="structCoordinate__t.html#a4e83334eabbe707ae5433ff65f60a475" title="X coordinate.">x</a>, 
<a name="l00557"></a>00557                                                         ri.camera_offset.<a class="code" href="structCoordinate__t.html#abbc494db10b22a87bede79c5b62be604" title="Y coordinate.">y</a> );
<a name="l00558"></a>00558         }
<a name="l00559"></a>00559     }
<a name="l00560"></a>00560 
<a name="l00561"></a>00561     
<a name="l00562"></a>00562     <span class="comment">// stuff for high-resolution camera generated by the ImageFilter routines</span>
<a name="l00563"></a>00563     <span class="comment">// right now, image filtering is only implemented for a single telescope.</span>
<a name="l00564"></a>00564     <a class="code" href="classCamera.html" title="Contains all operations pertaining to camera data.">Camera</a>* hires_cam=NULL;
<a name="l00565"></a>00565     Array_t hires_x,hires_y, hires_adc;
<a name="l00566"></a>00566     Array_t camrotx(curcam-&gt;<a class="code" href="classCamera.html#a8a4b74941bc6cfcd97ec1b135f6fec09" title="Array of x coordinates.">xCoords</a>());
<a name="l00567"></a>00567     Array_t camroty(curcam-&gt;<a class="code" href="classCamera.html#af2892e20c0a16ae802fcd8cc454bf59d" title="Array of y coordinates.">yCoords</a>());
<a name="l00568"></a>00568     vector&lt;Pedestal&gt; hires_peds;
<a name="l00569"></a>00569     <span class="keywordtype">double</span> s_max;
<a name="l00570"></a>00570     vector&lt;int&gt; hires_cleanpixels;
<a name="l00571"></a>00571     hires_cleanpixels.reserve(500);
<a name="l00572"></a>00572     
<a name="l00573"></a>00573     <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#a5536266accd3a3aae79224e8db27941d" title="Smooth images during.">image_filter</a> == <span class="keyword">true</span>) {
<a name="l00574"></a>00574         <span class="comment">// for image filter method, set up the analyzer to use the</span>
<a name="l00575"></a>00575         <span class="comment">// high-res version of camera generated by the filter program.</span>
<a name="l00576"></a>00576 
<a name="l00577"></a>00577         <span class="comment">// de-rotate the camera (must be aligned with axis):</span>
<a name="l00578"></a>00578         
<a name="l00579"></a>00579         <span class="keywordtype">double</span> angl = atan2( camroty[1]-camroty[0],camrotx[1]-camrotx[0] );
<a name="l00580"></a>00580         <a class="code" href="structCoordinate__t.html" title="A 2-d coordinate.">Coordinate_t</a> pt;
<a name="l00581"></a>00581 
<a name="l00582"></a>00582         <span class="keywordflow">if</span> (angl&gt;M_PI/2.0) angl = -(M_PI - angl);
<a name="l00583"></a>00583 
<a name="l00584"></a>00584         cout &lt;&lt; <span class="stringliteral">&quot;ImageFilter: De-rotating the camera by &quot;</span>&lt;&lt;angl*180.0/M_PI
<a name="l00585"></a>00585              &lt;&lt;<span class="stringliteral">&quot; degrees&quot;</span>&lt;&lt;endl;
<a name="l00586"></a>00586 
<a name="l00587"></a>00587 
<a name="l00588"></a>00588         <span class="keywordflow">for</span> (i=0; i&lt;camrotx.size(); i++) {
<a name="l00589"></a>00589             pt.<a class="code" href="structCoordinate__t.html#a4e83334eabbe707ae5433ff65f60a475" title="X coordinate.">x</a> = camrotx[i];
<a name="l00590"></a>00590             pt.<a class="code" href="structCoordinate__t.html#abbc494db10b22a87bede79c5b62be604" title="Y coordinate.">y</a> = camroty[i];
<a name="l00591"></a>00591             derotatePoint( angl, pt );
<a name="l00592"></a>00592             camrotx[i] = pt.<a class="code" href="structCoordinate__t.html#a4e83334eabbe707ae5433ff65f60a475" title="X coordinate.">x</a>;
<a name="l00593"></a>00593             camroty[i] = pt.<a class="code" href="structCoordinate__t.html#abbc494db10b22a87bede79c5b62be604" title="Y coordinate.">y</a>;
<a name="l00594"></a>00594         }
<a name="l00595"></a>00595         
<a name="l00596"></a>00596         filter_init( curcam-&gt;<a class="code" href="classCamera.html#a233576d02d136e96d8886627c2512afc" title="first pixel # to use">getLastPixel</a>()+1, <span class="comment">// actual number of pixels</span>
<a name="l00597"></a>00597                      camrotx, camroty, 
<a name="l00598"></a>00598                      hires_x, hires_y, 
<a name="l00599"></a>00599                      ri.<a class="code" href="classRunInfo.html#a399514a56d3e8aa99d8a84778107f3c7" title="msub">filter_subdivide</a>,  <span class="comment">// msub</span>
<a name="l00600"></a>00600                      ri.<a class="code" href="classRunInfo.html#a75082b7b3261dccc40a5ea526c91e68b" title="afiltr">filter_amount</a>, <span class="comment">// afilter </span>
<a name="l00601"></a>00601                      ri.<a class="code" href="classRunInfo.html#a6281a9efb704753b56516bd7b3ac300f" title="iterations for derivative calculation">filter_iter</a>, <span class="comment">// nc</span>
<a name="l00602"></a>00602                      ri.<a class="code" href="classRunInfo.html#a22c87862666b62fe0ef8730b2ccecdc2" title="spas">filter_smoothness</a>);  <span class="comment">//spas );</span>
<a name="l00603"></a>00603 
<a name="l00604"></a>00604         hires_cam = <span class="keyword">new</span> <a class="code" href="classCamera.html" title="Contains all operations pertaining to camera data.">Camera</a>( hires_x.size(), hires_x, hires_y );
<a name="l00605"></a>00605         tel[0].analyzer = <span class="keyword">new</span> <a class="code" href="classHillasImageAnalyzer.html" title="Calculates the Hillas parameters and 2D point of origin of a cleaned image.">HillasImageAnalyzer</a>( hires_cam );
<a name="l00606"></a>00606 
<a name="l00607"></a>00607         hires_peds.resize(hires_x.size());
<a name="l00608"></a>00608         <span class="keywordflow">for</span> ( i=0; i&lt;hires_peds.size();i++){
<a name="l00609"></a>00609             hires_peds[i].pedestal=0.0;
<a name="l00610"></a>00610             hires_peds[i].dispersion=0.0;
<a name="l00611"></a>00611         }
<a name="l00612"></a>00612     }
<a name="l00613"></a>00613     <span class="keywordflow">else</span> {
<a name="l00614"></a>00614         <span class="comment">//  standard method: set up analyzer to use the camera</span>
<a name="l00615"></a>00615         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel; k++) {
<a name="l00616"></a>00616             tel[k].analyzer = <span class="keyword">new</span> <a class="code" href="classHillasImageAnalyzer.html" title="Calculates the Hillas parameters and 2D point of origin of a cleaned image.">HillasImageAnalyzer</a>( array.getCamera(k) );
<a name="l00617"></a>00617         }
<a name="l00618"></a>00618     }  
<a name="l00619"></a>00619 
<a name="l00620"></a>00620     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel; k++) {
<a name="l00621"></a>00621         tel[k].muonanalyzer = <span class="keyword">new</span> <a class="code" href="classMuonImageAnalyzer.html" title="Analyzes the muon-like properties of an image.">MuonImageAnalyzer</a>( array.getCamera(k) );
<a name="l00622"></a>00622     }
<a name="l00623"></a>00623 
<a name="l00624"></a>00624     <span class="comment">// set up the plotters for interactive mode:</span>
<a name="l00625"></a>00625 
<a name="l00626"></a>00626     <a class="code" href="classPlotMaker.html" title="Plots stuff to any PlotUtils graphics context.">PlotMaker</a> *pm=NULL;
<a name="l00627"></a>00627     <a class="code" href="classPlotMaker.html" title="Plots stuff to any PlotUtils graphics context.">PlotMaker</a> *pspm=NULL;
<a name="l00628"></a>00628     <a class="code" href="classPlotMaker.html" title="Plots stuff to any PlotUtils graphics context.">PlotMaker</a> *hires_pm=NULL;
<a name="l00629"></a>00629     <span class="keywordflow">if</span> (_is_interactive || _is_display_enabled ) {
<a name="l00630"></a>00630         pm = <span class="keyword">new</span> <a class="code" href="classPlotMaker.html" title="Plots stuff to any PlotUtils graphics context.">PlotMaker</a>( <span class="stringliteral">&quot;X&quot;</span>, <span class="stringliteral">&quot;x.out&quot;</span>,
<a name="l00631"></a>00631                             curcam-&gt;getMinX() - 0.4, 
<a name="l00632"></a>00632                             curcam-&gt;getMinY() - 0.4, 
<a name="l00633"></a>00633                             curcam-&gt;getMaxX() + 0.4, 
<a name="l00634"></a>00634                             curcam-&gt;getMaxY() + 0.4 
<a name="l00635"></a>00635                             );
<a name="l00636"></a>00636         <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#a5536266accd3a3aae79224e8db27941d" title="Smooth images during.">image_filter</a>==<span class="keyword">true</span>) {
<a name="l00637"></a>00637             hires_pm = <span class="keyword">new</span> <a class="code" href="classPlotMaker.html" title="Plots stuff to any PlotUtils graphics context.">PlotMaker</a>( <span class="stringliteral">&quot;X&quot;</span>, <span class="stringliteral">&quot;x2.out&quot;</span>,
<a name="l00638"></a>00638                                       hires_cam-&gt;getMinX() - 0.4, 
<a name="l00639"></a>00639                                       hires_cam-&gt;getMinY() - 0.4, 
<a name="l00640"></a>00640                                       hires_cam-&gt;getMaxX() + 0.4, 
<a name="l00641"></a>00641                                       hires_cam-&gt;getMaxY() + 0.4 
<a name="l00642"></a>00642                                       );
<a name="l00643"></a>00643         }
<a name="l00644"></a>00644     }
<a name="l00645"></a>00645 
<a name="l00646"></a>00646     
<a name="l00647"></a>00647     <span class="comment">//=========================================================================</span>
<a name="l00648"></a>00648     <span class="comment">// Set up the histograms... These get deleted automatically when</span>
<a name="l00649"></a>00649     <span class="comment">// the tel[] array is destructed</span>
<a name="l00650"></a>00650 
<a name="l00651"></a>00651     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel; k++) {
<a name="l00652"></a>00652 
<a name="l00653"></a>00653         curcam = array.getCamera(k);
<a name="l00654"></a>00654         <span class="keywordtype">int</span> numtubes = curcam-&gt;<a class="code" href="classCamera.html#a233576d02d136e96d8886627c2512afc" title="first pixel # to use">getLastPixel</a>() - curcam-&gt;getFirstPixel();
<a name="l00655"></a>00655         cout &lt;&lt; <span class="stringliteral">&quot;DEBUG: &quot;</span>&lt;&lt;k&lt;&lt;<span class="stringliteral">&quot;: numtubes=&quot;</span>&lt;&lt;numtubes&lt;&lt;endl;
<a name="l00656"></a>00656 
<a name="l00657"></a>00657         tel[k].lensize = <span class="keyword">new</span> <a class="code" href="classHistogram.html" title="General 1-D histogram class.">Histogram</a>(100, 0.0001, 0.002, <span class="stringliteral">&quot;length/size&quot;</span>);
<a name="l00658"></a>00658         tel[k].pictubes = <span class="keyword">new</span> <a class="code" href="classHistogram.html" title="General 1-D histogram class.">Histogram</a>( array.getCamera(k)-&gt;getNumPixels(), 
<a name="l00659"></a>00659                                          0, array.getCamera(k)-&gt;getNumPixels(), 
<a name="l00660"></a>00660                                          <span class="stringliteral">&quot;tubes in picture&quot;</span>);
<a name="l00661"></a>00661         tel[k].tubehits= <span class="keyword">new</span> <a class="code" href="classHistogram.html" title="General 1-D histogram class.">Histogram</a>( numtubes, 
<a name="l00662"></a>00662                                         curcam-&gt;getFirstPixel(),
<a name="l00663"></a>00663                                         curcam-&gt;<a class="code" href="classCamera.html#a233576d02d136e96d8886627c2512afc" title="first pixel # to use">getLastPixel</a>(), <span class="stringliteral">&quot;tube hits&quot;</span>);
<a name="l00664"></a>00664         tel[k].phihist= <span class="keyword">new</span> <a class="code" href="classHistogram.html" title="General 1-D histogram class.">Histogram</a>( 180, 0.0, 2.0*M_PI,  <span class="stringliteral">&quot;phi angle&quot;</span>);
<a name="l00665"></a>00665         tel[k].alphahist= <span class="keyword">new</span> <a class="code" href="classHistogram.html" title="General 1-D histogram class.">Histogram</a>( 18, 0.0, 90.0, <span class="stringliteral">&quot;raw alpha&quot;</span> );
<a name="l00666"></a>00666         tel[k].lengthhist= <span class="keyword">new</span> <a class="code" href="classHistogram.html" title="General 1-D histogram class.">Histogram</a>( 50, 0.0, M_PI_2, <span class="stringliteral">&quot;length&quot;</span> );
<a name="l00667"></a>00667         tel[k].sizehist= <span class="keyword">new</span> <a class="code" href="classHistogram.html" title="General 1-D histogram class.">Histogram</a>( 50, 0.0, 3000, <span class="stringliteral">&quot;size&quot;</span> );
<a name="l00668"></a>00668         tel[k].disthist= <span class="keyword">new</span> <a class="code" href="classHistogram.html" title="General 1-D histogram class.">Histogram</a>( 50, 0.0, M_PI_2, <span class="stringliteral">&quot;distance&quot;</span> );
<a name="l00669"></a>00669         tel[k].widthhist= <span class="keyword">new</span> <a class="code" href="classHistogram.html" title="General 1-D histogram class.">Histogram</a>( 50, 0.0, M_PI_2, <span class="stringliteral">&quot;width&quot;</span> );
<a name="l00670"></a>00670         tel[k].rawrate= <span class="keyword">new</span> <a class="code" href="classHistogram.html" title="General 1-D histogram class.">Histogram</a>( 30,0,30, <span class="stringliteral">&quot;Raw Rate&quot;</span> );
<a name="l00671"></a>00671         tel[k].deltat= <span class="keyword">new</span> <a class="code" href="classHistogram.html" title="General 1-D histogram class.">Histogram</a>(100,0,0.00001,<span class="stringliteral">&quot;DeltaT&quot;</span>);
<a name="l00672"></a>00672         tel[k].max2hist= <span class="keyword">new</span> <a class="code" href="classHistogram.html" title="General 1-D histogram class.">Histogram</a>( 1000,0,1000,<span class="stringliteral">&quot;Max2&quot;</span> );
<a name="l00673"></a>00673         tel[k].centroids= <span class="keyword">new</span> <a class="code" href="classImage2D.html" title="Representation of a 2-D raster image (for 2D analysis)">Image2D</a>(39,39);
<a name="l00674"></a>00674         
<a name="l00675"></a>00675         <span class="comment">// for muon calibration</span>
<a name="l00676"></a>00676         tel[k].musoalhist= <span class="keyword">new</span> <a class="code" href="classHistogram.html" title="General 1-D histogram class.">Histogram</a>( 100,0,4000,<span class="stringliteral">&quot;signal/arclength&quot;</span> );
<a name="l00677"></a>00677         tel[k].musizehist= <span class="keyword">new</span> <a class="code" href="classHistogram.html" title="General 1-D histogram class.">Histogram</a>( 50,0.0,2000.0, <span class="stringliteral">&quot;Muon size&quot;</span>);
<a name="l00678"></a>00678         tel[k].muonnesshist= <span class="keyword">new</span> <a class="code" href="classHistogram.html" title="General 1-D histogram class.">Histogram</a>( 50,0.0,1.0, <span class="stringliteral">&quot;Muonness&quot;</span>);
<a name="l00679"></a>00679         tel[k].mugainhist= <span class="keyword">new</span> <a class="code" href="classHistogram.html" title="General 1-D histogram class.">Histogram</a>( 50,0,500, <span class="stringliteral">&quot;Muon gain factor&quot;</span>);
<a name="l00680"></a>00680         tel[k].mulensizehist= <span class="keyword">new</span> <a class="code" href="classHistogram.html" title="General 1-D histogram class.">Histogram</a>( 100,0.0001,0.002, <span class="stringliteral">&quot;Muon Length/Size&quot;</span>);
<a name="l00681"></a>00681         
<a name="l00682"></a>00682         tel[k].centroids-&gt;setCoordinateBox(-2,-2,  2,2);
<a name="l00683"></a>00683 
<a name="l00684"></a>00684     }
<a name="l00685"></a>00685 
<a name="l00686"></a>00686     ofstream  anglefile[numtel];
<a name="l00687"></a>00687     <span class="keywordtype">string</span> anglefilename;
<a name="l00688"></a>00688     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel; k++) {
<a name="l00689"></a>00689         <span class="keywordtype">char</span> telid[100];
<a name="l00690"></a>00690         sprintf( telid, <span class="stringliteral">&quot;-%03d&quot;</span>, k );
<a name="l00691"></a>00691         <span class="keywordtype">string</span> anglefilename = dir+<span class="keywordtype">id</span>+telid+<span class="stringliteral">&quot;-angles.dat&quot;</span>;
<a name="l00692"></a>00692         anglefile[k].open(anglefilename.c_str());
<a name="l00693"></a>00693     }
<a name="l00694"></a>00694 
<a name="l00695"></a>00695     <span class="comment">//=========================================================================</span>
<a name="l00696"></a>00696     <span class="comment">// Print run information to file and screen (if requested)</span>
<a name="l00697"></a>00697 
<a name="l00698"></a>00698     <span class="keywordflow">if</span> (_is_verbose_enabled){
<a name="l00699"></a>00699         <a class="code" href="classParameterizer.html#a8416f32994c05ffcdf0c27c93ff0d34b" title="Print out run summary information in human readable format.">printSummary</a>( cout, ri, <span class="keywordtype">id</span>, header, writer, data, array );
<a name="l00700"></a>00700     }
<a name="l00701"></a>00701     ofstream runinfo( <span class="keywordtype">string</span>(dir+<span class="keywordtype">id</span>+<span class="stringliteral">&quot;-run_info.txt&quot;</span>).c_str() );
<a name="l00702"></a>00702     <a class="code" href="classParameterizer.html#a8416f32994c05ffcdf0c27c93ff0d34b" title="Print out run summary information in human readable format.">printSummary</a>( runinfo, ri, <span class="keywordtype">id</span>, header, writer, data, array );
<a name="l00703"></a>00703     
<a name="l00704"></a>00704     <span class="comment">//=========================================================================</span>
<a name="l00705"></a>00705     <span class="comment">// if Padding is enabled, precalculate the </span>
<a name="l00706"></a>00706     <span class="comment">// max pedestal dispersions for the run pair</span>
<a name="l00707"></a>00707 
<a name="l00708"></a>00708     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel; k++) {
<a name="l00709"></a>00709         
<a name="l00710"></a>00710         tel[k].combinedpeds.resize( tel[k].peds.size() );
<a name="l00711"></a>00711         tel[k].sigmaped.resize( tel[k].peds.size() );
<a name="l00712"></a>00712 
<a name="l00713"></a>00713         <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#a169dac601c7f6f1be162e95faf0aa83a" title="flag to enable padding">padding</a> == <span class="keyword">true</span> ) {
<a name="l00714"></a>00714             
<a name="l00715"></a>00715             <span class="keywordflow">for</span> (i=0; i&lt;tel[k].combinedpeds.size(); i++) {
<a name="l00716"></a>00716                 
<a name="l00717"></a>00717                 <span class="keywordflow">if</span> (tel[k].peds[i].dispersion &gt; tel[k].padpeds[i].dispersion) 
<a name="l00718"></a>00718                     tel[k].combinedpeds[i] = tel[k].peds[i];
<a name="l00719"></a>00719                 <span class="keywordflow">else</span>
<a name="l00720"></a>00720                     tel[k].combinedpeds[i] = tel[k].padpeds[i];
<a name="l00721"></a>00721                 
<a name="l00722"></a>00722                 <span class="comment">// Note that if either padding or current run has a tube</span>
<a name="l00723"></a>00723                 <span class="comment">// off or a star, the attributes of combined peds take on</span>
<a name="l00724"></a>00724                 <span class="comment">// that of the current run.</span>
<a name="l00725"></a>00725                 
<a name="l00726"></a>00726                 <span class="keywordflow">if</span> (tel[k].padpeds[i].type != Pedestal::GOOD ){
<a name="l00727"></a>00727                     tel[k].combinedpeds[i].type = tel[k].padpeds[i].type;
<a name="l00728"></a>00728                 }
<a name="l00729"></a>00729                 
<a name="l00730"></a>00730                 <span class="keywordflow">if</span> (tel[k].peds[i].type != Pedestal::GOOD ){
<a name="l00731"></a>00731                     tel[k].combinedpeds[i].type = tel[k].peds[i].type;
<a name="l00732"></a>00732                 }
<a name="l00733"></a>00733                 
<a name="l00734"></a>00734                 <span class="comment">// Precalculate the pedestal sigmas</span>
<a name="l00735"></a>00735                 
<a name="l00736"></a>00736                 tel[k].sigmaped[i] = pow(tel[k].combinedpeds[i].dispersion,2) 
<a name="l00737"></a>00737                     - pow(tel[k].peds[i].dispersion,2);
<a name="l00738"></a>00738                 
<a name="l00739"></a>00739                 <span class="keywordflow">if</span> (tel[k].sigmaped[i] &gt; 0) tel[k].sigmaped[i] = sqrt(tel[k].sigmaped[i]);
<a name="l00740"></a>00740                 <span class="keywordflow">else</span> tel[k].sigmaped[i] = -1.0e-5;
<a name="l00741"></a>00741                 
<a name="l00742"></a>00742             }
<a name="l00743"></a>00743             
<a name="l00744"></a>00744         }
<a name="l00745"></a>00745         <span class="keywordflow">else</span> {
<a name="l00746"></a>00746             tel[k].combinedpeds = tel[k].peds;
<a name="l00747"></a>00747         }
<a name="l00748"></a>00748     }
<a name="l00749"></a>00749 
<a name="l00750"></a>00750     <span class="comment">// calculate average pedestal dispersion. This is used when image</span>
<a name="l00751"></a>00751     <span class="comment">// filtering is enabled to make the pedestal cut.</span>
<a name="l00752"></a>00752     <span class="comment">// TODO: fix this to work with multiple telescopes</span>
<a name="l00753"></a>00753     <span class="keywordtype">double</span> avgpeddisp=0;
<a name="l00754"></a>00754     <span class="keywordtype">int</span> navg=0;
<a name="l00755"></a>00755     <span class="keywordflow">for</span> (i=0; i&lt;tel[0].sigmaped.size(); i++) {
<a name="l00756"></a>00756         <span class="keywordflow">if</span> (tel[0].combinedpeds[i].type==Pedestal::GOOD){
<a name="l00757"></a>00757             avgpeddisp += tel[0].combinedpeds[i].dispersion;
<a name="l00758"></a>00758             navg++;
<a name="l00759"></a>00759         }       
<a name="l00760"></a>00760     }
<a name="l00761"></a>00761     avgpeddisp /= (double)navg;
<a name="l00762"></a>00762 
<a name="l00763"></a>00763     <span class="comment">// Apply the user-specified tube mask from the config file:</span>
<a name="l00764"></a>00764     <span class="comment">// TODO: implement for multiple telescopes</span>
<a name="l00765"></a>00765 
<a name="l00766"></a>00766     <span class="keywordflow">for</span> ( i=0; i&lt;tel[0].combinedpeds.size(); i++) {
<a name="l00767"></a>00767         <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#a8b754c6ff0b16fc81132e60fc4ae5e11" title="bitmask of tubes to turn off manually">tubemask</a>[i] == 1) {
<a name="l00768"></a>00768             tel[0].combinedpeds[i].type = Pedestal::TUBEOFF;
<a name="l00769"></a>00769             tel[0].peds[i].type = Pedestal::TUBEOFF;
<a name="l00770"></a>00770             tel[0].padpeds[i].type = Pedestal::TUBEOFF;
<a name="l00771"></a>00771         }
<a name="l00772"></a>00772     }
<a name="l00773"></a>00773 
<a name="l00774"></a>00774     <span class="comment">// Initialize the imagecleaner using the combined pedestal values</span>
<a name="l00775"></a>00775 
<a name="l00776"></a>00776     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel; k++) {
<a name="l00777"></a>00777         curcam = array.getCamera(k);
<a name="l00778"></a>00778         tel[k].cleaner = <span class="keyword">new</span> <a class="code" href="classDefaultImageCleaner.html" title="The default cleaner uses a simple 2 threshold process.">DefaultImageCleaner</a>( *curcam,tel[k].combinedpeds,
<a name="l00779"></a>00779                                                   ri.<a class="code" href="classRunInfo.html#ac25ba9471cf4ddbf4e48c8ec9646ece2" title="picture threshold value">picthresh</a>,ri.<a class="code" href="classRunInfo.html#a225661a33c3efe5332083a9372be66a4" title="boundary threshold value">bndthresh</a> );
<a name="l00780"></a>00780     }
<a name="l00781"></a>00781 
<a name="l00782"></a>00782     
<a name="l00783"></a>00783     <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#a5536266accd3a3aae79224e8db27941d" title="Smooth images during.">image_filter</a> == <span class="keyword">true</span> ) {
<a name="l00784"></a>00784         threshcleaner = <span class="keyword">new</span> <a class="code" href="classThresholdImageCleaner.html">ThresholdImageCleaner</a>( *hires_cam, 0.0 );
<a name="l00785"></a>00785     }
<a name="l00786"></a>00786     
<a name="l00787"></a>00787 
<a name="l00788"></a>00788     <span class="comment">//=========================================================================</span>
<a name="l00789"></a>00789     <span class="comment">// Loop over events in the data and parameterize...</span>
<a name="l00790"></a>00790 
<a name="l00791"></a>00791     vector&lt;int&gt; n(numtel);
<a name="l00792"></a>00792     vector&lt;int&gt; n_trig(numtel);
<a name="l00793"></a>00793     vector&lt;int&gt; n_other(numtel);
<a name="l00794"></a>00794     <span class="keywordtype">int</span> count =0;
<a name="l00795"></a>00795 
<a name="l00796"></a>00796     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel; k++) {
<a name="l00797"></a>00797         n[k] = n_trig[k] = n_other[k] = 0;
<a name="l00798"></a>00798     }
<a name="l00799"></a>00799     
<a name="l00800"></a>00800     
<a name="l00801"></a>00801 
<a name="l00802"></a>00802     <span class="keywordflow">while</span> ( data-&gt;isDone() == false ) {
<a name="l00803"></a>00803 
<a name="l00804"></a>00804         <span class="comment">// ---------------------------------------------------------</span>
<a name="l00805"></a>00805         <span class="comment">// Get events until no more are found </span>
<a name="l00806"></a>00806         <span class="comment">// ---------------------------------------------------------</span>
<a name="l00807"></a>00807 
<a name="l00808"></a>00808         <span class="keywordflow">try</span> {
<a name="l00809"></a>00809 
<a name="l00810"></a>00810             <span class="keywordflow">if</span> (interactive_hold == <span class="keyword">false</span>) 
<a name="l00811"></a>00811                 data-&gt;getNextEventRecord( event );  
<a name="l00812"></a>00812             <span class="keywordflow">else</span> 
<a name="l00813"></a>00813                 cout &lt;&lt; <span class="stringliteral">&quot;INTERACTIVE MODE: holding current event&quot;</span>&lt;&lt;endl;
<a name="l00814"></a>00814 
<a name="l00815"></a>00815         }
<a name="l00816"></a>00816         <span class="keywordflow">catch</span> (<a class="code" href="classMildAnalysisException.html" title="Thrown for warnings and recoverable errors.">MildAnalysisException</a> e) {
<a name="l00817"></a>00817             <span class="comment">// Mild exceptions should be noted, but processing should</span>
<a name="l00818"></a>00818             <span class="comment">// still continue.  Anything stronger will cause this to</span>
<a name="l00819"></a>00819             <span class="comment">// return and will be caught at a higher level.</span>
<a name="l00820"></a>00820             cerr &lt;&lt; endl &lt;&lt; <span class="stringliteral">&quot;WARNING: &quot;</span> &lt;&lt; e.what() &lt;&lt; endl;
<a name="l00821"></a>00821             <span class="keywordflow">break</span>;    
<a name="l00822"></a>00822         }
<a name="l00823"></a>00823         
<a name="l00824"></a>00824         <span class="keywordflow">if</span> (n[0] == 0) {
<a name="l00825"></a>00825             <span class="comment">// it&#39;s the first event, so store the start time</span>
<a name="l00826"></a>00826             gpstime_start = <span class="keyword">event</span>.gpstime;
<a name="l00827"></a>00827         }
<a name="l00828"></a>00828 
<a name="l00829"></a>00829         <span class="comment">// store a copy of the adc values</span>
<a name="l00830"></a>00830         <span class="keywordflow">if</span> (adc.size() != <span class="keyword">event</span>.adc.size()) adc.resize(event.adc.size());
<a name="l00831"></a>00831         adc = <span class="keyword">event</span>.adc;
<a name="l00832"></a>00832 
<a name="l00833"></a>00833         <span class="comment">// --------------------------------------------------------</span>
<a name="l00834"></a>00834         <span class="comment">// Parameterize each event if it&#39;s the right type:</span>
<a name="l00835"></a>00835         <span class="comment">// ---------------------------------------------------------</span>
<a name="l00836"></a>00836         <span class="keywordflow">if</span> (event.type == RawDataReader::EVENT) {
<a name="l00837"></a>00837 
<a name="l00838"></a>00838             <span class="comment">// Figure out which telescope to use:</span>
<a name="l00839"></a>00839             <span class="keywordflow">if</span> (event.telescope_id &gt;= numtel) {
<a name="l00840"></a>00840                 cout &lt;&lt; <span class="stringliteral">&quot;WARNING: &quot;</span>
<a name="l00841"></a>00841                      &lt;&lt; <span class="stringliteral">&quot;Skipping event with telescope id &quot;</span>&lt;&lt;<span class="keyword">event</span>.telescope_id
<a name="l00842"></a>00842                      &lt;&lt; <span class="stringliteral">&quot; (there are only &quot;</span>&lt;&lt;numtel
<a name="l00843"></a>00843                      &lt;&lt;<span class="stringliteral">&quot; telescopes in the array!)&quot;</span>
<a name="l00844"></a>00844                      &lt;&lt; endl;
<a name="l00845"></a>00845                 <span class="keywordflow">continue</span>;
<a name="l00846"></a>00846             }
<a name="l00847"></a>00847 
<a name="l00848"></a>00848             curcam = array.getCamera(event.telescope_id);
<a name="l00849"></a>00849             curtel = <span class="keyword">event</span>.telescope_id;
<a name="l00850"></a>00850 
<a name="l00851"></a>00851             <span class="comment">// ----------------------------------------- </span>
<a name="l00852"></a>00852             <span class="comment">// Subtract pedestals and pad if requested:</span>
<a name="l00853"></a>00853             <span class="comment">// -----------------------------------------</span>
<a name="l00854"></a>00854 
<a name="l00855"></a>00855             <span class="keywordflow">for</span> ( i=0; i&lt;(int)event.adc.size(); i++){
<a name="l00856"></a>00856 
<a name="l00857"></a>00857                 <span class="comment">// If the tube is on (according to the pedestal),</span>
<a name="l00858"></a>00858 
<a name="l00859"></a>00859                 <span class="keywordflow">if</span> (tel[curtel].peds[i].type == Pedestal::GOOD) { 
<a name="l00860"></a>00860 
<a name="l00861"></a>00861                     <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#a169dac601c7f6f1be162e95faf0aa83a" title="flag to enable padding">padding</a> == <span class="keyword">true</span>) {
<a name="l00862"></a>00862 
<a name="l00863"></a>00863                         <span class="comment">// &quot;Pad&quot; to bring the noise up to the maximum</span>
<a name="l00864"></a>00864                         <span class="comment">// of the on and off peddisps.  Currently, add</span>
<a name="l00865"></a>00865                         <span class="comment">// in noise based on a gaussian distribution,</span>
<a name="l00866"></a>00866                         <span class="comment">// but a poisson distribution may be better</span>
<a name="l00867"></a>00867                         <span class="comment">// for low statistics. That would require</span>
<a name="l00868"></a>00868                         <span class="comment">// switching gsl_ran_gaussian() to</span>
<a name="l00869"></a>00869                         <span class="comment">// gsl_ran_poisson() and changing the formula</span>
<a name="l00870"></a>00870                         <span class="comment">// a bit.</span>
<a name="l00871"></a>00871 
<a name="l00872"></a>00872 
<a name="l00873"></a>00873                         <span class="keywordflow">if</span> (tel[curtel].sigmaped[i] &gt; 0.0) {
<a name="l00874"></a>00874 
<a name="l00875"></a>00875                             deviate = _gaussdev-&gt;getDeviate();
<a name="l00876"></a>00876                             adc[i] += deviate*tel[curtel].sigmaped[i];
<a name="l00877"></a>00877 
<a name="l00878"></a>00878                         }
<a name="l00879"></a>00879 
<a name="l00880"></a>00880                     }
<a name="l00881"></a>00881 
<a name="l00882"></a>00882                     adc[i] -= tel[curtel].peds[i].pedestal;
<a name="l00883"></a>00883                     
<a name="l00884"></a>00884                 }
<a name="l00885"></a>00885 
<a name="l00886"></a>00886                 <span class="comment">// Otherwise mark the tube as off</span>
<a name="l00887"></a>00887 
<a name="l00888"></a>00888                 <span class="keywordflow">else</span> {
<a name="l00889"></a>00889                     adc[i] = 0; 
<a name="l00890"></a>00890                 }
<a name="l00891"></a>00891 
<a name="l00892"></a>00892             }
<a name="l00893"></a>00893 
<a name="l00894"></a>00894             <span class="comment">// ----------------------------------------- </span>
<a name="l00895"></a>00895             <span class="comment">// Apply gains:</span>
<a name="l00896"></a>00896             <span class="comment">// ----------------------------------------- </span>
<a name="l00897"></a>00897             
<a name="l00898"></a>00898             adc *= tel[curtel].gains;
<a name="l00899"></a>00899 
<a name="l00900"></a>00900             <span class="comment">// ----------------------------------------- </span>
<a name="l00901"></a>00901             <span class="comment">// Clean the image</span>
<a name="l00902"></a>00902             <span class="comment">// and generate a linked list of pixels that</span>
<a name="l00903"></a>00903             <span class="comment">// are in the picture and boundary.  </span>
<a name="l00904"></a>00904             <span class="comment">// ----------------------------------------- </span>
<a name="l00905"></a>00905 
<a name="l00906"></a>00906             <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#a5536266accd3a3aae79224e8db27941d" title="Smooth images during.">image_filter</a> == <span class="keyword">false</span>) {
<a name="l00907"></a>00907                
<a name="l00908"></a>00908                 <span class="comment">// standard cleaning method:</span>
<a name="l00909"></a>00909                  
<a name="l00910"></a>00910                 cleanpixels = tel[curtel].cleaner-&gt;getCleanPixels( adc );
<a name="l00911"></a>00911 
<a name="l00912"></a>00912                 <span class="comment">// add the clean pixels to a histogram to look for</span>
<a name="l00913"></a>00913                 <span class="comment">// misfiring tubes </span>
<a name="l00914"></a>00914                 
<a name="l00915"></a>00915                 <span class="comment">// TODO: speed this up by not using</span>
<a name="l00916"></a>00916                 <span class="comment">// increment() since it&#39;s integers anyway. Right now, I</span>
<a name="l00917"></a>00917                 <span class="comment">// add 0.5 to make sure the correct bin is incremented</span>
<a name="l00918"></a>00918                 <span class="comment">// (since the value lies on the bin-boundary, which seems</span>
<a name="l00919"></a>00919                 <span class="comment">// to cause random behavior due to rounding)</span>
<a name="l00920"></a>00920                 
<a name="l00921"></a>00921                 <span class="keywordflow">for</span> (i=0; i&lt;cleanpixels.size(); i++) {
<a name="l00922"></a>00922                     tel[curtel].tubehits-&gt;increment(cleanpixels[i]+0.5);
<a name="l00923"></a>00923                 }
<a name="l00924"></a>00924 
<a name="l00925"></a>00925             }
<a name="l00926"></a>00926             <span class="keywordflow">else</span> {
<a name="l00927"></a>00927                 <span class="comment">// Image filter method: smooth image with hexagonal</span>
<a name="l00928"></a>00928                 <span class="comment">// FFT filtering.  The resulting image has more pixels</span>
<a name="l00929"></a>00929                 <span class="comment">// than the original, since the resolution of the</span>
<a name="l00930"></a>00930                 <span class="comment">// camera is modified.</span>
<a name="l00931"></a>00931 
<a name="l00932"></a>00932                 <span class="comment">// first, get the regular cleaning for comparison:</span>
<a name="l00933"></a>00933                 cleanpixels = tel[curtel].cleaner-&gt;getCleanPixels( adc );
<a name="l00934"></a>00934 
<a name="l00935"></a>00935                 <span class="comment">// now filter the image:</span>
<a name="l00936"></a>00936                 s_max = filter_image( adc,hires_adc );
<a name="l00937"></a>00937 
<a name="l00938"></a>00938 
<a name="l00939"></a>00939                 <span class="comment">// clean the image with a threshold based on a</span>
<a name="l00940"></a>00940                 <span class="comment">// percentage of the maximum value after subtracting</span>
<a name="l00941"></a>00941                 <span class="comment">// the picture threshold:</span>
<a name="l00942"></a>00942                 ((<a class="code" href="classThresholdImageCleaner.html">ThresholdImageCleaner</a>*)(threshcleaner))
<a name="l00943"></a>00943                     -&gt;setThreshold( ri.<a class="code" href="classRunInfo.html#a28a6b7962b55bfdf725979206e9c86fe" title="Filter picture threshold (in sigma)">filter_threshold</a>*avgpeddisp 
<a name="l00944"></a>00944                                     + (s_max-ri.<a class="code" href="classRunInfo.html#a28a6b7962b55bfdf725979206e9c86fe" title="Filter picture threshold (in sigma)">filter_threshold</a>*avgpeddisp)
<a name="l00945"></a>00945                                     *ri.filter_percent );
<a name="l00946"></a>00946                 hires_cleanpixels = threshcleaner-&gt;getCleanPixels( hires_adc );
<a name="l00947"></a>00947 
<a name="l00948"></a>00948             }
<a name="l00949"></a>00949 
<a name="l00950"></a>00950 
<a name="l00951"></a>00951 
<a name="l00952"></a>00952             <span class="comment">// ----------------------------------------- </span>
<a name="l00953"></a>00953             <span class="comment">// Get the image parameterization</span>
<a name="l00954"></a>00954             <span class="comment">// ----------------------------------------- </span>
<a name="l00955"></a>00955 
<a name="l00956"></a>00956             updateAngles( event.gpstime, header );
<a name="l00957"></a>00957             zen =  M_PI_2 - _el;           <span class="comment">// zenith angle</span>
<a name="l00958"></a>00958 
<a name="l00959"></a>00959             <span class="keywordflow">if</span> ( ri.<a class="code" href="classRunInfo.html#a5536266accd3a3aae79224e8db27941d" title="Smooth images during.">image_filter</a> == <span class="keyword">true</span> )
<a name="l00960"></a>00960                 tel[curtel].analyzer-&gt;parameterize( hires_adc, hires_cleanpixels );
<a name="l00961"></a>00961             <span class="keywordflow">else</span>
<a name="l00962"></a>00962                 tel[curtel].analyzer-&gt;parameterize( adc, cleanpixels );
<a name="l00963"></a>00963 
<a name="l00964"></a>00964 
<a name="l00965"></a>00965 
<a name="l00966"></a>00966 
<a name="l00967"></a>00967             param = tel[curtel].analyzer-&gt;getHillasParameters();
<a name="l00968"></a>00968             param.<a class="code" href="structImageParameterization.html#a3d8a18d1b4e1bf7d7f5b177665651cf4" title="oscillator time">osctime</a> = <span class="keyword">event</span>.osctime;
<a name="l00969"></a>00969             param.<a class="code" href="structImageParameterization.html#a485ec7c0550f9214971331a7cc2b0b6c" title="livetime of run">livetime</a> = <span class="keyword">event</span>.livetime;
<a name="l00970"></a>00970             param.<a class="code" href="structImageParameterization.html#a169f947f6ed26a3097243c8c42c41a64" title="calibrated gps time">gpstime</a> = <span class="keyword">event</span>.gpstime;
<a name="l00971"></a>00971             param.<a class="code" href="structImageParameterization.html#a3524379a51b511ce132fb97d66e6028b" title="Event number for debugging.">event_number</a> = _event_number;
<a name="l00972"></a>00972             param.<a class="code" href="structHillasParameterization.html#aa9e06ca0a327df412ce4b314e0e8a093" title="zenith angle of event">zenith</a> =  zen; 
<a name="l00973"></a>00973             param.<a class="code" href="structImageParameterization.html#a7190a3fc893a52c1f544d34b09c0368f" title="telescope id number">telescope_id</a> = <span class="keyword">event</span>.telescope_id;
<a name="l00974"></a>00974 
<a name="l00975"></a>00975             <span class="comment">// if there&#39;s a zenith override</span>
<a name="l00976"></a>00976             <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#aaedba21055cfa1183b97a37db043962e" title="override value for zenith angle">zenithoverride</a> &gt; 1e-9) {
<a name="l00977"></a>00977                 param.<a class="code" href="structHillasParameterization.html#aa9e06ca0a327df412ce4b314e0e8a093" title="zenith angle of event">zenith</a> = ri.<a class="code" href="classRunInfo.html#aaedba21055cfa1183b97a37db043962e" title="override value for zenith angle">zenithoverride</a>;
<a name="l00978"></a>00978             }
<a name="l00979"></a>00979 
<a name="l00980"></a>00980             <span class="comment">// ----------------------------------------- </span>
<a name="l00981"></a>00981             <span class="comment">// Get the muon parameters if requested</span>
<a name="l00982"></a>00982             <span class="comment">// ----------------------------------------- </span>
<a name="l00983"></a>00983 
<a name="l00984"></a>00984             <span class="keywordflow">if</span> ( ri.<a class="code" href="classRunInfo.html#a4bdb5240f8897d53b71ea7bb1beb1393" title="flag to enable muon calibration">muoncalibrate</a> ) {
<a name="l00985"></a>00985 
<a name="l00986"></a>00986                 <span class="comment">// muons usually have a size less than 2000, so lets</span>
<a name="l00987"></a>00987                 <span class="comment">// only calculate muon parameters when this occurs.</span>
<a name="l00988"></a>00988                 <span class="comment">// Should define a muon size cut in the Config file!</span>
<a name="l00989"></a>00989 
<a name="l00990"></a>00990                 <span class="keywordflow">if</span> ( param.<a class="code" href="structHillasParameterization.html#abec8385793292018263164ea18601219" title="total signal">size</a> &lt; 3000 ) {
<a name="l00991"></a>00991                     
<a name="l00992"></a>00992                     <span class="keywordflow">try</span> {
<a name="l00993"></a>00993                         tel[curtel].muonanalyzer-&gt;parameterize( adc,cleanpixels );
<a name="l00994"></a>00994                         mparam = tel[curtel].muonanalyzer-&gt;getMuonParameters();
<a name="l00995"></a>00995                     }
<a name="l00996"></a>00996                     <span class="keywordflow">catch</span> (<a class="code" href="classMildAnalysisException.html" title="Thrown for warnings and recoverable errors.">MildAnalysisException</a> e) {
<a name="l00997"></a>00997                         
<a name="l00998"></a>00998                     }
<a name="l00999"></a>00999                     
<a name="l01000"></a>01000                     tel[curtel].muonnesshist-&gt;increment( mparam.<a class="code" href="structMuonParameterization.html#a2ebceb539977f87168c1f88efbb2dec6" title="measure of muon-like characteristics">muonness</a> );
<a name="l01001"></a>01001 
<a name="l01002"></a>01002                     <span class="keywordflow">if</span> ( mparam.<a class="code" href="structMuonParameterization.html#a2ebceb539977f87168c1f88efbb2dec6" title="measure of muon-like characteristics">muonness</a> &gt; ri.<a class="code" href="classRunInfo.html#af43ac9575e4f5ad74d345b7b7e1a203f" title="Muonness threshold for muon selection.">muon_threshold</a> ) {
<a name="l01003"></a>01003                         tel[curtel].musoalhist-&gt;increment( mparam.<a class="code" href="structMuonParameterization.html#a5755c497600535efe649802773ff2919" title="Signal over arclength.">soal</a> );
<a name="l01004"></a>01004                         tel[curtel].musizehist-&gt;increment( param.<a class="code" href="structHillasParameterization.html#abec8385793292018263164ea18601219" title="total signal">size</a> );
<a name="l01005"></a>01005                         tel[curtel].mugainhist-&gt;increment( mparam.<a class="code" href="structMuonParameterization.html#aca865edfe191cfad91502c0cc71d9eb8" title="Light in annulus corrected for spillover.">mugain</a> );
<a name="l01006"></a>01006                         tel[curtel].mulensizehist-&gt;increment( param.<a class="code" href="structHillasParameterization.html#a2be5e9e0885f119cf5df38aa77777542" title="length over size">length_over_size</a> );
<a name="l01007"></a>01007                     }
<a name="l01008"></a>01008                 }
<a name="l01009"></a>01009                 <span class="keywordflow">else</span> {
<a name="l01010"></a>01010                     mparam.clear();
<a name="l01011"></a>01011                 }
<a name="l01012"></a>01012                 
<a name="l01013"></a>01013                 <span class="comment">// write out the parameters</span>
<a name="l01014"></a>01014                 
<a name="l01015"></a>01015                 muonfile &lt;&lt; param.<a class="code" href="structImageParameterization.html#a3524379a51b511ce132fb97d66e6028b" title="Event number for debugging.">event_number</a> &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; mparam &lt;&lt; endl;
<a name="l01016"></a>01016                                 
<a name="l01017"></a>01017             }
<a name="l01018"></a>01018             
<a name="l01019"></a>01019             
<a name="l01020"></a>01020             <span class="comment">// ----------------------------------------- </span>
<a name="l01021"></a>01021             <span class="comment">// Display if interactive:</span>
<a name="l01022"></a>01022             <span class="comment">// ----------------------------------------- </span>
<a name="l01023"></a>01023 
<a name="l01024"></a>01024             <span class="keywordflow">if</span> ( _is_display_enabled ) {
<a name="l01025"></a>01025                 
<a name="l01026"></a>01026                 <span class="keywordflow">if</span> (_is_interactive == <span class="keyword">true</span>) {
<a name="l01027"></a>01027 
<a name="l01028"></a>01028 
<a name="l01029"></a>01029                     cout &lt;&lt; <span class="stringliteral">&quot;PARAMS   : &quot;</span>&lt;&lt;param &lt;&lt; endl;
<a name="l01030"></a>01030 
<a name="l01031"></a>01031                     <span class="keywordflow">if</span> (interactive_correct) {
<a name="l01032"></a>01032                         cutter-&gt;<a class="code" href="classSuperCutter.html#aa9affeb3c4e8b66860f26bd96954b4e1" title="Apply a filter to the parameters.">applyCorrections</a>(param);
<a name="l01033"></a>01033                         cout &lt;&lt; <span class="stringliteral">&quot;CORRECTED: &quot;</span> &lt;&lt; param &lt;&lt; endl;
<a name="l01034"></a>01034                     }
<a name="l01035"></a>01035 
<a name="l01036"></a>01036   
<a name="l01037"></a>01037                     cout &lt;&lt; <span class="stringliteral">&quot;Clean Pixels: &quot;</span>;
<a name="l01038"></a>01038                     <span class="keywordflow">for</span> (i=0; i&lt;cleanpixels.size(); i++)
<a name="l01039"></a>01039                         cout &lt;&lt; cleanpixels[i] &lt;&lt; <span class="stringliteral">&quot; &quot;</span>;
<a name="l01040"></a>01040                     cout &lt;&lt; endl;
<a name="l01041"></a>01041                     <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#a4bdb5240f8897d53b71ea7bb1beb1393" title="flag to enable muon calibration">muoncalibrate</a>)
<a name="l01042"></a>01042                         cout &lt;&lt; <span class="stringliteral">&quot;MUON PARAMETERS: &quot;</span>&lt;&lt; mparam &lt;&lt; endl;
<a name="l01043"></a>01043 
<a name="l01044"></a>01044 
<a name="l01045"></a>01045                     tempstr = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01046"></a>01046                     <span class="keywordflow">while</span> (tempstr != <span class="stringliteral">&quot;n&quot;</span>) {
<a name="l01047"></a>01047 
<a name="l01048"></a>01048                         <span class="keywordflow">if</span> (interactive_triplet_centers) 
<a name="l01049"></a>01049                             tel[curtel].muonanalyzer-&gt;enablePlotPoints(<span class="keyword">true</span>);
<a name="l01050"></a>01050                         <span class="keywordflow">else</span> 
<a name="l01051"></a>01051                             tel[curtel].muonanalyzer-&gt;enablePlotPoints(<span class="keyword">false</span>);
<a name="l01052"></a>01052                         
<a name="l01053"></a>01053                         <span class="keywordflow">if</span> (interactive_muon) {
<a name="l01054"></a>01054                             <span class="comment">// seek to next muon</span>
<a name="l01055"></a>01055                             <span class="keywordflow">if</span> (mparam.<a class="code" href="structMuonParameterization.html#a2ebceb539977f87168c1f88efbb2dec6" title="measure of muon-like characteristics">muonness</a> &gt; ri.<a class="code" href="classRunInfo.html#af43ac9575e4f5ad74d345b7b7e1a203f" title="Muonness threshold for muon selection.">muon_threshold</a>) { 
<a name="l01056"></a>01056                                 interactive_muon=<span class="keyword">false</span>;
<a name="l01057"></a>01057                             }
<a name="l01058"></a>01058                             <span class="keywordflow">else</span> {
<a name="l01059"></a>01059                                 <span class="keywordflow">break</span>;
<a name="l01060"></a>01060                             }
<a name="l01061"></a>01061                             
<a name="l01062"></a>01062                         }
<a name="l01063"></a>01063 
<a name="l01064"></a>01064                         
<a name="l01065"></a>01065                         <span class="keywordflow">if</span> (interactive_cuts) {
<a name="l01066"></a>01066                             cout &lt;&lt; <span class="stringliteral">&quot;Seeking: &quot;</span>&lt;&lt;param.<a class="code" href="structImageParameterization.html#a3524379a51b511ce132fb97d66e6028b" title="Event number for debugging.">event_number</a> 
<a name="l01067"></a>01067                                  &lt;&lt; <span class="stringliteral">&quot;     \r&quot;</span> &lt;&lt; flush;
<a name="l01068"></a>01068 
<a name="l01069"></a>01069                             <span class="keywordflow">if</span> (cutter-&gt;<a class="code" href="classSuperCutter.html#a10e29b1d569a2b09755e44c31b3c1e61" title="Checks the parameterization of an event to see if it passes cuts.">pass</a>(param,(SIZE|MAX|FRAC|LENSIZE
<a name="l01070"></a>01070                                                        |DISTANCE|LENGTH
<a name="l01071"></a>01071                                                        |WIDTH))){
<a name="l01072"></a>01072                                 cout &lt;&lt; <span class="stringliteral">&quot;Event &quot;</span> &lt;&lt; param.<a class="code" href="structImageParameterization.html#a3524379a51b511ce132fb97d66e6028b" title="Event number for debugging.">event_number</a>
<a name="l01073"></a>01073                                      &lt;&lt; <span class="stringliteral">&quot; Passed cuts    &quot;</span> &lt;&lt; endl;
<a name="l01074"></a>01074                             }
<a name="l01075"></a>01075                             <span class="keywordflow">else</span> <span class="keywordflow">break</span>;
<a name="l01076"></a>01076                         } <span class="comment">// End if cuts are enabled in interactive mode.</span>
<a name="l01077"></a>01077 
<a name="l01078"></a>01078 
<a name="l01079"></a>01079                         <span class="comment">// Plot the camera</span>
<a name="l01080"></a>01080 
<a name="l01081"></a>01081                         pm-&gt;setAxisBox( *curcam );
<a name="l01082"></a>01082                         <span class="keywordflow">if</span> (interactive_rotate){
<a name="l01083"></a>01083                             pm-&gt;pushState();
<a name="l01084"></a>01084                             pm-&gt;rotate( _theta );
<a name="l01085"></a>01085                         }
<a name="l01086"></a>01086 
<a name="l01087"></a>01087                         <span class="keywordflow">if</span> (interactive_clean == <span class="keyword">false</span>) {
<a name="l01088"></a>01088                             cleanpixels.clear();
<a name="l01089"></a>01089                         }
<a name="l01090"></a>01090 
<a name="l01091"></a>01091 
<a name="l01092"></a>01092                         <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#a5536266accd3a3aae79224e8db27941d" title="Smooth images during.">image_filter</a>==<span class="keyword">true</span>) {
<a name="l01093"></a>01093                             hires_pm-&gt;setAxisBox( *hires_cam );
<a name="l01094"></a>01094                             hires_pm-&gt;plot( *hires_cam, hires_adc, 
<a name="l01095"></a>01095                                       hires_peds,hires_cleanpixels,
<a name="l01096"></a>01096                                       interactive_disptype);
<a name="l01097"></a>01097                             hires_pm-&gt;plot( param );
<a name="l01098"></a>01098                             hires_pm-&gt;<a class="code" href="classPlotMaker.html#a7a63b2f17f113ee6b880aebf1cba1d91" title="Plot a set of axes around the AxisBox region.">plotAxes</a>();
<a name="l01099"></a>01099                             hires_pm-&gt;plotTitle(<span class="stringliteral">&quot;Filtered Image&quot;</span>);
<a name="l01100"></a>01100                             hires_pm-&gt;newPage();
<a name="l01101"></a>01101                         }
<a name="l01102"></a>01102 
<a name="l01103"></a>01103                         pm-&gt;plot( *curcam, adc, tel[curtel].combinedpeds, 
<a name="l01104"></a>01104                                   cleanpixels, interactive_disptype );
<a name="l01105"></a>01105                         
<a name="l01106"></a>01106                         
<a name="l01107"></a>01107                         <span class="keywordflow">if</span> (interactive_params) 
<a name="l01108"></a>01108                             pm-&gt;plot( param );
<a name="l01109"></a>01109 
<a name="l01110"></a>01110                         <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#a4bdb5240f8897d53b71ea7bb1beb1393" title="flag to enable muon calibration">muoncalibrate</a>) pm-&gt;plot( mparam );
<a name="l01111"></a>01111                         pm-&gt;<a class="code" href="classPlotMaker.html#a7a63b2f17f113ee6b880aebf1cba1d91" title="Plot a set of axes around the AxisBox region.">plotAxes</a>();
<a name="l01112"></a>01112                         <span class="keywordflow">switch</span> (interactive_disptype) {
<a name="l01113"></a>01113                         <span class="keywordflow">case</span> PlotMaker::CAMERA_IMAGE:
<a name="l01114"></a>01114                             pm-&gt;plotTitle(<span class="stringliteral">&quot;Camera image - &quot;</span>+header.<a class="code" href="structHeaderRecord.html#abe54c31e39ebf8b8b6e642aa9eb1d33e" title="name of the source">sourcename</a>);
<a name="l01115"></a>01115                             <span class="keywordflow">break</span>;
<a name="l01116"></a>01116                         <span class="keywordflow">case</span> PlotMaker::CAMERA_PEDS:
<a name="l01117"></a>01117                             pm-&gt;plotTitle(<span class="stringliteral">&quot;Peds - &quot;</span>+header.<a class="code" href="structHeaderRecord.html#abe54c31e39ebf8b8b6e642aa9eb1d33e" title="name of the source">sourcename</a>);
<a name="l01118"></a>01118                             <span class="keywordflow">break</span>;
<a name="l01119"></a>01119                         <span class="keywordflow">case</span> PlotMaker::CAMERA_PEDDISPS:
<a name="l01120"></a>01120                             pm-&gt;plotTitle(<span class="stringliteral">&quot;sigma_ped - &quot;</span>
<a name="l01121"></a>01121                                           +header.<a class="code" href="structHeaderRecord.html#abe54c31e39ebf8b8b6e642aa9eb1d33e" title="name of the source">sourcename</a>);
<a name="l01122"></a>01122                             <span class="keywordflow">break</span>;
<a name="l01123"></a>01123                         <span class="keywordflow">case</span> PlotMaker::CAMERA_TUBENUMS:
<a name="l01124"></a>01124                             pm-&gt;plotTitle(<span class="stringliteral">&quot;Tube numbers - &quot;</span>
<a name="l01125"></a>01125                                           +header.<a class="code" href="structHeaderRecord.html#abe54c31e39ebf8b8b6e642aa9eb1d33e" title="name of the source">sourcename</a>);
<a name="l01126"></a>01126                             <span class="keywordflow">break</span>;
<a name="l01127"></a>01127                         <span class="keywordflow">default</span>:
<a name="l01128"></a>01128                             pm-&gt;plotTitle(<span class="stringliteral">&quot;Camera image - &quot;</span>+header.<a class="code" href="structHeaderRecord.html#abe54c31e39ebf8b8b6e642aa9eb1d33e" title="name of the source">sourcename</a>);
<a name="l01129"></a>01129                             <span class="keywordflow">break</span>;
<a name="l01130"></a>01130                         }
<a name="l01131"></a>01131                     
<a name="l01132"></a>01132                         <span class="keywordflow">if</span> (interactive_rotate)pm-&gt;popState();
<a name="l01133"></a>01133                         pm-&gt;newPage();
<a name="l01134"></a>01134                                         
<a name="l01135"></a>01135                         cout &lt;&lt; <span class="stringliteral">&quot;-----------------------------------------&quot;</span>
<a name="l01136"></a>01136                              &lt;&lt; endl
<a name="l01137"></a>01137                              &lt;&lt; <span class="stringliteral">&quot;[n] Next event         [s] Save as ps    &quot;</span>
<a name="l01138"></a>01138                              &lt;&lt; <span class="stringliteral">&quot;      [p] set Plot type&quot;</span> &lt;&lt; endl
<a name="l01139"></a>01139                              &lt;&lt; <span class="stringliteral">&quot;[m] next Muon          [r] Redraw        &quot;</span>
<a name="l01140"></a>01140                              &lt;&lt; <span class="stringliteral">&quot;      [i] set dIsplay scale&quot;</span> &lt;&lt;endl
<a name="l01141"></a>01141                              &lt;&lt; <span class="stringliteral">&quot;[,] mark good muon     [c] toggle Cuts (&quot;</span>;
<a name="l01142"></a>01142                         <span class="keywordflow">if</span> (interactive_cuts) cout &lt;&lt; <span class="stringliteral">&quot;*&quot;</span>; <span class="keywordflow">else</span> cout &lt;&lt;<span class="stringliteral">&quot; &quot;</span>;
<a name="l01143"></a>01143                         cout &lt;&lt;<span class="stringliteral">&quot;)     [C] toggle corrections (&quot;</span>;
<a name="l01144"></a>01144                         <span class="keywordflow">if</span> (interactive_correct) cout &lt;&lt; <span class="stringliteral">&quot;*&quot;</span>; <span class="keywordflow">else</span> cout &lt;&lt;<span class="stringliteral">&quot; &quot;</span>;
<a name="l01145"></a>01145                         cout &lt;&lt; <span class="stringliteral">&quot;)&quot;</span> &lt;&lt; endl;
<a name="l01146"></a>01146                         cout &lt;&lt; <span class="stringliteral">&quot;[h] Hold event (&quot;</span>;
<a name="l01147"></a>01147                         <span class="keywordflow">if</span> (interactive_hold) cout &lt;&lt; <span class="stringliteral">&quot;*&quot;</span>; <span class="keywordflow">else</span> cout &lt;&lt;<span class="stringliteral">&quot; &quot;</span>;
<a name="l01148"></a>01148                         cout &lt;&lt;<span class="stringliteral">&quot;)     [R] toggle Rotation (&quot;</span>;
<a name="l01149"></a>01149                         <span class="keywordflow">if</span> (interactive_rotate) cout &lt;&lt; <span class="stringliteral">&quot;*&quot;</span>; <span class="keywordflow">else</span> cout &lt;&lt;<span class="stringliteral">&quot; &quot;</span>;
<a name="l01150"></a>01150                         cout &lt;&lt;<span class="stringliteral">&quot;) [t] toggle triplet cntrs (&quot;</span>;
<a name="l01151"></a>01151                         <span class="keywordflow">if</span> (interactive_triplet_centers) 
<a name="l01152"></a>01152                             cout &lt;&lt; <span class="stringliteral">&quot;*&quot;</span>; <span class="keywordflow">else</span> cout &lt;&lt;<span class="stringliteral">&quot; &quot;</span>;
<a name="l01153"></a>01153                         cout &lt;&lt;<span class="stringliteral">&quot;)&quot;</span>&lt;&lt;endl;
<a name="l01154"></a>01154                         cout &lt;&lt; <span class="stringliteral">&quot;CHOICE: &quot;</span>;
<a name="l01155"></a>01155                         cin &gt;&gt; tempstr;
<a name="l01156"></a>01156                         cout &lt;&lt; tempstr[0] &lt;&lt; endl;
<a name="l01157"></a>01157 
<a name="l01158"></a>01158                         <span class="keywordflow">switch</span> (tempstr[0]) {
<a name="l01159"></a>01159                         <span class="keywordflow">case</span> <span class="charliteral">&#39;c&#39;</span>:
<a name="l01160"></a>01160                             interactive_cuts = !interactive_cuts;
<a name="l01161"></a>01161                             <span class="keywordflow">break</span>;
<a name="l01162"></a>01162                         <span class="keywordflow">case</span> <span class="charliteral">&#39;C&#39;</span>:
<a name="l01163"></a>01163                             interactive_correct = !interactive_correct;
<a name="l01164"></a>01164                             <span class="keywordflow">break</span>;
<a name="l01165"></a>01165                         <span class="keywordflow">case</span> <span class="charliteral">&#39;h&#39;</span>:
<a name="l01166"></a>01166                             interactive_hold = !interactive_hold;
<a name="l01167"></a>01167                             <span class="keywordflow">break</span>;
<a name="l01168"></a>01168                         <span class="keywordflow">case</span> <span class="charliteral">&#39;l&#39;</span>:
<a name="l01169"></a>01169                             interactive_clean = !interactive_clean;
<a name="l01170"></a>01170                             <span class="keywordflow">break</span>;
<a name="l01171"></a>01171                         <span class="keywordflow">case</span> <span class="charliteral">&#39;P&#39;</span>:
<a name="l01172"></a>01172                             interactive_params = !interactive_params;
<a name="l01173"></a>01173                             <span class="keywordflow">break</span>;
<a name="l01174"></a>01174                         <span class="keywordflow">case</span> <span class="charliteral">&#39;t&#39;</span>:
<a name="l01175"></a>01175                             interactive_triplet_centers = 
<a name="l01176"></a>01176                                 !interactive_triplet_centers;
<a name="l01177"></a>01177                             <span class="keywordflow">break</span>;
<a name="l01178"></a>01178                         <span class="keywordflow">case</span> <span class="charliteral">&#39;s&#39;</span>:
<a name="l01179"></a>01179                             cout &lt;&lt; <span class="stringliteral">&quot;Enter filename: &quot;</span>;
<a name="l01180"></a>01180                             cin &gt;&gt; fname;
<a name="l01181"></a>01181                             pspm = <span class="keyword">new</span> <a class="code" href="classPlotMaker.html" title="Plots stuff to any PlotUtils graphics context.">PlotMaker</a>( <span class="stringliteral">&quot;PS&quot;</span>, fname.c_str() );
<a name="l01182"></a>01182                             pspm-&gt;setAxisBox( *curcam );
<a name="l01183"></a>01183                             pspm-&gt;plot( *curcam, adc, tel[curtel].combinedpeds,
<a name="l01184"></a>01184                                         cleanpixels,interactive_disptype);
<a name="l01185"></a>01185                             <span class="keywordflow">if</span> (interactive_params)
<a name="l01186"></a>01186                                 pspm-&gt;plot( param );
<a name="l01187"></a>01187                             <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#a4bdb5240f8897d53b71ea7bb1beb1393" title="flag to enable muon calibration">muoncalibrate</a>) pspm-&gt;plot( mparam );
<a name="l01188"></a>01188                             pspm-&gt;<a class="code" href="classPlotMaker.html#a7a63b2f17f113ee6b880aebf1cba1d91" title="Plot a set of axes around the AxisBox region.">plotAxes</a>();
<a name="l01189"></a>01189                             <span class="keywordflow">switch</span> (interactive_disptype) {
<a name="l01190"></a>01190                             <span class="keywordflow">case</span> PlotMaker::CAMERA_IMAGE:
<a name="l01191"></a>01191                                 pm-&gt;plotTitle(<span class="stringliteral">&quot;Camera image - &quot;</span>+
<a name="l01192"></a>01192                                               header.<a class="code" href="structHeaderRecord.html#abe54c31e39ebf8b8b6e642aa9eb1d33e" title="name of the source">sourcename</a>);
<a name="l01193"></a>01193                                 <span class="keywordflow">break</span>;
<a name="l01194"></a>01194                             <span class="keywordflow">case</span> PlotMaker::CAMERA_PEDS:
<a name="l01195"></a>01195                                 pm-&gt;plotTitle(<span class="stringliteral">&quot;Peds - &quot;</span>+header.<a class="code" href="structHeaderRecord.html#abe54c31e39ebf8b8b6e642aa9eb1d33e" title="name of the source">sourcename</a>);
<a name="l01196"></a>01196                                 <span class="keywordflow">break</span>;
<a name="l01197"></a>01197                             <span class="keywordflow">case</span> PlotMaker::CAMERA_PEDDISPS:
<a name="l01198"></a>01198                                 pm-&gt;plotTitle(<span class="stringliteral">&quot;sigma_ped - &quot;</span>
<a name="l01199"></a>01199                                               +header.<a class="code" href="structHeaderRecord.html#abe54c31e39ebf8b8b6e642aa9eb1d33e" title="name of the source">sourcename</a>);
<a name="l01200"></a>01200                                 <span class="keywordflow">break</span>;
<a name="l01201"></a>01201                             <span class="keywordflow">case</span> PlotMaker::CAMERA_TUBENUMS:
<a name="l01202"></a>01202                                 pm-&gt;plotTitle(<span class="stringliteral">&quot;Tube numbers - &quot;</span>
<a name="l01203"></a>01203                                               +header.<a class="code" href="structHeaderRecord.html#abe54c31e39ebf8b8b6e642aa9eb1d33e" title="name of the source">sourcename</a>);
<a name="l01204"></a>01204                                 <span class="keywordflow">break</span>;
<a name="l01205"></a>01205                             <span class="keywordflow">default</span>:
<a name="l01206"></a>01206                                 pm-&gt;plotTitle(<span class="stringliteral">&quot;Camera image - &quot;</span>
<a name="l01207"></a>01207                                               +header.<a class="code" href="structHeaderRecord.html#abe54c31e39ebf8b8b6e642aa9eb1d33e" title="name of the source">sourcename</a>);
<a name="l01208"></a>01208                                 <span class="keywordflow">break</span>;
<a name="l01209"></a>01209                             }
<a name="l01210"></a>01210                             <span class="keyword">delete</span> pspm;
<a name="l01211"></a>01211 
<a name="l01212"></a>01212                             <span class="keywordflow">break</span>;
<a name="l01213"></a>01213                         <span class="keywordflow">case</span> <span class="charliteral">&#39;S&#39;</span>:
<a name="l01214"></a>01214                             <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#a5536266accd3a3aae79224e8db27941d" title="Smooth images during.">image_filter</a>==<span class="keyword">true</span>) {
<a name="l01215"></a>01215                                 cout &lt;&lt; <span class="stringliteral">&quot;Enter filename: &quot;</span>;
<a name="l01216"></a>01216                                 cin &gt;&gt; fname;
<a name="l01217"></a>01217                                 pspm = <span class="keyword">new</span> <a class="code" href="classPlotMaker.html" title="Plots stuff to any PlotUtils graphics context.">PlotMaker</a>( <span class="stringliteral">&quot;PS&quot;</span>, fname.c_str() );
<a name="l01218"></a>01218                                 pspm-&gt;setAxisBox( *hires_cam );
<a name="l01219"></a>01219                                 pspm-&gt;plot( *hires_cam, hires_adc, 
<a name="l01220"></a>01220                                             hires_peds, hires_cleanpixels,
<a name="l01221"></a>01221                                             PlotMaker::CAMERA_IMAGE);
<a name="l01222"></a>01222                                 <span class="keywordflow">if</span> (interactive_params)
<a name="l01223"></a>01223                                     pspm-&gt;plot( param );
<a name="l01224"></a>01224                                 <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#a4bdb5240f8897d53b71ea7bb1beb1393" title="flag to enable muon calibration">muoncalibrate</a>) pspm-&gt;plot( mparam );
<a name="l01225"></a>01225                                 pspm-&gt;<a class="code" href="classPlotMaker.html#a7a63b2f17f113ee6b880aebf1cba1d91" title="Plot a set of axes around the AxisBox region.">plotAxes</a>();
<a name="l01226"></a>01226                                 pm-&gt;plotTitle(<span class="stringliteral">&quot;Filtered Camera image - &quot;</span>+
<a name="l01227"></a>01227                                               header.<a class="code" href="structHeaderRecord.html#abe54c31e39ebf8b8b6e642aa9eb1d33e" title="name of the source">sourcename</a>);
<a name="l01228"></a>01228                                 <span class="keyword">delete</span> pspm;
<a name="l01229"></a>01229                             }
<a name="l01230"></a>01230                             <span class="keywordflow">else</span> cout &lt;&lt; <span class="stringliteral">&quot;Image Filter is disabled&quot;</span>&lt;&lt;endl;
<a name="l01231"></a>01231                             <span class="keywordflow">break</span>;
<a name="l01232"></a>01232 
<a name="l01233"></a>01233                         <span class="keywordflow">case</span> <span class="charliteral">&#39;d&#39;</span>:
<a name="l01234"></a>01234                             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;100; k++) {
<a name="l01235"></a>01235                                 adc[k] -= 0.3*adc[k];
<a name="l01236"></a>01236                             }
<a name="l01237"></a>01237                             <span class="keywordflow">break</span>;
<a name="l01238"></a>01238                         <span class="keywordflow">case</span> <span class="charliteral">&#39;r&#39;</span>:
<a name="l01239"></a>01239                             <span class="keywordflow">break</span>;
<a name="l01240"></a>01240                         <span class="keywordflow">case</span> <span class="charliteral">&#39;i&#39;</span>:
<a name="l01241"></a>01241                             cout &lt;&lt; <span class="stringliteral">&quot;ENTER NEW MAX ADC VALUE (-1 for auto):&quot;</span>;
<a name="l01242"></a>01242                             cin &gt;&gt; answer;
<a name="l01243"></a>01243                             pm-&gt;setPixelScale(atoi(answer.c_str()));
<a name="l01244"></a>01244                             <span class="keywordflow">break</span>;
<a name="l01245"></a>01245                         <span class="keywordflow">case</span> <span class="charliteral">&#39;m&#39;</span>:
<a name="l01246"></a>01246                             <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#a4bdb5240f8897d53b71ea7bb1beb1393" title="flag to enable muon calibration">muoncalibrate</a>==<span class="keyword">true</span>){
<a name="l01247"></a>01247                                 interactive_muon = <span class="keyword">true</span>;
<a name="l01248"></a>01248                                 tempstr = <span class="stringliteral">&quot;n&quot;</span>;
<a name="l01249"></a>01249                             }
<a name="l01250"></a>01250                             <span class="keywordflow">else</span> {
<a name="l01251"></a>01251                                 cout &lt;&lt; <span class="stringliteral">&quot;MuonCalibration is currently &quot;</span>
<a name="l01252"></a>01252                                      &lt;&lt; <span class="stringliteral">&quot;disabled! &quot;</span> &lt;&lt; endl;
<a name="l01253"></a>01253                             }
<a name="l01254"></a>01254                             <span class="keywordflow">break</span>;
<a name="l01255"></a>01255                         <span class="keywordflow">case</span> <span class="charliteral">&#39;,&#39;</span>:
<a name="l01256"></a>01256                             goodmuons &lt;&lt; param.<a class="code" href="structImageParameterization.html#a3524379a51b511ce132fb97d66e6028b" title="Event number for debugging.">event_number</a> &lt;&lt; <span class="stringliteral">&quot; &quot;</span> 
<a name="l01257"></a>01257                                       &lt;&lt;mparam &lt;&lt; endl;
<a name="l01258"></a>01258                             cout &lt;&lt; <span class="stringliteral">&quot;Saved event to goodmuons.txt&quot;</span>&lt;&lt;endl;
<a name="l01259"></a>01259                             <span class="keywordflow">break</span>;
<a name="l01260"></a>01260                         <span class="keywordflow">case</span> <span class="charliteral">&#39;p&#39;</span>:
<a name="l01261"></a>01261                             cout &lt;&lt; <span class="stringliteral">&quot;CHOOSE PLOT TYPE: 1) image 2) peds &quot;</span>
<a name="l01262"></a>01262                                  &lt;&lt; <span class="stringliteral">&quot;3) ped disps 4) tube nums: &quot;</span>;
<a name="l01263"></a>01263                             cin &gt;&gt; answer;
<a name="l01264"></a>01264                             <span class="keywordflow">switch</span> ( atoi(answer.c_str())){
<a name="l01265"></a>01265                             <span class="keywordflow">case</span> 1:
<a name="l01266"></a>01266                                 interactive_disptype=PlotMaker::CAMERA_IMAGE;
<a name="l01267"></a>01267                                 <span class="keywordflow">break</span>;
<a name="l01268"></a>01268                             <span class="keywordflow">case</span> 2:
<a name="l01269"></a>01269                                 interactive_disptype=PlotMaker::CAMERA_PEDS;
<a name="l01270"></a>01270                                 <span class="keywordflow">break</span>;
<a name="l01271"></a>01271                             <span class="keywordflow">case</span> 3:
<a name="l01272"></a>01272                                 interactive_disptype=
<a name="l01273"></a>01273                                     PlotMaker::CAMERA_PEDDISPS;
<a name="l01274"></a>01274                                 <span class="keywordflow">break</span>;
<a name="l01275"></a>01275                             <span class="keywordflow">case</span> 4:
<a name="l01276"></a>01276                                 interactive_disptype=
<a name="l01277"></a>01277                                     PlotMaker::CAMERA_TUBENUMS;
<a name="l01278"></a>01278                                 <span class="keywordflow">break</span>;
<a name="l01279"></a>01279                             <span class="keywordflow">default</span>:
<a name="l01280"></a>01280                                 cout &lt;&lt; <span class="stringliteral">&quot;INVALID OPTION: &quot;</span>&lt;&lt;answer&lt;&lt;<span class="stringliteral">&quot;!&quot;</span>&lt;&lt;endl;
<a name="l01281"></a>01281                             }
<a name="l01282"></a>01282                             <span class="keywordflow">break</span>;
<a name="l01283"></a>01283                         <span class="keywordflow">case</span> <span class="charliteral">&#39;R&#39;</span>:
<a name="l01284"></a>01284                             interactive_rotate = !interactive_rotate;
<a name="l01285"></a>01285                             <span class="keywordflow">break</span>;
<a name="l01286"></a>01286                         <span class="keywordflow">case</span> <span class="charliteral">&#39;n&#39;</span>:
<a name="l01287"></a>01287                             <span class="keywordflow">break</span>;  <span class="comment">// don&#39;t print a warning</span>
<a name="l01288"></a>01288                         <span class="keywordflow">default</span>:
<a name="l01289"></a>01289                             cout &lt;&lt; <span class="stringliteral">&quot;Unknown command &#39;&quot;</span>&lt;&lt; tempstr &lt;&lt; <span class="stringliteral">&quot;&#39;&quot;</span>&lt;&lt; endl;
<a name="l01290"></a>01290                         }
<a name="l01291"></a>01291                             
<a name="l01292"></a>01292                     } <span class="comment">// End while</span>
<a name="l01293"></a>01293 
<a name="l01294"></a>01294                 } <span class="comment">// End if interactive</span>
<a name="l01295"></a>01295                 <span class="keywordflow">else</span> {
<a name="l01296"></a>01296                     <span class="comment">// non-interactive, just display</span>
<a name="l01297"></a>01297                     pm-&gt;setAxisBox( *curcam );
<a name="l01298"></a>01298                     pm-&gt;plot( *curcam, adc, tel[curtel].combinedpeds, cleanpixels,
<a name="l01299"></a>01299                               interactive_disptype);
<a name="l01300"></a>01300                     pm-&gt;plot( param );
<a name="l01301"></a>01301                     <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#a4bdb5240f8897d53b71ea7bb1beb1393" title="flag to enable muon calibration">muoncalibrate</a>) pm-&gt;plot( mparam );
<a name="l01302"></a>01302                     pm-&gt;<a class="code" href="classPlotMaker.html#a7a63b2f17f113ee6b880aebf1cba1d91" title="Plot a set of axes around the AxisBox region.">plotAxes</a>();
<a name="l01303"></a>01303                     pm-&gt;newPage();
<a name="l01304"></a>01304                 } <span class="comment">// End else not interactive</span>
<a name="l01305"></a>01305                         
<a name="l01306"></a>01306 
<a name="l01307"></a>01307             } <span class="comment">// End if diplay enabled</span>
<a name="l01308"></a>01308 
<a name="l01309"></a>01309             <span class="comment">// -----------------------------------------</span>
<a name="l01310"></a>01310             <span class="comment">// derotate the point of origin and centroid</span>
<a name="l01311"></a>01311             <span class="comment">// -----------------------------------------</span>
<a name="l01312"></a>01312             
<a name="l01313"></a>01313             <span class="comment">// write out the angles every so often for diagnostics:</span>
<a name="l01314"></a>01314             <span class="keywordflow">if</span> (n[curtel] % 256==0) {
<a name="l01315"></a>01315                 anglefile[curtel].precision(15);
<a name="l01316"></a>01316                 anglefile[curtel] &lt;&lt; (<span class="keyword">event</span>.gpstime-gpstime_start)*24*60&lt;&lt; <span class="stringliteral">&quot;\t&quot;</span> 
<a name="l01317"></a>01317                                   &lt;&lt; _theta *180.0/M_PI  &lt;&lt; <span class="stringliteral">&quot;\t&quot;</span>
<a name="l01318"></a>01318                                   &lt;&lt; _el * 180.0/M_PI &lt;&lt; <span class="stringliteral">&quot;\t&quot;</span>
<a name="l01319"></a>01319                                   &lt;&lt; _az * 180.0/M_PI 
<a name="l01320"></a>01320                                   &lt;&lt; endl;
<a name="l01321"></a>01321             }
<a name="l01322"></a>01322 
<a name="l01323"></a>01323             <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#a16057cde5b36b7c77e7ea7549049e540" title="flag to enable derotation">derotation</a> == <span class="keyword">true</span>) {
<a name="l01324"></a>01324 
<a name="l01325"></a>01325                 derotatePoint( _theta, param.<a class="code" href="structHillasParameterization.html#a32d9137a17d9b447695f50320697e9be" title="First point of origin (x,y)">point_of_origin_a</a> ); 
<a name="l01326"></a>01326                 derotatePoint( _theta, param.<a class="code" href="structHillasParameterization.html#a75b3e07788abe724e458ed14aa1339c9" title="second point of origin (x,y)">point_of_origin_b</a> ); 
<a name="l01327"></a>01327                 derotatePoint( _theta, param.<a class="code" href="structHillasParameterization.html#ae9b74033dd0e0671e59656a100358d5a" title="Center position of shower.">centroid</a> );
<a name="l01328"></a>01328 
<a name="l01329"></a>01329             }
<a name="l01330"></a>01330 
<a name="l01331"></a>01331             param.<a class="code" href="structHillasParameterization.html#a8a07467067d17d6430677bcae47b3c58" title="is this from an on run? (added by henric)">on</a>=ison;
<a name="l01332"></a>01332 
<a name="l01333"></a>01333             <span class="comment">// ----------------------------------------- </span>
<a name="l01334"></a>01334             <span class="comment">// Write parameters to disk and update</span>
<a name="l01335"></a>01335             <span class="comment">// diagnostic histograms</span>
<a name="l01336"></a>01336             <span class="comment">// ----------------------------------------- </span>
<a name="l01337"></a>01337 
<a name="l01338"></a>01338             <span class="keywordflow">if</span> (data-&gt;getType()==RawDataReader::SIM) {
<a name="l01339"></a>01339                 cursimshower=((<a class="code" href="classRawDataReaderSim.html" title="Implementation of RawDataReader for simulation .tubes files.">RawDataReaderSim</a>*)(data))-&gt;getSimShowerRecord();
<a name="l01340"></a>01340                 param.<a class="code" href="structImageParameterization.html#a87de679fb2937a5f1efe38b2c68dea44" title="simulation info">sim</a> = cursimshower;
<a name="l01341"></a>01341             }
<a name="l01342"></a>01342             <span class="keywordflow">else</span> {
<a name="l01343"></a>01343                 memset( &amp;(param.<a class="code" href="structImageParameterization.html#a87de679fb2937a5f1efe38b2c68dea44" title="simulation info">sim</a>), 0, <span class="keyword">sizeof</span>(<a class="code" href="structSimShowerRecord.html">SimShowerRecord</a>));
<a name="l01344"></a>01344             }
<a name="l01345"></a>01345             
<a name="l01346"></a>01346             writer-&gt;writeParameterization( param );
<a name="l01347"></a>01347                     
<a name="l01348"></a>01348             <span class="keywordflow">if</span> (param.<a class="code" href="structImageParameterization.html#a413610cc7481fd731c8b6a0e30d741a0" title="was this event properly parameterized?">invalid</a>==0) {
<a name="l01349"></a>01349                 tel[curtel].lensize-&gt;increment( param.<a class="code" href="structHillasParameterization.html#a2be5e9e0885f119cf5df38aa77777542" title="length over size">length_over_size</a> );
<a name="l01350"></a>01350                 tel[curtel].pictubes-&gt;increment( param.<a class="code" href="structHillasParameterization.html#a973a0f8fbe33182e15cf8d585dba5657" title="number of tubes in the picture">pixels_in_picture</a> );
<a name="l01351"></a>01351                 tel[curtel].phihist-&gt;increment( param.<a class="code" href="structHillasParameterization.html#a0592a9cf31f63ed2a19ae4022056981c" title="Angle that centroid makes with x-axis.">phi</a> );
<a name="l01352"></a>01352                 tel[curtel].alphahist-&gt;increment( param.<a class="code" href="structHillasParameterization.html#a1e908584f4dc7d52c573608b996c86cc" title="Alpha angle (-Pi/2..Pi/2)">alpha</a>*180.0/M_PI );
<a name="l01353"></a>01353                 tel[curtel].lengthhist-&gt;increment( param.<a class="code" href="structHillasParameterization.html#ad2aa423ddc75ba1e108fa31878ed756a" title="Length of ellipse.">length</a> );
<a name="l01354"></a>01354                 tel[curtel].widthhist-&gt;increment( param.<a class="code" href="structHillasParameterization.html#aadb8f3295cbf2b2e0a60c44ede3de8b2" title="width of ellipse">width</a> );
<a name="l01355"></a>01355                 tel[curtel].rawrate-&gt;increment((param.<a class="code" href="structImageParameterization.html#a169f947f6ed26a3097243c8c42c41a64" title="calibrated gps time">gpstime</a>-gpstime_start)*24*60 );
<a name="l01356"></a>01356                 tel[curtel].disthist-&gt;increment( param.<a class="code" href="structHillasParameterization.html#a3b247cc3ffeeea0972a94f2f6575a5a2" title="distance to centroid">distance</a> );
<a name="l01357"></a>01357                 tel[curtel].sizehist-&gt;increment( param.<a class="code" href="structHillasParameterization.html#abec8385793292018263164ea18601219" title="total signal">size</a> );
<a name="l01358"></a>01358                 tel[curtel].deltat-&gt;increment( param.<a class="code" href="structImageParameterization.html#a169f947f6ed26a3097243c8c42c41a64" title="calibrated gps time">gpstime</a>-gpstime_last );
<a name="l01359"></a>01359                 tel[curtel].max2hist-&gt;increment( param.<a class="code" href="structHillasParameterization.html#a7d8e7d294ee5e6dc185257c9e1adb994" title="The three largest adc values.">max</a>[2] );
<a name="l01360"></a>01360                 tel[curtel].centroids-&gt;addHist( param.<a class="code" href="structHillasParameterization.html#ae9b74033dd0e0671e59656a100358d5a" title="Center position of shower.">centroid</a>.<a class="code" href="structCoordinate__t.html#a4e83334eabbe707ae5433ff65f60a475" title="X coordinate.">x</a>,param.<a class="code" href="structHillasParameterization.html#ae9b74033dd0e0671e59656a100358d5a" title="Center position of shower.">centroid</a>.<a class="code" href="structCoordinate__t.html#abbc494db10b22a87bede79c5b62be604" title="Y coordinate.">y</a>,1);
<a name="l01361"></a>01361             }
<a name="l01362"></a>01362 
<a name="l01363"></a>01363             gpstime_last = param.<a class="code" href="structImageParameterization.html#a169f947f6ed26a3097243c8c42c41a64" title="calibrated gps time">gpstime</a>;
<a name="l01364"></a>01364             n_trig[curtel]++;
<a name="l01365"></a>01365 
<a name="l01366"></a>01366             <span class="keywordflow">if</span> (n_trig[curtel] == 1) {
<a name="l01367"></a>01367                 <span class="comment">// this is the first trigger event, so store the starting</span>
<a name="l01368"></a>01368                 <span class="comment">// zenith angle</span>
<a name="l01369"></a>01369                 <span class="comment">// TODO: make multi-telescope!</span>
<a name="l01370"></a>01370                 start_el = _el;
<a name="l01371"></a>01371             }
<a name="l01372"></a>01372 
<a name="l01373"></a>01373         }
<a name="l01374"></a>01374         <span class="keywordflow">else</span> {
<a name="l01375"></a>01375             <span class="comment">// not a trigger event</span>
<a name="l01376"></a>01376             n_other[curtel]++;
<a name="l01377"></a>01377         }
<a name="l01378"></a>01378        
<a name="l01379"></a>01379 
<a name="l01380"></a>01380         <span class="comment">// --------------------------------------------------------</span>
<a name="l01381"></a>01381         <span class="comment">// Output progress info if requested</span>
<a name="l01382"></a>01382         <span class="comment">// --------------------------------------------------------</span>
<a name="l01383"></a>01383         <span class="keywordflow">if</span> (_is_verbose_enabled &amp;&amp; (_is_interactive == <span class="keyword">false</span>) ) {
<a name="l01384"></a>01384             <span class="keywordflow">if</span> (count%256 == 0)
<a name="l01385"></a>01385                 progress.print( count );
<a name="l01386"></a>01386             <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#a5536266accd3a3aae79224e8db27941d" title="Smooth images during.">image_filter</a>==<span class="keyword">true</span> &amp;&amp; count%16==0)
<a name="l01387"></a>01387                 progress.print(count);
<a name="l01388"></a>01388         }
<a name="l01389"></a>01389         
<a name="l01390"></a>01390         <span class="keywordflow">if</span> (interactive_hold == <span class="keyword">false</span>) {
<a name="l01391"></a>01391             n[curtel]++;
<a name="l01392"></a>01392             count++;
<a name="l01393"></a>01393             _event_number++;
<a name="l01394"></a>01394         }
<a name="l01395"></a>01395 
<a name="l01396"></a>01396     }
<a name="l01397"></a>01397 
<a name="l01398"></a>01398     <span class="comment">// DEBUGGING:</span>
<a name="l01399"></a>01399 <span class="comment">//     rawfile.close() ;</span>
<a name="l01400"></a>01400 
<a name="l01401"></a>01401     progress.printClear();
<a name="l01402"></a>01402 
<a name="l01403"></a>01403     <span class="comment">// store the end time in the header to pass on to the cutter</span>
<a name="l01404"></a>01404     <span class="comment">// (this is needed for rate binning)</span>
<a name="l01405"></a>01405     
<a name="l01406"></a>01406     header.<a class="code" href="structHeaderRecord.html#ae69ec66d5e5904776cb35ea3f8d28729" title="ending time (MJD)">endtime</a> = <span class="keyword">event</span>.gpstime;
<a name="l01407"></a>01407     header.<a class="code" href="structHeaderRecord.html#ada2acccb51b80a28f583c987fc72024a" title="Average elevation (duh!)">average_elevation</a> = (start_el + _el) /2.0;
<a name="l01408"></a>01408 
<a name="l01409"></a>01409     <span class="keywordflow">if</span> (_is_verbose_enabled) {
<a name="l01410"></a>01410         cout &lt;&lt; <span class="stringliteral">&quot;Summary: &quot;</span> &lt;&lt; endl
<a name="l01411"></a>01411              &lt;&lt; <span class="stringliteral">&quot;\tTRIG EVENTS : &quot;</span> ;
<a name="l01412"></a>01412         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel;k++) cout &lt;&lt; n_trig[k] &lt;&lt; <span class="stringliteral">&quot; &quot;</span>;
<a name="l01413"></a>01413         cout &lt;&lt; endl
<a name="l01414"></a>01414              &lt;&lt; <span class="stringliteral">&quot;\tOTHER EVENTS: &quot;</span> ;
<a name="l01415"></a>01415         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel;k++) cout &lt;&lt; n_other[k] &lt;&lt; <span class="stringliteral">&quot; &quot;</span>;
<a name="l01416"></a>01416         cout &lt;&lt; endl
<a name="l01417"></a>01417              &lt;&lt; <span class="stringliteral">&quot;\tTOTAL EVENTS: &quot;</span> ;
<a name="l01418"></a>01418         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel;k++) cout &lt;&lt; n[k] &lt;&lt; <span class="stringliteral">&quot; &quot;</span>;
<a name="l01419"></a>01419         cout &lt;&lt; endl
<a name="l01420"></a>01420              &lt;&lt; <span class="stringliteral">&quot;\tLIVETIME    : &quot;</span> &lt;&lt; setprecision(4)
<a name="l01421"></a>01421              &lt;&lt;  <span class="keyword">event</span>.livetime/60.0 
<a name="l01422"></a>01422              &lt;&lt; <span class="stringliteral">&quot; min&quot;</span>&lt;&lt; endl
<a name="l01423"></a>01423              &lt;&lt; <span class="stringliteral">&quot;\tELAPSED GPS : &quot;</span> &lt;&lt; setprecision(10) 
<a name="l01424"></a>01424              &lt;&lt; (header.<a class="code" href="structHeaderRecord.html#ae69ec66d5e5904776cb35ea3f8d28729" title="ending time (MJD)">endtime</a>-gpstime_start)*24*60&lt;&lt;<span class="stringliteral">&quot; min&quot;</span>&lt;&lt; endl
<a name="l01425"></a>01425              &lt;&lt; <span class="stringliteral">&quot;\tDEAD TIME   : &quot;</span> 
<a name="l01426"></a>01426              &lt;&lt; (header.<a class="code" href="structHeaderRecord.html#ae69ec66d5e5904776cb35ea3f8d28729" title="ending time (MJD)">endtime</a>-gpstime_start)*24*60- <span class="keyword">event</span>.livetime/60.0 
<a name="l01427"></a>01427              &lt;&lt; <span class="stringliteral">&quot; min &quot;</span>
<a name="l01428"></a>01428              &lt;&lt;endl&lt;&lt;endl;
<a name="l01429"></a>01429 
<a name="l01430"></a>01430         runinfo &lt;&lt; <span class="stringliteral">&quot;Summary: &quot;</span> &lt;&lt; endl
<a name="l01431"></a>01431              &lt;&lt; <span class="stringliteral">&quot;\tTRIG EVENTS : &quot;</span> ;
<a name="l01432"></a>01432         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel;k++) runinfo &lt;&lt; n_trig[k] &lt;&lt; <span class="stringliteral">&quot; &quot;</span>;
<a name="l01433"></a>01433         runinfo &lt;&lt; endl
<a name="l01434"></a>01434              &lt;&lt; <span class="stringliteral">&quot;\tOTHER EVENTS: &quot;</span> ;
<a name="l01435"></a>01435         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel;k++) runinfo &lt;&lt; n_other[k] &lt;&lt; <span class="stringliteral">&quot; &quot;</span>;
<a name="l01436"></a>01436         runinfo &lt;&lt; endl
<a name="l01437"></a>01437              &lt;&lt; <span class="stringliteral">&quot;\tTOTAL EVENTS: &quot;</span> ;
<a name="l01438"></a>01438         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel;k++) runinfo &lt;&lt; n[k] &lt;&lt; <span class="stringliteral">&quot; &quot;</span>;
<a name="l01439"></a>01439         runinfo &lt;&lt; endl
<a name="l01440"></a>01440              &lt;&lt; <span class="stringliteral">&quot;\tLIVETIME    : &quot;</span> &lt;&lt; setprecision(4)
<a name="l01441"></a>01441              &lt;&lt;  <span class="keyword">event</span>.livetime/60.0 
<a name="l01442"></a>01442              &lt;&lt; <span class="stringliteral">&quot; min&quot;</span>&lt;&lt; endl
<a name="l01443"></a>01443              &lt;&lt; <span class="stringliteral">&quot;\tELAPSED GPS : &quot;</span> &lt;&lt; setprecision(10) 
<a name="l01444"></a>01444              &lt;&lt; (header.<a class="code" href="structHeaderRecord.html#ae69ec66d5e5904776cb35ea3f8d28729" title="ending time (MJD)">endtime</a>-gpstime_start)*24*60&lt;&lt;<span class="stringliteral">&quot; min&quot;</span>&lt;&lt; endl
<a name="l01445"></a>01445              &lt;&lt; <span class="stringliteral">&quot;\tDEAD TIME   : &quot;</span> 
<a name="l01446"></a>01446              &lt;&lt; (header.<a class="code" href="structHeaderRecord.html#ae69ec66d5e5904776cb35ea3f8d28729" title="ending time (MJD)">endtime</a>-gpstime_start)*24*60- <span class="keyword">event</span>.livetime/60.0 
<a name="l01447"></a>01447              &lt;&lt; <span class="stringliteral">&quot; min &quot;</span>
<a name="l01448"></a>01448              &lt;&lt;endl&lt;&lt;endl;
<a name="l01449"></a>01449 
<a name="l01450"></a>01450             
<a name="l01451"></a>01451     }
<a name="l01452"></a>01452     
<a name="l01453"></a>01453     runinfo.close();
<a name="l01454"></a>01454 
<a name="l01455"></a>01455 
<a name="l01456"></a>01456     <span class="comment">//======================================================</span>
<a name="l01457"></a>01457     <span class="comment">// generate diagnostic plots and brightness map</span>
<a name="l01458"></a>01458     <span class="comment">//======================================================</span>
<a name="l01459"></a>01459 
<a name="l01460"></a>01460     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel; k++) {
<a name="l01461"></a>01461         <span class="keywordtype">char</span> telid[100];
<a name="l01462"></a>01462         sprintf( telid, <span class="stringliteral">&quot;-%03d&quot;</span>, k );
<a name="l01463"></a>01463         tel[k].lensize-&gt;save(dir+<span class="keywordtype">id</span>+telid+<span class="stringliteral">&quot;-raw-lensize&quot;</span>);
<a name="l01464"></a>01464         tel[k].pictubes-&gt;save(dir+<span class="keywordtype">id</span>+telid+<span class="stringliteral">&quot;-raw-pictubes&quot;</span>);
<a name="l01465"></a>01465         tel[k].tubehits-&gt;save(dir+<span class="keywordtype">id</span>+telid+<span class="stringliteral">&quot;-tubehits&quot;</span>);
<a name="l01466"></a>01466         tel[k].phihist-&gt;save(dir+<span class="keywordtype">id</span>+telid+<span class="stringliteral">&quot;-raw-phi&quot;</span>);
<a name="l01467"></a>01467         tel[k].alphahist-&gt;save(dir+<span class="keywordtype">id</span>+telid+<span class="stringliteral">&quot;-raw-alpha&quot;</span>);
<a name="l01468"></a>01468         tel[k].lengthhist-&gt;save(dir+<span class="keywordtype">id</span>+telid+<span class="stringliteral">&quot;-raw-length&quot;</span>);
<a name="l01469"></a>01469         tel[k].widthhist-&gt;save(dir+<span class="keywordtype">id</span>+telid+<span class="stringliteral">&quot;-raw-width&quot;</span>);
<a name="l01470"></a>01470         tel[k].rawrate-&gt;save( dir+<span class="keywordtype">id</span>+telid+<span class="stringliteral">&quot;-raw-rate&quot;</span> );
<a name="l01471"></a>01471         tel[k].sizehist-&gt;save( dir+<span class="keywordtype">id</span>+telid+<span class="stringliteral">&quot;-raw-size&quot;</span> );
<a name="l01472"></a>01472         tel[k].disthist-&gt;save( dir+<span class="keywordtype">id</span>+telid+<span class="stringliteral">&quot;-raw-dist&quot;</span> );
<a name="l01473"></a>01473         tel[k].deltat-&gt;save( dir+<span class="keywordtype">id</span>+telid+<span class="stringliteral">&quot;-deltat&quot;</span> );
<a name="l01474"></a>01474         tel[k].centroids-&gt;save( dir+<span class="keywordtype">id</span>+telid+<span class="stringliteral">&quot;-centroids&quot;</span> );
<a name="l01475"></a>01475         tel[k].max2hist-&gt;save( dir+<span class="keywordtype">id</span>+telid+<span class="stringliteral">&quot;-raw-max2&quot;</span> );
<a name="l01476"></a>01476 
<a name="l01477"></a>01477         <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#a4bdb5240f8897d53b71ea7bb1beb1393" title="flag to enable muon calibration">muoncalibrate</a>) {
<a name="l01478"></a>01478             tel[k].musoalhist-&gt;save(dir+<span class="keywordtype">id</span>+telid+<span class="stringliteral">&quot;-muon-soal&quot;</span>);
<a name="l01479"></a>01479             tel[k].musizehist-&gt;save(dir+<span class="keywordtype">id</span>+telid+<span class="stringliteral">&quot;-muon-size&quot;</span>);
<a name="l01480"></a>01480             tel[k].mulensizehist-&gt;save(dir+<span class="keywordtype">id</span>+telid+<span class="stringliteral">&quot;-muon-lensize&quot;</span>);
<a name="l01481"></a>01481             tel[k].mugainhist-&gt;save(dir+<span class="keywordtype">id</span>+telid+<span class="stringliteral">&quot;-muon-gain&quot;</span>);
<a name="l01482"></a>01482             tel[k].muonnesshist-&gt;save( dir+<span class="keywordtype">id</span>+telid+<span class="stringliteral">&quot;-raw-muonness&quot;</span>);
<a name="l01483"></a>01483         }
<a name="l01484"></a>01484 
<a name="l01485"></a>01485         <span class="comment">// TODO: last arg is telescope_id</span>
<a name="l01486"></a>01486         generatePlots( <span class="keywordtype">id</span>, ri.<a class="code" href="classRunInfo.html#a4ed3be46e78ed8c602635ea1397d43e5" title="id of nitrogen gain run">n2id</a>, ri.<a class="code" href="classRunInfo.html#ae87a6169dbd7e2cf46acb700179410bc" title="directory to write ped/gain data">cachedir</a>, k );
<a name="l01487"></a>01487     }
<a name="l01488"></a>01488 
<a name="l01489"></a>01489     <span class="comment">// generate sky brightness/tubeoffness maps if it&#39;s an on or track run</span>
<a name="l01490"></a>01490     <span class="comment">// (no need to do for off, since it will be negative of on)</span>
<a name="l01491"></a>01491 
<a name="l01492"></a>01492     <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == ri.<a class="code" href="classRunInfo.html#a75fe835214afa525cc0a5bced31cbe57" title="id of on/tracking run">onid</a> &amp;&amp; dtype != RawDataReader::SIM) {
<a name="l01493"></a>01493         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel; k++) {
<a name="l01494"></a>01494             cout &lt;&lt; <span class="stringliteral">&quot;Generating sky brightness &amp; tubeoffness maps for &quot;</span> 
<a name="l01495"></a>01495                  &lt;&lt; <span class="stringliteral">&quot;telescope &quot;</span>&lt;&lt; k &lt;&lt; <span class="stringliteral">&quot; run &quot;</span>&lt;&lt; <span class="keywordtype">id</span> 
<a name="l01496"></a>01496                  &lt;&lt;<span class="stringliteral">&quot;...&quot;</span>&lt;&lt; endl;
<a name="l01497"></a>01497             mapSkyBrightness( <span class="keywordtype">id</span>, tel[k].peds, tel[k].padpeds, 
<a name="l01498"></a>01498                               tel[k].gains, header, 
<a name="l01499"></a>01499                               (event.gpstime+gpstime_start)/2.0,
<a name="l01500"></a>01500                               ri.<a class="code" href="classRunInfo.html#a16057cde5b36b7c77e7ea7549049e540" title="flag to enable derotation">derotation</a>,array.getCamera(k),k );
<a name="l01501"></a>01501 
<a name="l01502"></a>01502         }
<a name="l01503"></a>01503     }
<a name="l01504"></a>01504     
<a name="l01505"></a>01505     <span class="comment">// output a warning if too many tubes are turned off since the</span>
<a name="l01506"></a>01506     <span class="comment">// skybrightness map will be problematic in the pointing</span>
<a name="l01507"></a>01507     <span class="comment">// check later on</span>
<a name="l01508"></a>01508 
<a name="l01509"></a>01509     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel; k++) {
<a name="l01510"></a>01510         <span class="keywordtype">int</span> ntubesoff = 0;
<a name="l01511"></a>01511         curcam = array.getCamera(k);
<a name="l01512"></a>01512         <span class="keywordflow">for</span> (i=curcam-&gt;getFirstPixel(); i&lt;=curcam-&gt;<a class="code" href="classCamera.html#a233576d02d136e96d8886627c2512afc" title="first pixel # to use">getLastPixel</a>(); i++) {
<a name="l01513"></a>01513             <span class="keywordflow">if</span> (tel[k].combinedpeds[i].type == Pedestal::TUBEOFF) 
<a name="l01514"></a>01514                 ntubesoff++;
<a name="l01515"></a>01515         }
<a name="l01516"></a>01516         
<a name="l01517"></a>01517         cout &lt;&lt; <span class="stringliteral">&quot;Tubes physically turned off: &quot;</span>&lt;&lt; ntubesoff &lt;&lt; endl;
<a name="l01518"></a>01518         <span class="keywordflow">if</span> (ntubesoff &gt;= 10 ) {
<a name="l01519"></a>01519             logger-&gt;<a class="code" href="classLogger.html#a97d14a6dbc7c4490cbe590a0925bc42d" title="Writes warning string to the log and to stdout.">printf</a>(<span class="stringliteral">&quot;Pointing checks may be invalid for telescope %d &quot;</span>
<a name="l01520"></a>01520                            <span class="stringliteral">&quot;run %s since &quot;</span>
<a name="l01521"></a>01521                            <span class="stringliteral">&quot;%d tubes were physically turned off&quot;</span>, k,
<a name="l01522"></a>01522                            <span class="keywordtype">id</span>.c_str(),ntubesoff);
<a name="l01523"></a>01523         } 
<a name="l01524"></a>01524     }
<a name="l01525"></a>01525 
<a name="l01526"></a>01526 
<a name="l01527"></a>01527     <span class="comment">//======================================================</span>
<a name="l01528"></a>01528     <span class="comment">// clean up</span>
<a name="l01529"></a>01529     <span class="comment">//======================================================</span>
<a name="l01530"></a>01530 
<a name="l01531"></a>01531     writer-&gt;<a class="code" href="classParamDataWriter.html#a0a70e79b1d085e10036d5a0d437e624b" title="Write out header.">writeHeader</a>( header );
<a name="l01532"></a>01532 
<a name="l01533"></a>01533     <span class="keywordflow">if</span> (_is_verbose_enabled) {
<a name="l01534"></a>01534         cout &lt;&lt; <span class="stringliteral">&quot;========================================&quot;</span>
<a name="l01535"></a>01535              &lt;&lt; <span class="stringliteral">&quot;========================================&quot;</span>
<a name="l01536"></a>01536              &lt;&lt; endl&lt;&lt;endl;
<a name="l01537"></a>01537     }
<a name="l01538"></a>01538 
<a name="l01539"></a>01539     <span class="comment">// Clean out the cached file if requested</span>
<a name="l01540"></a>01540 
<a name="l01541"></a>01541     <span class="keywordflow">if</span> (_is_cleanup_enabled)
<a name="l01542"></a>01542         datafactory-&gt;<a class="code" href="classRawDataReaderFactory.html#a67fb5818c0d0f526c3ac165ada0e5173" title="Purge the cache of stored files.">clearCache</a>(ri.<a class="code" href="classRunInfo.html#ae87a6169dbd7e2cf46acb700179410bc" title="directory to write ped/gain data">cachedir</a>);
<a name="l01543"></a>01543 
<a name="l01544"></a>01544 
<a name="l01545"></a>01545     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel; k++) 
<a name="l01546"></a>01546         anglefile[k].close();
<a name="l01547"></a>01547     
<a name="l01548"></a>01548     <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#a4bdb5240f8897d53b71ea7bb1beb1393" title="flag to enable muon calibration">muoncalibrate</a>){
<a name="l01549"></a>01549         muonfile.close();
<a name="l01550"></a>01550         goodmuons.close();
<a name="l01551"></a>01551     }
<a name="l01552"></a>01552 
<a name="l01553"></a>01553     <span class="keywordflow">if</span> (pm) <span class="keyword">delete</span> pm;
<a name="l01554"></a>01554     <span class="keywordflow">if</span> (hires_pm)<span class="keyword">delete</span> hires_pm;
<a name="l01555"></a>01555     <span class="keywordflow">if</span> (hires_cam) <span class="keyword">delete</span> hires_cam;
<a name="l01556"></a>01556 
<a name="l01557"></a>01557     <span class="keyword">delete</span> writer;
<a name="l01558"></a>01558     <span class="keyword">delete</span> data;
<a name="l01559"></a>01559 
<a name="l01560"></a>01560 }
<a name="l01561"></a>01561 
<a name="l01565"></a>01565 <span class="keywordtype">void</span>
<a name="l01566"></a>01566 Parameterizer::
<a name="l01567"></a>01567 generatePlots( <span class="keywordtype">string</span> &amp;<span class="keywordtype">id</span>, <span class="keywordtype">string</span> &amp;n2id, <span class="keywordtype">string</span> &amp;cachedir, <span class="keywordtype">int</span> telescope_id ) {
<a name="l01568"></a>01568 
<a name="l01569"></a>01569     <span class="keywordtype">string</span> command;
<a name="l01570"></a>01570     <span class="keywordtype">int</span> ret;
<a name="l01571"></a>01571     <span class="keywordtype">char</span> telid[100];
<a name="l01572"></a>01572 
<a name="l01573"></a>01573     sprintf( telid, <span class="stringliteral">&quot;%03d&quot;</span>, telescope_id );
<a name="l01574"></a>01574 
<a name="l01575"></a>01575     cout &lt;&lt; <span class="stringliteral">&quot;Generating diagnostic plots for &quot;</span> &lt;&lt; <span class="keywordtype">id</span> &lt;&lt; <span class="stringliteral">&quot;...&quot;</span> &lt;&lt; endl;
<a name="l01576"></a>01576 
<a name="l01577"></a>01577     command = _wupdir + <span class="stringliteral">&quot;/gen-diag-plots.sh &quot;</span>+_wupdir+<span class="stringliteral">&quot; &quot;</span>
<a name="l01578"></a>01578         +<span class="keywordtype">id</span>+<span class="stringliteral">&quot; &quot;</span>+n2id+<span class="stringliteral">&quot; &quot;</span>+cachedir+<span class="stringliteral">&quot; &quot;</span>+telid;
<a name="l01579"></a>01579     ret = system(command.c_str());
<a name="l01580"></a>01580 
<a name="l01581"></a>01581     <span class="keywordflow">if</span> (ret) {
<a name="l01582"></a>01582         cout &lt;&lt; <span class="stringliteral">&quot;** Plotting failed.  Make sure you have GNUPlot installed&quot;</span>
<a name="l01583"></a>01583              &lt;&lt; endl
<a name="l01584"></a>01584              &lt;&lt; <span class="stringliteral">&quot;** and the plotting scripts are installed in either &quot;</span> 
<a name="l01585"></a>01585              &lt;&lt; _wupdir &lt;&lt; endl 
<a name="l01586"></a>01586              &lt;&lt; <span class="stringliteral">&quot;** or the directory specified by the WUPARAMDIR &quot;</span>
<a name="l01587"></a>01587              &lt;&lt; <span class="stringliteral">&quot;environment variable&quot;</span> &lt;&lt; endl
<a name="l01588"></a>01588              &lt;&lt; endl;
<a name="l01589"></a>01589     }
<a name="l01590"></a>01590 
<a name="l01591"></a>01591 
<a name="l01592"></a>01592 }
<a name="l01593"></a>01593 
<a name="l01594"></a>01594 
<a name="l01609"></a>01609 <span class="keywordtype">void</span> 
<a name="l01610"></a>01610 Parameterizer::
<a name="l01611"></a>01611 mapSkyBrightness( <span class="keyword">const</span> <span class="keywordtype">string</span> &amp;<span class="keywordtype">id</span>, <span class="keyword">const</span> vector&lt;Pedestal&gt; &amp;onpeds, 
<a name="l01612"></a>01612                   <span class="keyword">const</span> vector&lt;Pedestal&gt; &amp;offpeds, <span class="keyword">const</span> Array_t &amp;gain,
<a name="l01613"></a>01613                   <span class="keyword">const</span> <a class="code" href="structRawHeaderRecord.html">RawHeaderRecord</a> &amp;header, <span class="keywordtype">double</span> avg_gpstime,
<a name="l01614"></a>01614                   <span class="keywordtype">bool</span> derotation, <a class="code" href="classCamera.html" title="Contains all operations pertaining to camera data.">Camera</a> *cam, <span class="keywordtype">int</span> telescope_id) {
<a name="l01615"></a>01615     
<a name="l01616"></a>01616     <span class="keyword">const</span> <span class="keywordtype">double</span> DEGPERPIX=0.1; <span class="comment">// degrees per pixel (assuming square pixels)</span>
<a name="l01617"></a>01617     <span class="keyword">const</span> <span class="keywordtype">double</span> SIGR2 = 0.02;  <span class="comment">// something like the RMS^2 of the PSF</span>
<a name="l01618"></a>01618     
<a name="l01619"></a>01619     <a class="code" href="classImage2D.html" title="Representation of a 2-D raster image (for 2D analysis)">Image2D</a> brightmap(39,39);
<a name="l01620"></a>01620     <a class="code" href="classImage2D.html" title="Representation of a 2-D raster image (for 2D analysis)">Image2D</a> tubeoffmap(39,39);
<a name="l01621"></a>01621 
<a name="l01622"></a>01622     Array_t xcoord, ycoord;
<a name="l01623"></a>01623     Array_t pedvardiff;
<a name="l01624"></a>01624     <a class="code" href="structCoordinate__t.html" title="A 2-d coordinate.">Coordinate_t</a> coord;
<a name="l01625"></a>01625     <span class="keywordtype">int</span> i,j,k;
<a name="l01626"></a>01626     <span class="keywordtype">double</span> sky_brightness, tubeoffness;
<a name="l01627"></a>01627     <span class="keywordtype">double</span> r2, gauss_weight;
<a name="l01628"></a>01628     <span class="keywordtype">int</span> nxbins = brightmap.getXDim();
<a name="l01629"></a>01629     <span class="keywordtype">int</span> nybins = brightmap.getYDim();
<a name="l01630"></a>01630 
<a name="l01631"></a>01631     <span class="comment">// calculate the correct derotation angle (theta)</span>
<a name="l01632"></a>01632 
<a name="l01633"></a>01633     updateAngles( avg_gpstime, header );
<a name="l01634"></a>01634 
<a name="l01635"></a>01635     <span class="comment">// precalculate the pedestal variance difference (yes, variances</span>
<a name="l01636"></a>01636     <span class="comment">// not dispersions)</span>
<a name="l01637"></a>01637 
<a name="l01638"></a>01638     pedvardiff.resize(onpeds.size());
<a name="l01639"></a>01639     <span class="keywordflow">for</span> (i=0; i&lt;onpeds.size(); i++) {
<a name="l01640"></a>01640 
<a name="l01641"></a>01641         <span class="keywordflow">if</span> ( (onpeds[i].type == Pedestal::TUBEOFF || 
<a name="l01642"></a>01642               offpeds[i].type == Pedestal::TUBEOFF)
<a name="l01643"></a>01643              ||
<a name="l01644"></a>01644              (onpeds[i].type == Pedestal::STAR &amp;&amp; 
<a name="l01645"></a>01645               offpeds[i].type == Pedestal::STAR)) {
<a name="l01646"></a>01646 
<a name="l01647"></a>01647             pedvardiff[i] = 0;
<a name="l01648"></a>01648 
<a name="l01649"></a>01649         }
<a name="l01650"></a>01650         <span class="keywordflow">else</span> {
<a name="l01651"></a>01651             pedvardiff[i] = pow(onpeds[i].dispersion,2) 
<a name="l01652"></a>01652                 - pow(offpeds[i].dispersion,2);
<a name="l01653"></a>01653         }       
<a name="l01654"></a>01654 
<a name="l01655"></a>01655     }
<a name="l01656"></a>01656     
<a name="l01657"></a>01657     <span class="comment">// Get the camera coordinates and derotate them into tangential coords!</span>
<a name="l01658"></a>01658 
<a name="l01659"></a>01659     xcoord.resize(cam-&gt;<a class="code" href="classCamera.html#a8a4b74941bc6cfcd97ec1b135f6fec09" title="Array of x coordinates.">xCoords</a>().size());
<a name="l01660"></a>01660     ycoord.resize(cam-&gt;<a class="code" href="classCamera.html#af2892e20c0a16ae802fcd8cc454bf59d" title="Array of y coordinates.">yCoords</a>().size());
<a name="l01661"></a>01661     xcoord = cam-&gt;<a class="code" href="classCamera.html#a8a4b74941bc6cfcd97ec1b135f6fec09" title="Array of x coordinates.">xCoords</a>();
<a name="l01662"></a>01662     ycoord = cam-&gt;<a class="code" href="classCamera.html#af2892e20c0a16ae802fcd8cc454bf59d" title="Array of y coordinates.">yCoords</a>();
<a name="l01663"></a>01663 
<a name="l01664"></a>01664     <span class="keywordflow">if</span> (derotation == <span class="keyword">true</span>) {
<a name="l01665"></a>01665         <span class="comment">// not sure this is right: </span>
<a name="l01666"></a>01666         <span class="comment">// should we rotate by -theta instead?</span>
<a name="l01667"></a>01667         <span class="keywordflow">for</span> (i=0; i&lt;(int)xcoord.size(); i++) {
<a name="l01668"></a>01668             coord.<a class="code" href="structCoordinate__t.html#a4e83334eabbe707ae5433ff65f60a475" title="X coordinate.">x</a> = xcoord[i];
<a name="l01669"></a>01669             coord.<a class="code" href="structCoordinate__t.html#abbc494db10b22a87bede79c5b62be604" title="Y coordinate.">y</a> = ycoord[i];
<a name="l01670"></a>01670             derotatePoint( _theta, coord );
<a name="l01671"></a>01671             xcoord[i] = coord.<a class="code" href="structCoordinate__t.html#a4e83334eabbe707ae5433ff65f60a475" title="X coordinate.">x</a>;
<a name="l01672"></a>01672             ycoord[i] = coord.<a class="code" href="structCoordinate__t.html#abbc494db10b22a87bede79c5b62be604" title="Y coordinate.">y</a>;
<a name="l01673"></a>01673         }
<a name="l01674"></a>01674     }
<a name="l01675"></a>01675 
<a name="l01676"></a>01676     <span class="comment">// Set up the coordinate grid:</span>
<a name="l01677"></a>01677 
<a name="l01678"></a>01678     brightmap.setCoordinateBox( -nxbins*DEGPERPIX/2.0,-nybins*DEGPERPIX/2.0,
<a name="l01679"></a>01679                                 nxbins*DEGPERPIX/2.0,nybins*DEGPERPIX/2.0);
<a name="l01680"></a>01680     tubeoffmap.setCoordinateBox( -nxbins*DEGPERPIX/2.0,-nybins*DEGPERPIX/2.0,
<a name="l01681"></a>01681                                  nxbins*DEGPERPIX/2.0,nybins*DEGPERPIX/2.0);
<a name="l01682"></a>01682     
<a name="l01683"></a>01683     <span class="comment">// Accumulate the sky brightness and tubeoffness:</span>
<a name="l01684"></a>01684 
<a name="l01685"></a>01685     <span class="keywordflow">for</span> (i=0; i&lt;nxbins; i++) {
<a name="l01686"></a>01686         <span class="keywordflow">for</span> (j=0; j&lt;nybins; j++) {
<a name="l01687"></a>01687             
<a name="l01688"></a>01688             sky_brightness = 0;
<a name="l01689"></a>01689             tubeoffness = 0;
<a name="l01690"></a>01690 
<a name="l01691"></a>01691             <span class="keywordflow">for</span> (k=0; k&lt;(int)xcoord.size(); k++) {
<a name="l01692"></a>01692                         
<a name="l01693"></a>01693                 <span class="comment">// tube is ON or contains a star in the ON</span>
<a name="l01694"></a>01694                 <span class="comment">// run, or just good in the OFF, so update sky</span>
<a name="l01695"></a>01695                 <span class="comment">// brightness map</span>
<a name="l01696"></a>01696                 
<a name="l01697"></a>01697                 r2 = (pow(xcoord[k] - brightmap.getXCoord(i),2) +
<a name="l01698"></a>01698                       pow(ycoord[k] - brightmap.getYCoord(j),2));
<a name="l01699"></a>01699                 gauss_weight = exp(-r2/SIGR2);
<a name="l01700"></a>01700                 sky_brightness += pedvardiff[k]*gauss_weight
<a name="l01701"></a>01701                     *pow(gain[k],2); <span class="comment">// flat field</span>
<a name="l01702"></a>01702                 
<a name="l01703"></a>01703                 
<a name="l01704"></a>01704                 <span class="keywordflow">if</span> ((onpeds[k].type == Pedestal::TUBEOFF) ||
<a name="l01705"></a>01705                     (offpeds[k].type == Pedestal::TUBEOFF) ||
<a name="l01706"></a>01706                     (onpeds[k].type == Pedestal::STAR) || 
<a name="l01707"></a>01707                     (offpeds[k].type == Pedestal::STAR)) {
<a name="l01708"></a>01708 
<a name="l01709"></a>01709                     <span class="comment">// tube is OFF, so update tubeoffness map</span>
<a name="l01710"></a>01710                     r2 = (pow(xcoord[k] - tubeoffmap.getXCoord(i),2) +
<a name="l01711"></a>01711                           pow(ycoord[k] - tubeoffmap.getYCoord(j),2));
<a name="l01712"></a>01712                     gauss_weight = exp(-r2/SIGR2);
<a name="l01713"></a>01713                     tubeoffness  += 1.0*gauss_weight;
<a name="l01714"></a>01714 
<a name="l01715"></a>01715                 }
<a name="l01716"></a>01716                 
<a name="l01717"></a>01717             }
<a name="l01718"></a>01718                 
<a name="l01719"></a>01719                 
<a name="l01720"></a>01720             brightmap.addToPixel(i,j, sky_brightness);
<a name="l01721"></a>01721             tubeoffmap.addToPixel( i,j, tubeoffness );
<a name="l01722"></a>01722             
<a name="l01723"></a>01723         }
<a name="l01724"></a>01724     }
<a name="l01725"></a>01725     
<a name="l01726"></a>01726     <span class="comment">// save the maps...</span>
<a name="l01727"></a>01727 
<a name="l01728"></a>01728     <span class="keywordtype">char</span> telid[100];
<a name="l01729"></a>01729     sprintf( telid, <span class="stringliteral">&quot;-%03d&quot;</span>, telescope_id );
<a name="l01730"></a>01730 
<a name="l01731"></a>01731     brightmap.save( <span class="keywordtype">id</span>+<span class="stringliteral">&quot;/&quot;</span>+<span class="keywordtype">id</span>+telid+<span class="stringliteral">&quot;-sky_brightness&quot;</span> );
<a name="l01732"></a>01732     tubeoffmap.save( <span class="keywordtype">id</span>+<span class="stringliteral">&quot;/&quot;</span>+<span class="keywordtype">id</span>+telid+<span class="stringliteral">&quot;-tubeoffness&quot;</span> );
<a name="l01733"></a>01733 
<a name="l01734"></a>01734 }
<a name="l01735"></a>01735 
<a name="l01736"></a>01736 
<a name="l01737"></a>01737 <span class="keywordtype">void</span>
<a name="l01738"></a>01738 Parameterizer::
<a name="l01739"></a>01739 setLatLonInRadians( <span class="keywordtype">double</span> lat, <span class="keywordtype">double</span> lon ) {
<a name="l01740"></a>01740 
<a name="l01741"></a>01741     _latitude = lat;
<a name="l01742"></a>01742     _longitude = lon;
<a name="l01743"></a>01743 
<a name="l01744"></a>01744 }
<a name="l01745"></a>01745 
<a name="l01746"></a>01746 
<a name="l01755"></a>01755 <span class="keywordtype">void</span>
<a name="l01756"></a>01756 Parameterizer::
<a name="l01757"></a>01757 updateAngles( <span class="keywordtype">double</span> gpstime, <span class="keyword">const</span> <a class="code" href="structRawHeaderRecord.html">RawHeaderRecord</a> &amp;header ) {
<a name="l01758"></a>01758     
<a name="l01759"></a>01759     <span class="keywordtype">double</span> hourangle;
<a name="l01760"></a>01760     <span class="keywordtype">double</span> tmp1,tmp2;
<a name="l01761"></a>01761     <span class="keywordtype">double</span> cosdec, sindec, sinlat, coslat, sinhr, coshr;
<a name="l01762"></a>01762     <span class="keywordtype">double</span> sk,ck;
<a name="l01763"></a>01763 
<a name="l01764"></a>01764     <span class="keyword">const</span> <span class="keywordtype">double</span> TIME_TO_RADIANS = 2*M_PI/24.0;  
<a name="l01765"></a>01765     <span class="keywordtype">double</span> tt, tt0;
<a name="l01766"></a>01766     <span class="keywordtype">int</span> imjd = (int)(gpstime);
<a name="l01767"></a>01767     <span class="keywordtype">double</span> sidereal;
<a name="l01768"></a>01768     <span class="keywordtype">double</span> uttime;
<a name="l01769"></a>01769 
<a name="l01770"></a>01770     <span class="comment">// interval of time measured in julian centuries elapsed since 1</span>
<a name="l01771"></a>01771     <span class="comment">// Jan 2000 at 12h UT:</span>
<a name="l01772"></a>01772     tt = (imjd - 51544.5)/36525.0;
<a name="l01773"></a>01773 
<a name="l01774"></a>01774     <span class="comment">// fractional time in hours since UT midnight:</span>
<a name="l01775"></a>01775     <span class="comment">// Note: mjd is in units of DAYS</span>
<a name="l01776"></a>01776     uttime = (gpstime-imjd) * 24.0; 
<a name="l01777"></a>01777 
<a name="l01778"></a>01778     tt0=6.697374558 + (2.400051336e3 * tt)+(2.5862e-5 *  tt*tt);
<a name="l01779"></a>01779     sidereal = fmod( uttime * 1.002737909 + tt0 - 7.392333333, 24.0 );
<a name="l01780"></a>01780     <span class="keywordflow">if</span> (sidereal &lt; 0.0) sidereal += 24.0;
<a name="l01781"></a>01781     sidereal *= TIME_TO_RADIANS;
<a name="l01782"></a>01782 
<a name="l01783"></a>01783     <span class="comment">// the hour angle in radians</span>
<a name="l01784"></a>01784 
<a name="l01785"></a>01785     hourangle = sidereal - header.<a class="code" href="structHeaderRecord.html#a2f8307833dbe6f23944903cd21ea78b6" title="ra of run">ra</a>;
<a name="l01786"></a>01786     
<a name="l01787"></a>01787     <span class="comment">// precalculate some stuff for speed</span>
<a name="l01788"></a>01788 
<a name="l01789"></a>01789     sinlat = sin(_latitude);
<a name="l01790"></a>01790     coslat = cos(_latitude);
<a name="l01791"></a>01791     sindec = sin(header.<a class="code" href="structHeaderRecord.html#a85927153a843227a279beac0c4fbd99a" title="dec of run">dec</a>);
<a name="l01792"></a>01792     cosdec = cos(header.<a class="code" href="structHeaderRecord.html#a85927153a843227a279beac0c4fbd99a" title="dec of run">dec</a>);
<a name="l01793"></a>01793     sinhr  = sin(hourangle);
<a name="l01794"></a>01794     coshr  = cos(hourangle);
<a name="l01795"></a>01795 
<a name="l01796"></a>01796     <span class="comment">// calculate the elevation</span>
<a name="l01797"></a>01797     
<a name="l01798"></a>01798     tmp1 = sindec*sinlat + cosdec*coslat*coshr;
<a name="l01799"></a>01799     <span class="keywordflow">if</span> (tmp1 &gt; 1.0) tmp1 = 1.0;
<a name="l01800"></a>01800     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tmp1 &lt; -1.0) tmp1 = -1.0;
<a name="l01801"></a>01801     _el = asin(tmp1);
<a name="l01802"></a>01802 
<a name="l01803"></a>01803 <span class="comment">//     if (_el &lt; 0) {</span>
<a name="l01804"></a>01804 <span class="comment">//      cout &lt;&lt; &quot;DEBUG: Hey! elevation is negative: &quot; &lt;&lt; _el &lt;&lt; endl;</span>
<a name="l01805"></a>01805 <span class="comment">//      cout &lt;&lt; &quot;\tgpstime = &quot; &lt;&lt; gpstime &lt;&lt; endl;</span>
<a name="l01806"></a>01806 <span class="comment">//     }</span>
<a name="l01807"></a>01807 
<a name="l01808"></a>01808     <span class="comment">// calculate azimuth</span>
<a name="l01809"></a>01809 
<a name="l01810"></a>01810     tmp1 = -cosdec*coslat*sinhr;
<a name="l01811"></a>01811     tmp2 = sindec - sinlat*sin(_el);
<a name="l01812"></a>01812     
<a name="l01813"></a>01813     <span class="keywordflow">if</span> (tmp1&gt;1.0) tmp1=1.0;
<a name="l01814"></a>01814     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tmp1&lt;-1.0) tmp1 = -1.0;
<a name="l01815"></a>01815     <span class="keywordflow">if</span> (tmp2&gt;1.0) tmp2=1;
<a name="l01816"></a>01816     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tmp2&lt;-1.0) tmp2 = -1.0;
<a name="l01817"></a>01817     
<a name="l01818"></a>01818     _az = atan2(tmp1,tmp2);
<a name="l01819"></a>01819 
<a name="l01820"></a>01820     <span class="comment">// get theta (derotation angle)</span>
<a name="l01821"></a>01821     
<a name="l01822"></a>01822     sk = -coslat*sin(_az);
<a name="l01823"></a>01823     ck = cos(_el)*sinlat-sin(_el)*coslat*cos(_az);
<a name="l01824"></a>01824 
<a name="l01825"></a>01825     <span class="keywordflow">if</span> (sk &gt; 1.0) sk = 1.0;
<a name="l01826"></a>01826     <span class="keywordflow">else</span> <span class="keywordflow">if</span>( sk&lt;-1.0) sk = -1.0;
<a name="l01827"></a>01827     <span class="keywordflow">if</span> (ck &gt; 1.0) ck = 1.0;
<a name="l01828"></a>01828     <span class="keywordflow">else</span> <span class="keywordflow">if</span>( ck&lt;-1.0) ck = -1.0;
<a name="l01829"></a>01829     
<a name="l01830"></a>01830     _theta = -atan2(sk,ck);
<a name="l01831"></a>01831 
<a name="l01832"></a>01832 <span class="comment">//     gsl_sf_angle_restrict_pos_e( &amp;_el );</span>
<a name="l01833"></a>01833 <span class="comment">//     gsl_sf_angle_restrict_pos_e( &amp;_az );</span>
<a name="l01834"></a>01834 
<a name="l01835"></a>01835 }
<a name="l01836"></a>01836 
<a name="l01837"></a>01837 
<a name="l01846"></a>01846 <span class="keywordtype">void</span>  
<a name="l01847"></a>01847 Parameterizer::
<a name="l01848"></a>01848 derotatePoint(<span class="keywordtype">double</span> theta, <a class="code" href="structCoordinate__t.html" title="A 2-d coordinate.">Coordinate_t</a> &amp;point) {
<a name="l01849"></a>01849 
<a name="l01850"></a>01850     <span class="keywordtype">double</span> sintheta, costheta;
<a name="l01851"></a>01851     <a class="code" href="structCoordinate__t.html" title="A 2-d coordinate.">Coordinate_t</a> newpoint;
<a name="l01852"></a>01852 
<a name="l01853"></a>01853     sintheta = sin(theta);
<a name="l01854"></a>01854     costheta = cos(theta);
<a name="l01855"></a>01855 
<a name="l01856"></a>01856     newpoint.<a class="code" href="structCoordinate__t.html#a4e83334eabbe707ae5433ff65f60a475" title="X coordinate.">x</a> = point.<a class="code" href="structCoordinate__t.html#a4e83334eabbe707ae5433ff65f60a475" title="X coordinate.">x</a>*costheta + point.<a class="code" href="structCoordinate__t.html#abbc494db10b22a87bede79c5b62be604" title="Y coordinate.">y</a>*sintheta;
<a name="l01857"></a>01857     newpoint.<a class="code" href="structCoordinate__t.html#abbc494db10b22a87bede79c5b62be604" title="Y coordinate.">y</a> = -point.<a class="code" href="structCoordinate__t.html#a4e83334eabbe707ae5433ff65f60a475" title="X coordinate.">x</a>*sintheta + point.<a class="code" href="structCoordinate__t.html#abbc494db10b22a87bede79c5b62be604" title="Y coordinate.">y</a>*costheta;
<a name="l01858"></a>01858     
<a name="l01859"></a>01859     point.<a class="code" href="structCoordinate__t.html#a4e83334eabbe707ae5433ff65f60a475" title="X coordinate.">x</a> = newpoint.<a class="code" href="structCoordinate__t.html#a4e83334eabbe707ae5433ff65f60a475" title="X coordinate.">x</a>;
<a name="l01860"></a>01860     point.<a class="code" href="structCoordinate__t.html#abbc494db10b22a87bede79c5b62be604" title="Y coordinate.">y</a> = newpoint.<a class="code" href="structCoordinate__t.html#abbc494db10b22a87bede79c5b62be604" title="Y coordinate.">y</a>;
<a name="l01861"></a>01861     
<a name="l01862"></a>01862 }
<a name="l01863"></a>01863 
<a name="l01864"></a>01864 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 1 2011 18:52:49 for wuparam by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>
