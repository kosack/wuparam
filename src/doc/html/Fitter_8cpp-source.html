<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>wuparam: Fitter.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>Fitter.cpp</h1><div class="fragment"><pre>00001 <span class="comment">//</span>
00002 <span class="comment">// Fitter.cpp</span>
00003 <span class="comment">// Henric Krawczynski &lt;krawcz@wuphys.wustl.edu&gt;</span>
00004 <span class="comment">//</span>
00005 
00006 <span class="preprocessor">#include &lt;iostream&gt;</span>
00007 <span class="preprocessor">#include &lt;iomanip&gt;</span>
00008 <span class="preprocessor">#include &lt;string&gt;</span>
00009 <span class="preprocessor">#include &lt;fstream&gt;</span>
00010 <span class="preprocessor">#include &lt;list&gt;</span>
00011 <span class="preprocessor">#include &lt;cmath&gt;</span>
00012 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00013 <span class="preprocessor">#include &lt;cstring&gt;</span>
00014 <span class="preprocessor">#include &lt;sstream&gt;</span>
00015 
00016 <span class="preprocessor">#include "SuperCutter.h"</span>
00017 <span class="preprocessor">#include "ZCutter.h"</span>
00018 <span class="preprocessor">#include "SpectralCutter.h"</span>
00019 <span class="preprocessor">#include "Config.h"</span>
00020 <span class="preprocessor">#include "Histogram.h"</span>
00021 <span class="preprocessor">#include "EnergySpectrum.h"</span>
00022 <span class="preprocessor">#include "Fitter.h"</span>
00023 <span class="preprocessor">#include "Exceptions.h"</span>
00024 <span class="preprocessor">#include "ProgressBar.h"</span>
00025 <span class="preprocessor">#include "ImageAnalyzer.h"</span>
00026 <span class="preprocessor">#include "DataRecords.h"</span>
00027 <span class="preprocessor">#include "DataWriter.h"</span>
00028 <span class="preprocessor">#include "ParamDataReader.h"</span>
00029 
00030 <span class="comment">//#define ES_DEBUG 0</span>
00031 
00032 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00033 <span class="keyword">using</span> <span class="keyword">namespace </span>Cuts;
00034 
00035 <span class="comment">// ++++++++++++++++++</span>
00036 <span class="comment">// + MCdata Methods +</span>
00037 <span class="comment">// ++++++++++++++++++</span>
00038 
<a name="l00045"></a><a class="code" href="classMCSpectrum.html#a0">00045</a> <a class="code" href="classMCSpectrum.html#a0">MCSpectrum::MCSpectrum</a>( <a class="code" href="classRunInfo.html">RunInfo</a> &amp;ri ) {
00046    
00047     _spectrum = <span class="keyword">new</span> <a class="code" href="classEnergySpectrum.html">EnergySpectrum</a>(ri,<span class="stringliteral">"MC-Spectrum"</span>);
00048 
00049     <span class="comment">// ======================================================================</span>
00050     <span class="comment">// open the  MC Events database</span>
00051     
00052 
00053     ifstream simfile;
00054     simfile.open(string(ri.<a class="code" href="classRunInfo.html#o25">mcdatabase</a>+<span class="stringliteral">".simhdr"</span>).c_str());
00055   
00056     <span class="keywordflow">if</span> (simfile.fail())  {
00057         cout &lt;&lt; <span class="stringliteral">"Can Not Read MC File"</span> &lt;&lt; endl;
00058         <span class="keywordflow">throw</span> <a class="code" href="classCriticalAnalysisException.html">CriticalAnalysisException</a>(<span class="stringliteral">"Couldn't open simulation database: '"</span>
00059                                         + ri.<a class="code" href="classRunInfo.html#o25">mcdatabase</a> + <span class="stringliteral">"'"</span> );
00060     }
00061     <span class="keywordflow">else</span>
00062         cout &lt;&lt; <span class="stringliteral">"Reading Monte Carlo Data Set: "</span> &lt;&lt; ri.<a class="code" href="classRunInfo.html#o25">mcdatabase</a>&lt;&lt;endl;
00063   
00064     <span class="keywordtype">double</span> x;
00065     <a class="code" href="structMCRecord.html">MCRecord</a> temprecord;
00066 
00067     cout &lt;&lt; <span class="stringliteral">"with the following cuts:"</span> &lt;&lt; endl;
00068     cout &lt;&lt; ri.<a class="code" href="classRunInfo.html#o22">cuts</a> &lt;&lt; endl &lt;&lt; endl;
00069     
00070     <a class="code" href="structHillasParameterization.html">HillasParameterization</a> param,unscaled_param;
00071     <span class="keywordtype">int</span> numsims=0;
00072     <a class="code" href="classProgressBar.html">ProgressBar</a> prog(0,<span class="stringliteral">"Reading Sims"</span>);
00073 
00074     <span class="comment">// ======================================================================</span>
00075     <span class="comment">// Load the simulated events</span>
00076 
00077     <span class="comment">// first load the header from the file</span>
00078 
00079     string line;
00080     MCBinInfo tmpbin;
00081 
00082     cout  &lt;&lt; <span class="stringliteral">"   E_start     E_end    Radius    N_sims"</span> &lt;&lt; endl;
00083 
00084     <span class="keywordflow">while</span> (getline(simfile,line) &amp;&amp; line != <span class="stringliteral">"#===END==="</span>) {
00085 
00086         <span class="keywordflow">if</span> ( line.substr(0,2) == <span class="stringliteral">"#&gt;"</span> ) {
00087 
00088             vector&lt;string&gt; token;           
00089             tokenize( line, token );
00090             
00091             <span class="keywordflow">if</span> (token.size() != 5) {
00092                 cout &lt;&lt; token.size() &lt;&lt;endl;
00093                 cout &lt;&lt; <span class="stringliteral">"UNKNOWN INFO IN HEADER: "</span>&lt;&lt;line &lt;&lt;endl;
00094             }
00095             <span class="keywordflow">else</span> {
00096                 tmpbin.start = atof(token[1].c_str());
00097                 tmpbin.end = atof(token[2].c_str());
00098                 tmpbin.radius = atof(token[3].c_str());
00099                 tmpbin.nummc = atoi(token[4].c_str());
00100                 _info.push_back( tmpbin );
00101                 cout &lt;&lt; setw(10) &lt;&lt; tmpbin.start 
00102                      &lt;&lt; setw(10) &lt;&lt; tmpbin.end 
00103                      &lt;&lt; setw(10) &lt;&lt; tmpbin.radius
00104                      &lt;&lt; setw(10) &lt;&lt; tmpbin.nummc
00105                      &lt;&lt; endl;
00106             }
00107 
00108         }
00109 
00110     }
00111     
00112     <span class="keywordflow">if</span> (_info.size() != NUMMCBINS) {
00113         <span class="keywordflow">throw</span> <a class="code" href="classCriticalAnalysisException.html">CriticalAnalysisException</a>(<span class="stringliteral">"Bad header in "</span>
00114                                         +ri.<a class="code" href="classRunInfo.html#o25">mcdatabase</a>);
00115     }
00116 
00117 
00118     cout &lt;&lt; <span class="stringliteral">"Reading event data from "</span> &lt;&lt; ri.<a class="code" href="classRunInfo.html#o25">mcdatabase</a> &lt;&lt; endl;
00119 
00120 
00121     <span class="comment">// Read the event data</span>
00122 
00123     <a class="code" href="classParamDataReader.html">ParamDataReader</a> reader( ri.<a class="code" href="classRunInfo.html#o25">mcdatabase</a> );
00124 
00125     numsims=0;
00126 
00127     EnergyEstimatorFactory *efactory = EnergyEstimatorFactory::instance();
00128     EnergyEstimator *energy = efactory-&gt;getEstimator(ri.<a class="code" href="classRunInfo.html#o26">energyestimator</a>);
00129 
00130     <span class="keywordflow">try</span> {
00131         <span class="keywordflow">while</span> (1) {
00132 
00133             <span class="keywordflow">if</span>(numsims++ % 100==0) prog.<a class="code" href="classProgressBar.html#a2">print</a>(1);
00134 
00135             reader.<a class="code" href="classParamDataReader.html#a3">getNextEventRecord</a>( param );
00136             x = energy-&gt;getEstimate(param.<a class="code" href="structHillasParameterization.html#o5">size</a>,param.<a class="code" href="structHillasParameterization.html#o7">distance</a>,param.<a class="code" href="structHillasParameterization.html#o19">zenith</a>);
00137             temprecord.<a class="code" href="structMCRecord.html#o1">estimatedEnergy</a> = x;
00138             temprecord.<a class="code" href="structMCRecord.html#o0">trueEnergy_in_TeV</a> = param.<a class="code" href="structImageParameterization.html#o6">sim</a>.primary_energy;
00139             _event.push_back( temprecord );
00140 
00141 
00142         }
00143     }
00144     <span class="keywordflow">catch</span> (<a class="code" href="classEOFException.html">EOFException</a> &amp;e) {
00145         cout &lt;&lt; <span class="stringliteral">"DEBUG: end of file: "</span>&lt;&lt;e.what() &lt;&lt; endl;
00146     } 
00147        
00148     prog.<a class="code" href="classProgressBar.html#a3">printClear</a>();
00149 
00150     simfile.close();
00151 
00152     cout &lt;&lt; <span class="stringliteral">"Succesfully Read MC File, "</span> &lt;&lt; _event.size() &lt;&lt;<span class="stringliteral">" of "</span>
00153          &lt;&lt; numsims &lt;&lt; <span class="stringliteral">" events passed cuts"</span> &lt;&lt;endl;
00154 
00155 
00156 }
00157 
00158 
00159 MCSpectrum::~MCSpectrum() {
00160     <span class="keyword">delete</span> _spectrum;
00161 }
00162 
00163 
00164 
00165 
00170 <span class="keywordtype">void</span> 
00171 <a class="code" href="classMCSpectrum.html#a2">MCSpectrum::</a>
<a name="l00172"></a><a class="code" href="classMCSpectrum.html#a2">00172</a> <a class="code" href="classMCSpectrum.html#a2">fill</a>(<span class="keywordtype">double</span> N0, <span class="keywordtype">double</span> Gamma0, <span class="keywordtype">double</span> E0, <span class="keywordtype">double</span> Time) {
00173     
00174     <span class="keywordtype">double</span> w;
00175     
00176     <span class="comment">// Reset Histogram  </span>
00177     _spectrum-&gt;<a class="code" href="classHistogram.html#a22">reset</a>();
00178     
00179     <span class="keywordtype">double</span> n0 = pow(10.,N0);
00180     
00181     <span class="comment">// Loop over MC events, and fill "artifical" energy spectrum</span>
00182     vector&lt;MCRecord&gt;::iterator evt;
00183     <span class="keywordflow">for</span> (evt = _event.begin(); evt != _event.end(); evt++){
00184         
00185         w = weight( evt-&gt;trueEnergy_in_TeV,n0,Gamma0,E0,Time );
00186         _spectrum-&gt;<a class="code" href="classHistogram.html#a4">accumulate</a>( evt-&gt;estimatedEnergy, w );
00187         
00188     }
00189 
00190 }
00191 
00192 
00196 <span class="keywordtype">double</span> MCSpectrum::weight(<span class="keywordtype">double</span> energy, <span class="keywordtype">double</span> N0, <span class="keywordtype">double</span> Gamma0, <span class="keywordtype">double</span> E0,
00197                           <span class="keywordtype">double</span> Time) {
00198     
00199     <span class="comment">// that's the number of events per time area and energy that we</span>
00200     <span class="comment">// want to have</span>
00201     <span class="comment">//double soll = N0*pow(energy,Gamma0)*Time;</span>
00202     <span class="keywordtype">double</span> soll = N0*pow(energy,Gamma0)*Time*exp(-1*energy/E0);
00203     <span class="keywordtype">double</span> numShower,de,a,e1,e2;
00204     
00205     info(energy,numShower,de,a,e1,e2);
00206     
00207     <span class="keywordflow">if</span> (numShower&gt;0) {
00208 
00209         <span class="comment">// here we compute the number of events per time area and</span>
00210         <span class="comment">// energy that we have simulated some calculus is needed, to</span>
00211         <span class="comment">// take into account that we simulated with differential</span>
00212         <span class="comment">// spectral index of 1.5.</span>
00213         
00214         <span class="keywordtype">double</span> gamma_sim,gamma_red,n0,ist;
00215         
00216         gamma_sim = -1.5;  <span class="comment">// should be differential index</span>
00217         <span class="comment">// note some versions of Kascade incorrectly call the input</span>
00218         <span class="comment">// "integral" when it is actually differnetial!</span>
00219         gamma_red =  gamma_sim+1.;
00220 
00221         <span class="comment">// n0 is normalization constant of the simulated differential</span>
00222         <span class="comment">// energy spectrum</span>
00223         n0        = -gamma_red * numShower/(pow(e1,gamma_red)-
00224                                             pow(e2,gamma_red));
00225 
00226         ist       = n0 * pow(energy,gamma_sim) / a ;
00227         
00228        <span class="comment">// ratio of what we want to have and what we do have is the</span>
00229        <span class="comment">// weighting factor</span>
00230         
00231         <span class="keywordflow">return</span> soll/ist;
00232     }
00233     <span class="keywordflow">else</span>
00234         <span class="keywordflow">return</span> 0.;
00235 
00236 }
00237  
00243 <span class="keywordtype">void</span> MCSpectrum::info(<span class="keywordtype">double</span> energy,<span class="keywordtype">double</span> &amp;numShower, 
00244                       <span class="keywordtype">double</span> &amp;de, <span class="keywordtype">double</span> &amp;a, <span class="keywordtype">double</span> &amp;e1, <span class="keywordtype">double</span> &amp;e2){
00245     
00246     <span class="keywordflow">if</span> ((energy&lt;_info[0].start)||(energy &gt; _info[NUMMCBINS-1].end)) {
00247         numShower = -1;
00248         <span class="keywordflow">return</span> ;
00249     }
00250 
00251     <span class="keywordtype">int</span> i;
00252     <span class="keywordflow">for</span> (i=0;i&lt;NUMMCBINS;i++)
00253         <span class="keywordflow">if</span> (_info[i].end &gt;= energy) <span class="keywordflow">break</span>;
00254 
00255     numShower = _info[i].nummc;
00256 
00257     <span class="comment">// width of energy interval</span>
00258     de        = _info[i].end - _info[i].start;
00259     
00260     <span class="comment">// get boundaries of simulation interval</span>
00261     e1        = _info[i].start;
00262     e2        = _info[i].end;
00263     
00264     <span class="comment">// area</span>
00265     a         = M_PI * _info[i].radius * _info[i].radius;
00266 
00267  }
00268 
<a name="l00274"></a><a class="code" href="classMCSpectrum.html#a3">00274</a> <span class="keywordtype">double</span> <a class="code" href="classMCSpectrum.html#a3">MCSpectrum::chiSquare</a>( std::vector&lt;Data&gt; &amp;data ) {
00275     
00276     <span class="keywordtype">int</span> i;
00277     <span class="keywordtype">double</span> <a class="code" href="classMCSpectrum.html#a3">chiSquare</a> = 0.;
00278     <span class="keywordtype">double</span> diff;
00279     _ndof = -2;
00280     
00281 <span class="preprocessor">#ifdef ES_DEBUG</span>
00282 <span class="preprocessor"></span>    cout &lt;&lt; <span class="stringliteral">"New Chi^2"</span>&lt;&lt;endl;
00283 <span class="preprocessor">#endif</span>
00284 <span class="preprocessor"></span>    
00285     <span class="comment">// loop over bins</span>
00286     <span class="keywordflow">for</span> (i=0;i&lt;_spectrum-&gt;<a class="code" href="classHistogram.html#a17">numBins</a>();i++) {
00287 
00288         <span class="comment">// Only use if sum of on and off counts exceeds MIN_COUNTS (5),</span>
00289         <span class="comment">// that gurantees nice chi-square statistics</span>
00290 
00291 
00292         <span class="keywordflow">if</span> (data[i].onOffVariance&gt; 0 <span class="comment">/* EnergySpectrum::MIN_COUNTS*/</span>) {
00293             
00294             <span class="comment">//   kpk: also only keep points where the value is &gt;</span>
00295             <span class="comment">//   sqrt(variance), that way really sick points aren't counted.</span>
00296             <span class="comment">//             &amp;&amp; data[i].onOff &gt; sqrt(data[i].onOffVariance))  {</span>
00297 
00298            diff       = data[i].onOff - _spectrum-&gt;<a class="code" href="classHistogram.html#a21">get</a>(i);
00299            chiSquare += diff*diff/(data[i].onOffVariance);
00300            
00301 <span class="preprocessor">#ifdef ES_DEBUG </span>
00302 <span class="preprocessor"></span>           cout &lt;&lt; setw(10) &lt;&lt; i &lt;&lt; <span class="stringliteral">" "</span> 
00303                 &lt;&lt; setw(10)&lt;&lt; data[i].onOff &lt;&lt; <span class="stringliteral">" "</span> 
00304                 &lt;&lt; setw(10)&lt;&lt; data[i].onOffVariance &lt;&lt; <span class="stringliteral">" "</span> 
00305                 &lt;&lt; setw(10)&lt;&lt; _spectrum-&gt;<a class="code" href="classHistogram.html#a21">get</a>(i) &lt;&lt; <span class="stringliteral">" "</span>  
00306                 &lt;&lt; chiSquare&lt;&lt;endl; 
00307 <span class="preprocessor">#endif</span>
00308 <span class="preprocessor"></span>           
00309            _ndof++;
00310        }
00311     }
00312 <span class="preprocessor">#ifdef ES_DEBUG</span>
00313 <span class="preprocessor"></span>    cout &lt;&lt; endl &lt;&lt;endl;
00314 <span class="preprocessor">#endif</span>
00315 <span class="preprocessor"></span>    <span class="keywordflow">return</span> chiSquare;
00316 }
00317 
00318 <span class="comment">// ++++++++++++++++++ </span>
00319 <span class="comment">// + Fitter Methods +</span>
00320 <span class="comment">// ++++++++++++++++++</span>
00321 
00322 
00331 <span class="keywordtype">void</span>
00332 <a class="code" href="classFitter.html#a2">Fitter::</a>
<a name="l00333"></a><a class="code" href="classFitter.html#a2">00333</a> <a class="code" href="classFitter.html#a2">minimize</a>( <a class="code" href="classEnergySpectrum.html">EnergySpectrum</a>* energy_on,<a class="code" href="classEnergySpectrum.html">EnergySpectrum</a>* energy_off, 
00334           <span class="keywordtype">double</span> &amp;N0, <span class="keywordtype">double</span> &amp;Gamma0, <span class="keywordtype">double</span> &amp;e0, <span class="keywordtype">double</span> Time, 
00335           <span class="keywordtype">double</span> n0Range, <span class="keywordtype">int</span> n0Step, 
00336           <span class="keywordtype">double</span> gRange, <span class="keywordtype">int</span> gStep,<span class="keywordtype">double</span> onoffratio) {
00337     
00338     <span class="comment">// check that the histograms sizes are correct:</span>
00339 
00340     <span class="keywordflow">if</span> (energy_on-&gt;<a class="code" href="classHistogram.html#a17">numBins</a>() != energy_off-&gt;<a class="code" href="classHistogram.html#a17">numBins</a>() ) {
00341         <span class="keywordflow">throw</span> <a class="code" href="classCriticalAnalysisException.html">CriticalAnalysisException</a>(string(<span class="stringliteral">"Wrong energy spectrum sizes: "</span>)
00342                                         +<span class="stringliteral">"rerun wucut"</span> );
00343     }
00344     <span class="keywordflow">if</span> (energy_on-&gt;<a class="code" href="classHistogram.html#a17">numBins</a>() != _mcSpectrum-&gt;<a class="code" href="classMCSpectrum.html#a7">getSpectrum</a>()-&gt;<a class="code" href="classHistogram.html#a17">numBins</a>() ) {
00345         <span class="keywordflow">throw</span> <a class="code" href="classCriticalAnalysisException.html">CriticalAnalysisException</a>(string(<span class="stringliteral">"energy spectrum and "</span>) 
00346                                         +<span class="stringliteral">"monte carlo spectrum have "</span>
00347                                         + <span class="stringliteral">"different sizes: rerun wucut"</span>);
00348     }
00349 
00350     <span class="comment">// </span>
00351     <span class="comment">// Get information out of histograms</span>
00352     <span class="comment">//</span>
00353 
00354     <span class="keywordflow">if</span> (_data.size() != energy_on-&gt;<a class="code" href="classHistogram.html#a17">numBins</a>()) {
00355         _data.resize(energy_on-&gt;<a class="code" href="classHistogram.html#a17">numBins</a>());
00356     }
00357 
00358     <span class="keywordtype">int</span> i;
00359     <span class="keywordflow">for</span> (i=0;i&lt;energy_on-&gt;<a class="code" href="classHistogram.html#a17">numBins</a>();i++){
00360         _data[i].onOff         = (energy_on-&gt;<a class="code" href="classHistogram.html#a21">get</a>(i)-
00361                                   onoffratio*energy_off-&gt;<a class="code" href="classHistogram.html#a21">get</a>(i));
00362         _data[i].onOffVariance = onoffratio*(energy_on-&gt;<a class="code" href="classHistogram.html#a21">get</a>(i)
00363                                              +energy_off-&gt;<a class="code" href="classHistogram.html#a21">get</a>(i));
00364     }
00365     
00366     <span class="comment">// Now we loop 3 times over the data.</span>
00367     <span class="comment">// (1) loop over n0 and g to minimized the chi-square value</span>
00368     <span class="comment">// (2) loop over n0 to get error on n0</span>
00369     <span class="comment">// (3) loop over g to get error on g</span>
00370     
00371     <span class="keywordtype">double</span> n0,n1,n2,dn;
00372     n0 = log10(N0);
00373     n1 = n0-n0Range;
00374     n2 = n0+n0Range;
00375     dn = (n2-n1)/n0Step;
00376     
00377     <span class="keywordtype">double</span> g,g1,g2,dg;
00378     g1 = Gamma0-gRange;
00379     g2 = Gamma0+gRange;
00380     dg = (g2-g1)/gStep;
00381     
00382     <span class="keywordtype">double</span> chiSquare;
00383     _results.<a class="code" href="structResults.html#o0">chiSquare</a> = 1E+32;
00384     _results.<a class="code" href="structResults.html#o2">n0</a>        = 0.;
00385     _results.<a class="code" href="structResults.html#o5">gamma0</a>    = 0;
00386     
00387     ofstream chiFile(<span class="stringliteral">"Totals/chi.text"</span>);
00388     <span class="comment">// TODO: put in a progress bar here!</span>
00389     <a class="code" href="classProgressBar.html">ProgressBar</a> prog(n0Step,<span class="stringliteral">"Fitting"</span>);
00390     <span class="keywordtype">int</span> tmp=0;
00391 
00392     <span class="comment">// (1) loop over n0 and g to minimized the chi-square value</span>
00393     <span class="keywordflow">for</span> (n0=n1;n0&lt;n2;n0+=dn) {
00394         
00395         prog.<a class="code" href="classProgressBar.html#a2">print</a>(tmp);
00396         tmp++;
00397 
00398         <span class="comment">// Loop over Gamma0</span>
00399         <span class="keywordflow">for</span> (g=g1;g&lt;g2;g+=dg) {
00400 
00401             _mcSpectrum-&gt;<a class="code" href="classMCSpectrum.html#a2">fill</a>(n0,g,e0,Time);
00402             chiSquare = _mcSpectrum-&gt;<a class="code" href="classMCSpectrum.html#a3">chiSquare</a>(_data);
00403             chiFile &lt;&lt; n0 &lt;&lt; <span class="stringliteral">" "</span> &lt;&lt; g &lt;&lt; <span class="stringliteral">" "</span> &lt;&lt; chiSquare &lt;&lt; endl;
00404             <span class="keywordflow">if</span> (chiSquare&lt;_results.<a class="code" href="structResults.html#o0">chiSquare</a>) {
00405                 _results.<a class="code" href="structResults.html#o0">chiSquare</a> = chiSquare;
00406                 _results.<a class="code" href="structResults.html#o2">n0</a>        = n0;
00407                 _results.<a class="code" href="structResults.html#o5">gamma0</a>    = g;
00408                 
00409 <span class="preprocessor">#ifdef ES_DEBUG</span>
00410 <span class="preprocessor"></span>                cerr &lt;&lt; <span class="stringliteral">"BEST ChiSqr:  "</span>&lt;&lt;chiSquare
00411                      &lt;&lt; <span class="stringliteral">" at n0="</span>&lt;&lt;n0&lt;&lt;<span class="stringliteral">", gamma0="</span>&lt;&lt;g&lt;&lt;endl;
00412 <span class="preprocessor">#endif</span>
00413 <span class="preprocessor"></span>
00414             }
00415         }
00416     }
00417     chiFile.close();
00418     prog.<a class="code" href="classProgressBar.html#a3">printClear</a>();
00419     cout &lt;&lt; <span class="stringliteral">"Done"</span> &lt;&lt; endl;
00420     
00421     <a class="code" href="classProgressBar.html">ProgressBar</a> prog2( 0,<span class="stringliteral">"Error on n0"</span>);
00422     cout &lt;&lt; <span class="stringliteral">"Getting Errors..."</span> &lt;&lt; endl;
00423     <span class="comment">// (2) loop over n0 to get error on n0</span>
00424     _results.<a class="code" href="structResults.html#o3">n0P</a> = _results.<a class="code" href="structResults.html#o2">n0</a>;
00425     _results.<a class="code" href="structResults.html#o4">n0M</a> = _results.<a class="code" href="structResults.html#o2">n0</a>;
00426     
00427     <span class="keywordflow">for</span> (n0=n1;n0&lt;n2;n0+=dn/10.) {
00428 
00429         prog2.<a class="code" href="classProgressBar.html#a2">print</a>(1);
00430 
00431         _mcSpectrum-&gt;<a class="code" href="classMCSpectrum.html#a2">fill</a>(n0,_results.<a class="code" href="structResults.html#o5">gamma0</a>,e0,Time);
00432         chiSquare = _mcSpectrum-&gt;<a class="code" href="classMCSpectrum.html#a3">chiSquare</a>(_data);
00433         <span class="keywordflow">if</span> (chiSquare&lt;(_results.<a class="code" href="structResults.html#o0">chiSquare</a>+1)) {
00434             _results.<a class="code" href="structResults.html#o3">n0P</a>      = GSL_MAX_DBL( _results.<a class="code" href="structResults.html#o3">n0P</a>, n0 );
00435             _results.<a class="code" href="structResults.html#o4">n0M</a>      = GSL_MIN_DBL( _results.<a class="code" href="structResults.html#o4">n0M</a>, n0 );
00436             <span class="keywordflow">if</span> (chiSquare&lt;_results.<a class="code" href="structResults.html#o0">chiSquare</a>) 
00437                 _results.<a class="code" href="structResults.html#o2">n0</a> = n0;
00438         }
00439     }
00440     
00441     <span class="comment">// (3) loop over g to get error on g</span>
00442     _results.<a class="code" href="structResults.html#o6">gammaP</a> = _results.<a class="code" href="structResults.html#o5">gamma0</a>;
00443     _results.<a class="code" href="structResults.html#o7">gammaM</a> = _results.<a class="code" href="structResults.html#o5">gamma0</a>;
00444     
00445     prog2.<a class="code" href="classProgressBar.html#a1">setName</a>(<span class="stringliteral">"Error on gamma"</span>);
00446     <span class="keywordflow">for</span> (g=g1;g&lt;g2;g+=dg/10.) {
00447         prog2.<a class="code" href="classProgressBar.html#a2">print</a>(1);
00448         _mcSpectrum-&gt;<a class="code" href="classMCSpectrum.html#a2">fill</a>(_results.<a class="code" href="structResults.html#o2">n0</a>,g,e0,Time);
00449         chiSquare = _mcSpectrum-&gt;<a class="code" href="classMCSpectrum.html#a3">chiSquare</a>(_data);
00450         
00451         <span class="keywordflow">if</span> (chiSquare&lt;_results.<a class="code" href="structResults.html#o0">chiSquare</a>+1) {
00452             _results.<a class="code" href="structResults.html#o6">gammaP</a>   = GSL_MAX_DBL( _results.<a class="code" href="structResults.html#o6">gammaP</a>, g );
00453             _results.<a class="code" href="structResults.html#o7">gammaM</a>   = GSL_MIN_DBL( _results.<a class="code" href="structResults.html#o7">gammaM</a>, g );
00454             <span class="keywordflow">if</span> (chiSquare&lt;_results.<a class="code" href="structResults.html#o0">chiSquare</a>) 
00455                 _results.<a class="code" href="structResults.html#o5">gamma0</a> = g;
00456         }
00457 
00458     }
00459     prog2.<a class="code" href="classProgressBar.html#a3">printClear</a>();
00460     cout &lt;&lt; <span class="stringliteral">"Done"</span> &lt;&lt; endl;
00461 
00462     <span class="comment">//</span>
00463     <span class="comment">// Fill the histogram with best fit energy</span>
00464     <span class="comment">//</span>
00465     _mcSpectrum-&gt;<a class="code" href="classMCSpectrum.html#a2">fill</a>(_results.<a class="code" href="structResults.html#o2">n0</a>,_results.<a class="code" href="structResults.html#o5">gamma0</a>,e0,Time);
00466 
00467     <span class="comment">// TODO: make a histogram of simulated alpha after cuts filled by</span>
00468     <span class="comment">// weighting according to best fit parameters similar to the</span>
00469     <span class="comment">// fill() function.</span>
00470 
00471 
00472     <span class="comment">//</span>
00473     <span class="comment">// Fill all results into variables</span>
00474     <span class="comment">// </span>
00475     _results.<a class="code" href="structResults.html#o2">n0</a>       = pow(10,_results.<a class="code" href="structResults.html#o2">n0</a> );
00476     _results.<a class="code" href="structResults.html#o3">n0P</a>      = pow(10,_results.<a class="code" href="structResults.html#o3">n0P</a>);
00477     _results.<a class="code" href="structResults.html#o4">n0M</a>      = pow(10,_results.<a class="code" href="structResults.html#o4">n0M</a>);
00478     _results.<a class="code" href="structResults.html#o1">dof</a> = _mcSpectrum-&gt;<a class="code" href="classMCSpectrum.html#a4">dof</a>();
00479     
00480     _results.<a class="code" href="structResults.html#o8">e0</a> = e0;
00481     
00482     N0    = _results.<a class="code" href="structResults.html#o2">n0</a>;
00483     Gamma0 = _results.<a class="code" href="structResults.html#o5">gamma0</a>;
00484 }
00485 
<a name="l00490"></a><a class="code" href="classFitter.html#a3">00490</a> <span class="keywordtype">void</span> <a class="code" href="classFitter.html#a3">Fitter::save</a>() {
00491     
00492     <span class="comment">// output _results</span>
00493     <span class="comment">// first give fit parameters:</span>
00494     <span class="keywordtype">double</span> lower, upper;
00495     cout &lt;&lt; endl &lt;&lt; endl &lt;&lt; <span class="stringliteral">"Fit Results"</span> &lt;&lt; endl;
00496     
00497     cout &lt;&lt; <span class="stringliteral">"(chi_s/dof) : ("</span>
00498          &lt;&lt; setprecision(3) &lt;&lt; _results.<a class="code" href="structResults.html#o0">chiSquare</a> &lt;&lt; <span class="stringliteral">" / "</span> 
00499          &lt;&lt; _results.<a class="code" href="structResults.html#o1">dof</a>    &lt;&lt; <span class="stringliteral">")"</span>   &lt;&lt; endl ;
00500     
00501     lower = _results.<a class="code" href="structResults.html#o2">n0</a> - _results.<a class="code" href="structResults.html#o4">n0M</a>;
00502     upper = _results.<a class="code" href="structResults.html#o3">n0P</a> - _results.<a class="code" href="structResults.html#o2">n0</a>;
00503     cout &lt;&lt; <span class="stringliteral">"N0          :  "</span>&lt;&lt; setprecision(3)&lt;&lt; _results.<a class="code" href="structResults.html#o2">n0</a>        
00504          &lt;&lt; <span class="stringliteral">" - "</span> &lt;&lt; setprecision(3) &lt;&lt; lower 
00505          &lt;&lt; <span class="stringliteral">" + "</span> &lt;&lt; setprecision(3) &lt;&lt; upper &lt;&lt; endl;
00506     
00507     lower = _results.<a class="code" href="structResults.html#o5">gamma0</a> - _results.<a class="code" href="structResults.html#o7">gammaM</a>;
00508     upper = _results.<a class="code" href="structResults.html#o6">gammaP</a> - _results.<a class="code" href="structResults.html#o5">gamma0</a>;
00509     cout &lt;&lt; <span class="stringliteral">"Gamma0      :  "</span> &lt;&lt; setprecision(3) &lt;&lt; _results.<a class="code" href="structResults.html#o5">gamma0</a>  
00510          &lt;&lt; <span class="stringliteral">" - "</span> &lt;&lt; setprecision(3) &lt;&lt; lower 
00511          &lt;&lt; <span class="stringliteral">" + "</span> &lt;&lt; setprecision(3) &lt;&lt; upper &lt;&lt; endl &lt;&lt; endl;
00512 
00513     cout &lt;&lt; <span class="stringliteral">"E0          :  "</span> &lt;&lt; _results.<a class="code" href="structResults.html#o8">e0</a>  &lt;&lt; endl;
00514     cout &lt;&lt; endl &lt;&lt; endl;
00515     cout &lt;&lt; <span class="stringliteral">" N0 low_error  high_error gamma0 low_error  high_error "</span>  &lt;&lt; endl;
00516         cout &lt;&lt; _results.<a class="code" href="structResults.html#o2">n0</a> &lt;&lt; <span class="stringliteral">"  "</span> &lt;&lt; _results.<a class="code" href="structResults.html#o4">n0M</a> &lt;&lt; <span class="stringliteral">"  "</span>  &lt;&lt; _results.<a class="code" href="structResults.html#o3">n0P</a> &lt;&lt; <span class="stringliteral">"  "</span>  
00517              &lt;&lt; _results.<a class="code" href="structResults.html#o5">gamma0</a> &lt;&lt; <span class="stringliteral">"  "</span> &lt;&lt; _results.<a class="code" href="structResults.html#o7">gammaM</a> &lt;&lt; <span class="stringliteral">"  "</span> &lt;&lt; _results.<a class="code" href="structResults.html#o6">gammaP</a>  &lt;&lt; endl; 
00518          
00519     <span class="comment">// Now give fluxes</span>
00520     cout &lt;&lt; <span class="stringliteral">"Writing Energy Spectrum to file."</span> &lt;&lt; endl;
00521         
00522     <span class="keywordtype">int</span> i;
00523     <span class="keywordtype">double</span> logEnergy,energy,lowerError,upperError,model;
00524     <span class="keywordtype">double</span> observed,scaleFactor;
00525     <span class="keywordtype">double</span> fluxModel,fluxObserved,error;
00526     ofstream fluxesFile(<span class="stringliteral">"Totals/espectrum.text"</span>);
00527     
00528     fluxesFile &lt;&lt; <span class="stringliteral">"# energy lowerError upperError data variance "</span>
00529                &lt;&lt; <span class="stringliteral">"model flux error"</span> &lt;&lt; endl;
00530 
00531     <span class="keywordflow">for</span> (i=0;i&lt;_mcSpectrum-&gt;<a class="code" href="classMCSpectrum.html#a7">getSpectrum</a>()-&gt;<a class="code" href="classHistogram.html#a17">numBins</a>();i++) {
00532         <span class="comment">// column output</span>
00533         <span class="comment">// (1)-(3) info on energy bin,</span>
00534         <span class="comment">// (4) data counts</span>
00535         <span class="comment">// (5) error on (4)</span>
00536         <span class="comment">// (6) model counts</span>
00537         
00538         _mcSpectrum-&gt;<a class="code" href="classMCSpectrum.html#a6">getRange</a>(i,lower,upper );
00539         logEnergy   = (lower+upper)/2.;
00540         energy      = pow(10.,logEnergy);
00541         lowerError  = energy-pow(10.,lower);
00542         upperError  = pow(10.,upper)-energy;
00543         model         = _mcSpectrum-&gt;<a class="code" href="classMCSpectrum.html#a5">get</a>(i);
00544         
00545         fluxesFile &lt;&lt; setprecision(6)&lt;&lt; energy &lt;&lt; <span class="stringliteral">" "</span> 
00546                    &lt;&lt; setprecision(6)&lt;&lt; lowerError &lt;&lt; <span class="stringliteral">" "</span> 
00547                    &lt;&lt; setprecision(6)&lt;&lt; upperError &lt;&lt; <span class="stringliteral">" "</span>
00548                    &lt;&lt; setw(5)         &lt;&lt; _data[i].onOff &lt;&lt; <span class="stringliteral">" "</span> 
00549                    &lt;&lt; setprecision(6)&lt;&lt; sqrt(_data[i].onOffVariance) &lt;&lt; <span class="stringliteral">" "</span> 
00550                    &lt;&lt; setprecision(6)&lt;&lt; model &lt;&lt; <span class="stringliteral">" "</span>;
00551         
00552         <span class="keywordflow">if</span> (model&gt;0) {
00553             
00554             <span class="comment">// strategy: compute model energy spectrum and scale it by</span>
00555             <span class="comment">// ratio of predicted counts to observed counts</span>
00556             
00557             observed      = _data[i].onOff;
00558             scaleFactor   = observed/model;
00559             fluxModel     = _results.<a class="code" href="structResults.html#o2">n0</a>*pow(energy,_results.<a class="code" href="structResults.html#o5">gamma0</a>)*exp(-1*energy/_results.<a class="code" href="structResults.html#o8">e0</a>);
00560             fluxObserved  = scaleFactor * fluxModel;
00561             
00562             <span class="keywordflow">if</span> (_data[i].onOffVariance&gt;0)
00563                 error         = sqrt(_data[i].onOffVariance)/_data[i].onOff  
00564                     * fluxObserved;
00565             <span class="keywordflow">else</span>
00566                 error =0.;
00567         }
00568         <span class="keywordflow">else</span> {
00569             fluxObserved =0.;
00570             error=0.;
00571         }
00572         
00573         <span class="comment">// column output </span>
00574         <span class="comment">// (7) estimated flux for ith bin</span>
00575         <span class="comment">// (8) error on (7)</span>
00576         fluxesFile &lt;&lt; setprecision(6)&lt;&lt; fluxObserved &lt;&lt; <span class="stringliteral">" "</span> 
00577                    &lt;&lt; setprecision(6)&lt;&lt; error &lt;&lt; endl ;
00578     }
00579 
00580     fluxesFile.close();
00581 
00582 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Apr 21 10:22:45 2007 for wuparam by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
