<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>wuparam: ImageAnalyzer.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>ImageAnalyzer.cpp</h1><div class="fragment"><pre>00001 <span class="comment">// ImageAnalyzer.cpp</span>
00002 <span class="comment">// Karl Kosack &lt;kosack@hbar.wustl.edu&gt;</span>
00003 
00004 
00005 <span class="preprocessor">#include &lt;iostream&gt;</span>
00006 <span class="preprocessor">#include &lt;iomanip&gt;</span>
00007 <span class="preprocessor">#include &lt;valarray&gt;</span>
00008 <span class="preprocessor">#include &lt;gsl/gsl_sf_trig.h&gt;</span>
00009 <span class="preprocessor">#include &lt;gsl/gsl_math.h&gt;</span>
00010 
00011 <span class="preprocessor">#include "Camera.h"</span>
00012 <span class="preprocessor">#include "Types.h"</span>
00013 <span class="preprocessor">#include "ImageAnalyzer.h"</span>
00014 <span class="preprocessor">#include "DataWriter.h"</span>
00015 
00016 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00017 <span class="keywordtype">void</span> ImageAnalyzer::init( Array_t &amp;xcoords, Array_t &amp;ycoords, <span class="keywordtype">int</span> n ) {
00018 
00019     _nadc = n;
00020 
00021     <span class="keywordtype">int</span> npix = xcoords.size();
00022     
00023     _x.resize( npix );
00024     _y.resize( npix  );
00025     _x2.resize( npix );
00026     _y2.resize( npix );
00027     _xy.resize( npix );
00028 
00029     <span class="comment">//=========================================================================</span>
00030     <span class="comment">// Precalculate stuff for speed</span>
00031 
00032     _x = xcoords;
00033     _y = ycoords;
00034     _x2  = _x * _x;                     <span class="comment">// these are valarrays, so we </span>
00035     _y2  = _y * _y;                     <span class="comment">// can just multiply them </span>
00036     _xy  = _x * _y;                     <span class="comment">// directly (no loop needed!)</span>
00037 
00038 
00039 }
00040 
00041 
<a name="l00045"></a><a class="code" href="classImageAnalyzer.html#a0">00045</a> <a class="code" href="classImageAnalyzer.html#a0">ImageAnalyzer::ImageAnalyzer</a>( <a class="code" href="classCamera.html">Camera</a> *cam )  {
00046 
00047     <span class="comment">// KPK: used last pixel instead of getNumPixels to ignore outer tubes</span>
00048 
00049     init(cam-&gt;<a class="code" href="classCamera.html#a13">xCoords</a>(), cam-&gt;<a class="code" href="classCamera.html#a14">yCoords</a>(),cam-&gt;<a class="code" href="classCamera.html#a11">getLastPixel</a>() );
00050    
00051     
00052 
00053 }
00054 
00062 <a class="code" href="classHillasImageAnalyzer.html#a0">HillasImageAnalyzer::</a>
<a name="l00063"></a><a class="code" href="classHillasImageAnalyzer.html#a0">00063</a> <a class="code" href="classHillasImageAnalyzer.html#a0">HillasImageAnalyzer</a>( <a class="code" href="classCamera.html">Camera</a> *cam, <span class="keywordtype">double</span> elongation ) 
00064     :  _elongation(elongation), <a class="code" href="classImageAnalyzer.html">ImageAnalyzer</a>(cam)
00065 {
00066     
00067 
00068     _2d_is_enabled = <span class="keyword">true</span>;
00069 
00070 }
00071 
00072 
00082 <span class="keywordtype">void</span>
00083 <a class="code" href="classHillasImageAnalyzer.html#a1">HillasImageAnalyzer::</a>
<a name="l00084"></a><a class="code" href="classHillasImageAnalyzer.html#a1">00084</a> <a class="code" href="classHillasImageAnalyzer.html#a1">parameterize</a>(<span class="keyword">const</span> Array_t &amp;image, vector&lt;int&gt; &amp;cleanpixels){
00085 
00086     <span class="keyword">register</span> <span class="keywordtype">int</span> i;
00087     vector&lt;int&gt;::iterator iter;
00088     <span class="keywordtype">double</span> totalsignal=0;
00089     <span class="keywordtype">double</span> momx=0,momy=0, momx2=0, momy2=0, momxy=0, momx3=0, momy3=0;
00090     <span class="keywordtype">double</span> momx2y=0, momxy2=0;
00091     <span class="keywordtype">double</span> vx2, vy2, vxy, vx3, vy3, vx2y, vxy2;
00092     <span class="keywordtype">double</span> d,z, tanpsi_numerator, tanpsi_denominator, sinalpha, azwidth2,z2;
00093     <span class="keywordtype">double</span> cospsi, sinpsi;
00094     <span class="keywordtype">double</span> disp;
00095     <a class="code" href="structCoordinate__t.html">Coordinate_t</a> pa,pb,tempcoord;
00096     <span class="keywordtype">double</span> tmp;
00097     <span class="keywordtype">double</span> u,v;
00098     <span class="keywordtype">double</span> apsi;
00099     Array_t qx, qy;
00100 
00101     _param.<a class="code" href="structImageParameterization.html#o4">invalid</a> = 0;
00102 
00103     <span class="comment">//=========================================================================</span>
00104     <span class="comment">// Get total signal (sum over picture and boundary)</span>
00105 
00106     _param.<a class="code" href="structHillasParameterization.html#o16">pixels_in_picture</a> = 0;
00107 
00108     <span class="keywordflow">for</span> (iter=cleanpixels.begin(); iter != cleanpixels.end(); iter++) {
00109         totalsignal += image[*iter];
00110         _param.<a class="code" href="structHillasParameterization.html#o16">pixels_in_picture</a>++;
00111     }
00112 
00113     _param.<a class="code" href="structHillasParameterization.html#o5">size</a> = totalsignal;
00114 
00115     <span class="keywordflow">if</span> (totalsignal &lt; EPSILON) {
00116         clearParam(_param);
00117         _param.<a class="code" href="structImageParameterization.html#o4">invalid</a>=1;
00118         <span class="keywordflow">return</span>;
00119     }
00120 
00121     <span class="comment">//=========================================================================</span>
00122     <span class="comment">// Calculate moments &lt;x&gt;,&lt;y&gt;,&lt;x^2&gt;,&lt;y^2&gt;,&lt;xy&gt; and use values</span>
00123     <span class="comment">// precalculated in the constructor to minimize multiplies.  Third</span>
00124     <span class="comment">// order moments are calculated later, when the the asymmetry</span>
00125     <span class="comment">// calculation is done (since they myst be centered on the point</span>
00126     <span class="comment">// of origin, not the camera origin)</span>
00127 
00128     <span class="keywordflow">for</span> (iter=cleanpixels.begin(); iter != cleanpixels.end(); iter++) {
00129         momx    += image[*iter] * _x[*iter]  ;
00130         momy    += image[*iter] * _y[*iter];  
00131         momx2   += image[*iter] * _x2[*iter];
00132         momy2   += image[*iter] * _y2[*iter];
00133         momxy   += image[*iter] * _xy[*iter];
00134     }
00135 
00136     momx   /= totalsignal;
00137     momy   /= totalsignal;
00138     momx2  /= totalsignal;
00139     momy2  /= totalsignal;
00140     momxy  /= totalsignal;
00141     
00142     <span class="comment">//=========================================================================</span>
00143     <span class="comment">// Calculate variances (sigma = sqrt(variance))</span>
00144 
00145     vx2  = (momx2 - momx*momx);      <span class="comment">// &lt;x^2&gt; - &lt;x&gt;^2</span>
00146     vy2  = (momy2 - momy*momy);      <span class="comment">// &lt;y^2&gt; - &lt;y&gt;^2</span>
00147     vxy  = (momxy - momx*momy);      <span class="comment">// &lt;xy&gt; - &lt;x&gt;&lt;y&gt;</span>
00148 
00149     <span class="comment">//=========================================================================</span>
00150     <span class="comment">// Calculate some common factors...</span>
00151 
00152     d = vy2 - vx2; 
00153     
00154     z2 = d*d + 4.0*vxy*vxy;
00155     <span class="keywordflow">if</span> (z2&gt;0) 
00156         z = sqrt(z2) ;
00157     <span class="keywordflow">else</span> {
00158         z = 0.0;
00159         _param.<a class="code" href="structImageParameterization.html#o4">invalid</a>++;
00160     }
00161 
00162     <span class="comment">//======================================================================== </span>
00163     <span class="comment">// Calculate Centroid</span>
00164 
00165     _param.<a class="code" href="structHillasParameterization.html#o0">centroid</a>.<a class="code" href="structCoordinate__t.html#o0">x</a> = momx;
00166     _param.<a class="code" href="structHillasParameterization.html#o0">centroid</a>.<a class="code" href="structCoordinate__t.html#o1">y</a> = momy;
00167 
00168     <span class="comment">//=========================================================================</span>
00169     <span class="comment">// Calculate width and length</span>
00170 
00171     tmp  = (vx2 + vy2 - z )/2.0;
00172     <span class="keywordflow">if</span> (tmp&gt;0) _param.<a class="code" href="structHillasParameterization.html#o4">width</a> = sqrt(tmp);
00173     <span class="keywordflow">else</span> {_param.<a class="code" href="structHillasParameterization.html#o4">width</a> = 0.0; _param.<a class="code" href="structImageParameterization.html#o4">invalid</a>++;}
00174 
00175     tmp = ( vx2 + vy2 + z )/2.0;
00176     <span class="keywordflow">if</span> (tmp&gt;0) _param.<a class="code" href="structHillasParameterization.html#o3">length</a> = sqrt(tmp);
00177     <span class="keywordflow">else</span> {_param.<a class="code" href="structHillasParameterization.html#o3">length</a>=0.0; _param.<a class="code" href="structImageParameterization.html#o4">invalid</a>++;}
00178 
00179     <span class="comment">//=========================================================================</span>
00180     <span class="comment">// Calculate length over size</span>
00181     
00182     _param.<a class="code" href="structHillasParameterization.html#o10">length_over_size</a> = _param.<a class="code" href="structHillasParameterization.html#o3">length</a> / _param.<a class="code" href="structHillasParameterization.html#o5">size</a>;
00183 
00184     <span class="comment">//=========================================================================</span>
00185     <span class="comment">// Calculate distance</span>
00186 
00187     _param.<a class="code" href="structHillasParameterization.html#o7">distance</a> = gsl_hypot(momx, momy);
00188 
00189     <span class="comment">//=========================================================================</span>
00190     <span class="comment">// Calculate miss</span>
00191 
00192     <span class="keywordflow">if</span> (z &gt; 0.0) {
00193 
00194         u = 1.0+d/z;
00195         v = 2.0-u;
00196         
00197         tmp = (u*momx*momx + v*momy*momy)/2.0 - momx*momy*2.0*vxy/z;
00198         <span class="keywordflow">if</span>(tmp&gt;0.0) _param.<a class="code" href="structHillasParameterization.html#o6">miss</a> = sqrt(tmp);
00199         <span class="keywordflow">else</span> { _param.<a class="code" href="structHillasParameterization.html#o6">miss</a>=0; } <span class="comment">// don't want small miss to be invalid here</span>
00200     }
00201     <span class="keywordflow">else</span> {
00202         _param.<a class="code" href="structHillasParameterization.html#o6">miss</a> = _param.<a class="code" href="structHillasParameterization.html#o7">distance</a>;
00203     }
00204 
00205     <span class="comment">//=========================================================================</span>
00206     <span class="comment">// Calculate azwidth</span>
00207 
00208     azwidth2 = (momx2 + momy2 - z);
00209     <span class="keywordflow">if</span> (azwidth2&gt;0.0) _param.<a class="code" href="structHillasParameterization.html#o8">azwidth</a> = sqrt(azwidth2);
00210     <span class="keywordflow">else</span> {_param.<a class="code" href="structHillasParameterization.html#o8">azwidth</a>=0.0; _param.<a class="code" href="structImageParameterization.html#o4">invalid</a>++;}
00211 
00212     <span class="comment">//=========================================================================</span>
00213     <span class="comment">// Calculate psi angle</span>
00214 
00215     tanpsi_numerator = (d+z)*momy + 2.0*vxy*momx;
00216     tanpsi_denominator = (2*vxy*momy) - (d-z)*momx;
00217 
00218     <span class="keywordflow">if</span> (tanpsi_numerator &gt; 1.0) 
00219         tanpsi_numerator = 1.0;
00220     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tanpsi_numerator&lt;-1.0) 
00221         tanpsi_numerator = -1.0;
00222     <span class="keywordflow">if</span> (tanpsi_denominator &gt; 1.0) 
00223         tanpsi_denominator = 1.0;
00224     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tanpsi_denominator&lt;-1.0) 
00225         tanpsi_denominator = -1.0;
00226     
00227     <span class="keywordflow">if</span> (fabs(tanpsi_denominator) &gt; EPSILON ) 
00228         _param.<a class="code" href="structHillasParameterization.html#o11">psi</a> = atan2( tanpsi_numerator, tanpsi_denominator );
00229     <span class="keywordflow">else</span> {
00230         _param.<a class="code" href="structHillasParameterization.html#o11">psi</a> = M_PI_2;
00231         _param.<a class="code" href="structImageParameterization.html#o4">invalid</a>++;
00232     }
00233 
00234     <span class="comment">//    _param.psi = gsl_sf_angle_restrict_pos(_param.psi);</span>
00235 
00236     <span class="comment">//=========================================================================</span>
00237     <span class="comment">// Calculate alpha angle</span>
00238 
00239     sinalpha = _param.<a class="code" href="structHillasParameterization.html#o6">miss</a>/_param.<a class="code" href="structHillasParameterization.html#o7">distance</a>;
00240     <span class="keywordflow">if</span> (-1.0 &lt;= sinalpha &amp;&amp; sinalpha &lt;= 1.0)
00241         _param.<a class="code" href="structHillasParameterization.html#o9">alpha</a> = asin( sinalpha );
00242     <span class="keywordflow">else</span> {
00243         _param.<a class="code" href="structHillasParameterization.html#o9">alpha</a> = (sinalpha &gt;=1)? LARGE : -LARGE;
00244         _param.<a class="code" href="structImageParameterization.html#o4">invalid</a>++;
00245     }
00246 
00247     <span class="comment">//=========================================================================</span>
00248     <span class="comment">// Calculate phi angle (centroid polar angle)</span>
00249 
00250     _param.<a class="code" href="structHillasParameterization.html#o12">phi</a> = atan2( _param.<a class="code" href="structHillasParameterization.html#o0">centroid</a>.<a class="code" href="structCoordinate__t.html#o1">y</a>, _param.<a class="code" href="structHillasParameterization.html#o0">centroid</a>.<a class="code" href="structCoordinate__t.html#o0">x</a> );
00251     _param.<a class="code" href="structHillasParameterization.html#o12">phi</a> = gsl_sf_angle_restrict_pos( _param.<a class="code" href="structHillasParameterization.html#o12">phi</a> );
00252 
00253     <span class="comment">//=========================================================================</span>
00254     <span class="comment">// Obtain the max adc values... </span>
00255 
00256     <span class="keywordflow">for</span> (i=0; i&lt;3; i++) {
00257         _param.<a class="code" href="structHillasParameterization.html#o13">max</a>[i] = 0.0;
00258         _param.<a class="code" href="structHillasParameterization.html#o14">index_of_max</a>[i] = 0;
00259     }
00260     
00261     <span class="keywordflow">for</span> (iter=cleanpixels.begin(); iter != cleanpixels.end(); iter++) {
00262 
00263         <span class="keywordflow">if</span> ( image[*iter] &gt; _param.<a class="code" href="structHillasParameterization.html#o13">max</a>[2] ){
00264             <span class="keywordflow">if</span> ( image[*iter] &gt; _param.<a class="code" href="structHillasParameterization.html#o13">max</a>[1] ){
00265                 <span class="keywordflow">if</span> ( image[*iter] &gt; _param.<a class="code" href="structHillasParameterization.html#o13">max</a>[0] ){
00266                     _param.<a class="code" href="structHillasParameterization.html#o13">max</a>[2] = _param.<a class="code" href="structHillasParameterization.html#o13">max</a>[1];
00267                     _param.<a class="code" href="structHillasParameterization.html#o13">max</a>[1] = _param.<a class="code" href="structHillasParameterization.html#o13">max</a>[0];
00268                     _param.<a class="code" href="structHillasParameterization.html#o13">max</a>[0] = image[*iter];
00269                     _param.<a class="code" href="structHillasParameterization.html#o14">index_of_max</a>[2] = _param.<a class="code" href="structHillasParameterization.html#o14">index_of_max</a>[1];
00270                     _param.<a class="code" href="structHillasParameterization.html#o14">index_of_max</a>[1] = _param.<a class="code" href="structHillasParameterization.html#o14">index_of_max</a>[0];
00271                     _param.<a class="code" href="structHillasParameterization.html#o14">index_of_max</a>[0] = *iter;
00272                 }
00273                 <span class="keywordflow">else</span> {
00274                     _param.<a class="code" href="structHillasParameterization.html#o13">max</a>[2] = _param.<a class="code" href="structHillasParameterization.html#o13">max</a>[1];
00275                     _param.<a class="code" href="structHillasParameterization.html#o13">max</a>[1] = image[*iter];
00276                     _param.<a class="code" href="structHillasParameterization.html#o14">index_of_max</a>[2] = _param.<a class="code" href="structHillasParameterization.html#o14">index_of_max</a>[1];
00277                     _param.<a class="code" href="structHillasParameterization.html#o14">index_of_max</a>[1] = *iter;
00278                 }
00279             }
00280             <span class="keywordflow">else</span> {
00281                     _param.<a class="code" href="structHillasParameterization.html#o13">max</a>[2] = image[*iter];
00282                     _param.<a class="code" href="structHillasParameterization.html#o14">index_of_max</a>[2] = *iter;
00283             }
00284         }
00285     }    
00286 
00287     <span class="comment">//=========================================================================</span>
00288     <span class="comment">// Obtain frac[3] values</span>
00289     
00290     _param.<a class="code" href="structHillasParameterization.html#o15">frac</a>[0] = _param.<a class="code" href="structHillasParameterization.html#o13">max</a>[0]/totalsignal;
00291     _param.<a class="code" href="structHillasParameterization.html#o15">frac</a>[1] = _param.<a class="code" href="structHillasParameterization.html#o15">frac</a>[0] + _param.<a class="code" href="structHillasParameterization.html#o13">max</a>[1]/totalsignal;
00292     _param.<a class="code" href="structHillasParameterization.html#o15">frac</a>[2] = _param.<a class="code" href="structHillasParameterization.html#o15">frac</a>[1] + _param.<a class="code" href="structHillasParameterization.html#o13">max</a>[2]/totalsignal;
00293 
00294     <span class="comment">//=========================================================================</span>
00295     <span class="comment">// 2-D analysis</span>
00296 
00297     _param.<a class="code" href="structHillasParameterization.html#o17">asymmetry</a> = 0;
00298 
00299     <span class="keywordflow">if</span> ( _2d_is_enabled ) {
00300 
00301         <span class="comment">// ---------------------------------------------------------</span>
00302         <span class="comment">// Calculate 2 possible Points of Origin</span>
00303 
00304         cospsi = cos( -_param.<a class="code" href="structHillasParameterization.html#o11">psi</a> );
00305         sinpsi = sin( -_param.<a class="code" href="structHillasParameterization.html#o11">psi</a> );
00306 
00307         <span class="comment">// First calculate the displacement along the major-axis of the</span>
00308         <span class="comment">// point of origin (don't know whether it is plus or minus)</span>
00309 
00310 
00311         <span class="keywordflow">if</span> (_param.<a class="code" href="structHillasParameterization.html#o3">length</a> &gt; EPSILON) {
00312             disp = fabs( _elongation - _elongation *
00313                         _param.<a class="code" href="structHillasParameterization.html#o4">width</a>/_param.<a class="code" href="structHillasParameterization.html#o3">length</a> );
00314         }
00315         <span class="keywordflow">else</span> {
00316             disp = -LARGE;
00317         }
00318         
00319         <span class="comment">// the points of origin in this frame are given by </span>
00320         <span class="comment">// x' = x +/= disp, y' = y  </span>
00321 
00322         pa.<a class="code" href="structCoordinate__t.html#o0">x</a> = -disp;
00323         pb.<a class="code" href="structCoordinate__t.html#o0">x</a> = disp;
00324         pa.<a class="code" href="structCoordinate__t.html#o1">y</a> = 0.0;
00325         pb.<a class="code" href="structCoordinate__t.html#o1">y</a> = 0.0;
00326                                                      
00327         <span class="comment">// now put into correct orientation by rotating by psi</span>
00328         <span class="comment">// and then translating to the centroid </span>
00329 
00330         <span class="keywordflow">if</span> (fabs(_param.<a class="code" href="structHillasParameterization.html#o11">psi</a>) &gt; EPSILON ) {
00331             _param.<a class="code" href="structHillasParameterization.html#o1">point_of_origin_a</a>.<a class="code" href="structCoordinate__t.html#o0">x</a> = pa.<a class="code" href="structCoordinate__t.html#o0">x</a> * cospsi + pa.<a class="code" href="structCoordinate__t.html#o1">y</a>*sinpsi;
00332             _param.<a class="code" href="structHillasParameterization.html#o1">point_of_origin_a</a>.<a class="code" href="structCoordinate__t.html#o1">y</a> = -pa.<a class="code" href="structCoordinate__t.html#o0">x</a> * sinpsi + pa.<a class="code" href="structCoordinate__t.html#o1">y</a>*cospsi;
00333             _param.<a class="code" href="structHillasParameterization.html#o2">point_of_origin_b</a>.<a class="code" href="structCoordinate__t.html#o0">x</a> = pb.<a class="code" href="structCoordinate__t.html#o0">x</a> * cospsi + pb.<a class="code" href="structCoordinate__t.html#o1">y</a>*sinpsi;
00334             _param.<a class="code" href="structHillasParameterization.html#o2">point_of_origin_b</a>.<a class="code" href="structCoordinate__t.html#o1">y</a> = -pb.<a class="code" href="structCoordinate__t.html#o0">x</a> * sinpsi + pb.<a class="code" href="structCoordinate__t.html#o1">y</a>*cospsi;
00335         }       
00336         <span class="keywordflow">else</span> {
00337             _param.<a class="code" href="structHillasParameterization.html#o1">point_of_origin_a</a>.<a class="code" href="structCoordinate__t.html#o0">x</a> = pa.<a class="code" href="structCoordinate__t.html#o0">x</a>;
00338             _param.<a class="code" href="structHillasParameterization.html#o1">point_of_origin_a</a>.<a class="code" href="structCoordinate__t.html#o1">y</a> = pa.<a class="code" href="structCoordinate__t.html#o1">y</a>;
00339             _param.<a class="code" href="structHillasParameterization.html#o2">point_of_origin_b</a>.<a class="code" href="structCoordinate__t.html#o0">x</a> = pb.<a class="code" href="structCoordinate__t.html#o0">x</a>;
00340             _param.<a class="code" href="structHillasParameterization.html#o2">point_of_origin_b</a>.<a class="code" href="structCoordinate__t.html#o1">y</a> = pb.<a class="code" href="structCoordinate__t.html#o1">y</a>;
00341         }
00342 
00343         _param.<a class="code" href="structHillasParameterization.html#o1">point_of_origin_a</a>.<a class="code" href="structCoordinate__t.html#o0">x</a> += _param.<a class="code" href="structHillasParameterization.html#o0">centroid</a>.<a class="code" href="structCoordinate__t.html#o0">x</a>;
00344         _param.<a class="code" href="structHillasParameterization.html#o1">point_of_origin_a</a>.<a class="code" href="structCoordinate__t.html#o1">y</a> += _param.<a class="code" href="structHillasParameterization.html#o0">centroid</a>.<a class="code" href="structCoordinate__t.html#o1">y</a>;
00345         _param.<a class="code" href="structHillasParameterization.html#o2">point_of_origin_b</a>.<a class="code" href="structCoordinate__t.html#o0">x</a> += _param.<a class="code" href="structHillasParameterization.html#o0">centroid</a>.<a class="code" href="structCoordinate__t.html#o0">x</a>;
00346         _param.<a class="code" href="structHillasParameterization.html#o2">point_of_origin_b</a>.<a class="code" href="structCoordinate__t.html#o1">y</a> += _param.<a class="code" href="structHillasParameterization.html#o0">centroid</a>.<a class="code" href="structCoordinate__t.html#o1">y</a>;
00347 
00348         <span class="comment">// ---------------------------------------------------------</span>
00349         <span class="comment">// Now, we need to know which of the two points is the correct</span>
00350         <span class="comment">// one, so calculate the Asymmetry about one of the points.</span>
00351         <span class="comment">// Put the favored point in "a" and the reject in "b"</span>
00352 
00353         <span class="comment">// For the asymmetry calculation, we need to calculate vx3,</span>
00354         <span class="comment">// vx2y, vxy2, vy3 centered around one of the possible points</span>
00355         <span class="comment">// of origin (not about the camera center). That means</span>
00356         <span class="comment">// recalculating all the moments about the new origin.  I</span>
00357         <span class="comment">// don't use the precalculated arrays (_x, _y, etc.) since</span>
00358         <span class="comment">// it's pointless to recalculate ALL the pixels, just the ones</span>
00359         <span class="comment">// in the image. The precalculated arrays are still useful for</span>
00360         <span class="comment">// the next event, so they shouldn't be modified.</span>
00361         
00362         <span class="keywordtype">double</span> x,y;
00363         <span class="keywordtype">int</span> sign;
00364         momx=0; momy=0; momx2=0; momy2=0; momxy=0;
00365         momx3=0; momy3=0; momx2y=0; momxy2=0;
00366 
00367         <span class="keywordflow">for</span> (iter=cleanpixels.begin(); iter != cleanpixels.end(); iter++) {
00368             x = _x[*iter]-_param.<a class="code" href="structHillasParameterization.html#o1">point_of_origin_a</a>.<a class="code" href="structCoordinate__t.html#o0">x</a>;
00369             y = _y[*iter]-_param.<a class="code" href="structHillasParameterization.html#o1">point_of_origin_a</a>.<a class="code" href="structCoordinate__t.html#o1">y</a>;
00370             momx    += image[*iter] * x;
00371             momy    += image[*iter] * y;
00372             momx2   += image[*iter] * x*x;
00373             momy2   += image[*iter] * y*y;
00374             momxy   += image[*iter] * x*y;
00375             momx3   += image[*iter] * x*x*x;
00376             momy3   += image[*iter] * y*y*y;
00377             momx2y  += image[*iter] * x*x*y;
00378             momxy2  += image[*iter] * x*y*y;
00379         }
00380 
00381         momx   /= totalsignal;  
00382         momy   /= totalsignal;
00383         momx2  /= totalsignal;
00384         momy2  /= totalsignal;
00385         momxy  /= totalsignal;
00386         momx3  /= totalsignal;
00387         momy3  /= totalsignal;
00388         momx2y /= totalsignal;
00389         momxy2 /= totalsignal;
00390 
00391         vx3  = (momx3  - 3*momx2*momx + 2*momx*momx*momx);
00392         vy3  = (momy3  - 3*momy2*momy + 2*momy*momy*momy);
00393         vx2y = (momx2y - 2*momxy*momx + 2*momx*momx*momy - momx2*momy);
00394         vxy2 = (momxy2 - 2*momxy*momy + 2*momx*momy*momy - momx*momy2);
00395         
00396         <span class="comment">// Recalculate psi angle from the new point:</span>
00397         <span class="comment">// Really, the angle should be the same as for the origin, but </span>
00398         <span class="comment">// the sign may be incorrect (since the quandrants are different)</span>
00399 
00400         tanpsi_numerator = (d+z)*momy + 2.0*vxy*momx;
00401         tanpsi_denominator = (2*vxy*momy) - (d-z)*momx;
00402         apsi = atan2( tanpsi_numerator, tanpsi_denominator );
00403         cospsi = cos(apsi);
00404         sinpsi = sin(apsi);
00405         
00406         <span class="comment">// Now calculate the asymmetry</span>
00407 
00408         tmp = ( vx3*pow(cospsi,3) + 3*vx2y*cospsi*cospsi*sinpsi 
00409                 + 3*vxy2*cospsi*sinpsi*sinpsi + vy3*pow(sinpsi,3) );
00410 
00411         <span class="comment">// NOTE: unlike quicklook, assymmetry is an absolute value for</span>
00412         <span class="comment">// the correct point of origin (which is always "a")</span>
00413         <span class="comment">// A negative sign just means a swap occured</span>
00414 
00415         tmp = tmp/pow(_param.<a class="code" href="structHillasParameterization.html#o3">length</a>,3);
00416         sign = GSL_SIGN(tmp);
00417         _param.<a class="code" href="structHillasParameterization.html#o17">asymmetry</a> = sign*pow(fabs(tmp), 0.3333333);
00418 
00419         <span class="comment">// Swap points of origin if asymmetry is negative, so "a"</span>
00420         <span class="comment">// always contains the correct point of origin</span>
00421 
00422         <span class="keywordflow">if</span> (sign == -1 ) {
00423             tempcoord = _param.<a class="code" href="structHillasParameterization.html#o1">point_of_origin_a</a>;
00424             _param.<a class="code" href="structHillasParameterization.html#o1">point_of_origin_a</a> = _param.<a class="code" href="structHillasParameterization.html#o2">point_of_origin_b</a>;
00425             _param.<a class="code" href="structHillasParameterization.html#o2">point_of_origin_b</a> = tempcoord;
00426         }
00427 
00428     }
00429 
00430 }
00431 
00432 
00433 <span class="keywordtype">void</span>
00434 clearParam(<a class="code" href="structHillasParameterization.html">HillasParameterization</a> &amp;p ) {
00435 
00436     p.<a class="code" href="structImageParameterization.html#o5">event_number</a> =0;
00437     p.<a class="code" href="structImageParameterization.html#o2">gpstime</a> = 0;
00438     p.<a class="code" href="structHillasParameterization.html#o19">zenith</a>=0;
00439     p.<a class="code" href="structHillasParameterization.html#o16">pixels_in_picture</a> = 0;
00440     p.<a class="code" href="structHillasParameterization.html#o0">centroid</a>.<a class="code" href="structCoordinate__t.html#o0">x</a> = p.<a class="code" href="structHillasParameterization.html#o0">centroid</a>.<a class="code" href="structCoordinate__t.html#o1">y</a> = 0.0;
00441     p.<a class="code" href="structHillasParameterization.html#o1">point_of_origin_a</a>.<a class="code" href="structCoordinate__t.html#o0">x</a> = p.<a class="code" href="structHillasParameterization.html#o1">point_of_origin_a</a>.<a class="code" href="structCoordinate__t.html#o1">y</a> = 0.0;
00442     p.<a class="code" href="structHillasParameterization.html#o2">point_of_origin_b</a>.<a class="code" href="structCoordinate__t.html#o0">x</a> = p.<a class="code" href="structHillasParameterization.html#o2">point_of_origin_b</a>.<a class="code" href="structCoordinate__t.html#o1">y</a> = 0.0;
00443     p.<a class="code" href="structHillasParameterization.html#o3">length</a> = p.<a class="code" href="structHillasParameterization.html#o4">width</a> = 0.0;
00444     p.<a class="code" href="structHillasParameterization.html#o10">length_over_size</a> = 0.0;
00445     p.<a class="code" href="structHillasParameterization.html#o6">miss</a> = p.<a class="code" href="structHillasParameterization.html#o7">distance</a> = p.<a class="code" href="structHillasParameterization.html#o8">azwidth</a> = 0.0;
00446     p.<a class="code" href="structHillasParameterization.html#o5">size</a> = 0.0;
00447     p.<a class="code" href="structHillasParameterization.html#o9">alpha</a>=p.<a class="code" href="structHillasParameterization.html#o11">psi</a>=p.<a class="code" href="structHillasParameterization.html#o12">phi</a>=0.0;
00448     p.<a class="code" href="structHillasParameterization.html#o13">max</a>[0]=p.<a class="code" href="structHillasParameterization.html#o13">max</a>[1]=p.<a class="code" href="structHillasParameterization.html#o13">max</a>[2]=0.0;
00449     p.<a class="code" href="structHillasParameterization.html#o14">index_of_max</a>[0]= p.<a class="code" href="structHillasParameterization.html#o14">index_of_max</a>[1]= p.<a class="code" href="structHillasParameterization.html#o14">index_of_max</a>[2]=0;
00450     p.<a class="code" href="structHillasParameterization.html#o15">frac</a>[0]=p.<a class="code" href="structHillasParameterization.html#o15">frac</a>[1]=p.<a class="code" href="structHillasParameterization.html#o15">frac</a>[2]=0.0;
00451     p.<a class="code" href="structHillasParameterization.html#o17">asymmetry</a>=0.0;
00452     p.<a class="code" href="structHillasParameterization.html#o20">energy_estimate</a> = 0.0;
00453 
00454 }
00455 
<a name="l00459"></a><a class="code" href="structHillasParameterization.html#a1">00459</a> ostream&amp; operator&lt;&lt;(ostream &amp;stream,<span class="keyword">const</span> <a class="code" href="structHillasParameterization.html">HillasParameterization</a> &amp;p){
00460 
00461     stream &lt;&lt; p.<a class="code" href="structImageParameterization.html#o6">sim</a> 
00462            &lt;&lt; setw(8) &lt;&lt; p.<a class="code" href="structImageParameterization.html#o5">event_number</a> &lt;&lt; <span class="stringliteral">" "</span> 
00463            &lt;&lt; setw(8) &lt;&lt; (<span class="keywordtype">int</span>)p.<a class="code" href="structImageParameterization.html#o4">invalid</a> &lt;&lt; <span class="stringliteral">" "</span>
00464            &lt;&lt; setprecision(14) &lt;&lt; p.<a class="code" href="structImageParameterization.html#o2">gpstime</a> &lt;&lt; <span class="stringliteral">" "</span> 
00465            &lt;&lt; setw(8) &lt;&lt; p.<a class="code" href="structHillasParameterization.html#o0">centroid</a>.<a class="code" href="structCoordinate__t.html#o0">x</a> &lt;&lt; <span class="stringliteral">" "</span> 
00466            &lt;&lt; setw(8) &lt;&lt; p.<a class="code" href="structHillasParameterization.html#o0">centroid</a>.<a class="code" href="structCoordinate__t.html#o1">y</a> &lt;&lt; <span class="stringliteral">" "</span> 
00467            &lt;&lt; setw(8) &lt;&lt; p.<a class="code" href="structHillasParameterization.html#o1">point_of_origin_a</a>.<a class="code" href="structCoordinate__t.html#o0">x</a> &lt;&lt; <span class="stringliteral">" "</span> 
00468            &lt;&lt; setw(8) &lt;&lt; p.<a class="code" href="structHillasParameterization.html#o1">point_of_origin_a</a>.<a class="code" href="structCoordinate__t.html#o1">y</a> &lt;&lt; <span class="stringliteral">" "</span> 
00469            &lt;&lt; setw(8) &lt;&lt; p.<a class="code" href="structHillasParameterization.html#o2">point_of_origin_b</a>.<a class="code" href="structCoordinate__t.html#o0">x</a> &lt;&lt; <span class="stringliteral">" "</span> 
00470            &lt;&lt; setw(8) &lt;&lt; p.<a class="code" href="structHillasParameterization.html#o2">point_of_origin_b</a>.<a class="code" href="structCoordinate__t.html#o1">y</a> &lt;&lt; <span class="stringliteral">" "</span> 
00471            &lt;&lt; setw(8) &lt;&lt; p.<a class="code" href="structHillasParameterization.html#o3">length</a> &lt;&lt; <span class="stringliteral">" "</span> 
00472            &lt;&lt; setw(8) &lt;&lt; p.<a class="code" href="structHillasParameterization.html#o4">width</a> &lt;&lt; <span class="stringliteral">" "</span> 
00473            &lt;&lt; setw(8) &lt;&lt; p.<a class="code" href="structHillasParameterization.html#o6">miss</a> &lt;&lt; <span class="stringliteral">" "</span> 
00474            &lt;&lt; setw(8) &lt;&lt; p.<a class="code" href="structHillasParameterization.html#o7">distance</a> &lt;&lt; <span class="stringliteral">" "</span> 
00475            &lt;&lt; setw(8) &lt;&lt; p.<a class="code" href="structHillasParameterization.html#o8">azwidth</a> &lt;&lt; <span class="stringliteral">" "</span> 
00476            &lt;&lt; setw(8) &lt;&lt; p.<a class="code" href="structHillasParameterization.html#o9">alpha</a> &lt;&lt; <span class="stringliteral">" "</span> 
00477            &lt;&lt; setw(8) &lt;&lt; p.<a class="code" href="structHillasParameterization.html#o11">psi</a> &lt;&lt; <span class="stringliteral">" "</span>
00478            &lt;&lt; setw(8) &lt;&lt; p.<a class="code" href="structHillasParameterization.html#o12">phi</a> &lt;&lt; <span class="stringliteral">" "</span>
00479            &lt;&lt; setw(8) &lt;&lt; p.<a class="code" href="structHillasParameterization.html#o5">size</a> &lt;&lt; <span class="stringliteral">" "</span>;
00480 
00481     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;3; i++) 
00482         stream  &lt;&lt; setw(8) &lt;&lt; p.<a class="code" href="structHillasParameterization.html#o13">max</a>[i] &lt;&lt; <span class="stringliteral">" "</span> ;
00483     
00484     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;3; i++) 
00485         stream &lt;&lt; setw(3) &lt;&lt;p.<a class="code" href="structHillasParameterization.html#o14">index_of_max</a>[i] &lt;&lt; <span class="stringliteral">" "</span> ;
00486     
00487     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;3; i++) 
00488         stream &lt;&lt; setw(8) &lt;&lt;p.<a class="code" href="structHillasParameterization.html#o15">frac</a>[i] &lt;&lt; <span class="stringliteral">" "</span> ;
00489     
00490     stream  &lt;&lt; setw(8) &lt;&lt; p.<a class="code" href="structHillasParameterization.html#o17">asymmetry</a>&lt;&lt; <span class="stringliteral">" "</span> ;
00491     stream  &lt;&lt; setw(8) &lt;&lt; p.<a class="code" href="structHillasParameterization.html#o10">length_over_size</a> &lt;&lt; <span class="stringliteral">" "</span>;
00492     stream  &lt;&lt; setw(8) &lt;&lt; p.<a class="code" href="structHillasParameterization.html#o19">zenith</a>&lt;&lt; <span class="stringliteral">" "</span>;
00493     stream  &lt;&lt; setw(8) &lt;&lt; p.<a class="code" href="structHillasParameterization.html#o20">energy_estimate</a>&lt;&lt; <span class="stringliteral">" "</span>;
00494     stream  &lt;&lt; setw(5) &lt;&lt; (<span class="keywordtype">int</span>)p.<a class="code" href="structImageParameterization.html#o0">telescope_id</a>;
00495     
00496     <span class="keywordflow">return</span> stream;
00497 
00498 }
00499 
00500 
00504 <span class="comment">// istream&amp; operator&gt;&gt;(istream &amp;stream, HillasParameterization &amp;p){</span>
00505     
00506 <span class="comment">//     stream  &gt;&gt; p.event_number  </span>
00507 <span class="comment">// //       &gt;&gt; p.on </span>
00508 <span class="comment">//          &gt;&gt; p.invalid </span>
00509 <span class="comment">//          &gt;&gt; p.gpstime  </span>
00510 <span class="comment">//          &gt;&gt; p.centroid.x  </span>
00511 <span class="comment">//          &gt;&gt; p.centroid.y  </span>
00512 <span class="comment">//          &gt;&gt; p.point_of_origin_a.x  </span>
00513 <span class="comment">//          &gt;&gt; p.point_of_origin_a.y  </span>
00514 <span class="comment">//          &gt;&gt; p.point_of_origin_b.x  </span>
00515 <span class="comment">//          &gt;&gt; p.point_of_origin_b.y  </span>
00516 <span class="comment">//          &gt;&gt; p.length  </span>
00517 <span class="comment">//          &gt;&gt; p.width  </span>
00518 <span class="comment">//          &gt;&gt; p.miss  </span>
00519 <span class="comment">//          &gt;&gt; p.distance  </span>
00520 <span class="comment">//          &gt;&gt; p.azwidth  </span>
00521 <span class="comment">//          &gt;&gt; p.alpha  </span>
00522 <span class="comment">//          &gt;&gt; p.psi </span>
00523 <span class="comment">//          &gt;&gt; p.phi </span>
00524 <span class="comment">//          &gt;&gt; p.size ;</span>
00525     
00526 <span class="comment">//     for (int i=0; i&lt;3; i++) </span>
00527 <span class="comment">//      stream &gt;&gt; p.max[i]  ;</span>
00528     
00529 <span class="comment">//     for (int i=0; i&lt;3; i++) </span>
00530 <span class="comment">//      stream &gt;&gt; p.index_of_max[i]  ;</span>
00531     
00532 <span class="comment">//     for (int i=0; i&lt;3; i++) </span>
00533 <span class="comment">//      stream &gt;&gt; p.frac[i]  ;</span>
00534     
00535 <span class="comment">//     stream &gt;&gt; p.asymmetry ;</span>
00536 <span class="comment">//     stream &gt;&gt; p.length_over_size;</span>
00537 <span class="comment">//     stream &gt;&gt; p.zenith;</span>
00538 
00539 <span class="comment">//     return stream;</span>
00540 <span class="comment">// }</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Apr 21 10:22:45 2007 for wuparam by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
