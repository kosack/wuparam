<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>wuparam: Parameterizer.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>Parameterizer.cpp</h1><div class="fragment"><pre>00001 <span class="comment">//</span>
00002 <span class="comment">//</span>
00003 <span class="comment">// Parameterizer.cpp</span>
00004 <span class="comment">// Karl Kosack &lt;kosack@hbar.wustl.edu&gt;</span>
00005 <span class="comment">//</span>
00006 <span class="comment">// Modified 030201 by JB to correct some bugs in 2-d analys</span>
00007 <span class="comment">// save some computation time and correct a bug where zenith</span>
00008 <span class="comment">// corrections were applied twice when display was enabled</span>
00009 <span class="comment">// </span>
00010 <span class="comment">//</span>
00011 <span class="comment">// Modified July 2005 by KPK - Adding functionality to work with</span>
00012 <span class="comment">// multiple telescopes (i.e. VERITAS).  Since the original code really wan't designed to do that, it's somewhat of a messy situation</span>
00013 
00014 <span class="preprocessor">#include &lt;iostream&gt;</span>
00015 <span class="preprocessor">#include &lt;cmath&gt;</span>
00016 <span class="preprocessor">#include &lt;iomanip&gt;</span>
00017 <span class="preprocessor">#include &lt;list&gt;</span>
00018 <span class="preprocessor">#include &lt;cctype&gt;</span>
00019 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>          <span class="comment">// For POSIX mkdir</span>
00020 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>           <span class="comment">// For POSIX mkdir</span>
00021 <span class="preprocessor">#include &lt;gsl/gsl_rng.h&gt;</span>        <span class="comment">// Random num generators </span>
00022 <span class="preprocessor">#include &lt;gsl/gsl_randist.h&gt;</span>    <span class="comment">// Random distributions </span>
00023 <span class="preprocessor">#include &lt;gsl/gsl_sf_trig.h&gt;</span>
00024 
00025 <span class="preprocessor">#include "Camera.h"</span>
00026 <span class="preprocessor">#include "DataReader.h"</span>
00027 <span class="preprocessor">#include "DataRecords.h"</span>
00028 <span class="preprocessor">#include "DataWriter.h"</span>
00029 <span class="preprocessor">#include "ImageAnalyzer.h"</span>
00030 <span class="preprocessor">#include "MuonImageAnalyzer.h"</span>
00031 <span class="preprocessor">#include "ImageCleaner.h"</span>
00032 <span class="preprocessor">#include "PedestalFinder.h"</span>
00033 <span class="preprocessor">#include "GainFinder.h"</span>
00034 <span class="preprocessor">#include "ProgressBar.h"</span>
00035 <span class="preprocessor">#include "Parameterizer.h"</span>
00036 <span class="preprocessor">#include "Histogram.h"</span>
00037 <span class="preprocessor">#include "GaussianDeviate.h"</span>
00038 <span class="preprocessor">#include "SuperCutter.h"</span>
00039 <span class="preprocessor">#include "ZCutter.h"</span>
00040 <span class="preprocessor">#include "SpectralCutter.h"</span>
00041 <span class="preprocessor">#include "Image2D.h"</span>
00042 <span class="preprocessor">#include "PlotMaker.h"</span>
00043 <span class="preprocessor">#include "Log.h"</span>
00044 <span class="preprocessor">#include "AngleConverters.h"</span>
00045 <span class="preprocessor">#include "ImageFilter.h"</span>
00046 
00047 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00048 <span class="keyword">using</span> <span class="keyword">namespace </span>Cuts;
00049 
00050 Parameterizer::
00051 Parameterizer()
00052     : _is_verbose_enabled(true), _is_display_enabled(false),
00053       _is_interactive(false),_is_first_run(true) , _is_cleanup_enabled(true),
00054       _latitude(.553065751136), _longitude(1.935190) , _event_number(0) {
00055 
00056     _wupdir = getSupportDir();
00057 
00058 }
00059 
00060 Parameterizer::
00061 ~Parameterizer() {
00062 
00063     <span class="keyword">delete</span> _gaussdev;
00064     
00065 }
00066 
00070 <span class="keywordtype">void</span>
00071 <a class="code" href="classParameterizer.html#a2">Parameterizer::</a>
<a name="l00072"></a><a class="code" href="classParameterizer.html#a2">00072</a> <a class="code" href="classParameterizer.html#a2">process</a>(  <a class="code" href="classRunInfo.html">RunInfo</a> &amp;ri ) {
00073 
00074     <a class="code" href="classPedestalFinder.html">PedestalFinder</a> ped;
00075     <a class="code" href="classRunInfo.html">RunInfo</a> ri2 = ri;
00076 
00077     cout &lt;&lt; endl;
00078 
00079     <span class="keywordflow">if</span> (_is_first_run) {
00080         _gaussdev = <span class="keyword">new</span> GaussianDeviate(ri.<a class="code" href="classRunInfo.html#o2">cachedir</a>);
00081     }
00082 
00083     <span class="keywordflow">switch</span> ( ri.<a class="code" href="classRunInfo.html#o0">type</a> ) {
00084 
00085       <span class="keywordflow">case</span> Config::ONOFF:
00086 
00087           <span class="keywordflow">if</span> (_is_verbose_enabled) {
00088               cout &lt;&lt;<span class="stringliteral">"----------------------------------"</span>
00089                    &lt;&lt;<span class="stringliteral">"--------------------------------------"</span>&lt;&lt; endl;
00090               cout &lt;&lt;<span class="stringliteral">"---- ON/OFF PAIR ---- "</span> &lt;&lt;ri.<a class="code" href="classRunInfo.html#o4">onid</a>&lt;&lt;<span class="stringliteral">"/"</span>&lt;&lt;ri.<a class="code" href="classRunInfo.html#o5">offid</a>&lt;&lt;<span class="stringliteral">" "</span>;
00091               <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k=0; k&lt; 70-(<span class="keywordtype">int</span>)(ri.<a class="code" href="classRunInfo.html#o4">onid</a>.size()
00092                                        +(<span class="keywordtype">int</span>)ri.<a class="code" href="classRunInfo.html#o5">offid</a>.size()+1+21); k++)
00093                   cout &lt;&lt; <span class="stringliteral">"-"</span>;
00094               cout &lt;&lt; endl;
00095               cout &lt;&lt;<span class="stringliteral">"----------------------------------"</span>
00096                    &lt;&lt;<span class="stringliteral">"--------------------------------------"</span>&lt;&lt; endl;
00097           }
00098 
00099           ri2 = ri;
00100 
00101           <span class="comment">// Process on padded with off note padpeds is really</span>
00102           <span class="comment">// off-source pedestals and must be loaded even if padding</span>
00103           <span class="comment">// is off (for the skybrightness map)</span>
00104 
00105           <span class="comment">//      ped.getOffSourcePeds( ri, _padpeds );</span>
00106           processOne( ri, ri.onid );
00107           
00108           <span class="comment">// Process off padded with on</span>
00109           <span class="comment">//      ped.getOnSourcePeds( ri, _padpeds );</span>
00110           processOne( ri2, ri2.<a class="code" href="classRunInfo.html#o5">offid</a> );
00111           <span class="keywordflow">break</span>;
00112           
00113       <span class="keywordflow">case</span> Config::TRACK:
00114           <span class="keywordflow">if</span> (_is_verbose_enabled) {
00115               cout &lt;&lt;<span class="stringliteral">"----------------------------------"</span>
00116                    &lt;&lt;<span class="stringliteral">"--------------------------------------"</span>&lt;&lt; endl;
00117               cout &lt;&lt;<span class="stringliteral">"---- TRACKING RUN ---- "</span> &lt;&lt;ri.onid&lt;&lt;<span class="stringliteral">" "</span>;
00118               <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k=0; k&lt; 70-(<span class="keywordtype">int</span>)(ri.onid.size()+21+1); (<span class="keywordtype">int</span>)k++)
00119                   cout &lt;&lt; <span class="stringliteral">"-"</span>;
00120               cout &lt;&lt; endl;
00121               cout &lt;&lt;<span class="stringliteral">"----------------------------------"</span>
00122                    &lt;&lt;<span class="stringliteral">"--------------------------------------"</span>&lt;&lt; endl;
00123           }
00124           
00125           processOne( ri, ri.onid );
00126           <span class="keywordflow">break</span>;
00127           
00128       <span class="keywordflow">default</span>:
00129           cerr &lt;&lt; <span class="stringliteral">"*** Parameterizer: unknown run type: "</span> &lt;&lt; ri.type&lt;&lt;endl;
00130           <span class="keywordflow">break</span>;
00131     }
00132     
00133     _is_first_run = <span class="keyword">false</span>;
00134     
00135 
00136 }
00137 
00138 
00142 <span class="keywordtype">void</span>
<a name="l00143"></a><a class="code" href="classParameterizer.html#a10">00143</a> <a class="code" href="classParameterizer.html#a10">Parameterizer::printSummary</a>( ostream &amp;stream, <a class="code" href="classRunInfo.html">RunInfo</a> &amp;ri, 
00144                              string &amp;id, RawHeaderRecord &amp;header,
00145                              <a class="code" href="classParamDataWriter.html">ParamDataWriter</a> *writer, <a class="code" href="classRawDataReader.html">RawDataReader</a> *data, 
00146                              <a class="code" href="classTelescopeArray.html">TelescopeArray</a> &amp;array ){
00147 
00148     stream &lt;&lt;<span class="stringliteral">"Run information: "</span> &lt;&lt; endl;
00149     stream &lt;&lt; <span class="stringliteral">"\tUTDATE      : "</span> &lt;&lt; ri.<a class="code" href="classRunInfo.html#o7">utdate</a> &lt;&lt; endl;
00150     stream &lt;&lt; <span class="stringliteral">"\tRUN ID      : "</span> &lt;&lt; id &lt;&lt; endl;
00151     stream &lt;&lt; <span class="stringliteral">"\tNITROGEN ID : "</span> &lt;&lt; ri.<a class="code" href="classRunInfo.html#o6">n2id</a> &lt;&lt; endl;
00152     stream &lt;&lt; <span class="stringliteral">"\tPADDING     : "</span>;
00153     <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o17">padding</a>) {
00154         <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o0">type</a> == Config::ONOFF) {
00155             <span class="keywordflow">if</span> (id == ri.<a class="code" href="classRunInfo.html#o4">onid</a>)
00156                 stream &lt;&lt; ri.<a class="code" href="classRunInfo.html#o5">offid</a> &lt;&lt; endl;
00157             <span class="keywordflow">else</span>
00158                 stream &lt;&lt; ri.<a class="code" href="classRunInfo.html#o4">onid</a> &lt;&lt; endl;
00159         }
00160         <span class="keywordflow">else</span> {
00161             stream &lt;&lt; ri.<a class="code" href="classRunInfo.html#o15">padlevel</a> &lt;&lt; <span class="stringliteral">" (fixed level)"</span>&lt;&lt; endl;
00162         }
00163     }
00164     <span class="keywordflow">else</span> 
00165         stream &lt;&lt; <span class="stringliteral">"disabled"</span> &lt;&lt; endl;
00166     
00167     stream &lt;&lt; <span class="stringliteral">"\tINPUT FILE  : "</span> &lt;&lt; data-&gt;<a class="code" href="classDataReader.html#a2">getFilename</a>() &lt;&lt; endl;
00168     stream &lt;&lt; <span class="stringliteral">"\tINPUT TYPE  : "</span> &lt;&lt; data-&gt;<a class="code" href="classRawDataReader.html#a4">getTypeString</a>()&lt;&lt; endl;
00169     stream &lt;&lt; <span class="stringliteral">"\tOUTPUT      : "</span> &lt;&lt; writer-&gt;<a class="code" href="classDataWriter.html#a3">getFilename</a>() &lt;&lt; endl;
00170     stream &lt;&lt; <span class="stringliteral">"\tOUTPUT TYPE : "</span> &lt;&lt; writer-&gt;<a class="code" href="classParamDataWriter.html#a6">getTypeString</a>() &lt;&lt; endl;
00171     stream &lt;&lt; <span class="stringliteral">"\tSOURCENAME  : \""</span> &lt;&lt; header.sourcename &lt;&lt; <span class="stringliteral">"\""</span>&lt;&lt; endl
00172            &lt;&lt; <span class="stringliteral">"\tRA          : "</span> &lt;&lt; getHMSString(header.ra) &lt;&lt;endl
00173            &lt;&lt; <span class="stringliteral">"\tDEC         : "</span> &lt;&lt; getDMSString(header.dec) &lt;&lt;endl
00174            &lt;&lt; <span class="stringliteral">"\tSTART TIME  : "</span> &lt;&lt; setprecision(10) 
00175            &lt;&lt; header.starttime &lt;&lt; endl
00176            &lt;&lt; <span class="stringliteral">"\tPICTURE     : "</span> &lt;&lt; ri.<a class="code" href="classRunInfo.html#o13">picthresh</a> &lt;&lt; endl
00177            &lt;&lt; <span class="stringliteral">"\tBOUNDARY    : "</span> &lt;&lt; ri.<a class="code" href="classRunInfo.html#o14">bndthresh</a> &lt;&lt; endl;
00178     stream &lt;&lt; <span class="stringliteral">"\tDEROTATION  : "</span>;
00179     <span class="keywordflow">if</span>(ri.<a class="code" href="classRunInfo.html#o19">derotation</a>) 
00180         stream &lt;&lt; <span class="stringliteral">"enabled"</span> &lt;&lt; endl;
00181     <span class="keywordflow">else</span>
00182         stream &lt;&lt; <span class="stringliteral">"disabled"</span> &lt;&lt; endl;
00183     
00184     
00185     <span class="keywordtype">int</span> ntel = array.<a class="code" href="classTelescopeArray.html#a2">getNumTelescopes</a>();
00186     stream &lt;&lt; <span class="stringliteral">"\tTELESCOPES  : "</span> &lt;&lt; ntel &lt;&lt;endl;
00187 
00188     stream &lt;&lt; <span class="stringliteral">"\tNADC        : "</span>;
00189     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;header.nadc.size(); i++) 
00190         stream &lt;&lt;  header.nadc.at(i) &lt;&lt; <span class="stringliteral">" "</span>;
00191     stream &lt;&lt; endl;
00192 
00193     stream &lt;&lt; <span class="stringliteral">"\tCAMERA ID   : "</span>;
00194     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;ntel; i++) 
00195         stream &lt;&lt; array.<a class="code" href="classTelescopeArray.html#a3">getCamera</a>(i)-&gt;<a class="code" href="classCamera.html#a12">getCameraID</a>() &lt;&lt;<span class="stringliteral">" "</span>;
00196     stream &lt;&lt; endl;
00197 
00198 
00199     stream &lt;&lt; <span class="stringliteral">"\tPIXELS      : "</span>;
00200     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;ntel; i++) 
00201         stream &lt;&lt; array.<a class="code" href="classTelescopeArray.html#a3">getCamera</a>(i)-&gt;<a class="code" href="classCamera.html#a9">getNumPixels</a>() &lt;&lt;<span class="stringliteral">" "</span>;
00202     stream &lt;&lt; endl;
00203 
00204     stream &lt;&lt; <span class="stringliteral">"\tSIGMA_PIX   : "</span>;
00205     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;ntel; i++) 
00206         stream &lt;&lt; array.<a class="code" href="classTelescopeArray.html#a3">getCamera</a>(i)-&gt;<a class="code" href="classCamera.html#a7">getSigmaPixel</a>() &lt;&lt;<span class="stringliteral">" "</span>;
00207     stream &lt;&lt; endl;
00208 
00209     stream &lt;&lt; <span class="stringliteral">"\tPE TO DC    : "</span>;
00210     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;ntel; i++) 
00211         stream &lt;&lt; array.<a class="code" href="classTelescopeArray.html#a3">getCamera</a>(i)-&gt;<a class="code" href="classCamera.html#a8">getPEToDC</a>() &lt;&lt;<span class="stringliteral">" "</span>;
00212     stream &lt;&lt; endl;
00213     
00214     stream &lt;&lt; <span class="stringliteral">"\tMASKED TUBES: "</span>;
00215     vector&lt;int&gt; masked;
00216     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;1024; i++) {
00217         <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o30">tubemask</a>[i] == <span class="keyword">true</span>)
00218             masked.push_back(i);
00219     }
00220     <span class="keywordflow">if</span> (masked.size() &gt;0) {
00221         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;(<span class="keywordtype">int</span>)(masked.size()); i++)
00222             stream &lt;&lt; masked[i] &lt;&lt; <span class="stringliteral">" "</span>;
00223     }
00224     <span class="keywordflow">else</span> {
00225         stream &lt;&lt; <span class="stringliteral">"none"</span>;
00226     }
00227     stream &lt;&lt; endl;
00228 
00229     stream &lt;&lt; <span class="stringliteral">"\tCAM OFFSET  : "</span>;
00230     <span class="keywordflow">if</span>(ri.<a class="code" href="classRunInfo.html#o31">camera_offset_analysis</a>==<span class="keyword">true</span>) {
00231         stream &lt;&lt; ri.<a class="code" href="classRunInfo.html#o32">camera_offset</a>.<a class="code" href="structCoordinate__t.html#o0">x</a> &lt;&lt; <span class="stringliteral">" , "</span>&lt;&lt;ri.<a class="code" href="classRunInfo.html#o32">camera_offset</a>.<a class="code" href="structCoordinate__t.html#o1">y</a>&lt;&lt;endl;
00232     }
00233     <span class="keywordflow">else</span> {
00234         stream &lt;&lt; <span class="stringliteral">"disabled "</span> &lt;&lt; endl;
00235     }
00236 
00237     stream &lt;&lt; <span class="stringliteral">"\tIMAGE FILTER: "</span>;
00238     <span class="keywordflow">if</span>(ri.<a class="code" href="classRunInfo.html#o34">image_filter</a>==<span class="keyword">true</span>) {
00239         stream &lt;&lt; <span class="stringliteral">"amt="</span>&lt;&lt;ri.<a class="code" href="classRunInfo.html#o35">filter_amount</a> 
00240                &lt;&lt; <span class="stringliteral">" sub="</span>&lt;&lt;ri.<a class="code" href="classRunInfo.html#o36">filter_subdivide</a>
00241                &lt;&lt; <span class="stringliteral">" pct="</span>&lt;&lt;ri.<a class="code" href="classRunInfo.html#o39">filter_percent</a>
00242                &lt;&lt; <span class="stringliteral">" thr="</span>&lt;&lt;ri.<a class="code" href="classRunInfo.html#o40">filter_threshold</a>
00243                &lt;&lt; endl; 
00244     }
00245     <span class="keywordflow">else</span> {
00246         stream &lt;&lt; <span class="stringliteral">" disabled "</span> &lt;&lt; endl;
00247     }
00248 
00249 }
00250 
00251 
00272 <span class="keywordtype">void</span>
00273 Parameterizer::
00274 processOne(  <a class="code" href="classRunInfo.html">RunInfo</a> &amp;ri, string &amp;id ) {
00275 
00276     <span class="keyword">register</span> <span class="keywordtype">int</span> i;
00277 
00278 
00279     <a class="code" href="classPedestalFinder.html">PedestalFinder</a> ped;
00280     <a class="code" href="classGainFinder.html">GainFinder</a> gf;
00281     <a class="code" href="classRawDataReader.html">RawDataReader</a> *data =NULL;
00282     <a class="code" href="classParamDataWriter.html">ParamDataWriter</a> *writer=NULL;
00283     <a class="code" href="classImageCleaner.html">ImageCleaner</a> *threshcleaner = NULL;
00284     <a class="code" href="structHillasParameterization.html">HillasParameterization</a> param;
00285     <a class="code" href="structMuonParameterization.html">MuonParameterization</a> mparam;
00286     RawHeaderRecord header;
00287     <a class="code" href="structRawEventRecord.html">RawEventRecord</a>  event;
00288     Array_t adc;
00289     ofstream muonfile;
00290     ofstream goodmuons;
00291 
00292     vector&lt;TelescopeData&gt; tel(1);
00293 
00294     vector&lt;int&gt; cleanpixels;
00295     cleanpixels.reserve(100);
00296 
00297     string filename;
00298     string fname;
00299     <span class="keywordtype">double</span> start_el;
00300 
00301     <span class="keywordtype">int</span> datasize=0;
00302     string tempstr;
00303     string answer;
00304     <span class="keywordtype">double</span> gpstime_start=0;
00305     <span class="keywordtype">double</span> gpstime_last=0;
00306     <span class="keywordtype">double</span> deviate;
00307     <span class="keywordtype">int</span> dtype;
00308     <span class="keywordtype">double</span> zen;
00309 
00310     SimShowerRecord cursimshower;
00311 
00312     <a class="code" href="classCutFactory.html">CutFactory</a> *cutfactory = <a class="code" href="classCutFactory.html#e0">CutFactory::instance</a>();
00313     <a class="code" href="classSuperCutter.html">SuperCutter</a> *cutter;
00314     cutter = cutfactory-&gt;<a class="code" href="classCutFactory.html#a0">newCutter</a>( ri );    
00315     cutter-&gt;<a class="code" href="classSuperCutter.html#a0">setCuts</a>( ri.<a class="code" href="classRunInfo.html#o22">cuts</a> );
00316 
00317     <a class="code" href="classLogger.html">Logger</a> *logger = Logger::instance();
00318 
00319     <span class="comment">// for interactive mode:</span>
00320     <span class="keywordtype">bool</span> interactive_cuts=<span class="keyword">false</span>;
00321     <span class="keywordtype">bool</span> interactive_triplet_centers=<span class="keyword">false</span>;
00322     <span class="keywordtype">bool</span> interactive_hold=<span class="keyword">false</span>;
00323     <span class="keywordtype">bool</span> interactive_muon=<span class="keyword">false</span>;
00324     <span class="keywordtype">bool</span> interactive_rotate=<span class="keyword">false</span>;
00325     <span class="keywordtype">bool</span> interactive_correct=<span class="keyword">true</span>;
00326     <span class="keywordtype">bool</span> interactive_clean = <span class="keyword">true</span>;
00327     <span class="keywordtype">bool</span> interactive_params = <span class="keyword">true</span>;
00328     PlotMaker::CameraPlotType interactive_disptype=PlotMaker::CAMERA_IMAGE;
00329 
00330     <span class="keywordtype">int</span> ison;
00331     <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o4">onid</a> == id) ison = 1;
00332     <span class="keywordflow">else</span> ison=0;
00333 
00334     <span class="comment">// DEBUGGING: write out raw data</span>
00335 <span class="comment">//     ofstream rawfile( string(id+"-rawdata.txt").c_str() );</span>
00336     
00337     
00338     <span class="comment">//=========================================================================</span>
00339     <span class="comment">// Set up output directory:</span>
00340 
00341     string dir = id + <span class="stringliteral">"/"</span>;
00342     <span class="keywordflow">if</span> (mkdir(dir.c_str(), S_IRUSR | S_IWUSR | S_IXUSR | S_IXGRP | S_IRGRP )) {
00343         <span class="keywordflow">if</span> (errno != EEXIST) {
00344             perror(<span class="stringliteral">"mkdir"</span>);
00345             <span class="keywordflow">throw</span> <a class="code" href="classCriticalAnalysisException.html">CriticalAnalysisException</a>(<span class="stringliteral">"Couldn't create output directory!"</span>);
00346         }
00347     }
00348 
00349     <span class="comment">//=========================================================================</span>
00350     <span class="comment">// Open the output files:</span>
00351 
00352     <span class="keywordflow">try</span> {
00353 
00354         <span class="keywordflow">switch</span> ( ri.<a class="code" href="classRunInfo.html#o21">outtype</a> ) {
00355           <span class="keywordflow">case</span> Config::NTUPLE:
00356               writer = <span class="keyword">new</span> <a class="code" href="classParamDataWriterNtuple.html">ParamDataWriterNtuple</a>( dir+id+<span class="stringliteral">"-param.ntuple"</span>,
00357                                                   _is_overwrite_enabled);
00358               <span class="keywordflow">break</span>;
00359           <span class="keywordflow">case</span> Config::TEXT:
00360               writer = <span class="keyword">new</span> <a class="code" href="classParamDataWriterText.html">ParamDataWriterText</a>( dir+id+<span class="stringliteral">"-param.txt"</span>,
00361                                                 _is_overwrite_enabled );
00362               <span class="keywordflow">break</span>;
00363         }
00364 
00365         <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o20">muoncalibrate</a>) {
00366             
00367             string muonfilename = dir+id+<span class="stringliteral">"-muons.txt"</span>;
00368             muonfile.open( muonfilename.c_str() );
00369 
00370             muonfilename = dir+id+<span class="stringliteral">"-goodmuons.txt"</span>;
00371             goodmuons.open( muonfilename.c_str() );
00372 
00373         }
00374 
00375 
00376     }
00377     <span class="keywordflow">catch</span> (<a class="code" href="classMildAnalysisException.html">MildAnalysisException</a> &amp;e) {
00378         cerr &lt;&lt; <span class="stringliteral">"Skipping run since "</span>&lt;&lt;e.what() &lt;&lt; endl;
00379         <span class="keywordflow">return</span>;
00380     }
00381 
00382     <span class="comment">//=========================================================================</span>
00383     <span class="comment">// Open the input file:</span>
00384 
00385 
00386     <a class="code" href="classRawDataReaderFactory.html">RawDataReaderFactory</a> *datafactory = <a class="code" href="classRawDataReaderFactory.html#e0">RawDataReaderFactory::instance</a>();
00387     
00388     <span class="keywordflow">try</span> {
00389 
00390         data = datafactory-&gt;<a class="code" href="classRawDataReaderFactory.html#a0">getReader</a>( ri, id );
00391 
00392     }
00393     <span class="keywordflow">catch</span> (<a class="code" href="classAnalysisException.html">AnalysisException</a> &amp;e) {
00394         <span class="keyword">delete</span> data;
00395         <span class="keywordflow">throw</span> (e);
00396     } 
00397 
00398     dtype = data-&gt;<a class="code" href="classRawDataReader.html#a5">getType</a>();
00399     
00400     <span class="comment">//=========================================================================</span>
00401     <span class="comment">// Get some information: </span>
00402 
00403     datasize = data-&gt;<a class="code" href="classRawDataReader.html#a3">size</a>();
00404     <span class="keywordflow">if</span> (datasize == 0) {
00405         <span class="keyword">delete</span> data;
00406         <span class="keywordflow">throw</span> <a class="code" href="classAnalysisException.html">AnalysisException</a>(<span class="stringliteral">"There is no data in "</span>+id
00407                                 +<span class="stringliteral">"! Check that the file is not corrupt, "</span>
00408                                 +<span class="stringliteral">"or remove it from the conf file"</span>);
00409     }
00410 
00411 
00412     
00413     <span class="comment">// fetch the header from the data</span>
00414 
00415     data-&gt;<a class="code" href="classRawDataReader.html#a1">getHeaderRecord</a>( header );
00416 
00417     cout &lt;&lt; <span class="stringliteral">"DEBUG: header.nadc.size() = "</span>&lt;&lt;header.nadc.size()&lt;&lt;endl;
00418 
00419     <span class="comment">// Fill in unknown values from data file  and check for misinformation:</span>
00420 
00421     removeWhiteSpace(header.sourcename);
00422     removeWhiteSpace(ri.<a class="code" href="classRunInfo.html#o3">sourcename</a>);
00423     transform( header.sourcename.begin(),header.sourcename.end(), 
00424                header.sourcename.begin(), (int(*)(<span class="keywordtype">int</span>))tolower);
00425 
00426     <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o3">sourcename</a> != <span class="stringliteral">""</span>) {
00427         <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o3">sourcename</a> != header.sourcename) {
00428             logger-&gt;<a class="code" href="classLogger.html#a0">printf</a>(<span class="stringliteral">"Sourcename may be bad for '%s': conf says '%s', "</span>
00429                            <span class="stringliteral">"data says '%s'"</span>, id.c_str(),
00430                            ri.<a class="code" href="classRunInfo.html#o3">sourcename</a>.c_str(), header.sourcename.c_str() );
00431             
00432         }
00433         header.sourcename = ri.<a class="code" href="classRunInfo.html#o3">sourcename</a>;
00434     }
00435 
00436     <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o9">ra</a> != 0.0)  {        <span class="comment">// if there's an ra override</span>
00437         <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o9">ra</a> != header.ra) {
00438             logger-&gt;<a class="code" href="classLogger.html#a0">printf</a>(<span class="stringliteral">"RA may be incorrect for '%s': conf says '%f',"</span>
00439                            <span class="stringliteral">" data says '%f'"</span>,
00440                            id.c_str(), ri.<a class="code" href="classRunInfo.html#o9">ra</a>, header.ra);           
00441             logger-&gt;<a class="code" href="classLogger.html#a0">printf</a>(<span class="stringliteral">"RA Override currently assumes ON before OFF "</span>
00442                           <span class="stringliteral">"and 30minute offset"</span>);
00443         }
00444         <span class="keywordflow">if</span> ( id == ri.<a class="code" href="classRunInfo.html#o5">offid</a>) 
00445             header.ra = ri.<a class="code" href="classRunInfo.html#o9">ra</a> + (30*((M_PI/12.0)/60.0));  <span class="comment">// offset 30 minutes</span>
00446         <span class="keywordflow">else</span>
00447             header.ra   = ri.<a class="code" href="classRunInfo.html#o9">ra</a>;
00448     }
00449     <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o10">dec</a> != 0.0) {        <span class="comment">// if there is a dec override</span>
00450         <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o10">dec</a> != header.dec) {
00451             logger-&gt;<a class="code" href="classLogger.html#a0">printf</a>( <span class="stringliteral">"DEC may be incorrect for %s: "</span>
00452                             <span class="stringliteral">"conf says '%f', data says '%f'"</span>, 
00453                             id.c_str(), ri.<a class="code" href="classRunInfo.html#o10">dec</a>, header.dec);
00454         }
00455         header.dec  = ri.<a class="code" href="classRunInfo.html#o10">dec</a>;
00456     }
00457     <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o12">ntubes</a> != 0)      header.nadc[0] = ri.<a class="code" href="classRunInfo.html#o12">ntubes</a>;
00458 
00459     <span class="comment">// warn if ra and dec are 0 (usually means there was a problem with</span>
00460     <span class="comment">// the tracking computer when the run was being taken:</span>
00461 
00462     <span class="keywordflow">if</span> (header.ra==0 &amp;&amp; header.dec==0) {
00463         logger-&gt;<a class="code" href="classLogger.html#a0">printf</a>(<span class="stringliteral">"RA and Dec are 0 for %s! "</span>
00464                        <span class="stringliteral">"Maybe you need to specify them?"</span>, id.c_str());
00465     } 
00466 
00467     <span class="comment">// set up progress bar</span>
00468 
00469     <a class="code" href="classProgressBar.html">ProgressBar</a> progress( datasize,id );
00470 
00471     <span class="comment">//=========================================================================</span>
00472     <span class="comment">// Now that the header has been loaded, we can get the array</span>
00473     <span class="comment">// information.  The array object will automatically load the</span>
00474     <span class="comment">// correct cameras.  Right now, there's just one "nadc" value</span>
00475     <span class="comment">// stored in the header, so I assume all cameras are the same.</span>
00476     <span class="comment">// Eventually, there needs to be a mechanism to detect different</span>
00477     <span class="comment">// cameras in the data. In principle, there's no reason that there</span>
00478     <span class="comment">// can't be mixed cameras.</span>
00479 
00480     <a class="code" href="classTelescopeArray.html">TelescopeArray</a> array(ri.<a class="code" href="classRunInfo.html#o8">arrayconfig</a>, 
00481                          header.nadc, atoi(ri.<a class="code" href="classRunInfo.html#o7">utdate</a>.c_str()) );
00482 
00483     <span class="keywordtype">int</span> numtel = array.<a class="code" href="classTelescopeArray.html#a2">getNumTelescopes</a>();
00484     <span class="keywordtype">int</span> curtel = 0; <span class="comment">// current telescope</span>
00485 
00486     tel.resize(array.<a class="code" href="classTelescopeArray.html#a2">getNumTelescopes</a>());
00487 
00488     <span class="comment">// KPK: NOTE: header.nadc[k] is the number of adc values that the data</span>
00489     <span class="comment">// file is reporting while array.getCamera(k)-&gt;getNumPixels() is</span>
00490     <span class="comment">// the number of pixels in the camera according to the camera</span>
00491     <span class="comment">// definition file.  These numbers really should be the same, but</span>
00492     <span class="comment">// in some cases there nadc is larger than numPixels when extra</span>
00493     <span class="comment">// adc channels are installed on the telescope for monitoring</span>
00494     <span class="comment">// other data. Hopefully, I've used the correct one in each case</span>
00495     <span class="comment">// to resize arrays, but if not it may cause things to crash in</span>
00496     <span class="comment">// certain circumstances.</span>
00497 
00498 
00499     <span class="keywordflow">if</span> (numtel != header.num_telescopes) 
00500         logger-&gt;<a class="code" href="classLogger.html#a0">printf</a>( <span class="stringliteral">"The data file (%s) contains %d telescopes, while "</span>
00501                         <span class="stringliteral">"the array config (%s) specifies %d. "</span>
00502                         <span class="stringliteral">"Are you sure you are using the correct array "</span>
00503                         <span class="stringliteral">"configuration?"</span>, 
00504                         id.c_str(), header.num_telescopes, 
00505                         ri.<a class="code" href="classRunInfo.html#o8">arrayconfig</a>.c_str(), numtel);
00506 
00507 
00508     <span class="comment">//=========================================================================</span>
00509     <span class="comment">// Fetch the pedestal/gain information for each telescope in the array</span>
00510 
00511     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel; k++) {
00512 
00513         ped.<a class="code" href="classPedestalFinder.html#a4">getPeds</a>( ri, id, tel[k].peds, k );
00514         gf.<a class="code" href="classGainFinder.html#a2">getGains</a>( ri, tel[k].gains, k );
00515     
00516         <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o0">type</a> == Config::ONOFF) {
00517             <span class="keywordflow">if</span> (ison) 
00518                 ped.<a class="code" href="classPedestalFinder.html#a3">getOffSourcePeds</a>( ri, tel[k].padpeds,k );
00519             <span class="keywordflow">else</span> 
00520                 ped.<a class="code" href="classPedestalFinder.html#a2">getOnSourcePeds</a>( ri, tel[k].padpeds,k );
00521         }
00522         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o0">type</a> == Config::TRACK &amp;&amp; ri.<a class="code" href="classRunInfo.html#o18">pad_track_with_run</a>==<span class="keyword">true</span>) {
00523             ped.<a class="code" href="classPedestalFinder.html#a3">getOffSourcePeds</a>( ri, tel[k].padpeds,k );
00524         }
00525         
00526     
00527 
00528         <span class="comment">// Pad to fixed value if a tracking run and no padding run is specfied</span>
00529         <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o17">padding</a> == <span class="keyword">true</span> &amp;&amp; ri.<a class="code" href="classRunInfo.html#o0">type</a> == Config::TRACK 
00530             &amp;&amp; ri.<a class="code" href="classRunInfo.html#o18">pad_track_with_run</a> == <span class="keyword">false</span>) {
00531             
00532             tel[k].padpeds.resize( tel[k].peds.size() );
00533             <span class="keywordflow">for</span> (i=0; i&lt;(<span class="keywordtype">int</span>)(tel[k].padpeds.size()); i++) {
00534                 tel[k].padpeds[i].dispersion = ri.<a class="code" href="classRunInfo.html#o15">padlevel</a>;
00535                 tel[k].padpeds[i].pedestal = 0;
00536             }
00537         }
00538 
00539     }
00540 
00541 
00542 
00543 
00544     <span class="comment">//=========================================================================</span>
00545     <span class="comment">//  HillasImageAnalyzer, ImageCleaner, etc.</span>
00546 
00547     <a class="code" href="classCamera.html">Camera</a> *curcam = array.<a class="code" href="classTelescopeArray.html#a3">getCamera</a>(0);
00548 
00549     <span class="comment">// if the user requests analysis centered around a position other</span>
00550     <span class="comment">// than 0,0, we need to shift the point of origin of the camera before</span>
00551     <span class="comment">// parameterization:</span>
00552 
00553     <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o31">camera_offset_analysis</a> == <span class="keyword">true</span>) {
00554         
00555         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel; k++) {
00556             array.<a class="code" href="classTelescopeArray.html#a3">getCamera</a>(k)-&gt;<a class="code" href="classCamera.html#a5">shiftCameraCoordinates</a>( ri.<a class="code" href="classRunInfo.html#o32">camera_offset</a>.<a class="code" href="structCoordinate__t.html#o0">x</a>, 
00557                                                         ri.<a class="code" href="classRunInfo.html#o32">camera_offset</a>.<a class="code" href="structCoordinate__t.html#o1">y</a> );
00558         }
00559     }
00560 
00561     
00562     <span class="comment">// stuff for high-resolution camera generated by the ImageFilter routines</span>
00563     <span class="comment">// right now, image filtering is only implemented for a single telescope.</span>
00564     <a class="code" href="classCamera.html">Camera</a>* hires_cam=NULL;
00565     Array_t hires_x,hires_y, hires_adc;
00566     Array_t camrotx(curcam-&gt;<a class="code" href="classCamera.html#a13">xCoords</a>());
00567     Array_t camroty(curcam-&gt;<a class="code" href="classCamera.html#a14">yCoords</a>());
00568     vector&lt;Pedestal&gt; hires_peds;
00569     <span class="keywordtype">double</span> s_max;
00570     vector&lt;int&gt; hires_cleanpixels;
00571     hires_cleanpixels.reserve(500);
00572     
00573     <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o34">image_filter</a> == <span class="keyword">true</span>) {
00574         <span class="comment">// for image filter method, set up the analyzer to use the</span>
00575         <span class="comment">// high-res version of camera generated by the filter program.</span>
00576 
00577         <span class="comment">// de-rotate the camera (must be aligned with axis):</span>
00578         
00579         <span class="keywordtype">double</span> angl = atan2( camroty[1]-camroty[0],camrotx[1]-camrotx[0] );
00580         <a class="code" href="structCoordinate__t.html">Coordinate_t</a> pt;
00581 
00582         <span class="keywordflow">if</span> (angl&gt;M_PI/2.0) angl = -(M_PI - angl);
00583 
00584         cout &lt;&lt; <span class="stringliteral">"ImageFilter: De-rotating the camera by "</span>&lt;&lt;angl*180.0/M_PI
00585              &lt;&lt;<span class="stringliteral">" degrees"</span>&lt;&lt;endl;
00586 
00587 
00588         <span class="keywordflow">for</span> (i=0; i&lt;camrotx.size(); i++) {
00589             pt.<a class="code" href="structCoordinate__t.html#o0">x</a> = camrotx[i];
00590             pt.<a class="code" href="structCoordinate__t.html#o1">y</a> = camroty[i];
00591             derotatePoint( angl, pt );
00592             camrotx[i] = pt.<a class="code" href="structCoordinate__t.html#o0">x</a>;
00593             camroty[i] = pt.<a class="code" href="structCoordinate__t.html#o1">y</a>;
00594         }
00595         
00596         filter_init( curcam-&gt;<a class="code" href="classCamera.html#a11">getLastPixel</a>()+1, <span class="comment">// actual number of pixels</span>
00597                      camrotx, camroty, 
00598                      hires_x, hires_y, 
00599                      ri.<a class="code" href="classRunInfo.html#o36">filter_subdivide</a>,  <span class="comment">// msub</span>
00600                      ri.<a class="code" href="classRunInfo.html#o35">filter_amount</a>, <span class="comment">// afilter </span>
00601                      ri.<a class="code" href="classRunInfo.html#o37">filter_iter</a>, <span class="comment">// nc</span>
00602                      ri.<a class="code" href="classRunInfo.html#o38">filter_smoothness</a>);  <span class="comment">//spas );</span>
00603 
00604         hires_cam = <span class="keyword">new</span> <a class="code" href="classCamera.html">Camera</a>( hires_x.size(), hires_x, hires_y );
00605         tel[0].analyzer = <span class="keyword">new</span> <a class="code" href="classHillasImageAnalyzer.html">HillasImageAnalyzer</a>( hires_cam );
00606 
00607         hires_peds.resize(hires_x.size());
00608         <span class="keywordflow">for</span> ( i=0; i&lt;hires_peds.size();i++){
00609             hires_peds[i].pedestal=0.0;
00610             hires_peds[i].dispersion=0.0;
00611         }
00612     }
00613     <span class="keywordflow">else</span> {
00614         <span class="comment">//  standard method: set up analyzer to use the camera</span>
00615         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel; k++) {
00616             tel[k].analyzer = <span class="keyword">new</span> <a class="code" href="classHillasImageAnalyzer.html">HillasImageAnalyzer</a>( array.<a class="code" href="classTelescopeArray.html#a3">getCamera</a>(k) );
00617         }
00618     }  
00619 
00620     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel; k++) {
00621         tel[k].muonanalyzer = <span class="keyword">new</span> <a class="code" href="classMuonImageAnalyzer.html">MuonImageAnalyzer</a>( array.<a class="code" href="classTelescopeArray.html#a3">getCamera</a>(k) );
00622     }
00623 
00624     <span class="comment">// set up the plotters for interactive mode:</span>
00625 
00626     <a class="code" href="classPlotMaker.html">PlotMaker</a> *pm=NULL;
00627     <a class="code" href="classPlotMaker.html">PlotMaker</a> *pspm=NULL;
00628     <a class="code" href="classPlotMaker.html">PlotMaker</a> *hires_pm=NULL;
00629     <span class="keywordflow">if</span> (_is_interactive || _is_display_enabled ) {
00630         pm = <span class="keyword">new</span> <a class="code" href="classPlotMaker.html">PlotMaker</a>( <span class="stringliteral">"X"</span>, <span class="stringliteral">"x.out"</span>,
00631                             curcam-&gt;<a class="code" href="classCamera.html#a16">getMinX</a>() - 0.4, 
00632                             curcam-&gt;<a class="code" href="classCamera.html#a17">getMinY</a>() - 0.4, 
00633                             curcam-&gt;<a class="code" href="classCamera.html#a18">getMaxX</a>() + 0.4, 
00634                             curcam-&gt;<a class="code" href="classCamera.html#a19">getMaxY</a>() + 0.4 
00635                             );
00636         <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o34">image_filter</a>==<span class="keyword">true</span>) {
00637             hires_pm = <span class="keyword">new</span> PlotMaker( <span class="stringliteral">"X"</span>, <span class="stringliteral">"x2.out"</span>,
00638                                       hires_cam-&gt;<a class="code" href="classCamera.html#a16">getMinX</a>() - 0.4, 
00639                                       hires_cam-&gt;<a class="code" href="classCamera.html#a17">getMinY</a>() - 0.4, 
00640                                       hires_cam-&gt;<a class="code" href="classCamera.html#a18">getMaxX</a>() + 0.4, 
00641                                       hires_cam-&gt;<a class="code" href="classCamera.html#a19">getMaxY</a>() + 0.4 
00642                                       );
00643         }
00644     }
00645 
00646     
00647     <span class="comment">//=========================================================================</span>
00648     <span class="comment">// Set up the histograms... These get deleted automatically when</span>
00649     <span class="comment">// the tel[] array is destructed</span>
00650 
00651     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel; k++) {
00652 
00653         curcam = array.<a class="code" href="classTelescopeArray.html#a3">getCamera</a>(k);
00654         <span class="keywordtype">int</span> numtubes = curcam-&gt;<a class="code" href="classCamera.html#a11">getLastPixel</a>() - curcam-&gt;<a class="code" href="classCamera.html#a10">getFirstPixel</a>();
00655         cout &lt;&lt; <span class="stringliteral">"DEBUG: "</span>&lt;&lt;k&lt;&lt;<span class="stringliteral">": numtubes="</span>&lt;&lt;numtubes&lt;&lt;endl;
00656 
00657         tel[k].lensize = <span class="keyword">new</span> <a class="code" href="classHistogram.html">Histogram</a>(100, 0.0001, 0.002, <span class="stringliteral">"length/size"</span>);
00658         tel[k].pictubes = <span class="keyword">new</span> <a class="code" href="classHistogram.html">Histogram</a>( array.<a class="code" href="classTelescopeArray.html#a3">getCamera</a>(k)-&gt;<a class="code" href="classCamera.html#a9">getNumPixels</a>(), 
00659                                          0, array.<a class="code" href="classTelescopeArray.html#a3">getCamera</a>(k)-&gt;<a class="code" href="classCamera.html#a9">getNumPixels</a>(), 
00660                                          <span class="stringliteral">"tubes in picture"</span>);
00661         tel[k].tubehits= <span class="keyword">new</span> <a class="code" href="classHistogram.html">Histogram</a>( numtubes, 
00662                                         curcam-&gt;<a class="code" href="classCamera.html#a10">getFirstPixel</a>(),
00663                                         curcam-&gt;<a class="code" href="classCamera.html#a11">getLastPixel</a>(), <span class="stringliteral">"tube hits"</span>);
00664         tel[k].phihist= <span class="keyword">new</span> <a class="code" href="classHistogram.html">Histogram</a>( 180, 0.0, 2.0*M_PI,  <span class="stringliteral">"phi angle"</span>);
00665         tel[k].alphahist= <span class="keyword">new</span> <a class="code" href="classHistogram.html">Histogram</a>( 18, 0.0, 90.0, <span class="stringliteral">"raw alpha"</span> );
00666         tel[k].lengthhist= <span class="keyword">new</span> <a class="code" href="classHistogram.html">Histogram</a>( 50, 0.0, M_PI_2, <span class="stringliteral">"length"</span> );
00667         tel[k].sizehist= <span class="keyword">new</span> <a class="code" href="classHistogram.html">Histogram</a>( 50, 0.0, 3000, <span class="stringliteral">"size"</span> );
00668         tel[k].disthist= <span class="keyword">new</span> <a class="code" href="classHistogram.html">Histogram</a>( 50, 0.0, M_PI_2, <span class="stringliteral">"distance"</span> );
00669         tel[k].widthhist= <span class="keyword">new</span> <a class="code" href="classHistogram.html">Histogram</a>( 50, 0.0, M_PI_2, <span class="stringliteral">"width"</span> );
00670         tel[k].rawrate= <span class="keyword">new</span> <a class="code" href="classHistogram.html">Histogram</a>( 30,0,30, <span class="stringliteral">"Raw Rate"</span> );
00671         tel[k].deltat= <span class="keyword">new</span> <a class="code" href="classHistogram.html">Histogram</a>(100,0,0.00001,<span class="stringliteral">"DeltaT"</span>);
00672         tel[k].max2hist= <span class="keyword">new</span> <a class="code" href="classHistogram.html">Histogram</a>( 1000,0,1000,<span class="stringliteral">"Max2"</span> );
00673         tel[k].centroids= <span class="keyword">new</span> <a class="code" href="classImage2D.html">Image2D</a>(39,39);
00674         
00675         <span class="comment">// for muon calibration</span>
00676         tel[k].musoalhist= <span class="keyword">new</span> <a class="code" href="classHistogram.html">Histogram</a>( 100,0,4000,<span class="stringliteral">"signal/arclength"</span> );
00677         tel[k].musizehist= <span class="keyword">new</span> <a class="code" href="classHistogram.html">Histogram</a>( 50,0.0,2000.0, <span class="stringliteral">"Muon size"</span>);
00678         tel[k].muonnesshist= <span class="keyword">new</span> <a class="code" href="classHistogram.html">Histogram</a>( 50,0.0,1.0, <span class="stringliteral">"Muonness"</span>);
00679         tel[k].mugainhist= <span class="keyword">new</span> <a class="code" href="classHistogram.html">Histogram</a>( 50,0,500, <span class="stringliteral">"Muon gain factor"</span>);
00680         tel[k].mulensizehist= <span class="keyword">new</span> <a class="code" href="classHistogram.html">Histogram</a>( 100,0.0001,0.002, <span class="stringliteral">"Muon Length/Size"</span>);
00681         
00682         tel[k].centroids-&gt;setCoordinateBox(-2,-2,  2,2);
00683 
00684     }
00685 
00686     ofstream  anglefile[numtel];
00687     string anglefilename;
00688     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel; k++) {
00689         <span class="keywordtype">char</span> telid[100];
00690         sprintf( telid, <span class="stringliteral">"-%03d"</span>, k );
00691         string anglefilename = dir+id+telid+<span class="stringliteral">"-angles.dat"</span>;
00692         anglefile[k].open(anglefilename.c_str());
00693     }
00694 
00695     <span class="comment">//=========================================================================</span>
00696     <span class="comment">// Print run information to file and screen (if requested)</span>
00697 
00698     <span class="keywordflow">if</span> (_is_verbose_enabled){
00699         <a class="code" href="classParameterizer.html#a10">printSummary</a>( cout, ri, id, header, writer, data, array );
00700     }
00701     ofstream runinfo( string(dir+id+<span class="stringliteral">"-run_info.txt"</span>).c_str() );
00702     <a class="code" href="classParameterizer.html#a10">printSummary</a>( runinfo, ri, id, header, writer, data, array );
00703     
00704     <span class="comment">//=========================================================================</span>
00705     <span class="comment">// if Padding is enabled, precalculate the </span>
00706     <span class="comment">// max pedestal dispersions for the run pair</span>
00707 
00708     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel; k++) {
00709         
00710         tel[k].combinedpeds.resize( tel[k].peds.size() );
00711         tel[k].sigmaped.resize( tel[k].peds.size() );
00712 
00713         <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o17">padding</a> == <span class="keyword">true</span> ) {
00714             
00715             <span class="keywordflow">for</span> (i=0; i&lt;tel[k].combinedpeds.size(); i++) {
00716                 
00717                 <span class="keywordflow">if</span> (tel[k].peds[i].dispersion &gt; tel[k].padpeds[i].dispersion) 
00718                     tel[k].combinedpeds[i] = tel[k].peds[i];
00719                 <span class="keywordflow">else</span>
00720                     tel[k].combinedpeds[i] = tel[k].padpeds[i];
00721                 
00722                 <span class="comment">// Note that if either padding or current run has a tube</span>
00723                 <span class="comment">// off or a star, the attributes of combined peds take on</span>
00724                 <span class="comment">// that of the current run.</span>
00725                 
00726                 <span class="keywordflow">if</span> (tel[k].padpeds[i].type != Pedestal::GOOD ){
00727                     tel[k].combinedpeds[i].type = tel[k].padpeds[i].type;
00728                 }
00729                 
00730                 <span class="keywordflow">if</span> (tel[k].peds[i].type != Pedestal::GOOD ){
00731                     tel[k].combinedpeds[i].type = tel[k].peds[i].type;
00732                 }
00733                 
00734                 <span class="comment">// Precalculate the pedestal sigmas</span>
00735                 
00736                 tel[k].sigmaped[i] = pow(tel[k].combinedpeds[i].dispersion,2) 
00737                     - pow(tel[k].peds[i].dispersion,2);
00738                 
00739                 <span class="keywordflow">if</span> (tel[k].sigmaped[i] &gt; 0) tel[k].sigmaped[i] = sqrt(tel[k].sigmaped[i]);
00740                 <span class="keywordflow">else</span> tel[k].sigmaped[i] = -1.0e-5;
00741                 
00742             }
00743             
00744         }
00745         <span class="keywordflow">else</span> {
00746             tel[k].combinedpeds = tel[k].peds;
00747         }
00748     }
00749 
00750     <span class="comment">// calculate average pedestal dispersion. This is used when image</span>
00751     <span class="comment">// filtering is enabled to make the pedestal cut.</span>
00752     <span class="comment">// TODO: fix this to work with multiple telescopes</span>
00753     <span class="keywordtype">double</span> avgpeddisp=0;
00754     <span class="keywordtype">int</span> navg=0;
00755     <span class="keywordflow">for</span> (i=0; i&lt;tel[0].sigmaped.size(); i++) {
00756         <span class="keywordflow">if</span> (tel[0].combinedpeds[i].type==Pedestal::GOOD){
00757             avgpeddisp += tel[0].combinedpeds[i].dispersion;
00758             navg++;
00759         }       
00760     }
00761     avgpeddisp /= (<span class="keywordtype">double</span>)navg;
00762 
00763     <span class="comment">// Apply the user-specified tube mask from the config file:</span>
00764     <span class="comment">// TODO: implement for multiple telescopes</span>
00765 
00766     <span class="keywordflow">for</span> ( i=0; i&lt;tel[0].combinedpeds.size(); i++) {
00767         <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o30">tubemask</a>[i] == 1) {
00768             tel[0].combinedpeds[i].type = Pedestal::TUBEOFF;
00769             tel[0].peds[i].type = Pedestal::TUBEOFF;
00770             tel[0].padpeds[i].type = Pedestal::TUBEOFF;
00771         }
00772     }
00773 
00774     <span class="comment">// Initialize the imagecleaner using the combined pedestal values</span>
00775 
00776     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel; k++) {
00777         curcam = array.<a class="code" href="classTelescopeArray.html#a3">getCamera</a>(k);
00778         tel[k].cleaner = <span class="keyword">new</span> <a class="code" href="classDefaultImageCleaner.html">DefaultImageCleaner</a>( *curcam,tel[k].combinedpeds,
00779                                                   ri.<a class="code" href="classRunInfo.html#o13">picthresh</a>,ri.<a class="code" href="classRunInfo.html#o14">bndthresh</a> );
00780     }
00781 
00782     
00783     <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o34">image_filter</a> == <span class="keyword">true</span> ) {
00784         threshcleaner = <span class="keyword">new</span> ThresholdImageCleaner( *hires_cam, 0.0 );
00785     }
00786     
00787 
00788     <span class="comment">//=========================================================================</span>
00789     <span class="comment">// Loop over events in the data and parameterize...</span>
00790 
00791     vector&lt;int&gt; n(numtel);
00792     vector&lt;int&gt; n_trig(numtel);
00793     vector&lt;int&gt; n_other(numtel);
00794     <span class="keywordtype">int</span> count =0;
00795 
00796     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel; k++) {
00797         n[k] = n_trig[k] = n_other[k] = 0;
00798     }
00799     
00800     
00801 
00802     <span class="keywordflow">while</span> ( data-&gt;<a class="code" href="classRawDataReader.html#a6">isDone</a>() == <span class="keyword">false</span> ) {
00803 
00804         <span class="comment">// ---------------------------------------------------------</span>
00805         <span class="comment">// Get events until no more are found </span>
00806         <span class="comment">// ---------------------------------------------------------</span>
00807 
00808         <span class="keywordflow">try</span> {
00809 
00810             <span class="keywordflow">if</span> (interactive_hold == <span class="keyword">false</span>) 
00811                 data-&gt;<a class="code" href="classRawDataReader.html#a2">getNextEventRecord</a>( event );  
00812             <span class="keywordflow">else</span> 
00813                 cout &lt;&lt; <span class="stringliteral">"INTERACTIVE MODE: holding current event"</span>&lt;&lt;endl;
00814 
00815         }
00816         <span class="keywordflow">catch</span> (<a class="code" href="classMildAnalysisException.html">MildAnalysisException</a> e) {
00817             <span class="comment">// Mild exceptions should be noted, but processing should</span>
00818             <span class="comment">// still continue.  Anything stronger will cause this to</span>
00819             <span class="comment">// return and will be caught at a higher level.</span>
00820             cerr &lt;&lt; endl &lt;&lt; <span class="stringliteral">"WARNING: "</span> &lt;&lt; e.what() &lt;&lt; endl;
00821             <span class="keywordflow">break</span>;    
00822         }
00823         
00824         <span class="keywordflow">if</span> (n[0] == 0) {
00825             <span class="comment">// it's the first event, so store the start time</span>
00826             gpstime_start = event.<a class="code" href="structRawEventRecord.html#o1">gpstime</a>;
00827         }
00828 
00829         <span class="comment">// store a copy of the adc values</span>
00830         <span class="keywordflow">if</span> (adc.size() != event.<a class="code" href="structRawEventRecord.html#o7">adc</a>.size()) adc.resize(event.<a class="code" href="structRawEventRecord.html#o7">adc</a>.size());
00831         adc = event.<a class="code" href="structRawEventRecord.html#o7">adc</a>;
00832 
00833         <span class="comment">// --------------------------------------------------------</span>
00834         <span class="comment">// Parameterize each event if it's the right type:</span>
00835         <span class="comment">// ---------------------------------------------------------</span>
00836         <span class="keywordflow">if</span> (event.<a class="code" href="structRawEventRecord.html#o0">type</a> == RawDataReader::EVENT) {
00837 
00838             <span class="comment">// Figure out which telescope to use:</span>
00839             <span class="keywordflow">if</span> (event.<a class="code" href="structRawEventRecord.html#o6">telescope_id</a> &gt;= numtel) {
00840                 cout &lt;&lt; <span class="stringliteral">"WARNING: "</span>
00841                      &lt;&lt; <span class="stringliteral">"Skipping event with telescope id "</span>&lt;&lt;event.<a class="code" href="structRawEventRecord.html#o6">telescope_id</a>
00842                      &lt;&lt; <span class="stringliteral">" (there are only "</span>&lt;&lt;numtel
00843                      &lt;&lt;<span class="stringliteral">" telescopes in the array!)"</span>
00844                      &lt;&lt; endl;
00845                 <span class="keywordflow">continue</span>;
00846             }
00847 
00848             curcam = array.<a class="code" href="classTelescopeArray.html#a3">getCamera</a>(event.<a class="code" href="structRawEventRecord.html#o6">telescope_id</a>);
00849             curtel = event.<a class="code" href="structRawEventRecord.html#o6">telescope_id</a>;
00850 
00851             <span class="comment">// ----------------------------------------- </span>
00852             <span class="comment">// Subtract pedestals and pad if requested:</span>
00853             <span class="comment">// -----------------------------------------</span>
00854 
00855             <span class="keywordflow">for</span> ( i=0; i&lt;(<span class="keywordtype">int</span>)event.<a class="code" href="structRawEventRecord.html#o7">adc</a>.size(); i++){
00856 
00857                 <span class="comment">// If the tube is on (according to the pedestal),</span>
00858 
00859                 <span class="keywordflow">if</span> (tel[curtel].peds[i].type == Pedestal::GOOD) { 
00860 
00861                     <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o17">padding</a> == <span class="keyword">true</span>) {
00862 
00863                         <span class="comment">// "Pad" to bring the noise up to the maximum</span>
00864                         <span class="comment">// of the on and off peddisps.  Currently, add</span>
00865                         <span class="comment">// in noise based on a gaussian distribution,</span>
00866                         <span class="comment">// but a poisson distribution may be better</span>
00867                         <span class="comment">// for low statistics. That would require</span>
00868                         <span class="comment">// switching gsl_ran_gaussian() to</span>
00869                         <span class="comment">// gsl_ran_poisson() and changing the formula</span>
00870                         <span class="comment">// a bit.</span>
00871 
00872 
00873                         <span class="keywordflow">if</span> (tel[curtel].sigmaped[i] &gt; 0.0) {
00874 
00875                             deviate = _gaussdev-&gt;getDeviate();
00876                             adc[i] += deviate*tel[curtel].sigmaped[i];
00877 
00878                         }
00879 
00880                     }
00881 
00882                     adc[i] -= tel[curtel].peds[i].pedestal;
00883                     
00884                 }
00885 
00886                 <span class="comment">// Otherwise mark the tube as off</span>
00887 
00888                 <span class="keywordflow">else</span> {
00889                     adc[i] = 0; 
00890                 }
00891 
00892             }
00893 
00894             <span class="comment">// ----------------------------------------- </span>
00895             <span class="comment">// Apply gains:</span>
00896             <span class="comment">// ----------------------------------------- </span>
00897             
00898             adc *= tel[curtel].gains;
00899 
00900             <span class="comment">// ----------------------------------------- </span>
00901             <span class="comment">// Clean the image</span>
00902             <span class="comment">// and generate a linked list of pixels that</span>
00903             <span class="comment">// are in the picture and boundary.  </span>
00904             <span class="comment">// ----------------------------------------- </span>
00905 
00906             <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o34">image_filter</a> == <span class="keyword">false</span>) {
00907                
00908                 <span class="comment">// standard cleaning method:</span>
00909                  
00910                 cleanpixels = tel[curtel].cleaner-&gt;getCleanPixels( adc );
00911 
00912                 <span class="comment">// add the clean pixels to a histogram to look for</span>
00913                 <span class="comment">// misfiring tubes </span>
00914                 
00915                 <span class="comment">// TODO: speed this up by not using</span>
00916                 <span class="comment">// increment() since it's integers anyway. Right now, I</span>
00917                 <span class="comment">// add 0.5 to make sure the correct bin is incremented</span>
00918                 <span class="comment">// (since the value lies on the bin-boundary, which seems</span>
00919                 <span class="comment">// to cause random behavior due to rounding)</span>
00920                 
00921                 <span class="keywordflow">for</span> (i=0; i&lt;cleanpixels.size(); i++) {
00922                     tel[curtel].tubehits-&gt;increment(cleanpixels[i]+0.5);
00923                 }
00924 
00925             }
00926             <span class="keywordflow">else</span> {
00927                 <span class="comment">// Image filter method: smooth image with hexagonal</span>
00928                 <span class="comment">// FFT filtering.  The resulting image has more pixels</span>
00929                 <span class="comment">// than the original, since the resolution of the</span>
00930                 <span class="comment">// camera is modified.</span>
00931 
00932                 <span class="comment">// first, get the regular cleaning for comparison:</span>
00933                 cleanpixels = tel[curtel].cleaner-&gt;getCleanPixels( adc );
00934 
00935                 <span class="comment">// now filter the image:</span>
00936                 s_max = filter_image( adc,hires_adc );
00937 
00938 
00939                 <span class="comment">// clean the image with a threshold based on a</span>
00940                 <span class="comment">// percentage of the maximum value after subtracting</span>
00941                 <span class="comment">// the picture threshold:</span>
00942                 ((ThresholdImageCleaner*)(threshcleaner))
00943                     -&gt;setThreshold( ri.<a class="code" href="classRunInfo.html#o40">filter_threshold</a>*avgpeddisp 
00944                                     + (s_max-ri.<a class="code" href="classRunInfo.html#o40">filter_threshold</a>*avgpeddisp)
00945                                     *ri.<a class="code" href="classRunInfo.html#o39">filter_percent</a> );
00946                 hires_cleanpixels = threshcleaner-&gt;<a class="code" href="classImageCleaner.html#a1">getCleanPixels</a>( hires_adc );
00947 
00948             }
00949 
00950 
00951 
00952             <span class="comment">// ----------------------------------------- </span>
00953             <span class="comment">// Get the image parameterization</span>
00954             <span class="comment">// ----------------------------------------- </span>
00955 
00956             updateAngles( event.<a class="code" href="structRawEventRecord.html#o1">gpstime</a>, header );
00957             zen =  M_PI_2 - _el;           <span class="comment">// zenith angle</span>
00958 
00959             <span class="keywordflow">if</span> ( ri.<a class="code" href="classRunInfo.html#o34">image_filter</a> == <span class="keyword">true</span> )
00960                 tel[curtel].analyzer-&gt;parameterize( hires_adc, hires_cleanpixels );
00961             <span class="keywordflow">else</span>
00962                 tel[curtel].analyzer-&gt;parameterize( adc, cleanpixels );
00963 
00964 
00965 
00966 
00967             param = tel[curtel].analyzer-&gt;getHillasParameters();
00968             param.<a class="code" href="structImageParameterization.html#o1">osctime</a> = event.<a class="code" href="structRawEventRecord.html#o2">osctime</a>;
00969             param.<a class="code" href="structImageParameterization.html#o3">livetime</a> = event.<a class="code" href="structRawEventRecord.html#o3">livetime</a>;
00970             param.<a class="code" href="structImageParameterization.html#o2">gpstime</a> = event.<a class="code" href="structRawEventRecord.html#o1">gpstime</a>;
00971             param.<a class="code" href="structImageParameterization.html#o5">event_number</a> = _event_number;
00972             param.<a class="code" href="structHillasParameterization.html#o19">zenith</a> =  zen; 
00973             param.<a class="code" href="structImageParameterization.html#o0">telescope_id</a> = event.<a class="code" href="structRawEventRecord.html#o6">telescope_id</a>;
00974 
00975             <span class="comment">// if there's a zenith override</span>
00976             <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o11">zenithoverride</a> &gt; 1e-9) {
00977                 param.<a class="code" href="structHillasParameterization.html#o19">zenith</a> = ri.<a class="code" href="classRunInfo.html#o11">zenithoverride</a>;
00978             }
00979 
00980             <span class="comment">// ----------------------------------------- </span>
00981             <span class="comment">// Get the muon parameters if requested</span>
00982             <span class="comment">// ----------------------------------------- </span>
00983 
00984             <span class="keywordflow">if</span> ( ri.<a class="code" href="classRunInfo.html#o20">muoncalibrate</a> ) {
00985 
00986                 <span class="comment">// muons usually have a size less than 2000, so lets</span>
00987                 <span class="comment">// only calculate muon parameters when this occurs.</span>
00988                 <span class="comment">// Should define a muon size cut in the Config file!</span>
00989 
00990                 <span class="keywordflow">if</span> ( param.<a class="code" href="structHillasParameterization.html#o5">size</a> &lt; 3000 ) {
00991                     
00992                     <span class="keywordflow">try</span> {
00993                         tel[curtel].muonanalyzer-&gt;parameterize( adc,cleanpixels );
00994                         mparam = tel[curtel].muonanalyzer-&gt;getMuonParameters();
00995                     }
00996                     <span class="keywordflow">catch</span> (<a class="code" href="classMildAnalysisException.html">MildAnalysisException</a> e) {
00997                         
00998                     }
00999                     
01000                     tel[curtel].muonnesshist-&gt;increment( mparam.<a class="code" href="structMuonParameterization.html#o14">muonness</a> );
01001 
01002                     <span class="keywordflow">if</span> ( mparam.<a class="code" href="structMuonParameterization.html#o14">muonness</a> &gt; ri.<a class="code" href="classRunInfo.html#o23">muon_threshold</a> ) {
01003                         tel[curtel].musoalhist-&gt;increment( mparam.<a class="code" href="structMuonParameterization.html#o6">soal</a> );
01004                         tel[curtel].musizehist-&gt;increment( param.<a class="code" href="structHillasParameterization.html#o5">size</a> );
01005                         tel[curtel].mugainhist-&gt;increment( mparam.<a class="code" href="structMuonParameterization.html#o4">mugain</a> );
01006                         tel[curtel].mulensizehist-&gt;increment( param.<a class="code" href="structHillasParameterization.html#o10">length_over_size</a> );
01007                     }
01008                 }
01009                 <span class="keywordflow">else</span> {
01010                     mparam.<a class="code" href="structMuonParameterization.html#a0">clear</a>();
01011                 }
01012                 
01013                 <span class="comment">// write out the parameters</span>
01014                 
01015                 muonfile &lt;&lt; param.<a class="code" href="structImageParameterization.html#o5">event_number</a> &lt;&lt; <span class="stringliteral">" "</span> &lt;&lt; mparam &lt;&lt; endl;
01016                                 
01017             }
01018             
01019             
01020             <span class="comment">// ----------------------------------------- </span>
01021             <span class="comment">// Display if interactive:</span>
01022             <span class="comment">// ----------------------------------------- </span>
01023 
01024             <span class="keywordflow">if</span> ( _is_display_enabled ) {
01025                 
01026                 <span class="keywordflow">if</span> (_is_interactive == <span class="keyword">true</span>) {
01027 
01028 
01029                     cout &lt;&lt; <span class="stringliteral">"PARAMS   : "</span>&lt;&lt;param &lt;&lt; endl;
01030 
01031                     <span class="keywordflow">if</span> (interactive_correct) {
01032                         cutter-&gt;<a class="code" href="classSuperCutter.html#a1">applyCorrections</a>(param);
01033                         cout &lt;&lt; <span class="stringliteral">"CORRECTED: "</span> &lt;&lt; param &lt;&lt; endl;
01034                     }
01035 
01036   
01037                     cout &lt;&lt; <span class="stringliteral">"Clean Pixels: "</span>;
01038                     <span class="keywordflow">for</span> (i=0; i&lt;cleanpixels.size(); i++)
01039                         cout &lt;&lt; cleanpixels[i] &lt;&lt; <span class="stringliteral">" "</span>;
01040                     cout &lt;&lt; endl;
01041                     <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o20">muoncalibrate</a>)
01042                         cout &lt;&lt; <span class="stringliteral">"MUON PARAMETERS: "</span>&lt;&lt; mparam &lt;&lt; endl;
01043 
01044 
01045                     tempstr = <span class="stringliteral">""</span>;
01046                     <span class="keywordflow">while</span> (tempstr != <span class="stringliteral">"n"</span>) {
01047 
01048                         <span class="keywordflow">if</span> (interactive_triplet_centers) 
01049                             tel[curtel].muonanalyzer-&gt;enablePlotPoints(<span class="keyword">true</span>);
01050                         <span class="keywordflow">else</span> 
01051                             tel[curtel].muonanalyzer-&gt;enablePlotPoints(<span class="keyword">false</span>);
01052                         
01053                         <span class="keywordflow">if</span> (interactive_muon) {
01054                             <span class="comment">// seek to next muon</span>
01055                             <span class="keywordflow">if</span> (mparam.<a class="code" href="structMuonParameterization.html#o14">muonness</a> &gt; ri.<a class="code" href="classRunInfo.html#o23">muon_threshold</a>) { 
01056                                 interactive_muon=<span class="keyword">false</span>;
01057                             }
01058                             <span class="keywordflow">else</span> {
01059                                 <span class="keywordflow">break</span>;
01060                             }
01061                             
01062                         }
01063 
01064                         
01065                         <span class="keywordflow">if</span> (interactive_cuts) {
01066                             cout &lt;&lt; <span class="stringliteral">"Seeking: "</span>&lt;&lt;param.<a class="code" href="structImageParameterization.html#o5">event_number</a> 
01067                                  &lt;&lt; <span class="stringliteral">"     \r"</span> &lt;&lt; flush;
01068 
01069                             <span class="keywordflow">if</span> (cutter-&gt;<a class="code" href="classSuperCutter.html#a2">pass</a>(param,(SIZE|MAX|FRAC|LENSIZE
01070                                                        |DISTANCE|LENGTH
01071                                                        |WIDTH))){
01072                                 cout &lt;&lt; <span class="stringliteral">"Event "</span> &lt;&lt; param.<a class="code" href="structImageParameterization.html#o5">event_number</a>
01073                                      &lt;&lt; <span class="stringliteral">" Passed cuts    "</span> &lt;&lt; endl;
01074                             }
01075                             <span class="keywordflow">else</span> <span class="keywordflow">break</span>;
01076                         } <span class="comment">// End if cuts are enabled in interactive mode.</span>
01077 
01078 
01079                         <span class="comment">// Plot the camera</span>
01080 
01081                         pm-&gt;<a class="code" href="classPlotMaker.html#a2">setAxisBox</a>( *curcam );
01082                         <span class="keywordflow">if</span> (interactive_rotate){
01083                             pm-&gt;<a class="code" href="classPlotMaker.html#a8">pushState</a>();
01084                             pm-&gt;<a class="code" href="classPlotMaker.html#a10">rotate</a>( _theta );
01085                         }
01086 
01087                         <span class="keywordflow">if</span> (interactive_clean == <span class="keyword">false</span>) {
01088                             cleanpixels.clear();
01089                         }
01090 
01091 
01092                         <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o34">image_filter</a>==<span class="keyword">true</span>) {
01093                             hires_pm-&gt;<a class="code" href="classPlotMaker.html#a2">setAxisBox</a>( *hires_cam );
01094                             hires_pm-&gt;<a class="code" href="classPlotMaker.html#a20">plot</a>( *hires_cam, hires_adc, 
01095                                       hires_peds,hires_cleanpixels,
01096                                       interactive_disptype);
01097                             hires_pm-&gt;<a class="code" href="classPlotMaker.html#a20">plot</a>( param );
01098                             hires_pm-&gt;<a class="code" href="classPlotMaker.html#a11">plotAxes</a>();
01099                             hires_pm-&gt;<a class="code" href="classPlotMaker.html#a12">plotTitle</a>(<span class="stringliteral">"Filtered Image"</span>);
01100                             hires_pm-&gt;<a class="code" href="classPlotMaker.html#a7">newPage</a>();
01101                         }
01102 
01103                         pm-&gt;<a class="code" href="classPlotMaker.html#a20">plot</a>( *curcam, adc, tel[curtel].combinedpeds, 
01104                                   cleanpixels, interactive_disptype );
01105                         
01106                         
01107                         <span class="keywordflow">if</span> (interactive_params) 
01108                             pm-&gt;<a class="code" href="classPlotMaker.html#a20">plot</a>( param );
01109 
01110                         <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o20">muoncalibrate</a>) pm-&gt;<a class="code" href="classPlotMaker.html#a20">plot</a>( mparam );
01111                         pm-&gt;<a class="code" href="classPlotMaker.html#a11">plotAxes</a>();
01112                         <span class="keywordflow">switch</span> (interactive_disptype) {
01113                         <span class="keywordflow">case</span> PlotMaker::CAMERA_IMAGE:
01114                             pm-&gt;<a class="code" href="classPlotMaker.html#a12">plotTitle</a>(<span class="stringliteral">"Camera image - "</span>+header.sourcename);
01115                             <span class="keywordflow">break</span>;
01116                         <span class="keywordflow">case</span> PlotMaker::CAMERA_PEDS:
01117                             pm-&gt;<a class="code" href="classPlotMaker.html#a12">plotTitle</a>(<span class="stringliteral">"Peds - "</span>+header.sourcename);
01118                             <span class="keywordflow">break</span>;
01119                         <span class="keywordflow">case</span> PlotMaker::CAMERA_PEDDISPS:
01120                             pm-&gt;<a class="code" href="classPlotMaker.html#a12">plotTitle</a>(<span class="stringliteral">"sigma_ped - "</span>
01121                                           +header.sourcename);
01122                             <span class="keywordflow">break</span>;
01123                         <span class="keywordflow">case</span> PlotMaker::CAMERA_TUBENUMS:
01124                             pm-&gt;<a class="code" href="classPlotMaker.html#a12">plotTitle</a>(<span class="stringliteral">"Tube numbers - "</span>
01125                                           +header.sourcename);
01126                             <span class="keywordflow">break</span>;
01127                         <span class="keywordflow">default</span>:
01128                             pm-&gt;<a class="code" href="classPlotMaker.html#a12">plotTitle</a>(<span class="stringliteral">"Camera image - "</span>+header.sourcename);
01129                             <span class="keywordflow">break</span>;
01130                         }
01131                     
01132                         <span class="keywordflow">if</span> (interactive_rotate)pm-&gt;<a class="code" href="classPlotMaker.html#a9">popState</a>();
01133                         pm-&gt;<a class="code" href="classPlotMaker.html#a7">newPage</a>();
01134                                         
01135                         cout &lt;&lt; <span class="stringliteral">"-----------------------------------------"</span>
01136                              &lt;&lt; endl
01137                              &lt;&lt; <span class="stringliteral">"[n] Next event         [s] Save as ps    "</span>
01138                              &lt;&lt; <span class="stringliteral">"      [p] set Plot type"</span> &lt;&lt; endl
01139                              &lt;&lt; <span class="stringliteral">"[m] next Muon          [r] Redraw        "</span>
01140                              &lt;&lt; <span class="stringliteral">"      [i] set dIsplay scale"</span> &lt;&lt;endl
01141                              &lt;&lt; <span class="stringliteral">"[,] mark good muon     [c] toggle Cuts ("</span>;
01142                         <span class="keywordflow">if</span> (interactive_cuts) cout &lt;&lt; <span class="stringliteral">"*"</span>; <span class="keywordflow">else</span> cout &lt;&lt;<span class="stringliteral">" "</span>;
01143                         cout &lt;&lt;<span class="stringliteral">")     [C] toggle corrections ("</span>;
01144                         <span class="keywordflow">if</span> (interactive_correct) cout &lt;&lt; <span class="stringliteral">"*"</span>; <span class="keywordflow">else</span> cout &lt;&lt;<span class="stringliteral">" "</span>;
01145                         cout &lt;&lt; <span class="stringliteral">")"</span> &lt;&lt; endl;
01146                         cout &lt;&lt; <span class="stringliteral">"[h] Hold event ("</span>;
01147                         <span class="keywordflow">if</span> (interactive_hold) cout &lt;&lt; <span class="stringliteral">"*"</span>; <span class="keywordflow">else</span> cout &lt;&lt;<span class="stringliteral">" "</span>;
01148                         cout &lt;&lt;<span class="stringliteral">")     [R] toggle Rotation ("</span>;
01149                         <span class="keywordflow">if</span> (interactive_rotate) cout &lt;&lt; <span class="stringliteral">"*"</span>; <span class="keywordflow">else</span> cout &lt;&lt;<span class="stringliteral">" "</span>;
01150                         cout &lt;&lt;<span class="stringliteral">") [t] toggle triplet cntrs ("</span>;
01151                         <span class="keywordflow">if</span> (interactive_triplet_centers) 
01152                             cout &lt;&lt; <span class="stringliteral">"*"</span>; <span class="keywordflow">else</span> cout &lt;&lt;<span class="stringliteral">" "</span>;
01153                         cout &lt;&lt;<span class="stringliteral">")"</span>&lt;&lt;endl;
01154                         cout &lt;&lt; <span class="stringliteral">"CHOICE: "</span>;
01155                         cin &gt;&gt; tempstr;
01156                         cout &lt;&lt; tempstr[0] &lt;&lt; endl;
01157 
01158                         <span class="keywordflow">switch</span> (tempstr[0]) {
01159                         <span class="keywordflow">case</span> <span class="charliteral">'c'</span>:
01160                             interactive_cuts = !interactive_cuts;
01161                             <span class="keywordflow">break</span>;
01162                         <span class="keywordflow">case</span> <span class="charliteral">'C'</span>:
01163                             interactive_correct = !interactive_correct;
01164                             <span class="keywordflow">break</span>;
01165                         <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:
01166                             interactive_hold = !interactive_hold;
01167                             <span class="keywordflow">break</span>;
01168                         <span class="keywordflow">case</span> <span class="charliteral">'l'</span>:
01169                             interactive_clean = !interactive_clean;
01170                             <span class="keywordflow">break</span>;
01171                         <span class="keywordflow">case</span> <span class="charliteral">'P'</span>:
01172                             interactive_params = !interactive_params;
01173                             <span class="keywordflow">break</span>;
01174                         <span class="keywordflow">case</span> <span class="charliteral">'t'</span>:
01175                             interactive_triplet_centers = 
01176                                 !interactive_triplet_centers;
01177                             <span class="keywordflow">break</span>;
01178                         <span class="keywordflow">case</span> <span class="charliteral">'s'</span>:
01179                             cout &lt;&lt; <span class="stringliteral">"Enter filename: "</span>;
01180                             cin &gt;&gt; fname;
01181                             pspm = <span class="keyword">new</span> <a class="code" href="classPlotMaker.html">PlotMaker</a>( <span class="stringliteral">"PS"</span>, fname.c_str() );
01182                             pspm-&gt;<a class="code" href="classPlotMaker.html#a2">setAxisBox</a>( *curcam );
01183                             pspm-&gt;<a class="code" href="classPlotMaker.html#a20">plot</a>( *curcam, adc, tel[curtel].combinedpeds,
01184                                         cleanpixels,interactive_disptype);
01185                             <span class="keywordflow">if</span> (interactive_params)
01186                                 pspm-&gt;<a class="code" href="classPlotMaker.html#a20">plot</a>( param );
01187                             <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o20">muoncalibrate</a>) pspm-&gt;<a class="code" href="classPlotMaker.html#a20">plot</a>( mparam );
01188                             pspm-&gt;<a class="code" href="classPlotMaker.html#a11">plotAxes</a>();
01189                             <span class="keywordflow">switch</span> (interactive_disptype) {
01190                             <span class="keywordflow">case</span> PlotMaker::CAMERA_IMAGE:
01191                                 pm-&gt;<a class="code" href="classPlotMaker.html#a12">plotTitle</a>(<span class="stringliteral">"Camera image - "</span>+
01192                                               header.sourcename);
01193                                 <span class="keywordflow">break</span>;
01194                             <span class="keywordflow">case</span> PlotMaker::CAMERA_PEDS:
01195                                 pm-&gt;<a class="code" href="classPlotMaker.html#a12">plotTitle</a>(<span class="stringliteral">"Peds - "</span>+header.sourcename);
01196                                 <span class="keywordflow">break</span>;
01197                             <span class="keywordflow">case</span> PlotMaker::CAMERA_PEDDISPS:
01198                                 pm-&gt;<a class="code" href="classPlotMaker.html#a12">plotTitle</a>(<span class="stringliteral">"sigma_ped - "</span>
01199                                               +header.sourcename);
01200                                 <span class="keywordflow">break</span>;
01201                             <span class="keywordflow">case</span> PlotMaker::CAMERA_TUBENUMS:
01202                                 pm-&gt;<a class="code" href="classPlotMaker.html#a12">plotTitle</a>(<span class="stringliteral">"Tube numbers - "</span>
01203                                               +header.sourcename);
01204                                 <span class="keywordflow">break</span>;
01205                             <span class="keywordflow">default</span>:
01206                                 pm-&gt;<a class="code" href="classPlotMaker.html#a12">plotTitle</a>(<span class="stringliteral">"Camera image - "</span>
01207                                               +header.sourcename);
01208                                 <span class="keywordflow">break</span>;
01209                             }
01210                             <span class="keyword">delete</span> pspm;
01211 
01212                             <span class="keywordflow">break</span>;
01213                         <span class="keywordflow">case</span> <span class="charliteral">'S'</span>:
01214                             <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o34">image_filter</a>==<span class="keyword">true</span>) {
01215                                 cout &lt;&lt; <span class="stringliteral">"Enter filename: "</span>;
01216                                 cin &gt;&gt; fname;
01217                                 pspm = <span class="keyword">new</span> PlotMaker( <span class="stringliteral">"PS"</span>, fname.c_str() );
01218                                 pspm-&gt;<a class="code" href="classPlotMaker.html#a2">setAxisBox</a>( *hires_cam );
01219                                 pspm-&gt;<a class="code" href="classPlotMaker.html#a20">plot</a>( *hires_cam, hires_adc, 
01220                                             hires_peds, hires_cleanpixels,
01221                                             PlotMaker::CAMERA_IMAGE);
01222                                 <span class="keywordflow">if</span> (interactive_params)
01223                                     pspm-&gt;<a class="code" href="classPlotMaker.html#a20">plot</a>( param );
01224                                 <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o20">muoncalibrate</a>) pspm-&gt;<a class="code" href="classPlotMaker.html#a20">plot</a>( mparam );
01225                                 pspm-&gt;<a class="code" href="classPlotMaker.html#a11">plotAxes</a>();
01226                                 pm-&gt;<a class="code" href="classPlotMaker.html#a12">plotTitle</a>(<span class="stringliteral">"Filtered Camera image - "</span>+
01227                                               header.sourcename);
01228                                 <span class="keyword">delete</span> pspm;
01229                             }
01230                             <span class="keywordflow">else</span> cout &lt;&lt; <span class="stringliteral">"Image Filter is disabled"</span>&lt;&lt;endl;
01231                             <span class="keywordflow">break</span>;
01232 
01233                         <span class="keywordflow">case</span> <span class="charliteral">'d'</span>:
01234                             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;100; k++) {
01235                                 adc[k] -= 0.3*adc[k];
01236                             }
01237                             <span class="keywordflow">break</span>;
01238                         <span class="keywordflow">case</span> <span class="charliteral">'r'</span>:
01239                             <span class="keywordflow">break</span>;
01240                         <span class="keywordflow">case</span> <span class="charliteral">'i'</span>:
01241                             cout &lt;&lt; <span class="stringliteral">"ENTER NEW MAX ADC VALUE (-1 for auto):"</span>;
01242                             cin &gt;&gt; answer;
01243                             pm-&gt;<a class="code" href="classPlotMaker.html#a33">setPixelScale</a>(atoi(answer.c_str()));
01244                             <span class="keywordflow">break</span>;
01245                         <span class="keywordflow">case</span> <span class="charliteral">'m'</span>:
01246                             <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o20">muoncalibrate</a>==<span class="keyword">true</span>){
01247                                 interactive_muon = <span class="keyword">true</span>;
01248                                 tempstr = <span class="stringliteral">"n"</span>;
01249                             }
01250                             <span class="keywordflow">else</span> {
01251                                 cout &lt;&lt; <span class="stringliteral">"MuonCalibration is currently "</span>
01252                                      &lt;&lt; <span class="stringliteral">"disabled! "</span> &lt;&lt; endl;
01253                             }
01254                             <span class="keywordflow">break</span>;
01255                         <span class="keywordflow">case</span> <span class="charliteral">','</span>:
01256                             goodmuons &lt;&lt; param.<a class="code" href="structImageParameterization.html#o5">event_number</a> &lt;&lt; <span class="stringliteral">" "</span> 
01257                                       &lt;&lt;mparam &lt;&lt; endl;
01258                             cout &lt;&lt; <span class="stringliteral">"Saved event to goodmuons.txt"</span>&lt;&lt;endl;
01259                             <span class="keywordflow">break</span>;
01260                         <span class="keywordflow">case</span> <span class="charliteral">'p'</span>:
01261                             cout &lt;&lt; <span class="stringliteral">"CHOOSE PLOT TYPE: 1) image 2) peds "</span>
01262                                  &lt;&lt; <span class="stringliteral">"3) ped disps 4) tube nums: "</span>;
01263                             cin &gt;&gt; answer;
01264                             <span class="keywordflow">switch</span> ( atoi(answer.c_str())){
01265                             <span class="keywordflow">case</span> 1:
01266                                 interactive_disptype=PlotMaker::CAMERA_IMAGE;
01267                                 <span class="keywordflow">break</span>;
01268                             <span class="keywordflow">case</span> 2:
01269                                 interactive_disptype=PlotMaker::CAMERA_PEDS;
01270                                 <span class="keywordflow">break</span>;
01271                             <span class="keywordflow">case</span> 3:
01272                                 interactive_disptype=
01273                                     PlotMaker::CAMERA_PEDDISPS;
01274                                 <span class="keywordflow">break</span>;
01275                             <span class="keywordflow">case</span> 4:
01276                                 interactive_disptype=
01277                                     PlotMaker::CAMERA_TUBENUMS;
01278                                 <span class="keywordflow">break</span>;
01279                             <span class="keywordflow">default</span>:
01280                                 cout &lt;&lt; <span class="stringliteral">"INVALID OPTION: "</span>&lt;&lt;answer&lt;&lt;<span class="stringliteral">"!"</span>&lt;&lt;endl;
01281                             }
01282                             <span class="keywordflow">break</span>;
01283                         <span class="keywordflow">case</span> <span class="charliteral">'R'</span>:
01284                             interactive_rotate = !interactive_rotate;
01285                             <span class="keywordflow">break</span>;
01286                         <span class="keywordflow">case</span> <span class="charliteral">'n'</span>:
01287                             <span class="keywordflow">break</span>;  <span class="comment">// don't print a warning</span>
01288                         <span class="keywordflow">default</span>:
01289                             cout &lt;&lt; <span class="stringliteral">"Unknown command '"</span>&lt;&lt; tempstr &lt;&lt; <span class="stringliteral">"'"</span>&lt;&lt; endl;
01290                         }
01291                             
01292                     } <span class="comment">// End while</span>
01293 
01294                 } <span class="comment">// End if interactive</span>
01295                 <span class="keywordflow">else</span> {
01296                     <span class="comment">// non-interactive, just display</span>
01297                     pm-&gt;<a class="code" href="classPlotMaker.html#a2">setAxisBox</a>( *curcam );
01298                     pm-&gt;<a class="code" href="classPlotMaker.html#a20">plot</a>( *curcam, adc, tel[curtel].combinedpeds, cleanpixels,
01299                               interactive_disptype);
01300                     pm-&gt;<a class="code" href="classPlotMaker.html#a20">plot</a>( param );
01301                     <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o20">muoncalibrate</a>) pm-&gt;<a class="code" href="classPlotMaker.html#a20">plot</a>( mparam );
01302                     pm-&gt;<a class="code" href="classPlotMaker.html#a11">plotAxes</a>();
01303                     pm-&gt;<a class="code" href="classPlotMaker.html#a7">newPage</a>();
01304                 } <span class="comment">// End else not interactive</span>
01305                         
01306 
01307             } <span class="comment">// End if diplay enabled</span>
01308 
01309             <span class="comment">// -----------------------------------------</span>
01310             <span class="comment">// derotate the point of origin and centroid</span>
01311             <span class="comment">// -----------------------------------------</span>
01312             
01313             <span class="comment">// write out the angles every so often for diagnostics:</span>
01314             <span class="keywordflow">if</span> (n[curtel] % 256==0) {
01315                 anglefile[curtel].precision(15);
01316                 anglefile[curtel] &lt;&lt; (event.<a class="code" href="structRawEventRecord.html#o1">gpstime</a>-gpstime_start)*24*60&lt;&lt; <span class="stringliteral">"\t"</span> 
01317                                   &lt;&lt; _theta *180.0/M_PI  &lt;&lt; <span class="stringliteral">"\t"</span>
01318                                   &lt;&lt; _el * 180.0/M_PI &lt;&lt; <span class="stringliteral">"\t"</span>
01319                                   &lt;&lt; _az * 180.0/M_PI 
01320                                   &lt;&lt; endl;
01321             }
01322 
01323             <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o19">derotation</a> == <span class="keyword">true</span>) {
01324 
01325                 derotatePoint( _theta, param.<a class="code" href="structHillasParameterization.html#o1">point_of_origin_a</a> ); 
01326                 derotatePoint( _theta, param.<a class="code" href="structHillasParameterization.html#o2">point_of_origin_b</a> ); 
01327                 derotatePoint( _theta, param.<a class="code" href="structHillasParameterization.html#o0">centroid</a> );
01328 
01329             }
01330 
01331             param.<a class="code" href="structHillasParameterization.html#o18">on</a>=ison;
01332 
01333             <span class="comment">// ----------------------------------------- </span>
01334             <span class="comment">// Write parameters to disk and update</span>
01335             <span class="comment">// diagnostic histograms</span>
01336             <span class="comment">// ----------------------------------------- </span>
01337 
01338             <span class="keywordflow">if</span> (data-&gt;<a class="code" href="classRawDataReader.html#a5">getType</a>()==RawDataReader::SIM) {
01339                 cursimshower=((<a class="code" href="classRawDataReaderSim.html">RawDataReaderSim</a>*)(data))-&gt;getSimShowerRecord();
01340                 param.<a class="code" href="structImageParameterization.html#o6">sim</a> = cursimshower;
01341             }
01342             <span class="keywordflow">else</span> {
01343                 memset( &amp;(param.<a class="code" href="structImageParameterization.html#o6">sim</a>), 0, <span class="keyword">sizeof</span>(SimShowerRecord));
01344             }
01345             
01346             writer-&gt;<a class="code" href="classParamDataWriter.html#a3">writeParameterization</a>( param );
01347                     
01348             <span class="keywordflow">if</span> (param.<a class="code" href="structImageParameterization.html#o4">invalid</a>==0) {
01349                 tel[curtel].lensize-&gt;increment( param.<a class="code" href="structHillasParameterization.html#o10">length_over_size</a> );
01350                 tel[curtel].pictubes-&gt;increment( param.<a class="code" href="structHillasParameterization.html#o16">pixels_in_picture</a> );
01351                 tel[curtel].phihist-&gt;increment( param.<a class="code" href="structHillasParameterization.html#o12">phi</a> );
01352                 tel[curtel].alphahist-&gt;increment( param.<a class="code" href="structHillasParameterization.html#o9">alpha</a>*180.0/M_PI );
01353                 tel[curtel].lengthhist-&gt;increment( param.<a class="code" href="structHillasParameterization.html#o3">length</a> );
01354                 tel[curtel].widthhist-&gt;increment( param.<a class="code" href="structHillasParameterization.html#o4">width</a> );
01355                 tel[curtel].rawrate-&gt;increment((param.<a class="code" href="structImageParameterization.html#o2">gpstime</a>-gpstime_start)*24*60 );
01356                 tel[curtel].disthist-&gt;increment( param.<a class="code" href="structHillasParameterization.html#o7">distance</a> );
01357                 tel[curtel].sizehist-&gt;increment( param.<a class="code" href="structHillasParameterization.html#o5">size</a> );
01358                 tel[curtel].deltat-&gt;increment( param.<a class="code" href="structImageParameterization.html#o2">gpstime</a>-gpstime_last );
01359                 tel[curtel].max2hist-&gt;increment( param.<a class="code" href="structHillasParameterization.html#o13">max</a>[2] );
01360                 tel[curtel].centroids-&gt;addHist( param.<a class="code" href="structHillasParameterization.html#o0">centroid</a>.<a class="code" href="structCoordinate__t.html#o0">x</a>,param.<a class="code" href="structHillasParameterization.html#o0">centroid</a>.<a class="code" href="structCoordinate__t.html#o1">y</a>,1);
01361             }
01362 
01363             gpstime_last = param.<a class="code" href="structImageParameterization.html#o2">gpstime</a>;
01364             n_trig[curtel]++;
01365 
01366             <span class="keywordflow">if</span> (n_trig[curtel] == 1) {
01367                 <span class="comment">// this is the first trigger event, so store the starting</span>
01368                 <span class="comment">// zenith angle</span>
01369                 <span class="comment">// TODO: make multi-telescope!</span>
01370                 start_el = _el;
01371             }
01372 
01373         }
01374         <span class="keywordflow">else</span> {
01375             <span class="comment">// not a trigger event</span>
01376             n_other[curtel]++;
01377         }
01378        
01379 
01380         <span class="comment">// --------------------------------------------------------</span>
01381         <span class="comment">// Output progress info if requested</span>
01382         <span class="comment">// --------------------------------------------------------</span>
01383         <span class="keywordflow">if</span> (_is_verbose_enabled &amp;&amp; (_is_interactive == <span class="keyword">false</span>) ) {
01384             <span class="keywordflow">if</span> (count%256 == 0)
01385                 progress.<a class="code" href="classProgressBar.html#a2">print</a>( count );
01386             <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o34">image_filter</a>==<span class="keyword">true</span> &amp;&amp; count%16==0)
01387                 progress.<a class="code" href="classProgressBar.html#a2">print</a>(count);
01388         }
01389         
01390         <span class="keywordflow">if</span> (interactive_hold == <span class="keyword">false</span>) {
01391             n[curtel]++;
01392             count++;
01393             _event_number++;
01394         }
01395 
01396     }
01397 
01398     <span class="comment">// DEBUGGING:</span>
01399 <span class="comment">//     rawfile.close() ;</span>
01400 
01401     progress.<a class="code" href="classProgressBar.html#a3">printClear</a>();
01402 
01403     <span class="comment">// store the end time in the header to pass on to the cutter</span>
01404     <span class="comment">// (this is needed for rate binning)</span>
01405     
01406     header.endtime = event.<a class="code" href="structRawEventRecord.html#o1">gpstime</a>;
01407     header.average_elevation = (start_el + _el) /2.0;
01408 
01409     <span class="keywordflow">if</span> (_is_verbose_enabled) {
01410         cout &lt;&lt; <span class="stringliteral">"Summary: "</span> &lt;&lt; endl
01411              &lt;&lt; <span class="stringliteral">"\tTRIG EVENTS : "</span> ;
01412         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel;k++) cout &lt;&lt; n_trig[k] &lt;&lt; <span class="stringliteral">" "</span>;
01413         cout &lt;&lt; endl
01414              &lt;&lt; <span class="stringliteral">"\tOTHER EVENTS: "</span> ;
01415         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel;k++) cout &lt;&lt; n_other[k] &lt;&lt; <span class="stringliteral">" "</span>;
01416         cout &lt;&lt; endl
01417              &lt;&lt; <span class="stringliteral">"\tTOTAL EVENTS: "</span> ;
01418         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel;k++) cout &lt;&lt; n[k] &lt;&lt; <span class="stringliteral">" "</span>;
01419         cout &lt;&lt; endl
01420              &lt;&lt; <span class="stringliteral">"\tLIVETIME    : "</span> &lt;&lt; setprecision(4)
01421              &lt;&lt;  event.<a class="code" href="structRawEventRecord.html#o3">livetime</a>/60.0 
01422              &lt;&lt; <span class="stringliteral">" min"</span>&lt;&lt; endl
01423              &lt;&lt; <span class="stringliteral">"\tELAPSED GPS : "</span> &lt;&lt; setprecision(10) 
01424              &lt;&lt; (header.endtime-gpstime_start)*24*60&lt;&lt;<span class="stringliteral">" min"</span>&lt;&lt; endl
01425              &lt;&lt; <span class="stringliteral">"\tDEAD TIME   : "</span> 
01426              &lt;&lt; (header.endtime-gpstime_start)*24*60- event.<a class="code" href="structRawEventRecord.html#o3">livetime</a>/60.0 
01427              &lt;&lt; <span class="stringliteral">" min "</span>
01428              &lt;&lt;endl&lt;&lt;endl;
01429 
01430         runinfo &lt;&lt; <span class="stringliteral">"Summary: "</span> &lt;&lt; endl
01431              &lt;&lt; <span class="stringliteral">"\tTRIG EVENTS : "</span> ;
01432         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel;k++) runinfo &lt;&lt; n_trig[k] &lt;&lt; <span class="stringliteral">" "</span>;
01433         runinfo &lt;&lt; endl
01434              &lt;&lt; <span class="stringliteral">"\tOTHER EVENTS: "</span> ;
01435         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel;k++) runinfo &lt;&lt; n_other[k] &lt;&lt; <span class="stringliteral">" "</span>;
01436         runinfo &lt;&lt; endl
01437              &lt;&lt; <span class="stringliteral">"\tTOTAL EVENTS: "</span> ;
01438         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel;k++) runinfo &lt;&lt; n[k] &lt;&lt; <span class="stringliteral">" "</span>;
01439         runinfo &lt;&lt; endl
01440              &lt;&lt; <span class="stringliteral">"\tLIVETIME    : "</span> &lt;&lt; setprecision(4)
01441              &lt;&lt;  event.<a class="code" href="structRawEventRecord.html#o3">livetime</a>/60.0 
01442              &lt;&lt; <span class="stringliteral">" min"</span>&lt;&lt; endl
01443              &lt;&lt; <span class="stringliteral">"\tELAPSED GPS : "</span> &lt;&lt; setprecision(10) 
01444              &lt;&lt; (header.endtime-gpstime_start)*24*60&lt;&lt;<span class="stringliteral">" min"</span>&lt;&lt; endl
01445              &lt;&lt; <span class="stringliteral">"\tDEAD TIME   : "</span> 
01446              &lt;&lt; (header.endtime-gpstime_start)*24*60- event.<a class="code" href="structRawEventRecord.html#o3">livetime</a>/60.0 
01447              &lt;&lt; <span class="stringliteral">" min "</span>
01448              &lt;&lt;endl&lt;&lt;endl;
01449 
01450             
01451     }
01452     
01453     runinfo.close();
01454 
01455 
01456     <span class="comment">//======================================================</span>
01457     <span class="comment">// generate diagnostic plots and brightness map</span>
01458     <span class="comment">//======================================================</span>
01459 
01460     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel; k++) {
01461         <span class="keywordtype">char</span> telid[100];
01462         sprintf( telid, <span class="stringliteral">"-%03d"</span>, k );
01463         tel[k].lensize-&gt;save(dir+id+telid+<span class="stringliteral">"-raw-lensize"</span>);
01464         tel[k].pictubes-&gt;save(dir+id+telid+<span class="stringliteral">"-raw-pictubes"</span>);
01465         tel[k].tubehits-&gt;save(dir+id+telid+<span class="stringliteral">"-tubehits"</span>);
01466         tel[k].phihist-&gt;save(dir+id+telid+<span class="stringliteral">"-raw-phi"</span>);
01467         tel[k].alphahist-&gt;save(dir+id+telid+<span class="stringliteral">"-raw-alpha"</span>);
01468         tel[k].lengthhist-&gt;save(dir+id+telid+<span class="stringliteral">"-raw-length"</span>);
01469         tel[k].widthhist-&gt;save(dir+id+telid+<span class="stringliteral">"-raw-width"</span>);
01470         tel[k].rawrate-&gt;save( dir+id+telid+<span class="stringliteral">"-raw-rate"</span> );
01471         tel[k].sizehist-&gt;save( dir+id+telid+<span class="stringliteral">"-raw-size"</span> );
01472         tel[k].disthist-&gt;save( dir+id+telid+<span class="stringliteral">"-raw-dist"</span> );
01473         tel[k].deltat-&gt;save( dir+id+telid+<span class="stringliteral">"-deltat"</span> );
01474         tel[k].centroids-&gt;save( dir+id+telid+<span class="stringliteral">"-centroids"</span> );
01475         tel[k].max2hist-&gt;save( dir+id+telid+<span class="stringliteral">"-raw-max2"</span> );
01476 
01477         <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o20">muoncalibrate</a>) {
01478             tel[k].musoalhist-&gt;save(dir+id+telid+<span class="stringliteral">"-muon-soal"</span>);
01479             tel[k].musizehist-&gt;save(dir+id+telid+<span class="stringliteral">"-muon-size"</span>);
01480             tel[k].mulensizehist-&gt;save(dir+id+telid+<span class="stringliteral">"-muon-lensize"</span>);
01481             tel[k].mugainhist-&gt;save(dir+id+telid+<span class="stringliteral">"-muon-gain"</span>);
01482             tel[k].muonnesshist-&gt;save( dir+id+telid+<span class="stringliteral">"-raw-muonness"</span>);
01483         }
01484 
01485         <span class="comment">// TODO: last arg is telescope_id</span>
01486         generatePlots( id, ri.<a class="code" href="classRunInfo.html#o6">n2id</a>, ri.<a class="code" href="classRunInfo.html#o2">cachedir</a>, k );
01487     }
01488 
01489     <span class="comment">// generate sky brightness/tubeoffness maps if it's an on or track run</span>
01490     <span class="comment">// (no need to do for off, since it will be negative of on)</span>
01491 
01492     <span class="keywordflow">if</span> (id == ri.<a class="code" href="classRunInfo.html#o4">onid</a> &amp;&amp; dtype != RawDataReader::SIM) {
01493         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel; k++) {
01494             cout &lt;&lt; <span class="stringliteral">"Generating sky brightness &amp; tubeoffness maps for "</span> 
01495                  &lt;&lt; <span class="stringliteral">"telescope "</span>&lt;&lt; k &lt;&lt; <span class="stringliteral">" run "</span>&lt;&lt; id 
01496                  &lt;&lt;<span class="stringliteral">"..."</span>&lt;&lt; endl;
01497             mapSkyBrightness( id, tel[k].peds, tel[k].padpeds, 
01498                               tel[k].gains, header, 
01499                               (event.<a class="code" href="structRawEventRecord.html#o1">gpstime</a>+gpstime_start)/2.0,
01500                               ri.<a class="code" href="classRunInfo.html#o19">derotation</a>,array.<a class="code" href="classTelescopeArray.html#a3">getCamera</a>(k),k );
01501 
01502         }
01503     }
01504     
01505     <span class="comment">// output a warning if too many tubes are turned off since the</span>
01506     <span class="comment">// skybrightness map will be problematic in the pointing</span>
01507     <span class="comment">// check later on</span>
01508 
01509     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel; k++) {
01510         <span class="keywordtype">int</span> ntubesoff = 0;
01511         curcam = array.<a class="code" href="classTelescopeArray.html#a3">getCamera</a>(k);
01512         <span class="keywordflow">for</span> (i=curcam-&gt;<a class="code" href="classCamera.html#a10">getFirstPixel</a>(); i&lt;=curcam-&gt;<a class="code" href="classCamera.html#a11">getLastPixel</a>(); i++) {
01513             <span class="keywordflow">if</span> (tel[k].combinedpeds[i].type == Pedestal::TUBEOFF) 
01514                 ntubesoff++;
01515         }
01516         
01517         cout &lt;&lt; <span class="stringliteral">"Tubes physically turned off: "</span>&lt;&lt; ntubesoff &lt;&lt; endl;
01518         <span class="keywordflow">if</span> (ntubesoff &gt;= 10 ) {
01519             logger-&gt;<a class="code" href="classLogger.html#a0">printf</a>(<span class="stringliteral">"Pointing checks may be invalid for telescope %d "</span>
01520                            <span class="stringliteral">"run %s since "</span>
01521                            <span class="stringliteral">"%d tubes were physically turned off"</span>, k,
01522                            id.c_str(),ntubesoff);
01523         } 
01524     }
01525 
01526 
01527     <span class="comment">//======================================================</span>
01528     <span class="comment">// clean up</span>
01529     <span class="comment">//======================================================</span>
01530 
01531     writer-&gt;<a class="code" href="classParamDataWriter.html#a2">writeHeader</a>( header );
01532 
01533     <span class="keywordflow">if</span> (_is_verbose_enabled) {
01534         cout &lt;&lt; <span class="stringliteral">"========================================"</span>
01535              &lt;&lt; <span class="stringliteral">"========================================"</span>
01536              &lt;&lt; endl&lt;&lt;endl;
01537     }
01538 
01539     <span class="comment">// Clean out the cached file if requested</span>
01540 
01541     <span class="keywordflow">if</span> (_is_cleanup_enabled)
01542         datafactory-&gt;<a class="code" href="classRawDataReaderFactory.html#a2">clearCache</a>(ri.<a class="code" href="classRunInfo.html#o2">cachedir</a>);
01543 
01544 
01545     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;numtel; k++) 
01546         anglefile[k].close();
01547     
01548     <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o20">muoncalibrate</a>){
01549         muonfile.close();
01550         goodmuons.close();
01551     }
01552 
01553     <span class="keywordflow">if</span> (pm) <span class="keyword">delete</span> pm;
01554     <span class="keywordflow">if</span> (hires_pm)<span class="keyword">delete</span> hires_pm;
01555     <span class="keywordflow">if</span> (hires_cam) <span class="keyword">delete</span> hires_cam;
01556 
01557     <span class="keyword">delete</span> writer;
01558     <span class="keyword">delete</span> data;
01559 
01560 }
01561 
01565 <span class="keywordtype">void</span>
01566 Parameterizer::
01567 generatePlots( string &amp;id, string &amp;n2id, string &amp;cachedir, <span class="keywordtype">int</span> telescope_id ) {
01568 
01569     string command;
01570     <span class="keywordtype">int</span> ret;
01571     <span class="keywordtype">char</span> telid[100];
01572 
01573     sprintf( telid, <span class="stringliteral">"%03d"</span>, telescope_id );
01574 
01575     cout &lt;&lt; <span class="stringliteral">"Generating diagnostic plots for "</span> &lt;&lt; id &lt;&lt; <span class="stringliteral">"..."</span> &lt;&lt; endl;
01576 
01577     command = _wupdir + <span class="stringliteral">"/gen-diag-plots.sh "</span>+_wupdir+<span class="stringliteral">" "</span>
01578         +id+<span class="stringliteral">" "</span>+n2id+<span class="stringliteral">" "</span>+cachedir+<span class="stringliteral">" "</span>+telid;
01579     ret = system(command.c_str());
01580 
01581     <span class="keywordflow">if</span> (ret) {
01582         cout &lt;&lt; <span class="stringliteral">"** Plotting failed.  Make sure you have GNUPlot installed"</span>
01583              &lt;&lt; endl
01584              &lt;&lt; <span class="stringliteral">"** and the plotting scripts are installed in either "</span> 
01585              &lt;&lt; _wupdir &lt;&lt; endl 
01586              &lt;&lt; <span class="stringliteral">"** or the directory specified by the WUPARAMDIR "</span>
01587              &lt;&lt; <span class="stringliteral">"environment variable"</span> &lt;&lt; endl
01588              &lt;&lt; endl;
01589     }
01590 
01591 
01592 }
01593 
01594 
01609 <span class="keywordtype">void</span> 
01610 Parameterizer::
01611 mapSkyBrightness( <span class="keyword">const</span> string &amp;id, <span class="keyword">const</span> vector&lt;Pedestal&gt; &amp;onpeds, 
01612                   <span class="keyword">const</span> vector&lt;Pedestal&gt; &amp;offpeds, <span class="keyword">const</span> Array_t &amp;gain,
01613                   <span class="keyword">const</span> RawHeaderRecord &amp;header, <span class="keywordtype">double</span> avg_gpstime,
01614                   <span class="keywordtype">bool</span> derotation, <a class="code" href="classCamera.html">Camera</a> *cam, <span class="keywordtype">int</span> telescope_id) {
01615     
01616     <span class="keyword">const</span> <span class="keywordtype">double</span> DEGPERPIX=0.1; <span class="comment">// degrees per pixel (assuming square pixels)</span>
01617     <span class="keyword">const</span> <span class="keywordtype">double</span> SIGR2 = 0.02;  <span class="comment">// something like the RMS^2 of the PSF</span>
01618     
01619     <a class="code" href="classImage2D.html">Image2D</a> brightmap(39,39);
01620     <a class="code" href="classImage2D.html">Image2D</a> tubeoffmap(39,39);
01621 
01622     Array_t xcoord, ycoord;
01623     Array_t pedvardiff;
01624     <a class="code" href="structCoordinate__t.html">Coordinate_t</a> coord;
01625     <span class="keywordtype">int</span> i,j,k;
01626     <span class="keywordtype">double</span> sky_brightness, tubeoffness;
01627     <span class="keywordtype">double</span> r2, gauss_weight;
01628     <span class="keywordtype">int</span> nxbins = brightmap.<a class="code" href="classImage2D.html#a21">getXDim</a>();
01629     <span class="keywordtype">int</span> nybins = brightmap.<a class="code" href="classImage2D.html#a22">getYDim</a>();
01630 
01631     <span class="comment">// calculate the correct derotation angle (theta)</span>
01632 
01633     updateAngles( avg_gpstime, header );
01634 
01635     <span class="comment">// precalculate the pedestal variance difference (yes, variances</span>
01636     <span class="comment">// not dispersions)</span>
01637 
01638     pedvardiff.resize(onpeds.size());
01639     <span class="keywordflow">for</span> (i=0; i&lt;onpeds.size(); i++) {
01640 
01641         <span class="keywordflow">if</span> ( (onpeds[i].type == Pedestal::TUBEOFF || 
01642               offpeds[i].type == Pedestal::TUBEOFF)
01643              ||
01644              (onpeds[i].type == Pedestal::STAR &amp;&amp; 
01645               offpeds[i].type == Pedestal::STAR)) {
01646 
01647             pedvardiff[i] = 0;
01648 
01649         }
01650         <span class="keywordflow">else</span> {
01651             pedvardiff[i] = pow(onpeds[i].dispersion,2) 
01652                 - pow(offpeds[i].dispersion,2);
01653         }       
01654 
01655     }
01656     
01657     <span class="comment">// Get the camera coordinates and derotate them into tangential coords!</span>
01658 
01659     xcoord.resize(cam-&gt;<a class="code" href="classCamera.html#a13">xCoords</a>().size());
01660     ycoord.resize(cam-&gt;<a class="code" href="classCamera.html#a14">yCoords</a>().size());
01661     xcoord = cam-&gt;<a class="code" href="classCamera.html#a13">xCoords</a>();
01662     ycoord = cam-&gt;<a class="code" href="classCamera.html#a14">yCoords</a>();
01663 
01664     <span class="keywordflow">if</span> (derotation == <span class="keyword">true</span>) {
01665         <span class="comment">// not sure this is right: </span>
01666         <span class="comment">// should we rotate by -theta instead?</span>
01667         <span class="keywordflow">for</span> (i=0; i&lt;(<span class="keywordtype">int</span>)xcoord.size(); i++) {
01668             coord.<a class="code" href="structCoordinate__t.html#o0">x</a> = xcoord[i];
01669             coord.<a class="code" href="structCoordinate__t.html#o1">y</a> = ycoord[i];
01670             derotatePoint( _theta, coord );
01671             xcoord[i] = coord.<a class="code" href="structCoordinate__t.html#o0">x</a>;
01672             ycoord[i] = coord.<a class="code" href="structCoordinate__t.html#o1">y</a>;
01673         }
01674     }
01675 
01676     <span class="comment">// Set up the coordinate grid:</span>
01677 
01678     brightmap.<a class="code" href="classImage2D.html#a1">setCoordinateBox</a>( -nxbins*DEGPERPIX/2.0,-nybins*DEGPERPIX/2.0,
01679                                 nxbins*DEGPERPIX/2.0,nybins*DEGPERPIX/2.0);
01680     tubeoffmap.<a class="code" href="classImage2D.html#a1">setCoordinateBox</a>( -nxbins*DEGPERPIX/2.0,-nybins*DEGPERPIX/2.0,
01681                                  nxbins*DEGPERPIX/2.0,nybins*DEGPERPIX/2.0);
01682     
01683     <span class="comment">// Accumulate the sky brightness and tubeoffness:</span>
01684 
01685     <span class="keywordflow">for</span> (i=0; i&lt;nxbins; i++) {
01686         <span class="keywordflow">for</span> (j=0; j&lt;nybins; j++) {
01687             
01688             sky_brightness = 0;
01689             tubeoffness = 0;
01690 
01691             <span class="keywordflow">for</span> (k=0; k&lt;(<span class="keywordtype">int</span>)xcoord.size(); k++) {
01692                         
01693                 <span class="comment">// tube is ON or contains a star in the ON</span>
01694                 <span class="comment">// run, or just good in the OFF, so update sky</span>
01695                 <span class="comment">// brightness map</span>
01696                 
01697                 r2 = (pow(xcoord[k] - brightmap.<a class="code" href="classImage2D.html#a2">getXCoord</a>(i),2) +
01698                       pow(ycoord[k] - brightmap.<a class="code" href="classImage2D.html#a3">getYCoord</a>(j),2));
01699                 gauss_weight = exp(-r2/SIGR2);
01700                 sky_brightness += pedvardiff[k]*gauss_weight
01701                     *pow(gain[k],2); <span class="comment">// flat field</span>
01702                 
01703                 
01704                 <span class="keywordflow">if</span> ((onpeds[k].type == Pedestal::TUBEOFF) ||
01705                     (offpeds[k].type == Pedestal::TUBEOFF) ||
01706                     (onpeds[k].type == Pedestal::STAR) || 
01707                     (offpeds[k].type == Pedestal::STAR)) {
01708 
01709                     <span class="comment">// tube is OFF, so update tubeoffness map</span>
01710                     r2 = (pow(xcoord[k] - tubeoffmap.<a class="code" href="classImage2D.html#a2">getXCoord</a>(i),2) +
01711                           pow(ycoord[k] - tubeoffmap.<a class="code" href="classImage2D.html#a3">getYCoord</a>(j),2));
01712                     gauss_weight = exp(-r2/SIGR2);
01713                     tubeoffness  += 1.0*gauss_weight;
01714 
01715                 }
01716                 
01717             }
01718                 
01719                 
01720             brightmap.<a class="code" href="classImage2D.html#a15">addToPixel</a>(i,j, sky_brightness);
01721             tubeoffmap.<a class="code" href="classImage2D.html#a15">addToPixel</a>( i,j, tubeoffness );
01722             
01723         }
01724     }
01725     
01726     <span class="comment">// save the maps...</span>
01727 
01728     <span class="keywordtype">char</span> telid[100];
01729     sprintf( telid, <span class="stringliteral">"-%03d"</span>, telescope_id );
01730 
01731     brightmap.<a class="code" href="classImage2D.html#a9">save</a>( id+<span class="stringliteral">"/"</span>+id+telid+<span class="stringliteral">"-sky_brightness"</span> );
01732     tubeoffmap.<a class="code" href="classImage2D.html#a9">save</a>( id+<span class="stringliteral">"/"</span>+id+telid+<span class="stringliteral">"-tubeoffness"</span> );
01733 
01734 }
01735 
01736 
01737 <span class="keywordtype">void</span>
01738 Parameterizer::
01739 setLatLonInRadians( <span class="keywordtype">double</span> lat, <span class="keywordtype">double</span> lon ) {
01740 
01741     _latitude = lat;
01742     _longitude = lon;
01743 
01744 }
01745 
01746 
01755 <span class="keywordtype">void</span>
01756 Parameterizer::
01757 updateAngles( <span class="keywordtype">double</span> gpstime, <span class="keyword">const</span> RawHeaderRecord &amp;header ) {
01758     
01759     <span class="keywordtype">double</span> hourangle;
01760     <span class="keywordtype">double</span> tmp1,tmp2;
01761     <span class="keywordtype">double</span> cosdec, sindec, sinlat, coslat, sinhr, coshr;
01762     <span class="keywordtype">double</span> sk,ck;
01763 
01764     <span class="keyword">const</span> <span class="keywordtype">double</span> TIME_TO_RADIANS = 2*M_PI/24.0;  
01765     <span class="keywordtype">double</span> tt, tt0;
01766     <span class="keywordtype">int</span> imjd = (<span class="keywordtype">int</span>)(gpstime);
01767     <span class="keywordtype">double</span> sidereal;
01768     <span class="keywordtype">double</span> uttime;
01769 
01770     <span class="comment">// interval of time measured in julian centuries elapsed since 1</span>
01771     <span class="comment">// Jan 2000 at 12h UT:</span>
01772     tt = (imjd - 51544.5)/36525.0;
01773 
01774     <span class="comment">// fractional time in hours since UT midnight:</span>
01775     <span class="comment">// Note: mjd is in units of DAYS</span>
01776     uttime = (gpstime-imjd) * 24.0; 
01777 
01778     tt0=6.697374558 + (2.400051336e3 * tt)+(2.5862e-5 *  tt*tt);
01779     sidereal = fmod( uttime * 1.002737909 + tt0 - 7.392333333, 24.0 );
01780     <span class="keywordflow">if</span> (sidereal &lt; 0.0) sidereal += 24.0;
01781     sidereal *= TIME_TO_RADIANS;
01782 
01783     <span class="comment">// the hour angle in radians</span>
01784 
01785     hourangle = sidereal - header.ra;
01786     
01787     <span class="comment">// precalculate some stuff for speed</span>
01788 
01789     sinlat = sin(_latitude);
01790     coslat = cos(_latitude);
01791     sindec = sin(header.dec);
01792     cosdec = cos(header.dec);
01793     sinhr  = sin(hourangle);
01794     coshr  = cos(hourangle);
01795 
01796     <span class="comment">// calculate the elevation</span>
01797     
01798     tmp1 = sindec*sinlat + cosdec*coslat*coshr;
01799     <span class="keywordflow">if</span> (tmp1 &gt; 1.0) tmp1 = 1.0;
01800     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tmp1 &lt; -1.0) tmp1 = -1.0;
01801     _el = asin(tmp1);
01802 
01803 <span class="comment">//     if (_el &lt; 0) {</span>
01804 <span class="comment">//      cout &lt;&lt; "DEBUG: Hey! elevation is negative: " &lt;&lt; _el &lt;&lt; endl;</span>
01805 <span class="comment">//      cout &lt;&lt; "\tgpstime = " &lt;&lt; gpstime &lt;&lt; endl;</span>
01806 <span class="comment">//     }</span>
01807 
01808     <span class="comment">// calculate azimuth</span>
01809 
01810     tmp1 = -cosdec*coslat*sinhr;
01811     tmp2 = sindec - sinlat*sin(_el);
01812     
01813     <span class="keywordflow">if</span> (tmp1&gt;1.0) tmp1=1.0;
01814     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tmp1&lt;-1.0) tmp1 = -1.0;
01815     <span class="keywordflow">if</span> (tmp2&gt;1.0) tmp2=1;
01816     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tmp2&lt;-1.0) tmp2 = -1.0;
01817     
01818     _az = atan2(tmp1,tmp2);
01819 
01820     <span class="comment">// get theta (derotation angle)</span>
01821     
01822     sk = -coslat*sin(_az);
01823     ck = cos(_el)*sinlat-sin(_el)*coslat*cos(_az);
01824 
01825     <span class="keywordflow">if</span> (sk &gt; 1.0) sk = 1.0;
01826     <span class="keywordflow">else</span> <span class="keywordflow">if</span>( sk&lt;-1.0) sk = -1.0;
01827     <span class="keywordflow">if</span> (ck &gt; 1.0) ck = 1.0;
01828     <span class="keywordflow">else</span> <span class="keywordflow">if</span>( ck&lt;-1.0) ck = -1.0;
01829     
01830     _theta = -atan2(sk,ck);
01831 
01832 <span class="comment">//     gsl_sf_angle_restrict_pos_e( &amp;_el );</span>
01833 <span class="comment">//     gsl_sf_angle_restrict_pos_e( &amp;_az );</span>
01834 
01835 }
01836 
01837 
01846 <span class="keywordtype">void</span>  
01847 Parameterizer::
01848 derotatePoint(<span class="keywordtype">double</span> theta, <a class="code" href="structCoordinate__t.html">Coordinate_t</a> &amp;point) {
01849 
01850     <span class="keywordtype">double</span> sintheta, costheta;
01851     <a class="code" href="structCoordinate__t.html">Coordinate_t</a> newpoint;
01852 
01853     sintheta = sin(theta);
01854     costheta = cos(theta);
01855 
01856     newpoint.<a class="code" href="structCoordinate__t.html#o0">x</a> = point.<a class="code" href="structCoordinate__t.html#o0">x</a>*costheta + point.<a class="code" href="structCoordinate__t.html#o1">y</a>*sintheta;
01857     newpoint.<a class="code" href="structCoordinate__t.html#o1">y</a> = -point.<a class="code" href="structCoordinate__t.html#o0">x</a>*sintheta + point.<a class="code" href="structCoordinate__t.html#o1">y</a>*costheta;
01858     
01859     point.<a class="code" href="structCoordinate__t.html#o0">x</a> = newpoint.<a class="code" href="structCoordinate__t.html#o0">x</a>;
01860     point.<a class="code" href="structCoordinate__t.html#o1">y</a> = newpoint.<a class="code" href="structCoordinate__t.html#o1">y</a>;
01861     
01862 }
01863 
01864 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Apr 21 10:22:45 2007 for wuparam by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
