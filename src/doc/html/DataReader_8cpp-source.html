<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>wuparam: DataReader.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>DataReader.cpp</h1><div class="fragment"><pre>00001 <span class="comment">// DataReader.cpp</span>
00002 <span class="comment">// Karl Kosack &lt;kosack@hbar.wustl.edu&gt;</span>
00003 
00004 <span class="preprocessor">#include &lt;iostream&gt;</span>
00005 <span class="preprocessor">#include &lt;string&gt;</span>
00006 <span class="preprocessor">#include &lt;iomanip&gt;</span>
00007 <span class="preprocessor">#include &lt;glob.h&gt;</span>
00008 <span class="preprocessor">#include &lt;sstream&gt;</span>
00009 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00010 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00011 <span class="preprocessor">#include &lt;hdf.h&gt;</span>
00012 
00013 <span class="preprocessor">#include "ProgressBar.h"</span>
00014 <span class="preprocessor">#include "DataReader.h"</span>
00015 <span class="preprocessor">#include "Exceptions.h"</span>
00016 <span class="preprocessor">#include "Config.h"</span>
00017 
00018 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00019 
00020 
00021 RawDataReader::
00022 RawDataReader( <span class="keyword">const</span> string &amp;filename ) : <a class="code" href="classDataReader.html">DataReader</a>(filename) {
00023     
00024 
00025 }
00026 
00027 RawDataReaderHDF4::
00028 RawDataReaderHDF4( <span class="keyword">const</span> string &amp;filename )  : <a class="code" href="classRawDataReader.html">RawDataReader</a>( filename ) {
00029 
00030     <span class="keywordtype">int</span> status;
00031 
00032     <span class="comment">// =================================================</span>
00033     <span class="comment">// Allocate memory and set defaults... </span>
00034     <span class="comment">// =================================================</span>
00035 
00036     _infobufsize = 
00037         2*<span class="keyword">sizeof</span>(int32) +
00038         3*<span class="keyword">sizeof</span>(float64) +
00039         80*<span class="keyword">sizeof</span>(char8);
00040 
00041     _infobuf = <span class="keyword">new</span> uint8[ _infobufsize ];
00042     _eventbufsize = -1;
00043     _is_header_initialized = <span class="keyword">false</span>;
00044     _is_event_initialized = <span class="keyword">false</span>;
00045     _is_file_done = <span class="keyword">false</span>;
00046 
00047     <span class="comment">// =================================================</span>
00048     <span class="comment">// open the HDF file</span>
00049     <span class="comment">// =================================================    </span>
00050 
00051     _hfileid = Hopen( getFilename().c_str(), DFACC_READ, 0 );
00052 
00053     <span class="keywordflow">if</span> (_hfileid == -1) {
00054         <span class="keywordflow">throw</span> <a class="code" href="classCriticalAnalysisException.html">CriticalAnalysisException</a>( <span class="stringliteral">"HDF Open Failed"</span> );
00055     }
00056 
00057     <span class="comment">// ==================================================</span>
00058     <span class="comment">// Attach to the required VDatas</span>
00059     <span class="comment">// ==================================================</span>
00060 
00061     status = Vstart( _hfileid );
00062 
00063     _eventref = VSfind( _hfileid, <span class="stringliteral">"10M Event"</span> );
00064     <span class="keywordflow">if</span>( _eventref &lt; 0 ) {
00065         <span class="keywordflow">throw</span> <a class="code" href="classCriticalAnalysisException.html">CriticalAnalysisException</a>(<span class="stringliteral">"Couldn't locate 10M Event Vdata in "</span>
00066                                         +getFilename());
00067     }
00068     
00069     _eventid = VSattach( _hfileid, _eventref, <span class="stringliteral">"r"</span>);
00070     <span class="keywordflow">if</span>( _eventid &lt; 0 ) {
00071         <span class="keywordflow">throw</span> <a class="code" href="classCriticalAnalysisException.html">CriticalAnalysisException</a>(<span class="stringliteral">"Couldn't find event in "</span>
00072                                         +getFilename());
00073     }
00074         
00075 
00076     _headerref = VSfind( _hfileid, <span class="stringliteral">"10M Run Information"</span> );
00077     _headerid  = VSattach( _hfileid, _headerref, <span class="stringliteral">"r"</span>);
00078     <span class="keywordflow">if</span>( _headerid &lt; 0 ) {
00079         <span class="keywordflow">throw</span> <a class="code" href="classCriticalAnalysisException.html">CriticalAnalysisException</a>(<span class="stringliteral">"Couldn't find run information in "</span>
00080                                         +getFilename());
00081     }
00082         
00083 
00084     
00085 }
00086 
00087 RawDataReaderHDF4::~RawDataReaderHDF4() {
00088 
00089     VSdetach( _headerid );
00090     VSdetach( _eventid );
00091     Hclose( _hfileid );
00092 
00093     <span class="keyword">delete</span> [] _infobuf;
00094     <span class="keyword">delete</span> [] _eventbuf;
00095     <span class="keyword">delete</span> [] _eventadc;
00096 
00097 }
00098 
00099 <span class="keywordtype">void</span>
00100 RawDataReaderHDF4::
00101 getHeaderRecord( RawHeaderRecord &amp;header ) {
00102 
00103     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> NFIELDS = 6;
00104     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> FIELDNAMES[128] = 
00105         <span class="stringliteral">"VERSION,NADC,UTC_START,SOURCE_NAME,SOURCE_RA,SOURCE_DEC"</span>;
00106     <span class="keywordtype">int</span> ret;
00107     VOIDP field[NFIELDS];
00108     <span class="keywordtype">char</span> sourcename[128];
00109     <span class="keywordtype">int</span> version;
00110 
00111     header.num_telescopes = 1; <span class="comment">// whipple data always has 1 telescope</span>
00112     header.nadc.resize(1);
00113     <span class="keywordtype">int</span> nadc;
00114         
00115     <span class="comment">// =================================================</span>
00116     <span class="comment">// Read the header information</span>
00117     <span class="comment">// =================================================</span>
00118 
00119     ret = VSsetfields( _headerid, FIELDNAMES );
00120     <span class="keywordflow">if</span> (ret == -1) {
00121         <span class="keywordflow">throw</span> <a class="code" href="classCriticalAnalysisException.html">CriticalAnalysisException</a>(<span class="stringliteral">"VSsetfields() failed"</span>);
00122     }
00123 
00124     ret = VSread( _headerid, _infobuf, 1, FULL_INTERLACE );
00125     <span class="keywordflow">if</span>(ret != 1){
00126         <span class="keywordflow">throw</span> <a class="code" href="classCriticalAnalysisException.html">CriticalAnalysisException</a>(<span class="stringliteral">"Couldn't read the run header record"</span>);
00127     }
00128 
00129     <span class="comment">// =================================================</span>
00130     <span class="comment">// Unpack the fields into the correct variables</span>
00131     <span class="comment">// =================================================</span>
00132 
00133     field[0] = &amp;version;
00134     field[1] = &amp;(nadc);
00135     field[2] = &amp;(header.starttime);
00136     field[3] = &amp;(sourcename[0]);
00137     field[4] = &amp;(header.ra);
00138     field[5] = &amp;(header.dec);
00139 
00140     VSfpack( _headerid, 
00141              _HDF_VSUNPACK, 
00142              FIELDNAMES, 
00143              _infobuf,
00144              _infobufsize,
00145              1, NULL,
00146              (VOIDP *)field);
00147 
00148     sourcename[80] = <span class="charliteral">'\0'</span>;
00149     header.sourcename = sourcename;
00150     header.nadc[0] = nadc;
00151     header.windowsize = 0;
00152 
00153    
00154     <span class="comment">// =================================================</span>
00155     <span class="comment">// Allocate memory for the event record if needed...</span>
00156     <span class="comment">// =================================================</span>
00157     <span class="keywordflow">if</span> (_is_header_initialized == <span class="keyword">false</span>) {
00158         <span class="keywordflow">try</span> {
00159             _eventbufsize = (nadc+3)*<span class="keyword">sizeof</span>(int16)+3*<span class="keyword">sizeof</span>(float64);
00160             _eventbuf = <span class="keyword">new</span> uint8[_eventbufsize];
00161             _eventadc = <span class="keyword">new</span> <span class="keywordtype">short</span>[ nadc ];
00162             _nadc = nadc;
00163         }
00164         <span class="keywordflow">catch</span>(bad_alloc e) {
00165             <span class="keywordflow">throw</span> <a class="code" href="classCriticalAnalysisException.html">CriticalAnalysisException</a>( <span class="stringliteral">"Memory allocation failed: event buffer"</span>);
00166         }
00167 
00168         _is_header_initialized = <span class="keyword">true</span>;
00169 
00170     }
00171 
00172 }
00173 
00177 <span class="keywordtype">int</span>
00178 <a class="code" href="classRawDataReaderHDF4.html#a4">RawDataReaderHDF4::</a>
<a name="l00179"></a><a class="code" href="classRawDataReaderHDF4.html#a4">00179</a> <a class="code" href="classRawDataReaderHDF4.html#a4">size</a>() {
00180 
00181     <span class="keywordflow">return</span> VSelts( _eventid );
00182 
00183 }
00184 
00185 
00186 <span class="keywordtype">void</span>
00187 RawDataReaderHDF4::
00188 getNextEventRecord( <a class="code" href="structRawEventRecord.html">RawEventRecord</a> &amp;event ) {
00189 
00190     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> FIELDNAMES[128] =
00191         <span class="stringliteral">"CODE,GPSTIME,OSCTIME,LIVETIME,ADC,ELEVATION,AZIMUTH"</span>;
00192     <span class="keywordtype">int</span> ret=0;
00193     <span class="keywordtype">short</span> code;
00194     VOIDP field[7];
00195 
00196     <span class="keywordflow">if</span> (_is_file_done == <span class="keyword">true</span> ) {
00197         <span class="keywordflow">throw</span> <a class="code" href="classEOFException.html">EOFException</a>( <span class="stringliteral">"no more events"</span> );
00198     }
00199 
00200     <span class="comment">// =================================================</span>
00201     <span class="comment">// If not initialized, fetch the header to determine</span>
00202     <span class="comment">// buffer sizes (and allocate memory).  Then </span>
00203     <span class="comment">// set up to read from the event vdata...</span>
00204     <span class="comment">// =================================================</span>
00205     
00206     <span class="keywordflow">if</span> ( _is_header_initialized == <span class="keyword">false</span>  ) {
00207         
00208         RawHeaderRecord header;
00209         getHeaderRecord( header );
00210         
00211     }
00212     
00213     <span class="keywordflow">if</span> ( _is_event_initialized == <span class="keyword">false</span> ) {
00214 
00215 
00216         ret = VSsetfields( _eventid, FIELDNAMES );
00217         <span class="keywordflow">if</span> (ret == -1) {
00218             <span class="keywordflow">throw</span> <a class="code" href="classCriticalAnalysisException.html">CriticalAnalysisException</a>(<span class="stringliteral">"VSsetfields() failed"</span>);
00219         }
00220 
00221         _is_event_initialized = <span class="keyword">true</span>;
00222         
00223     }
00224 
00225 
00226     <span class="comment">// =================================================</span>
00227     <span class="comment">// Read an event record from the file...</span>
00228     <span class="comment">// =================================================</span>
00229 
00230     ret = VSread( _eventid, _eventbuf, 1, FULL_INTERLACE );
00231     <span class="keywordflow">if</span>(ret != 1){
00232         _is_file_done = <span class="keyword">true</span>;
00233     }
00234 
00235     <span class="comment">// =================================================</span>
00236     <span class="comment">// Unpack the data and put it into the record object</span>
00237     <span class="comment">// =================================================</span>
00238     
00239     field[0] = &amp;(code);
00240     field[1] = &amp;(event.<a class="code" href="structRawEventRecord.html#o1">gpstime</a>);
00241     field[2] = &amp;(event.<a class="code" href="structRawEventRecord.html#o2">osctime</a>);
00242     field[3] = &amp;(event.<a class="code" href="structRawEventRecord.html#o3">livetime</a>);
00243     field[4] = &amp;(_eventadc[0]);
00244     field[5] = &amp;(event.<a class="code" href="structRawEventRecord.html#o4">elevation</a>);
00245     field[6] = &amp;(event.<a class="code" href="structRawEventRecord.html#o5">azimuth</a>);
00246 
00247     VSfpack( _eventid, 
00248              _HDF_VSUNPACK, 
00249              <span class="stringliteral">"CODE,GPSTIME,OSCTIME,LIVETIME,ADC,ELEVATION,AZIMUTH"</span>, 
00250              _eventbuf,
00251              _eventbufsize,
00252              1, NULL,
00253              (VOIDP *)field);
00254 
00255     <span class="comment">// convert the adc counts to doubles: eventually gains will be</span>
00256     <span class="comment">// applied, so we want floating point</span>
00257     <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)event.<a class="code" href="structRawEventRecord.html#o7">adc</a>.size() != _nadc)  event.<a class="code" href="structRawEventRecord.html#o7">adc</a>.resize( _nadc );
00258     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i=0; i&lt;_nadc; i++ ) {
00259         event.<a class="code" href="structRawEventRecord.html#o7">adc</a>[i] =  (<span class="keywordtype">double</span>) _eventadc[i];
00260     }
00261 
00262 
00263     <span class="comment">// Check this! </span>
00264     <span class="keywordflow">if</span> (code &amp; 0x4) {
00265         event.<a class="code" href="structRawEventRecord.html#o0">type</a> = RawDataReader::EVENT;
00266     }
00267     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (code &amp; 0x1) {
00268         event.<a class="code" href="structRawEventRecord.html#o0">type</a> = RawDataReader::PEDESTAL;
00269     }
00270     <span class="keywordflow">else</span> {
00271         event.<a class="code" href="structRawEventRecord.html#o0">type</a> = RawDataReader::UNKNOWN;
00272     }
00273 
00274     event.<a class="code" href="structRawEventRecord.html#o6">telescope_id</a> = 0;
00275 
00276 
00277 }
00278 
00279 
00280 string
00281 RawDataReaderHDF4::
00282 getTypeString() { 
00283     
00284     uint32 maj,min,rel;
00285     <span class="keywordtype">char</span> str[100];
00286 
00287     Hgetfileversion( _hfileid, &amp;maj,&amp;min,&amp;rel,str );
00288 
00289     string s((<span class="keyword">const</span> <span class="keywordtype">char</span> *)str);
00290     <span class="keywordflow">return</span> s;
00291 }
00292 
<a name="l00297"></a><a class="code" href="classRawDataReaderSim.html#a0">00297</a> <a class="code" href="classRawDataReaderSim.html#a0">RawDataReaderSim::RawDataReaderSim</a>( <span class="keyword">const</span> string &amp;filename ) 
00298     : <a class="code" href="classRawDataReader.html">RawDataReader</a>( filename ), _is_file_done(false), 
00299       _count(0), _nadc(490), _faketime(0)
00300 {
00301 
00302     _infile.open( filename.c_str() );
00303 
00304     <span class="keywordflow">if</span> (!_infile || _infile.fail()) {
00305         <span class="keywordflow">throw</span> <a class="code" href="classCriticalAnalysisException.html">CriticalAnalysisException</a>(<span class="stringliteral">"Open failed for "</span>+filename);
00306     }
00307     
00308 }
00309 
00310 RawDataReaderSim::~RawDataReaderSim() {
00311     
00312     _infile.close();
00313     
00314 }
00315 
00316 
00320 <span class="keywordtype">int</span>
<a name="l00321"></a><a class="code" href="classRawDataReaderSim.html#a4">00321</a> <a class="code" href="classRawDataReaderSim.html#a4">RawDataReaderSim::size</a>() {
00322     
00323     ifstream infile( getFilename().c_str() );
00324     string line;
00325     <span class="keywordtype">int</span> count=0;
00326 
00327     <span class="keywordflow">while</span> ( !infile.eof() &amp;&amp; getline( infile, line, <span class="charliteral">'\n'</span>) ){
00328         <span class="keywordflow">if</span> (line[0] == <span class="charliteral">'Z'</span> || line[0] == <span class="charliteral">'Q'</span>)
00329             count++;
00330     }
00331 
00332     infile.close();
00333 
00334     <span class="keywordflow">return</span> count;
00335 
00336 }
00337 
00342 <span class="keywordtype">void</span>
00343 <a class="code" href="classRawDataReaderSim.html#a2">RawDataReaderSim::</a>
<a name="l00344"></a><a class="code" href="classRawDataReaderSim.html#a2">00344</a> <a class="code" href="classRawDataReaderSim.html#a2">getHeaderRecord</a>( RawHeaderRecord &amp;header ) {
00345 
00346     header.nadc.resize(1);
00347     header.nadc[0] = 490;
00348     header.sourcename = <span class="stringliteral">"Simulation Data"</span>;
00349     header.starttime = 0;
00350     header.ra = 0.0;
00351     header.dec = 0.0;
00352     
00353 
00354 }
00355 
00359 <span class="keywordtype">void</span>
00360 <a class="code" href="classRawDataReaderSim.html#a3">RawDataReaderSim::</a>
<a name="l00361"></a><a class="code" href="classRawDataReaderSim.html#a3">00361</a> <a class="code" href="classRawDataReaderSim.html#a3">getNextEventRecord</a>( <a class="code" href="structRawEventRecord.html">RawEventRecord</a> &amp;event ) {
00362 
00363     string line, temp;
00364 
00365     <span class="keywordflow">if</span> (event.<a class="code" href="structRawEventRecord.html#o7">adc</a>.size() != _nadc);
00366         event.<a class="code" href="structRawEventRecord.html#o7">adc</a>.resize(_nadc);
00367 
00368     <span class="keywordflow">while</span> (!_infile.eof() &amp;&amp; getline( _infile, line, <span class="charliteral">'\n'</span>)) {
00369 
00370         <span class="keywordflow">if</span> ( line[0] == <span class="charliteral">'S'</span> ) {
00371             <span class="comment">// Process a shower record Only shower records which</span>
00372             <span class="comment">// precede a 'Q' record are ones that actually triggered</span>
00373             <span class="comment">// the telescope, so others can be ignored.</span>
00374             
00375             istringstream ist( line );
00376             ist &gt;&gt; temp  <span class="comment">// the 'S'</span>
00377                 &gt;&gt; _curshower.event_number
00378                 &gt;&gt; _curshower.primary_type
00379                 &gt;&gt; _curshower.primary_energy
00380                 &gt;&gt; _curshower.impact_parameter.x
00381                 &gt;&gt; _curshower.impact_parameter.y
00382                 &gt;&gt; _curshower.direction_cos.x
00383                 &gt;&gt; _curshower.direction_cos.y;
00384 
00385         }
00386 
00387         <span class="keywordflow">if</span> ( line[0] == <span class="charliteral">'Z'</span> || line[0] ==<span class="charliteral">'Q'</span> ) {
00388             <span class="comment">// Process a pedestal (Z) or actual event (Q)</span>
00389             
00390             <span class="keywordflow">if</span> (line[0] == <span class="charliteral">'Z'</span>) event.<a class="code" href="structRawEventRecord.html#o0">type</a> = RawDataReader::PEDESTAL;
00391             <span class="keywordflow">else</span> event.<a class="code" href="structRawEventRecord.html#o0">type</a> = RawDataReader::EVENT;
00392             
00393             istringstream ist( line );
00394             ist &gt;&gt; temp <span class="comment">// record type</span>
00395                 &gt;&gt; temp <span class="comment">// placeholder</span>
00396                 &gt;&gt; event.<a class="code" href="structRawEventRecord.html#o6">telescope_id</a>; <span class="comment">// telescope number </span>
00397             
00398             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;_nadc; i++) {
00399                 <span class="keywordflow">if</span> (!(ist &gt;&gt; event.<a class="code" href="structRawEventRecord.html#o7">adc</a>[i])) 
00400                     <span class="keywordflow">throw</span> <a class="code" href="classCriticalAnalysisException.html">CriticalAnalysisException</a>(<span class="stringliteral">"Not enough PMTS in data"</span>);
00401             }
00402 
00403             event.<a class="code" href="structRawEventRecord.html#o1">gpstime</a> = _faketime;
00404             event.<a class="code" href="structRawEventRecord.html#o2">osctime</a> = _faketime;
00405             event.<a class="code" href="structRawEventRecord.html#o3">livetime</a> =_faketime;
00406             _faketime += 1e-6;
00407             event.<a class="code" href="structRawEventRecord.html#o4">elevation</a> = 0;
00408             event.<a class="code" href="structRawEventRecord.html#o5">azimuth</a> = 0;
00409 
00410             <span class="comment">// found event, so stop looking</span>
00411             <span class="keywordflow">return</span>;
00412 
00413         }
00414 
00415     }
00416 
00417     <span class="comment">// if we got here, then the file is done</span>
00418     _is_file_done = <span class="keyword">true</span>;
00419     <span class="keywordflow">return</span>;
00420 
00421 }
00422 
00423 
00424 
00425 
00426 <span class="comment">//========================================================================</span>
00427 
00428 
00432 <span class="keywordtype">int</span>
<a name="l00433"></a><a class="code" href="classRawDataReaderVText.html#a4">00433</a> <a class="code" href="classRawDataReaderVText.html#a4">RawDataReaderVText::size</a>() {
00434 
00435 
00436     RawHeaderRecord header;
00437     <a class="code" href="classRawDataReaderVText.html#a2">getHeaderRecord</a>( header );
00438 
00439     <span class="keywordflow">if</span> (_nevents != -1) {
00440 
00441         <span class="keywordflow">return</span> _nevents;
00442     }
00443     
00444     cout &lt;&lt; <span class="stringliteral">"RawDataReaderVText: size of file not found in header, calculating it"</span>&lt;&lt;endl
00445          &lt;&lt; <span class="stringliteral">"                    with brute force method! (please wait)"</span>&lt;&lt; endl;
00446 
00447     <a class="code" href="classProgressBar.html">ProgressBar</a> progress( 0, <span class="stringliteral">"CalcSize"</span> );
00448 
00449     ifstream infile( getFilename().c_str() );
00450     string line;
00451     <span class="keywordtype">int</span> count=0;
00452     <span class="keywordtype">int</span> pcount=0;
00453 
00454     <span class="keywordflow">while</span> ( !infile.eof() &amp;&amp; getline( infile, line, <span class="charliteral">'\n'</span>) ){
00455         <span class="keywordflow">if</span> (line[0] == <span class="charliteral">'v'</span> || line[0] == <span class="charliteral">'p'</span>)
00456             count++;
00457         <span class="keywordflow">if</span> (pcount++ &gt;= 2048) {pcount=0; progress.<a class="code" href="classProgressBar.html#a2">print</a>(1);}
00458         
00459     }
00460 
00461     infile.close();
00462     progress.<a class="code" href="classProgressBar.html#a3">printClear</a>();
00463 
00464     _nevents = count;
00465 
00466     cout &lt;&lt; <span class="stringliteral">"RawDataReaderVText: size = "</span>&lt;&lt; _nevents &lt;&lt; endl;
00467 
00468     <span class="keywordflow">return</span> count;
00469 
00470 }
00471 
00472 
<a name="l00476"></a><a class="code" href="classRawDataReaderVText.html#a0">00476</a> <a class="code" href="classRawDataReaderVText.html#a0">RawDataReaderVText::RawDataReaderVText</a>( <span class="keyword">const</span> string &amp;filename ) 
00477     : <a class="code" href="classRawDataReader.html">RawDataReader</a>( filename ), _is_file_done(false), _count(0), _nadc(500),_nevents(-1)
00478 {
00479     _infile.open( filename.c_str() );
00480 
00481     <span class="keywordflow">if</span> ( !_infile || _infile.fail()) {
00482         <span class="keywordflow">throw</span> <a class="code" href="classCriticalAnalysisException.html">CriticalAnalysisException</a>(<span class="stringliteral">"Open failed for "</span>+filename);
00483     }
00484 
00485 }
00486 
00487 RawDataReaderVText::~RawDataReaderVText() {
00488     _infile.close();
00489 }
00490 
00495 <span class="keywordtype">void</span>
00496 <a class="code" href="classRawDataReaderVText.html#a2">RawDataReaderVText::</a>
<a name="l00497"></a><a class="code" href="classRawDataReaderVText.html#a2">00497</a> <a class="code" href="classRawDataReaderVText.html#a2">getHeaderRecord</a>( RawHeaderRecord &amp;header ) {
00498     
00499     string line;
00500     vector&lt;string&gt; tokens;
00501     <span class="keywordtype">bool</span> foundheader=<span class="keyword">false</span>;
00502     <span class="keywordtype">int</span> count=0;
00503 
00504     ifstream infile( getFilename().c_str() );
00505 
00506     <span class="keywordflow">if</span> (!infile) {
00507         <span class="keywordflow">throw</span> <a class="code" href="classCriticalAnalysisException.html">CriticalAnalysisException</a>(<span class="stringliteral">"Open failed for "</span>+getFilename());
00508     }
00509 
00510 
00511     <span class="comment">//cout &lt;&lt; "DEBUG: RawDataReaderVText: searching for header record..."</span>
00512     <span class="comment">//   &lt;&lt; endl;</span>
00513 
00514     header.num_telescopes = 1;
00515     header.nadc.resize(header.num_telescopes);
00516 
00517     
00518     <span class="keywordflow">while</span> (!infile.eof() &amp;&amp; getline( infile, line, <span class="charliteral">'\n'</span>)) {
00519 
00520         count++;
00521 
00522         <span class="keywordflow">if</span>  (count &gt; 100) <span class="keywordflow">break</span>; <span class="comment">// bail out early - header shuld be near top!</span>
00523 
00524         tokenize( line, tokens, <span class="stringliteral">"\t "</span> );
00525 
00526         <span class="keywordflow">if</span> (tokens[0] == <span class="stringliteral">"h"</span>) {
00527 
00528             <span class="keywordflow">if</span> (tokens.size() &lt;= 5) {
00529                 infile.close();
00530                 <span class="keywordflow">throw</span> <a class="code" href="classCriticalAnalysisException.html">CriticalAnalysisException</a>(<span class="stringliteral">"Bad header "</span>+getFilename());
00531             }
00532 
00533             <span class="comment">// found the header</span>
00534             <span class="comment">// TODO: make this work for multi-telescope data</span>
00535             header.nadc[0] = atoi(tokens[1].c_str());
00536             _nadc = header.nadc[0]; <span class="comment">// TODO: make this the maximum of all nadc</span>
00537             header.starttime = atof(tokens[2].c_str());     
00538             header.sourcename = tokens[3];
00539             header.ra = atof(tokens[4].c_str());            
00540             header.dec = atof(tokens[5].c_str());           
00541 
00542             <span class="keywordflow">if</span> (tokens.size() &gt;= 7) {
00543                 _nevents = atoi(tokens[6].c_str());
00544             }
00545             foundheader=<span class="keyword">true</span>;
00546             header.windowsize = atoi(tokens[7].c_str());
00547             <span class="keywordflow">break</span>;
00548 
00549         }
00550 
00551     }
00552 
00553     infile.close();
00554 
00555     <span class="keywordflow">if</span> (foundheader==<span class="keyword">false</span>) {
00556         <span class="keywordflow">throw</span> <a class="code" href="classCriticalAnalysisException.html">CriticalAnalysisException</a>(<span class="stringliteral">"Couldn't find the header 'h'"</span>
00557                                         <span class="stringliteral">"record in "</span>
00558                                         +getFilename());
00559     }
00560 
00561 }
00562 
00569 <span class="keywordtype">void</span>
00570 <a class="code" href="classRawDataReaderVText.html#a3">RawDataReaderVText::</a>
<a name="l00571"></a><a class="code" href="classRawDataReaderVText.html#a3">00571</a> <a class="code" href="classRawDataReaderVText.html#a3">getNextEventRecord</a>( <a class="code" href="structRawEventRecord.html">RawEventRecord</a> &amp;event ) {
00572 
00573     string line, temp;
00574     <span class="keywordtype">int</span> nsamp;
00575 
00576     <span class="keywordflow">if</span> (_is_file_done == <span class="keyword">true</span>) 
00577         <span class="keywordflow">throw</span> <a class="code" href="classMildAnalysisException.html">MildAnalysisException</a>(<span class="stringliteral">"There are no more events!"</span>);
00578 
00579 
00580     <span class="keywordflow">while</span> (!_infile.eof() &amp;&amp; getline( _infile, line, <span class="charliteral">'\n'</span>)) {
00581 
00582 
00583         <span class="keywordflow">if</span> (line.size() == 0 ) <span class="keywordflow">continue</span>;
00584 
00585         <span class="comment">// --------------------------------------</span>
00586         <span class="comment">// Process veritas event</span>
00587         <span class="comment">// --------------------------------------</span>
00588         <span class="keywordflow">if</span> ( line[0] == <span class="charliteral">'v'</span> || line[0] == <span class="charliteral">'p'</span>) {
00589 
00590             _count++;
00591             
00592             <span class="keywordflow">if</span> (line[0] == <span class="charliteral">'v'</span>) event.<a class="code" href="structRawEventRecord.html#o0">type</a>=RawDataReader::EVENT;
00593             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (line[0] == <span class="charliteral">'p'</span>) event.<a class="code" href="structRawEventRecord.html#o0">type</a>=RawDataReader::PEDESTAL;
00594 
00595             istringstream ist(line);
00596 
00597 
00598             ist &gt;&gt; temp; <span class="comment">// type    </span>
00599             ist &gt;&gt; temp; <span class="comment">// event number</span>
00600             ist &gt;&gt; event.<a class="code" href="structRawEventRecord.html#o1">gpstime</a>
00601                 &gt;&gt; event.<a class="code" href="structRawEventRecord.html#o2">osctime</a>
00602                 &gt;&gt; event.<a class="code" href="structRawEventRecord.html#o3">livetime</a> 
00603                 &gt;&gt; temp <span class="comment">//event.elevation is a short</span>
00604                 &gt;&gt; temp <span class="comment">//event.azimuth  is a short</span>
00605                 &gt;&gt; event.<a class="code" href="structRawEventRecord.html#o6">telescope_id</a>;
00606             ist &gt;&gt; nsamp; <span class="comment">// num samples;</span>
00607                 
00608             <span class="keywordflow">if</span> (event.<a class="code" href="structRawEventRecord.html#o7">adc</a>.size() != _nadc);
00609             event.<a class="code" href="structRawEventRecord.html#o7">adc</a>.resize(_nadc);
00610 
00611             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt; _nadc; i++) {
00612                 ist &gt;&gt; event.<a class="code" href="structRawEventRecord.html#o7">adc</a>[i]; 
00613             }
00614                  
00615             <span class="comment">// found event, so stop looking</span>
00616             <span class="keywordflow">return</span>;
00617    
00618         }
00619         <span class="keywordflow">else</span> {
00620             cout &lt;&lt; <span class="stringliteral">"Skipping unknown event at line "</span> &lt;&lt;_count
00621                  &lt;&lt; <span class="stringliteral">" of "</span>&lt;&lt; getFilename()&lt;&lt;endl;
00622         }
00623 
00624     }
00625 
00626     <span class="comment">// if we got here, then the file is done</span>
00627     _is_file_done = <span class="keyword">true</span>;
00628     <span class="keywordflow">return</span>;
00629 
00630 }
00631 
00632 
00633 
00634 <span class="comment">//========================================================================</span>
00635 
00639 ostream &amp;operator&lt;&lt;( ostream &amp;stream, RawHeaderRecord &amp;record ) {
00640 
00641     stream &lt;&lt;<span class="stringliteral">"NTEL: "</span>&lt;&lt; setw(5) &lt;&lt; record.num_telescopes &lt;&lt; <span class="stringliteral">" "</span>;
00642     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;record.num_telescopes; i++) {
00643         cout   &lt;&lt;<span class="stringliteral">"N"</span>&lt;&lt;i&lt;&lt;<span class="stringliteral">":   "</span>&lt;&lt; setw(5) &lt;&lt; record.nadc[i] &lt;&lt; <span class="stringliteral">" "</span>;
00644     }
00645     cout    &lt;&lt;<span class="stringliteral">"RA:  "</span>&lt;&lt; setw(12) &lt;&lt; record.ra &lt;&lt; <span class="stringliteral">" "</span>
00646             &lt;&lt;<span class="stringliteral">"DEC: "</span>&lt;&lt; setw(12) &lt;&lt; record.dec &lt;&lt; <span class="stringliteral">" "</span>
00647             &lt;&lt;<span class="stringliteral">"STT: "</span>&lt;&lt; setw(12) &lt;&lt; record.starttime &lt;&lt; <span class="stringliteral">" "</span>
00648             &lt;&lt;<span class="stringliteral">"SRC: "</span>&lt;&lt; record.sourcename &lt;&lt; <span class="stringliteral">" "</span>;
00649 
00650     <span class="keywordflow">return</span> stream;
00651 
00652 }
00653 
00657 ostream &amp;operator&lt;&lt;( ostream &amp;stream, <a class="code" href="structRawEventRecord.html">RawEventRecord</a> &amp;record ) {
00658 
00659     stream &lt;&lt;<span class="stringliteral">"typ: "</span> &lt;&lt; setw(5)  &lt;&lt; record.<a class="code" href="structRawEventRecord.html#o0">type</a> &lt;&lt; <span class="stringliteral">" "</span>
00660            &lt;&lt;<span class="stringliteral">"gps: "</span> &lt;&lt; setw(12) &lt;&lt; record.<a class="code" href="structRawEventRecord.html#o1">gpstime</a> &lt;&lt; <span class="stringliteral">" "</span>
00661            &lt;&lt;<span class="stringliteral">"osc: "</span> &lt;&lt; setw(12) &lt;&lt; record.<a class="code" href="structRawEventRecord.html#o2">osctime</a> &lt;&lt; <span class="stringliteral">" "</span>
00662            &lt;&lt;<span class="stringliteral">"liv: "</span> &lt;&lt; setw(12) &lt;&lt; record.<a class="code" href="structRawEventRecord.html#o3">livetime</a>&lt;&lt; <span class="stringliteral">" "</span>
00663            &lt;&lt;<span class="stringliteral">"ele: "</span> &lt;&lt; setw(6)  &lt;&lt; record.<a class="code" href="structRawEventRecord.html#o4">elevation</a>&lt;&lt; <span class="stringliteral">" "</span>
00664            &lt;&lt;<span class="stringliteral">"azi: "</span> &lt;&lt; setw(6)  &lt;&lt; record.<a class="code" href="structRawEventRecord.html#o5">azimuth</a> &lt;&lt; <span class="stringliteral">" "</span>
00665            &lt;&lt;<span class="stringliteral">"tel: "</span> &lt;&lt; setw(6)  &lt;&lt; (<span class="keywordtype">int</span>)record.<a class="code" href="structRawEventRecord.html#o6">telescope_id</a>&lt;&lt;<span class="stringliteral">" "</span>;
00666        
00667     <span class="keywordflow">return</span> stream;
00668 
00669 }
00670 
00671 
00672 <a class="code" href="classRawDataReaderFactory.html">RawDataReaderFactory</a>* RawDataReaderFactory::pinstance = NULL;
00673 
00677 <a class="code" href="classRawDataReaderFactory.html">RawDataReaderFactory</a>* 
00678 <a class="code" href="classRawDataReaderFactory.html#e0">RawDataReaderFactory::</a>
<a name="l00679"></a><a class="code" href="classRawDataReaderFactory.html#e0">00679</a> <a class="code" href="classRawDataReaderFactory.html#e0">instance</a>() {
00680 
00681     <span class="keywordflow">if</span> (pinstance == NULL)
00682         pinstance = <span class="keyword">new</span> <a class="code" href="classRawDataReaderFactory.html">RawDataReaderFactory</a>();
00683     
00684     <span class="keywordflow">return</span> pinstance;
00685 
00686 }
00687 
00688 RawDataReaderFactory::
00689 RawDataReaderFactory() {
00690 
00691 
00692 }
00693 
00694 
00698 <a class="code" href="classRawDataReader.html">RawDataReader</a>*
00699 <a class="code" href="classRawDataReaderFactory.html#a0">RawDataReaderFactory::</a>
<a name="l00700"></a><a class="code" href="classRawDataReaderFactory.html#a0">00700</a> <a class="code" href="classRawDataReaderFactory.html#a0">getReader</a>( <span class="keyword">const</span> <a class="code" href="classRunInfo.html">RunInfo</a> &amp;ri, string runid ) {
00701 
00702     string filename;
00703     <span class="keywordtype">int</span> type=RawDataReader::OTHER;
00704     <a class="code" href="classRawDataReader.html">RawDataReader</a> *rawdatareader;
00705 
00706     <span class="comment">// first look for an HDF4 File:</span>
00707 
00708     filename = <a class="code" href="classRawDataReaderFactory.html#a1">locateFile</a>( ri, runid, <span class="stringliteral">"hdf"</span> );
00709 
00710     <span class="keywordflow">if</span> (filename == <span class="stringliteral">""</span>) {
00711 
00712         <span class="comment">// Try to find a vtext file:</span>
00713         filename = <a class="code" href="classRawDataReaderFactory.html#a1">locateFile</a>( ri, runid, <span class="stringliteral">"vtext"</span>);
00714         <span class="keywordflow">if</span> (filename == <span class="stringliteral">""</span>) {
00715         
00716             <span class="comment">// Try to find a simulation file</span>
00717             filename = <a class="code" href="classRawDataReaderFactory.html#a1">locateFile</a>( ri, runid, <span class="stringliteral">"rec"</span> );
00718             <span class="keywordflow">if</span> (filename ==<span class="stringliteral">""</span>) {
00719                 
00720                 <span class="comment">// bail out!</span>
00721                 <span class="keywordflow">throw</span> <a class="code" href="classCriticalAnalysisException.html">CriticalAnalysisException</a>(<span class="stringliteral">"No file with id "</span>+runid
00722                                                 + <span class="stringliteral">" could be found under "</span>
00723                                                 + ri.<a class="code" href="classRunInfo.html#o1">datadir</a> );
00724             }
00725             <span class="keywordflow">else</span> {
00726                 type = RawDataReader::SIM;
00727             }
00728         }
00729         <span class="keywordflow">else</span> {
00730             type = RawDataReader::VTEXT;
00731         }
00732     }
00733     <span class="keywordflow">else</span> {
00734         type = RawDataReader::HDF4;
00735     }
00736 
00737     
00738     <span class="keywordflow">switch</span> (type) {
00739 
00740     <span class="keywordflow">case</span> RawDataReader::HDF4:
00741         rawdatareader = <span class="keyword">new</span> <a class="code" href="classRawDataReaderHDF4.html">RawDataReaderHDF4</a>(filename);
00742         <span class="keywordflow">break</span>;
00743         
00744     <span class="keywordflow">case</span> RawDataReader::SIM:
00745         rawdatareader = <span class="keyword">new</span> <a class="code" href="classRawDataReaderSim.html">RawDataReaderSim</a>(filename);
00746         <span class="keywordflow">break</span>;
00747 
00748     <span class="keywordflow">case</span> RawDataReader::VTEXT:
00749         rawdatareader = <span class="keyword">new</span> <a class="code" href="classRawDataReaderVText.html">RawDataReaderVText</a>(filename);
00750         <span class="keywordflow">break</span>;
00751 
00752     <span class="keywordflow">default</span>:
00753         <span class="keywordflow">throw</span>(<a class="code" href="classCriticalAnalysisException.html">CriticalAnalysisException</a>(<span class="stringliteral">"Unknown run data type for "</span>+runid));
00754         <span class="keywordflow">break</span>;
00755     }
00756     
00757     <span class="keywordflow">return</span> rawdatareader;
00758 
00759 }
00760 
00761 
00771 string 
00772 <a class="code" href="classRawDataReaderFactory.html#a1">RawDataReaderFactory::</a>
<a name="l00773"></a><a class="code" href="classRawDataReaderFactory.html#a1">00773</a> <a class="code" href="classRawDataReaderFactory.html#a1">locateFile</a>( <span class="keyword">const</span> <a class="code" href="classRunInfo.html">RunInfo</a> &amp;ri, <span class="keyword">const</span> string basename, <span class="keyword">const</span> string ext ) {
00774     
00775     glob_t globbuf;
00776     string pattern;
00777 
00778     <span class="comment">// Check in cache directory first:</span>
00779     pattern = ri.<a class="code" href="classRunInfo.html#o2">cachedir</a> + basename +<span class="stringliteral">"."</span>+ext;
00780     glob(pattern.c_str(), 0, NULL, &amp;globbuf);
00781 
00782     <span class="keywordflow">if</span> (globbuf.gl_pathc &gt; 0)  
00783         <span class="keywordflow">return</span> string(globbuf.gl_pathv[0]);
00784 
00785     <span class="comment">// Next, look in DataDir for the original, uncompressed file...</span>
00786 
00787     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i=0; i&lt;5; i++ ) {
00788         pattern = ri.<a class="code" href="classRunInfo.html#o1">datadir</a>;
00789         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;i; j++) {
00790             pattern += <span class="stringliteral">"*/"</span>;
00791         }
00792         pattern += basename + <span class="stringliteral">"."</span> + ext;
00793         glob(pattern.c_str(), GLOB_APPEND, NULL, &amp;globbuf);
00794 
00795         <span class="keywordflow">if</span> (globbuf.gl_pathc &gt; 0) {
00796             <span class="keywordflow">return</span> string(globbuf.gl_pathv[0]);
00797         }
00798     }
00799 
00800     <span class="comment">// If we've got this far, then no file has been located. Check for</span>
00801     <span class="comment">// a compressed version...</span>
00802 
00803     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i=0; i&lt;5; i++ ) {
00804         pattern = ri.<a class="code" href="classRunInfo.html#o1">datadir</a>;
00805         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;i; j++) {
00806             pattern += <span class="stringliteral">"*/"</span>;
00807         }
00808         pattern += basename + <span class="stringliteral">"."</span> + ext+<span class="stringliteral">".bz2"</span>;
00809         <span class="keywordflow">if</span> (i==0) 
00810             glob(pattern.c_str(), 0, NULL, &amp;globbuf);
00811         <span class="keywordflow">else</span>
00812             glob(pattern.c_str(), GLOB_APPEND, NULL, &amp;globbuf);
00813 
00814         <span class="keywordflow">if</span> (globbuf.gl_pathc &gt; 0) {
00815 
00816             <span class="comment">// Found file, needs to be uncompressed...</span>
00817 
00818             string found = globbuf.gl_pathv[0];
00819             string uncompressed = ri.<a class="code" href="classRunInfo.html#o2">cachedir</a>+basename+<span class="stringliteral">"."</span>+ext;
00820             string command = <span class="stringliteral">"bunzip2 -v -c "</span>+found+<span class="stringliteral">" &gt; "</span>+uncompressed+<span class="stringliteral">"~"</span>;
00821             string command2= <span class="stringliteral">"mv "</span>+uncompressed+<span class="stringliteral">"~ "</span>+uncompressed;
00822             cout &lt;&lt; <span class="stringliteral">"Uncompressing "</span> &lt;&lt; basename
00823                  &lt;&lt;<span class="stringliteral">", this may take some time... "</span>&lt;&lt; endl;
00824             system(command.c_str());
00825             system(command2.c_str());
00826 
00827             <span class="comment">// Record the fact that this file has been cached...</span>
00828             
00829             pid_t pid = getpid();
00830             <span class="keywordtype">char</span> pidstr[16];
00831             sprintf( pidstr, <span class="stringliteral">"%d"</span>, pid );
00832             string listname = ri.<a class="code" href="classRunInfo.html#o2">cachedir</a>+string(pidstr)+<span class="stringliteral">"-cached_files.list"</span>;
00833             ofstream filelist(listname.c_str(), ios::app);
00834             filelist &lt;&lt; basename+<span class="stringliteral">"."</span>+ext &lt;&lt; endl;
00835             filelist.close();
00836 
00837             <span class="keywordflow">return</span> uncompressed;
00838 
00839         }
00840 
00841     }
00842 
00843     <span class="comment">// File wasn't found anywhere!</span>
00844     <span class="keywordflow">return</span> string(<span class="stringliteral">""</span>);
00845 
00846 }
00847 
00851 <span class="keywordtype">void</span>
00852 <a class="code" href="classRawDataReaderFactory.html#a2">RawDataReaderFactory::</a>
<a name="l00853"></a><a class="code" href="classRawDataReaderFactory.html#a2">00853</a> <a class="code" href="classRawDataReaderFactory.html#a2">clearCache</a>(string cachedir) {
00854     
00855     pid_t pid = getpid();
00856     <span class="keywordtype">char</span> pidstr[16];
00857     sprintf( pidstr, <span class="stringliteral">"%d"</span>, pid );
00858     string listname = cachedir+string(pidstr)+<span class="stringliteral">"-cached_files.list"</span>;
00859     ifstream filelist(listname.c_str());
00860     string file;
00861 
00862     <span class="keywordflow">if</span> (!filelist.fail()) {
00863 
00864         cout &lt;&lt; <span class="stringliteral">"Clearing cached uncompressed files in "</span>
00865              &lt;&lt; cachedir &lt;&lt;<span class="stringliteral">"..."</span>&lt;&lt;endl;
00866 
00867         <span class="keywordflow">while</span> (filelist &gt;&gt; file) {
00868             string fullfile = cachedir+file;
00869             unlink( fullfile.c_str() );
00870         }
00871 
00872         filelist.close();
00873 
00874     }
00875 
00876     unlink(listname.c_str());
00877 
00878 }
00879 
00880 
00881 
00882 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Apr 21 10:22:45 2007 for wuparam by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
