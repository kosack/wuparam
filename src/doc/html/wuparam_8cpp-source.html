<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>wuparam: wuparam.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>wuparam.cpp</h1><div class="fragment"><pre>00001 
00002 <span class="comment">//  w  u  p  a  r  a  m </span>
00003 <span class="comment">//</span>
00004 <span class="comment">//  Washington University data parameterization program for Whipple</span>
00005 <span class="comment">//  Gamma-Ray telescope data.</span>
00006 <span class="comment">//</span>
00007 <span class="comment">//  by Karl Kosack (2000-08-21)</span>
00009 <span class="comment"></span>
00025 <span class="preprocessor">#include &lt;iostream&gt;</span>
00026 <span class="preprocessor">#include &lt;ctime&gt;</span>
00027 <span class="preprocessor">#include &lt;getopt.h&gt;</span>
00028 <span class="preprocessor">#include &lt;cstdlib&gt;</span>
00029 <span class="preprocessor">#include &lt;fstream&gt;</span>
00030 <span class="preprocessor">#include &lt;string&gt;</span>
00031 <span class="preprocessor">#include &lt;list&gt;</span>
00032 <span class="preprocessor">#include &lt;exception&gt;</span>
00033 <span class="preprocessor">#include &lt;stdexcept&gt;</span>
00034 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00035 <span class="preprocessor">#include &lt;signal.h&gt;</span>
00036 
00037 <span class="preprocessor">#ifdef HAVE_LIBMPI</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#include &lt;mpi.h&gt;</span>
00039 <span class="preprocessor">#endif</span>
00040 <span class="preprocessor"></span>
00041 <span class="preprocessor">#include "Types.h"</span>
00042 <span class="preprocessor">#include "Exceptions.h"</span>
00043 <span class="preprocessor">#include "Config.h"</span>
00044 <span class="preprocessor">#include "Parameterizer.h"</span>
00045 <span class="preprocessor">#include "DataReader.h"</span>
00046 <span class="preprocessor">#include "wuparam.h"</span> 
00047 <span class="preprocessor">#include "Log.h"</span>
00048 
00049 <span class="keywordtype">void</span> showUsage();
00050 <span class="keywordtype">void</span> getCommandLineOptions(<span class="keywordtype">int</span> argc , <span class="keywordtype">char</span> **argv);
00051 <span class="keywordtype">void</span> trap_ctrl_c( <span class="keywordtype">int</span> n );
00052 <span class="keywordtype">void</span> shutdown();
00053 
00054 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00055 
00056 <span class="keyword">const</span> <span class="keywordtype">char</span> ESC = 0x1b;
00057 
00058 <span class="keywordtype">int</span>
00059 main( <span class="keywordtype">int</span> argc , <span class="keywordtype">char</span> **argv ) {
00060 
00061     <a class="code" href="classRunInfo.html">RunInfo</a> ri;
00062     <a class="code" href="classParameterizer.html">Parameterizer</a> param;
00063     <a class="code" href="classConfig.html">Config</a> *conf;
00064     <span class="keywordtype">int</span> numruns=0;
00065     <span class="keywordtype">int</span> myrank, numprocs;
00066 
00067     <span class="comment">// set up ctrl-c handler</span>
00068     
00069     <span class="keyword">struct </span>sigaction sa;
00070     
00071     sigfillset( &amp;sa.sa_mask );
00072     sa.sa_flags = 0;
00073     sa.sa_handler = trap_ctrl_c;
00074     <span class="keywordflow">if</span> (sigaction(SIGINT, &amp;sa, NULL) &lt; 0) {
00075         perror( <span class="stringliteral">"sigaction SIGINT"</span> );
00076         exit(1);
00077     }
00078     
00079     <span class="comment">// turn off cursor because it looks nicer! Uses the VT100 escape</span>
00080     <span class="comment">// sequence for "cursor off"</span>
00081     
00082     cerr &lt;&lt; ESC &lt;&lt; <span class="stringliteral">"[25l"</span>;
00083 
00084     <span class="comment">// call the shutdown function whenever an exit() is encountered</span>
00085     atexit(shutdown);
00086 
00087     <span class="comment">//-------------------------------------- </span>
00088     <span class="comment">// Check command line args and output </span>
00089     <span class="comment">// usage info or header</span>
00090 
00091     cout &lt;&lt; <span class="stringliteral">"===================================="</span>
00092          &lt;&lt; <span class="stringliteral">"===================================="</span> &lt;&lt; endl
00093          &lt;&lt; <span class="stringliteral">"WUParam - parameterizer v"</span>&lt;&lt; VERSION
00094          &lt;&lt; <span class="stringliteral">" &lt;kosack@hbar.wustl.edu&gt; "</span> &lt;&lt; endl
00095          &lt;&lt; <span class="stringliteral">"Washington University Physics Department, St. Louis M0"</span>
00096          &lt;&lt; endl;
00097 
00098 <span class="preprocessor">#ifdef HAVE_LIBMPI</span>
00099 <span class="preprocessor"></span>    MPI_Init( &amp;argc, &amp;argv );
00100     MPI_Comm_rank( MPI_COMM_WORLD, &amp;myrank );
00101     MPI_Comm_size( MPI_COMM_WORLD, &amp;numprocs );
00102 <span class="preprocessor">#endif</span>
00103 <span class="preprocessor"></span>
00104     cout &lt;&lt; <span class="stringliteral">"===================================="</span>
00105          &lt;&lt; <span class="stringliteral">"===================================="</span>
00106          &lt;&lt; endl &lt;&lt; endl;
00107 
00108     getCommandLineOptions( argc, argv );
00109 
00110     <span class="keywordflow">if</span> (argc-optind &lt; 1) {
00111         showUsage();
00112         exit(1);
00113     }
00114 
00115 
00116     param.<a class="code" href="classParameterizer.html#a4">enableDisplay</a>( Options.display );
00117     param.<a class="code" href="classParameterizer.html#a6">enableInteractive</a>( Options.interactive );
00118     param.<a class="code" href="classParameterizer.html#a5">enableVerbose</a>( Options.verbose );
00119     param.<a class="code" href="classParameterizer.html#a9">enableOverwrite</a>( Options.overwrite );
00120     param.<a class="code" href="classParameterizer.html#a8">enableCleanup</a>( Options.clearcache );
00121 
00122 <span class="preprocessor">#ifdef HAVE_LIBMPI</span>
00123 <span class="preprocessor"></span>    cout &lt;&lt; <span class="stringliteral">"USING MPI WITH "</span> &lt;&lt; numprocs &lt;&lt; <span class="stringliteral">" PROCESSORS"</span>
00124          &lt;&lt; endl;
00125 <span class="preprocessor">#endif    </span>
00126 <span class="preprocessor"></span>
00127     <a class="code" href="classLogger.html">Logger</a> *logger = Logger::instance();
00128 
00129     logger-&gt;<a class="code" href="classLogger.html#a1">info</a>(<span class="stringliteral">"&lt;&lt;&lt; This is WUParam &gt;&gt;&gt;"</span>);
00130 
00131     <span class="comment">//--------------------------------------</span>
00132     <span class="comment">// Open and read config file...</span>
00133         
00134     <span class="keywordflow">try</span> {
00135         conf = <span class="keyword">new</span> <a class="code" href="classConfig.html">Config</a>( argv[optind] );
00136     }
00137     <span class="keywordflow">catch</span> (<a class="code" href="classAnalysisException.html">AnalysisException</a> &amp;e) {
00138             
00139         cout &lt;&lt; <span class="stringliteral">"*** Couldn't process configuration '"</span> &lt;&lt; argv[optind] 
00140              &lt;&lt; <span class="stringliteral">"' because:  "</span> &lt;&lt; e.what() 
00141              &lt;&lt; endl;
00142             
00143         exit(1);
00144             
00145     }
00146 
00147 
00148     <span class="comment">//--------------------------------------</span>
00149     <span class="comment">// go through each run in config file...</span>
00150 
00151     <span class="keywordflow">try</span> {
00152             
00153         <span class="keywordflow">while</span> (conf-&gt;<a class="code" href="classConfig.html#a5">isDone</a>() == <span class="keyword">false</span>) {
00154             ri = conf-&gt;<a class="code" href="classConfig.html#a3">getNextRun</a>();
00155             numruns++;
00156 <span class="preprocessor">#ifdef HAVE_LIBMPI</span>
00157 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (numruns%numprocs == myrank) {
00158                 cout &lt;&lt;endl&lt;&lt; <span class="stringliteral">"Rank "</span> &lt;&lt;myrank&lt;&lt; <span class="stringliteral">": processing job "</span>
00159                      &lt;&lt;numruns&lt;&lt;<span class="stringliteral">" of "</span>&lt;&lt; numruns+conf-&gt;<a class="code" href="classConfig.html#a6">getRunCount</a>()
00160                      &lt;&lt; endl;
00161                 param.<a class="code" href="classParameterizer.html#a2">process</a>( ri );
00162             }
00163 <span class="preprocessor">#else</span>
00164 <span class="preprocessor"></span>            cout &lt;&lt; endl &lt;&lt; <span class="stringliteral">"[Processing run "</span>&lt;&lt;numruns
00165                  &lt;&lt;<span class="stringliteral">", "</span>&lt;&lt;conf-&gt;<a class="code" href="classConfig.html#a6">getRunCount</a>()
00166                  &lt;&lt; <span class="stringliteral">" left]"</span>&lt;&lt; endl;
00167             param.<a class="code" href="classParameterizer.html#a2">process</a>( ri );
00168 <span class="preprocessor">#endif</span>
00169 <span class="preprocessor"></span>            
00170 
00171         }
00172         
00173     }
00174     <span class="keywordflow">catch</span> (<a class="code" href="classAnalysisException.html">AnalysisException</a> &amp;e) {
00175         cout &lt;&lt; <span class="stringliteral">"Processing failed: "</span> &lt;&lt; e.what() &lt;&lt; endl;          
00176         exit(1);
00177     }
00178 
00179     <span class="keyword">delete</span> conf;
00180     
00181     <span class="comment">//-------------------------------------</span>
00182     <span class="comment">// If no runs were found, output a warning</span>
00183         
00184     <span class="keywordflow">if</span> (numruns == 0) {
00185         cout &lt;&lt; <span class="stringliteral">"** No runs were specified in the configuration file: "</span>
00186              &lt;&lt; argv[1] &lt;&lt; endl
00187              &lt;&lt; <span class="stringliteral">"** Please edit it and add some runs to process!"</span> &lt;&lt; endl
00188              &lt;&lt; endl;   
00189     }
00190         
00191     cout &lt;&lt; endl;
00192     cout &lt;&lt; <span class="stringliteral">"Wuparam exited normally. Goodbye!"</span> &lt;&lt; endl;
00193 
00194 <span class="preprocessor">#ifdef HAVE_LIBMPI</span>
00195 <span class="preprocessor"></span>    MPI_Finalize();
00196 <span class="preprocessor">#endif</span>
00197 <span class="preprocessor"></span>
00198     <span class="keywordtype">int</span> ecount = logger-&gt;<a class="code" href="classLogger.html#a2">getErrorCount</a>();
00199     <span class="keywordflow">if</span> ( ecount &gt; 0 ) {
00200         cout &lt;&lt; <span class="stringliteral">"======================================"</span> &lt;&lt; endl;
00201         cout &lt;&lt; <span class="stringliteral">"ATTENTION: "</span>&lt;&lt;ecount&lt;&lt;<span class="stringliteral">" warnings were logged"</span>&lt;&lt; endl;
00202         cout &lt;&lt; <span class="stringliteral">"please look at '"</span>&lt;&lt;logger-&gt;<a class="code" href="classLogger.html#a4">getFileName</a>()&lt;&lt;<span class="stringliteral">"'"</span>&lt;&lt;endl;
00203         cout &lt;&lt; <span class="stringliteral">"======================================"</span> &lt;&lt; endl;
00204     }
00205     
00206     <span class="keywordflow">return</span> 0;
00207 
00208 }
00209 
00210 
00211 <span class="keywordtype">void</span> 
00212 getCommandLineOptions(<span class="keywordtype">int</span> argc , <span class="keywordtype">char</span> **argv) {
00213 
00214     <span class="keywordtype">int</span> ret=0;
00215     <span class="keywordtype">char</span> c;
00216 
00217     Options.verbose = <span class="keyword">true</span>;
00218     Options.interactive = <span class="keyword">false</span>;
00219     Options.overwrite = <span class="keyword">false</span>;
00220     Options.clearcache = <span class="keyword">true</span>;
00221 
00222 
00223     <span class="keywordflow">while</span> ( ret != -1 ) {
00224 
00225         ret=getopt( argc, argv, <span class="stringliteral">"qidomk"</span>);
00226         c = (<span class="keywordtype">char</span>)ret;
00227 
00228         <span class="keywordflow">switch</span> (c) {
00229         
00230         <span class="keywordflow">case</span> <span class="charliteral">'q'</span>:
00231               Options.verbose = <span class="keyword">false</span>;
00232             <span class="keywordflow">break</span>;
00233             
00234         <span class="keywordflow">case</span> <span class="charliteral">'i'</span>:
00235             Options.interactive = <span class="keyword">true</span>;
00236             Options.display = <span class="keyword">true</span>;
00237             <span class="keywordflow">break</span>;
00238             
00239         <span class="keywordflow">case</span> <span class="charliteral">'d'</span>:
00240             Options.display=<span class="keyword">true</span>;
00241             Options.interactive=<span class="keyword">false</span>;
00242             <span class="keywordflow">break</span>;
00243 
00244         <span class="keywordflow">case</span> <span class="charliteral">'o'</span>:
00245             Options.overwrite=<span class="keyword">true</span>;
00246             <span class="keywordflow">break</span>;
00247             
00248         <span class="keywordflow">case</span> <span class="charliteral">'k'</span>:
00249             Options.clearcache = <span class="keyword">false</span>;
00250             <span class="keywordflow">break</span>;
00251 
00252         <span class="keywordflow">default</span>:
00253             <span class="keywordflow">break</span>;
00254 
00255         }
00256         
00257     }
00258 
00259 }
00260 
00261 <span class="keywordtype">void</span> showUsage() {
00262 
00263     cerr &lt;&lt; <span class="stringliteral">"USAGE: wuparam [-idqok] &lt;config file&gt;"</span> &lt;&lt; endl
00264          &lt;&lt; <span class="stringliteral">"\t-i\tInteractive mode"</span> &lt;&lt;endl
00265          &lt;&lt; <span class="stringliteral">"\t-d\tDisplay events as they are processed (non-interactive)"</span> 
00266          &lt;&lt;endl
00267          &lt;&lt; <span class="stringliteral">"\t-q\tQuiet (less verbose text output)"</span> &lt;&lt;endl
00268          &lt;&lt; <span class="stringliteral">"\t-o\tOverwrite previously parameterized files "</span>
00269          &lt;&lt; <span class="stringliteral">"(skipped otherwise)"</span> &lt;&lt;endl
00270          &lt;&lt; <span class="stringliteral">"\t-k\tKeep uncompressed files in the cache (normally deleted)"</span>
00271          &lt;&lt; endl;
00272     
00273     cout &lt;&lt;endl
00274          &lt;&lt; <span class="stringliteral">"All other options are specified in the config file."</span>&lt;&lt;endl
00275          &lt;&lt;endl;
00276 
00277 }
00278 
00279 
00280 <span class="keywordtype">void</span> trap_ctrl_c( <span class="keywordtype">int</span> n) {
00281 
00282     <a class="code" href="classLogger.html">Logger</a> *logger = Logger::instance();
00283 
00284     <span class="keywordflow">if</span> ( n == SIGINT ){
00285         cout &lt;&lt; endl&lt;&lt;endl&lt;&lt;<span class="stringliteral">"WUParam was interrupted by CTRL-C. "</span> &lt;&lt; endl
00286              &lt;&lt; <span class="stringliteral">"Parametrization was not completed. If you re-run "</span>
00287              &lt;&lt; <span class="stringliteral">"wuparam, it will start up "</span> &lt;&lt; endl
00288              &lt;&lt; <span class="stringliteral">"where it left off. If you wish to re-parameterize "</span>
00289              &lt;&lt; <span class="stringliteral">"all files, run with the "</span>&lt;&lt; endl
00290              &lt;&lt; <span class="stringliteral">"'-o' option (overwrite)."</span> &lt;&lt; endl
00291              &lt;&lt;endl;
00292         logger-&gt;<a class="code" href="classLogger.html#a1">info</a>(<span class="stringliteral">"WUParam was interrupted by CTRL-C"</span>);
00293     }
00294 
00295     exit(1);
00296 
00297 }
00298 
00299 <span class="keywordtype">void</span> shutdown() {
00300 
00301     <a class="code" href="classLogger.html">Logger</a> *logger = Logger::instance();
00302 
00303     <span class="comment">// turn on cursor</span>
00304     cerr &lt;&lt; ESC &lt;&lt; <span class="stringliteral">"[25h"</span>;
00305 
00306     logger-&gt;<a class="code" href="classLogger.html#a0">printf</a>(<span class="stringliteral">"WUParam exited"</span>);
00307 
00308 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Apr 21 10:22:46 2007 for wuparam by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
