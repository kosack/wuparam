<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>wuparam: DataWriter.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>DataWriter.cpp</h1><div class="fragment"><pre>00001 <span class="comment">//</span>
00002 <span class="comment">// DataWriter.cpp</span>
00003 <span class="comment">//</span>
00004 <span class="comment">// DataWriter.cpp</span>
00005 <span class="comment">// Karl Kosack &lt;kosack@hbar.wustl.edu&gt;</span>
00006 
00007 <span class="preprocessor">#include &lt;iostream&gt;</span>
00008 <span class="preprocessor">#include &lt;iomanip&gt;</span>
00009 <span class="preprocessor">#include &lt;fstream&gt;</span>
00010 <span class="preprocessor">#include &lt;gsl/gsl_ntuple.h&gt;</span>
00011 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00012 
00013 <span class="preprocessor">#include "ImageAnalyzer.h"</span>
00014 <span class="preprocessor">#include "DataWriter.h"</span>
00015 <span class="preprocessor">#include "Exceptions.h"</span>
00016 <span class="preprocessor">#include "Types.h"</span>
00017 
00018 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00019 
00020 ParamDataWriter::ParamDataWriter(<span class="keyword">const</span> string &amp;filename,<span class="keywordtype">bool</span> overwrite)
00021     : <a class="code" href="classDataWriter.html">DataWriter</a>(filename,overwrite) {
00022 
00023     <span class="keywordflow">if</span> (overwrite == <span class="keyword">false</span>) {
00024         <span class="comment">// test if header file exists, if it does, exit.</span>
00025         string headerfilename = filename+<span class="stringliteral">".hdr"</span>;
00026         string versionfilename = filename+<span class="stringliteral">".ver"</span>;
00027         ifstream test(headerfilename.c_str());
00028         <span class="keywordflow">if</span> (!test.fail()) {
00029                 
00030             <span class="comment">// Also check that the version of the file is current</span>
00031             <span class="comment">// otherwise, must reparameterize</span>
00032             ifstream verfile(versionfilename.c_str());
00033             <span class="keywordflow">if</span> (!verfile.fail()){
00034                 
00035                 string version;
00036                 verfile &gt;&gt; version;
00037                 <span class="keywordflow">if</span> (version != OUTPUT_FILE_VERSION) {
00038                     cout &lt;&lt; <span class="stringliteral">"NOTE: "</span>&lt;&lt;filename&lt;&lt;<span class="stringliteral">" was parameterized using "</span>
00039                          &lt;&lt; <span class="stringliteral">"a different"</span>&lt;&lt; endl
00040                          &lt;&lt; <span class="stringliteral">"      version of WUPARAM ("</span>&lt;&lt;version&lt;&lt;<span class="stringliteral">") "</span>
00041                          &lt;&lt; <span class="stringliteral">"and must be re-parameterized"</span>&lt;&lt;endl;
00042                 }
00043                 <span class="keywordflow">else</span> {
00044                     <span class="keywordflow">throw</span> <a class="code" href="classMildAnalysisException.html">MildAnalysisException</a>(filename+
00045                                                 <span class="stringliteral">" is already parameterized."</span>);
00046                 }
00047             }
00048         }
00049         test.close();
00050     }
00051     <span class="keywordflow">else</span> {
00052         cout &lt;&lt; <span class="stringliteral">"Overwriting "</span> &lt;&lt; filename &lt;&lt; <span class="stringliteral">" with new version"</span>&lt;&lt; endl;
00053     }
00054 
00055 }
00056 
00057 
00058 <span class="comment">//===============================================================================</span>
00059 
00060 ParamDataWriterText::ParamDataWriterText( <span class="keyword">const</span> string &amp;filename, 
00061                                           <span class="keywordtype">bool</span> ow ) 
00062     : <a class="code" href="classParamDataWriter.html">ParamDataWriter</a>(filename,ow) {
00063  
00064     _outfile.open( getFilename().c_str() );
00065 
00066     <span class="keywordflow">if</span> (_outfile.fail()) 
00067         <span class="keywordflow">throw</span> <a class="code" href="classCriticalAnalysisException.html">CriticalAnalysisException</a>(<span class="stringliteral">"Couldn't open output file"</span>);
00068     
00069 }
00070 
00071 ParamDataWriterText::~ParamDataWriterText() {
00072     
00073     _outfile.close();
00074     
00075 }
00076 
00077 <span class="keywordtype">void</span>
00078 ParamDataWriterText::
00079 writeParameterization( <a class="code" href="structHillasParameterization.html">HillasParameterization</a> &amp;param ) {
00080 
00081     _outfile &lt;&lt; param &lt;&lt; endl;
00082         
00083 }
00084 
00085 <span class="keywordtype">void</span>
00086 ParamDataWriterText::writeParameterization(SimShowerRecord &amp;p1,
00087                                            <a class="code" href="structHillasParameterization.html">HillasParameterization</a> &amp;p2){
00088     _outfile &lt;&lt; p1 &lt;&lt; p2 &lt;&lt; endl;
00089 }
00090 
00091 
00092 <span class="comment">//===============================================================================</span>
00093 
00094 ParamDataWriterNtuple::
00095 ParamDataWriterNtuple( <span class="keyword">const</span> string &amp;filename,
00096                        <span class="keywordtype">bool</span> overwrite) 
00097     : <a class="code" href="classParamDataWriter.html">ParamDataWriter</a>(filename,overwrite), _ntuple(NULL), _numrows(0) {
00098     
00099     _ntuple = gsl_ntuple_create( (<span class="keywordtype">char</span> *)filename.c_str(), 
00100                                  &amp;_ntuplerow, 
00101                                  <span class="keyword">sizeof</span>(_ntuplerow) );
00102     
00103     <span class="keywordflow">if</span> (_ntuple == NULL) {
00104         <span class="keywordflow">throw</span> <a class="code" href="classCriticalAnalysisException.html">CriticalAnalysisException</a>(<span class="stringliteral">"Couldn't create N-tuple"</span>);
00105     }
00106 
00107     <span class="keywordflow">if</span> (overwrite) {
00108         <span class="comment">// remove the old header file if it exists...</span>
00109         string headerfilename = filename+<span class="stringliteral">".hdr"</span>;
00110         unlink( headerfilename.c_str() );
00111     }
00112 }
00113 
00114 ParamDataWriterNtuple::~ParamDataWriterNtuple() {
00115 
00116     gsl_ntuple_close( _ntuple );
00117 
00118 }
00119 
00120 
00121 <span class="keywordtype">void</span>
00122 ParamDataWriterNtuple::
00123 writeParameterization(  <a class="code" href="structHillasParameterization.html">HillasParameterization</a> &amp;param ) {
00124     
00125     _ntuplerow = param;
00126 
00127     gsl_ntuple_write( _ntuple );
00128 
00129     _numrows++;
00130 
00131 }
00132 
00133 
00138 <span class="keywordtype">void</span> 
00139 <a class="code" href="classParamDataWriter.html#a2">ParamDataWriter::</a>
<a name="l00140"></a><a class="code" href="classParamDataWriter.html#a2">00140</a> <a class="code" href="classParamDataWriter.html#a2">writeHeader</a>( <a class="code" href="structHeaderRecord.html">HeaderRecord</a> &amp;hdr ) {
00141 
00142     string hdrname = getFilename() + <span class="stringliteral">".hdr"</span>;
00143     ofstream outfile( hdrname.c_str() );
00144     
00145     string tsourcename = hdr.<a class="code" href="structHeaderRecord.html#o8">sourcename</a>;
00146 
00147     <span class="comment">// replace spaces in source name with underscore, so it's all one</span>
00148     <span class="comment">// token</span>
00149     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;tsourcename.length(); i++)
00150         <span class="keywordflow">if</span> (tsourcename[i] == <span class="charliteral">' '</span>)
00151             tsourcename[i] = <span class="charliteral">'_'</span>;
00152         
00153 
00154     outfile.precision(20);
00155     outfile &lt;&lt; size() &lt;&lt; <span class="stringliteral">" "</span>
00156             &lt;&lt; hdr.<a class="code" href="structHeaderRecord.html#o2">ra</a> &lt;&lt; <span class="stringliteral">" "</span>
00157             &lt;&lt; hdr.<a class="code" href="structHeaderRecord.html#o3">dec</a> &lt;&lt; <span class="stringliteral">" "</span>
00158             &lt;&lt; hdr.<a class="code" href="structHeaderRecord.html#o4">starttime</a> &lt;&lt; <span class="stringliteral">" "</span>
00159             &lt;&lt; hdr.<a class="code" href="structHeaderRecord.html#o5">endtime</a> &lt;&lt; <span class="stringliteral">" "</span>
00160             &lt;&lt; hdr.<a class="code" href="structHeaderRecord.html#o6">average_elevation</a> &lt;&lt; <span class="stringliteral">" "</span>
00161             &lt;&lt; tsourcename &lt;&lt; <span class="stringliteral">" "</span>
00162             &lt;&lt; hdr.<a class="code" href="structHeaderRecord.html#o0">num_telescopes</a> &lt;&lt; <span class="stringliteral">" "</span>;
00163 
00164     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;hdr.<a class="code" href="structHeaderRecord.html#o0">num_telescopes</a>; i++) {
00165         outfile &lt;&lt; hdr.<a class="code" href="structHeaderRecord.html#o1">nadc</a>[i] &lt;&lt; <span class="stringliteral">" "</span>;
00166     }
00167     outfile &lt;&lt; endl;
00168 
00169     outfile.close();
00170 
00171     <span class="comment">// also write out version file:</span>
00172     string vername = getFilename() + <span class="stringliteral">".ver"</span>;
00173     ofstream voutfile( vername.c_str() );
00174     voutfile &lt;&lt; OUTPUT_FILE_VERSION &lt;&lt; endl;
00175     voutfile.close();
00176 
00177 }
00178 
00182 ostream&amp; operator&lt;&lt;(ostream &amp;stream,<span class="keyword">const</span> SimShowerRecord &amp;p){
00183  
00184     stream &lt;&lt; (<span class="keywordtype">int</span>) p.event_number &lt;&lt; <span class="stringliteral">" "</span>
00185            &lt;&lt; (<span class="keywordtype">int</span>) p.primary_type &lt;&lt; <span class="stringliteral">" "</span>
00186            &lt;&lt; setprecision(14) &lt;&lt; p.primary_energy &lt;&lt; <span class="stringliteral">" "</span>
00187            &lt;&lt; setprecision(14) &lt;&lt; p.impact_parameter.x &lt;&lt; <span class="stringliteral">" "</span>
00188            &lt;&lt; setprecision(14) &lt;&lt; p.impact_parameter.y &lt;&lt; <span class="stringliteral">" "</span>
00189            &lt;&lt; setprecision(14) &lt;&lt; p.direction_cos.x &lt;&lt; <span class="stringliteral">" "</span>
00190            &lt;&lt; setprecision(14) &lt;&lt; p.direction_cos.y &lt;&lt; <span class="stringliteral">" "</span> ;
00191  
00192     <span class="keywordflow">return</span> stream;
00193 }
00194 
00195 
00196 
00200 <span class="comment">// istream &amp;operator&gt;&gt;( istream &amp;stream, SimShowerRecord &amp;p) {</span>
00201 
00202 <span class="comment">//     stream &gt;&gt; p.event_number</span>
00203 <span class="comment">//            &gt;&gt; p.primary_type</span>
00204 <span class="comment">//            &gt;&gt; p.primary_energy </span>
00205 <span class="comment">//            &gt;&gt; p.impact_parameter.x</span>
00206 <span class="comment">//            &gt;&gt; p.impact_parameter.y</span>
00207 <span class="comment">//            &gt;&gt; p.direction_cos.x </span>
00208 <span class="comment">//            &gt;&gt; p.direction_cos.y;</span>
00209     
00210 <span class="comment">//     return stream;</span>
00211     
00212 <span class="comment">// }</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Apr 21 10:22:45 2007 for wuparam by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
