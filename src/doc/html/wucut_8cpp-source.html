<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>wuparam: wucut.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>wucut.cpp</h1><div class="fragment"><pre>00001 
00002 <span class="comment">//  w  u  c  u  t</span>
00003 <span class="comment">//</span>
00004 <span class="comment">//  Washington University data cutting and analysis program for</span>
00005 <span class="comment">//  Whipple Gamma-Ray telescope data.</span>
00006 <span class="comment">//</span>
00007 <span class="comment">//  by Karl Kosack (2002-06-01)</span>
00009 <span class="comment"></span>
00010 <span class="preprocessor">#include &lt;iostream&gt;</span>
00011 <span class="preprocessor">#include &lt;getopt.h&gt;</span>
00012 <span class="preprocessor">#include &lt;cstdlib&gt;</span>
00013 <span class="preprocessor">#include &lt;fstream&gt;</span>
00014 <span class="preprocessor">#include &lt;string&gt;</span>
00015 <span class="preprocessor">#include &lt;exception&gt;</span>
00016 <span class="preprocessor">#include &lt;stdexcept&gt;</span>
00017 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00018 <span class="preprocessor">#include &lt;signal.h&gt;</span>
00019 
00020 <span class="preprocessor">#include "Types.h"</span>
00021 <span class="preprocessor">#include "Exceptions.h"</span>
00022 <span class="preprocessor">#include "Config.h"</span>
00023 <span class="preprocessor">#include "Parameterizer.h"</span>
00024 <span class="preprocessor">#include "ProgressBar.h"</span>
00025 <span class="preprocessor">#include "ImageAnalyzer.h"</span>
00026 <span class="preprocessor">#include "Cutter.h"</span>
00027 <span class="preprocessor">#include "Log.h"</span>
00028 
00029 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00030 
00031 <span class="keyword">const</span> <span class="keywordtype">char</span> ESC = 0x1b;
00032 
00033 <span class="keywordtype">void</span> getCommandLineOptions(<span class="keywordtype">int</span> argc , <span class="keywordtype">char</span> **argv);
00034 <span class="keywordtype">void</span> showUsage();
00035 <span class="keywordtype">void</span> trap_ctrl_c( <span class="keywordtype">int</span> n );
00036 <span class="keywordtype">void</span> shutdown();
00037 
00038 <span class="keywordtype">bool</span> Enable2d = <span class="keyword">true</span>;
00039 <span class="keywordtype">bool</span> NewOutputDir = <span class="keyword">false</span>;
00040 <span class="keywordtype">bool</span> PointingCheck = <span class="keyword">true</span>;
00041 <span class="keywordtype">bool</span> Display = <span class="keyword">true</span>;
00042 <span class="keywordtype">bool</span> Output =<span class="keyword">false</span>;
00043 <span class="keywordtype">bool</span> ScaledParameterOutput = <span class="keyword">false</span>;
00044 <span class="keywordtype">bool</span> FastImageProcessing=<span class="keyword">false</span>;
00045 string Outdir;
00046 <span class="keywordtype">int</span> TelescopeID = 0;
00047 
00048 
00049 <span class="keywordtype">int</span>
00050 main( <span class="keywordtype">int</span> argc , <span class="keywordtype">char</span> **argv ) {
00051 
00052     <a class="code" href="classRunInfo.html">RunInfo</a> ri;
00053     <a class="code" href="classCutter.html">Cutter</a> cutter;
00054     <a class="code" href="classConfig.html">Config</a> *conf;
00055     <span class="keywordtype">int</span> numruns=0;
00056     <span class="keywordtype">bool</span> errorflag=<span class="keyword">false</span>;
00057 
00058     <span class="comment">//-------------------------------------- </span>
00059     <span class="comment">// Check command line args and output </span>
00060     <span class="comment">// usage info or header</span>
00061 
00062     cout &lt;&lt; <span class="stringliteral">"wucut - data cutter v"</span>&lt;&lt; VERSION
00063          &lt;&lt; <span class="stringliteral">" &lt;kosack@hbar.wustl.edu&gt; "</span> &lt;&lt; endl
00064          &lt;&lt; <span class="stringliteral">"Washington University Physics Department, St. Louis M0"</span>
00065          &lt;&lt; endl
00066          &lt;&lt; <span class="stringliteral">"============================================================"</span> 
00067          &lt;&lt; endl &lt;&lt; endl;
00068 
00069 
00070     <span class="comment">// set up ctrl-c handler</span>
00071     
00072     <span class="keyword">struct </span>sigaction sa;
00073     
00074     sigfillset( &amp;sa.sa_mask );
00075     sa.sa_flags = 0;
00076     sa.sa_handler = trap_ctrl_c;
00077     <span class="keywordflow">if</span> (sigaction(SIGINT, &amp;sa, NULL) &lt; 0) {
00078         perror( <span class="stringliteral">"sigaction SIGINT"</span> );
00079         exit(1);
00080     }
00081     
00082     <span class="comment">// turn off cursor because it looks nicer! Uses the VT100 escape</span>
00083     <span class="comment">// sequence for "cursor off"</span>
00084     
00085     cerr &lt;&lt; ESC &lt;&lt; <span class="stringliteral">"[25l"</span>;
00086 
00087     <span class="comment">// call the shutdown function whenever an exit() is encountered</span>
00088     atexit(shutdown);
00089 
00090 
00091     getCommandLineOptions( argc, argv );
00092 
00093     <span class="keywordflow">if</span> (argc-optind &lt; 1) {
00094         showUsage();
00095         exit(1);
00096     }
00097 
00098     <span class="keywordflow">if</span> (Enable2d)
00099         cutter.<a class="code" href="classCutter.html#a5">enable2D</a>(<span class="keyword">true</span>);
00100     
00101     cutter.<a class="code" href="classCutter.html#a6">enablePointingCheck</a>( PointingCheck );
00102     cutter.<a class="code" href="classCutter.html#a7">enableDisplay</a>( Display );
00103     cutter.<a class="code" href="classCutter.html#a2">enableOutput</a>( Output );
00104     cutter.<a class="code" href="classCutter.html#a3">enableScaledParameterOutput</a>( ScaledParameterOutput );
00105     cutter.<a class="code" href="classCutter.html#a4">enableFastImageProcessing</a>( FastImageProcessing );
00106     cutter.<a class="code" href="classCutter.html#a24">setTelescopeID</a>( TelescopeID );
00107 
00108     <span class="keywordflow">if</span> (NewOutputDir) 
00109         cutter.<a class="code" href="classCutter.html#a19">setOutputDir</a>( Outdir );
00110 
00111     <a class="code" href="classLogger.html">Logger</a> *logger = Logger::instance();
00112     logger-&gt;<a class="code" href="classLogger.html#a1">info</a>(<span class="stringliteral">"&lt;&lt;&lt; This is WUCut &gt;&gt;&gt;"</span>);
00113 
00114 
00115     <span class="comment">//--------------------------------------</span>
00116     <span class="comment">// Open and read config file...</span>
00117         
00118     <span class="keywordflow">try</span> {
00119         conf = <span class="keyword">new</span> <a class="code" href="classConfig.html">Config</a>( argv[optind] );
00120     }
00121     <span class="keywordflow">catch</span> (<a class="code" href="classAnalysisException.html">AnalysisException</a> &amp;e) {
00122             
00123         cout &lt;&lt; <span class="stringliteral">"*** Couldn't process configuration '"</span> &lt;&lt; argv[1] 
00124              &lt;&lt; <span class="stringliteral">"' because:  "</span> &lt;&lt; e.what() 
00125              &lt;&lt; endl;
00126             
00127         exit(1);
00128             
00129     }
00130 
00131     cout &lt;&lt; endl;
00132 
00133     cout &lt;&lt; <span class="stringliteral">"Cutting "</span> &lt;&lt; conf-&gt;<a class="code" href="classConfig.html#a6">getRunCount</a>() &lt;&lt; <span class="stringliteral">" runs..."</span> &lt;&lt; endl;
00134     cout &lt;&lt; <span class="stringliteral">"Using Telescope: "</span> &lt;&lt; TelescopeID &lt;&lt; endl;
00135     <a class="code" href="classProgressBar.html">ProgressBar</a> progress(conf-&gt;<a class="code" href="classConfig.html#a6">getRunCount</a>(),<span class="stringliteral">"Cutting"</span>);
00136 
00137     <span class="comment">//--------------------------------------</span>
00138     <span class="comment">// go through each run in config file...</span>
00139             
00140     <span class="keywordflow">while</span> (conf-&gt;<a class="code" href="classConfig.html#a5">isDone</a>() == <span class="keyword">false</span>) {
00141 
00142         ri = conf-&gt;<a class="code" href="classConfig.html#a3">getNextRun</a>();
00143 
00144         <span class="keywordflow">try</span> {
00145             progress.<a class="code" href="classProgressBar.html#a1">setName</a>(ri.<a class="code" href="classRunInfo.html#o4">onid</a>);
00146             progress.<a class="code" href="classProgressBar.html#a2">print</a>(numruns);
00147             numruns++;
00148 
00149             cutter.<a class="code" href="classCutter.html#a8">process</a>( ri );
00150 
00151         }
00152         <span class="keywordflow">catch</span> (<a class="code" href="classAnalysisException.html">AnalysisException</a> &amp;e) {
00153             cout &lt;&lt; <span class="stringliteral">"Processing failed: "</span> &lt;&lt; e.what() &lt;&lt; endl;      
00154             errorflag=<span class="keyword">true</span>;
00155             <span class="keywordflow">break</span>;
00156         }
00157         
00158     }
00159 
00160     progress.<a class="code" href="classProgressBar.html#a3">printClear</a>();
00161     <span class="keyword">delete</span> conf;
00162     
00163     <span class="comment">//-------------------------------------</span>
00164     <span class="comment">// If no runs were found, output a warning</span>
00165         
00166     <span class="keywordflow">if</span> (numruns == 0) {
00167         cout &lt;&lt; <span class="stringliteral">"** No runs were specified in the configuration file: "</span>
00168              &lt;&lt; argv[1] &lt;&lt; endl
00169              &lt;&lt; <span class="stringliteral">"** Please edit it and add some runs to process!"</span> &lt;&lt; endl
00170              &lt;&lt; endl;   
00171     }
00172         
00173     cout &lt;&lt; endl;
00174         
00175     <span class="comment">//-------------------------------------</span>
00176     <span class="comment">// output statistics</span>
00177     
00178     <span class="keywordflow">if</span> (errorflag==<span class="keyword">false</span>)
00179         cutter.<a class="code" href="classCutter.html#a12">outputStatistics</a>();
00180     <span class="keywordflow">else</span> 
00181         cout &lt;&lt; <span class="stringliteral">"An error occured. Please correct it and re-run wucut."</span> 
00182              &lt;&lt; endl;
00183 
00184     cout &lt;&lt; <span class="stringliteral">"Goodbye."</span> &lt;&lt; endl;
00185 
00186 
00187     <span class="keywordtype">int</span> ecount = logger-&gt;<a class="code" href="classLogger.html#a2">getErrorCount</a>();
00188     <span class="keywordflow">if</span> ( ecount &gt; 0 ) {
00189         cout &lt;&lt; <span class="stringliteral">"======================================"</span> &lt;&lt; endl;
00190         cout &lt;&lt; <span class="stringliteral">"ATTENTION: "</span>&lt;&lt;ecount&lt;&lt;<span class="stringliteral">" warnings were logged"</span>&lt;&lt; endl;
00191         cout &lt;&lt; <span class="stringliteral">"please look at '"</span>&lt;&lt;logger-&gt;<a class="code" href="classLogger.html#a4">getFileName</a>()&lt;&lt;<span class="stringliteral">"'"</span>&lt;&lt;endl;
00192         cout &lt;&lt; <span class="stringliteral">"======================================"</span> &lt;&lt; endl;
00193     }
00194 
00195     <span class="keywordflow">return</span> 0;
00196 
00197 
00198 }
00199 
00200 
00201 <span class="keywordtype">void</span> 
00202 getCommandLineOptions(<span class="keywordtype">int</span> argc , <span class="keywordtype">char</span> **argv) {
00203 
00204     <span class="keywordtype">char</span> c=0;
00205 
00206     <span class="keywordflow">while</span> ( c != -1 &amp;&amp; c!= 255) {
00207 
00208         c=getopt( argc, argv, <span class="stringliteral">"1d:PDoSft:"</span>);
00209 
00210         <span class="keywordflow">switch</span> (c) {
00211 
00212         <span class="keywordflow">case</span> <span class="charliteral">'1'</span>:
00213             Enable2d = <span class="keyword">false</span>;
00214             <span class="keywordflow">break</span>;
00215 
00216         <span class="keywordflow">case</span> <span class="charliteral">'d'</span>:
00217             NewOutputDir = <span class="keyword">true</span>;
00218             Outdir = optarg;
00219             <span class="keywordflow">break</span>;
00220 
00221         <span class="keywordflow">case</span> <span class="charliteral">'P'</span>:
00222             PointingCheck = <span class="keyword">false</span>;
00223             <span class="keywordflow">break</span>;
00224 
00225         <span class="keywordflow">case</span> <span class="charliteral">'D'</span>:
00226             Display = <span class="keyword">false</span>;
00227             <span class="keywordflow">break</span>;
00228             
00229         <span class="keywordflow">case</span> <span class="charliteral">'o'</span>:
00230             Output=<span class="keyword">true</span>;
00231             <span class="keywordflow">break</span>;
00232 
00233         <span class="keywordflow">case</span> <span class="charliteral">'S'</span>:
00234             ScaledParameterOutput = <span class="keyword">true</span>;
00235             <span class="keywordflow">break</span>;
00236 
00237         <span class="keywordflow">case</span> <span class="charliteral">'f'</span>:
00238             FastImageProcessing = <span class="keyword">true</span>;
00239             <span class="keywordflow">break</span>;
00240         <span class="keywordflow">case</span> <span class="charliteral">'t'</span>:
00241             TelescopeID = atoi(optarg);
00242             <span class="keywordflow">break</span>;
00243 
00244         <span class="keywordflow">default</span>:
00245             <span class="keywordflow">break</span>;
00246 
00247         }
00248         
00249     }
00250 
00251 }
00252 
00253 <span class="keywordtype">void</span> showUsage() {
00254 
00255     cerr &lt;&lt; <span class="stringliteral">"USAGE: wucut [-1dPoDS] [-d &lt;out dir&gt;] [-t &lt;tel num&gt;] &lt;config file&gt;"</span> &lt;&lt; endl
00256          &lt;&lt;endl
00257          &lt;&lt; <span class="stringliteral">"\t-1  1D analysis only (disable 2D)"</span>&lt;&lt; endl
00258          &lt;&lt; <span class="stringliteral">"\t-d  &lt;dir&gt; output to the specified directory (default: Totals/)"</span>
00259          &lt;&lt; endl
00260          &lt;&lt; <span class="stringliteral">"\t-P  disable the 2D pointing check (cross-correlation)"</span>
00261          &lt;&lt; endl
00262          &lt;&lt; <span class="stringliteral">"\t-o  output raw events which pass cuts to an ntuple"</span>
00263          &lt;&lt; endl
00264          &lt;&lt; <span class="stringliteral">"\t-S  if output is enabled, output scaled parameters instead of raw"</span> 
00265          &lt;&lt; endl 
00266          &lt;&lt; <span class="stringliteral">"\t-D  disable the X display"</span> 
00267          &lt;&lt; endl
00268          &lt;&lt; <span class="stringliteral">"\t-f  enable fast (but less accurate) 2D image processing"</span>&lt;&lt;endl
00269          &lt;&lt; <span class="stringliteral">"\t-t &lt;telescope number&gt; "</span>&lt;&lt;endl
00270          &lt;&lt; <span class="stringliteral">"\t    process only events from specified"</span>
00271          &lt;&lt;      <span class="stringliteral">" telescope, (default: 0)"</span>
00272          &lt;&lt; endl &lt;&lt; endl  
00273          &lt;&lt; <span class="stringliteral">"All options are specified in the config file."</span>&lt;&lt;endl
00274          &lt;&lt;endl;
00275 
00276 }
00277 
00278 <span class="keywordtype">void</span> trap_ctrl_c( <span class="keywordtype">int</span> n) {
00279 
00280     <a class="code" href="classLogger.html">Logger</a> *logger = Logger::instance();
00281 
00282     <span class="keywordflow">if</span> ( n == SIGINT ){
00283         cout &lt;&lt; endl&lt;&lt;endl&lt;&lt;<span class="stringliteral">"WUCut was interrupted by CTRL-C. "</span> &lt;&lt; endl
00284              &lt;&lt; <span class="stringliteral">"Cutting was not completed. If you re-run "</span>
00285              &lt;&lt; <span class="stringliteral">"wucut, it will start up "</span> &lt;&lt; endl
00286              &lt;&lt; <span class="stringliteral">"where it left off."</span> &lt;&lt;endl;
00287         logger-&gt;<a class="code" href="classLogger.html#a1">info</a>(<span class="stringliteral">"WUCut was interrupted by CTRL-C"</span>);
00288     }
00289 
00290     exit(1);
00291 
00292 }
00293 
00294 <span class="keywordtype">void</span> shutdown() {
00295 
00296     <a class="code" href="classLogger.html">Logger</a> *logger = Logger::instance();
00297 
00298     <span class="comment">// turn on cursor</span>
00299     cerr &lt;&lt; ESC &lt;&lt; <span class="stringliteral">"[25h"</span>;
00300 
00301     logger-&gt;<a class="code" href="classLogger.html#a0">printf</a>(<span class="stringliteral">"WUCut exited"</span>);
00302 
00303 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Apr 21 10:22:46 2007 for wuparam by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
