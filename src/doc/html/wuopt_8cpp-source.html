<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>wuparam: wuopt.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>wuopt.cpp</h1><div class="fragment"><pre>00001 
00002 <span class="comment">//  w  u  o p t</span>
00003 <span class="comment">//</span>
00004 <span class="comment">//  Washington University cut optimization program for Whipple</span>
00005 <span class="comment">//  Gamma-Ray telescope data.</span>
00006 <span class="comment">//</span>
00007 <span class="comment">//  by Karl Kosack (2003-11-17)</span>
00009 <span class="comment"></span>
00010 <span class="preprocessor">#include &lt;iostream&gt;</span>
00011 <span class="preprocessor">#include &lt;getopt.h&gt;</span>
00012 <span class="preprocessor">#include &lt;cstdlib&gt;</span>
00013 <span class="preprocessor">#include &lt;fstream&gt;</span>
00014 <span class="preprocessor">#include &lt;string&gt;</span>
00015 <span class="preprocessor">#include &lt;queue&gt;</span>
00016 <span class="preprocessor">#include &lt;exception&gt;</span>
00017 <span class="preprocessor">#include &lt;stdexcept&gt;</span>
00018 <span class="preprocessor">#include &lt;iomanip&gt;</span>
00019 
00020 <span class="preprocessor">#include "Types.h"</span>
00021 <span class="preprocessor">#include "Exceptions.h"</span>
00022 <span class="preprocessor">#include "Config.h"</span>
00023 <span class="preprocessor">#include "Parameterizer.h"</span>
00024 <span class="preprocessor">#include "ProgressBar.h"</span>
00025 <span class="preprocessor">#include "ImageAnalyzer.h"</span>
00026 <span class="preprocessor">#include "Cutter.h"</span>
00027 <span class="preprocessor">#include "Log.h"</span>
00028 
00029 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00030 <span class="keyword">enum</span> BoundType { UPPER, LOWER };
00031 
00032 <span class="keywordtype">void</span> getWUOptCommandLineOptions(<span class="keywordtype">int</span> argc , <span class="keywordtype">char</span> **argv);
00033 <span class="keywordtype">void</span> showUsage();
00034 
00035 <span class="keywordtype">void</span> optimizeParameter( <a class="code" href="classConfig.html">Config</a> *, ofstream &amp;, string , BoundType );
00036 <span class="keywordtype">void</span> optimize2DParameter( <a class="code" href="classConfig.html">Config</a> *, ofstream &amp;, string, BoundType,
00037                           <span class="keywordtype">int</span> xpix, <span class="keywordtype">int</span> ypix );
00038 
00039 
00040 string What_to_optimize=<span class="stringliteral">"lensize"</span>;
00041 <span class="keywordtype">bool</span> NewOutputDir = <span class="keyword">false</span>;
00042 string Outdir;
00043 BoundType Bound;
00044 
00045 <span class="keywordtype">double</span> Low=0;
00046 <span class="keywordtype">double</span> High=0;
00047 <span class="keywordtype">int</span> Steps=0;
00048 
00049 <span class="keywordtype">int</span>
00050 main( <span class="keywordtype">int</span> argc , <span class="keywordtype">char</span> **argv ) {
00051 
00052     <a class="code" href="classConfig.html">Config</a> *conf;
00053     <span class="keywordtype">int</span> numruns=0;
00054 
00055     <span class="comment">//-------------------------------------- </span>
00056     <span class="comment">// Check command line args and output </span>
00057     <span class="comment">// usage info or header</span>
00058 
00059     cout &lt;&lt; <span class="stringliteral">"wuopt - cut optimizer v"</span>&lt;&lt; VERSION
00060          &lt;&lt; <span class="stringliteral">" &lt;kosack@hbar.wustl.edu&gt; "</span> &lt;&lt; endl
00061          &lt;&lt; <span class="stringliteral">"Washington University Physics Department, St. Louis M0"</span>
00062          &lt;&lt; endl
00063          &lt;&lt; <span class="stringliteral">"============================================================"</span> 
00064          &lt;&lt; endl &lt;&lt; endl;
00065 
00066     getWUOptCommandLineOptions( argc, argv );
00067     
00068     <span class="comment">//--------------------------------------</span>
00069     <span class="comment">// Open and read config file...</span>
00070         
00071     <span class="keywordflow">try</span> {
00072         conf = <span class="keyword">new</span> <a class="code" href="classConfig.html">Config</a>( argv[6] );
00073     }
00074     <span class="keywordflow">catch</span> (<a class="code" href="classAnalysisException.html">AnalysisException</a> &amp;e) {
00075             
00076         cout &lt;&lt; <span class="stringliteral">"*** Couldn't process configuration '"</span> &lt;&lt; argv[1] 
00077              &lt;&lt; <span class="stringliteral">"' because:  "</span> &lt;&lt; e.what()    &lt;&lt; endl;
00078             
00079         exit(1);
00080             
00081     }
00082 
00083 
00084     <span class="keywordflow">try</span> {
00085         cout &lt;&lt; endl;
00086         cout &lt;&lt; <span class="stringliteral">"Optimizing "</span>;
00087         <span class="keywordflow">if</span> (Bound == LOWER) cout &lt;&lt; <span class="stringliteral">" lower "</span>;
00088         <span class="keywordflow">else</span>
00089             cout &lt;&lt; <span class="stringliteral">" upper "</span>;
00090         cout &lt;&lt; What_to_optimize&lt;&lt; <span class="stringliteral">" using database of "</span> 
00091              &lt;&lt; conf-&gt;<a class="code" href="classConfig.html#a6">getRunCount</a>() &lt;&lt; <span class="stringliteral">" runs..."</span> &lt;&lt; endl;
00092 
00093         cout &lt;&lt; <span class="stringliteral">"Optimization Limits: ("</span>&lt;&lt;Low&lt;&lt;<span class="stringliteral">" , "</span>&lt;&lt;High&lt;&lt;<span class="stringliteral">") in "</span>
00094              &lt;&lt;Steps&lt;&lt;<span class="stringliteral">" steps"</span>&lt;&lt; endl;
00095        
00096         string bstring;
00097         <span class="keywordflow">if</span> (Bound == LOWER) bstring = <span class="stringliteral">"-lower"</span>;
00098         <span class="keywordflow">else</span> bstring = <span class="stringliteral">"-upper"</span>;
00099         string outfilename=<span class="stringliteral">"optimize-"</span>+What_to_optimize+bstring+<span class="stringliteral">".txt"</span>;
00100         ofstream outfile( outfilename.c_str() );
00101         
00102         cout &lt;&lt; <span class="stringliteral">"Output to: "</span>&lt;&lt; outfilename &lt;&lt; endl;
00103 
00104         <span class="keywordflow">if</span> (What_to_optimize[0] == <span class="charliteral">'2'</span>)
00105             optimize2DParameter( conf, outfile, What_to_optimize, Bound,
00106                                  19,19 );
00107         <span class="keywordflow">else</span>
00108             optimizeParameter( conf, outfile, What_to_optimize, Bound );
00109 
00110         outfile.close();
00111         <span class="keyword">delete</span> conf;
00112 
00113     }
00114     <span class="keywordflow">catch</span> (<a class="code" href="classAnalysisException.html">AnalysisException</a> &amp;e) {
00115         cout &lt;&lt; <span class="stringliteral">"WUOpt failed: "</span> &lt;&lt; e.what() &lt;&lt; endl;       
00116         cout &lt;&lt; <span class="stringliteral">"Please correct problem and re-run wuopt."</span> 
00117              &lt;&lt; endl;
00118     }
00119     
00120 
00121 
00122 
00123     <span class="keywordflow">return</span> 0;
00124 
00125 
00126 }
00127 
00128 
00129 <span class="keywordtype">void</span> 
00130 optimizeParameter( <a class="code" href="classConfig.html">Config</a> *conf, ofstream &amp;outfile, string parameter, BoundType bound ) {
00131 
00132     <a class="code" href="classRunInfo.html">RunInfo</a> ri;
00133     <span class="keywordtype">double</span> delta = (High-Low)/(<span class="keywordtype">double</span>)Steps;
00134     <a class="code" href="classProgressBar.html">ProgressBar</a> progress(Steps,<span class="stringliteral">"Optimizing"</span>);
00135 
00136     deque&lt;RunInfo&gt; &amp;runqueue = conf-&gt;<a class="code" href="classConfig.html#a4">getRunQueue</a>();
00137     deque&lt;RunInfo&gt;::iterator iter;   
00138 
00139     <span class="keywordtype">double</span> value;
00140     RunStatistics stats;
00141 
00142     <a class="code" href="classCutter.html">Cutter</a> *cutter = <span class="keyword">new</span> <a class="code" href="classCutter.html">Cutter</a>;
00143     cutter-&gt;<a class="code" href="classCutter.html#a2">enableOutput</a>(<span class="keyword">false</span>);
00144     cutter-&gt;<a class="code" href="classCutter.html#a5">enable2D</a>(<span class="keyword">false</span>);
00145     cutter-&gt;<a class="code" href="classCutter.html#a7">enableDisplay</a>(<span class="keyword">false</span>);
00146 
00147     <span class="comment">//--------------------------------------</span>
00148     <span class="comment">// loop over optimization parameter</span>
00149     
00150     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;=Steps; i++) {    
00151 
00152         value = Low + delta*i;
00153         
00154         <span class="comment">// go through each run in the queue...</span>
00155         
00156         cutter-&gt;<a class="code" href="classCutter.html#a25">clear</a>();
00157         <span class="keywordflow">for</span> (iter = runqueue.begin(); iter != runqueue.end(); iter++) {
00158             
00159             progress.<a class="code" href="classProgressBar.html#a2">print</a>(i);
00160             
00161             <span class="keywordflow">if</span> (parameter==<span class="stringliteral">"length"</span>){
00162                 <span class="keywordflow">if</span> (bound == LOWER) 
00163                     iter-&gt;cuts.length.lower = value;
00164                 <span class="keywordflow">else</span> 
00165                     iter-&gt;cuts.length.upper = value;
00166             }
00167             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (parameter== <span class="stringliteral">"width"</span>){
00168                 <span class="keywordflow">if</span> (bound == LOWER) 
00169                     iter-&gt;cuts.width.lower = value;
00170                 <span class="keywordflow">else</span> 
00171                     iter-&gt;cuts.width.upper = value;
00172             }
00173             
00174             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (parameter== <span class="stringliteral">"size"</span>){
00175                 <span class="keywordflow">if</span> (bound == LOWER) 
00176                     iter-&gt;cuts.size.lower = value;
00177                 <span class="keywordflow">else</span> 
00178                     iter-&gt;cuts.size.upper = value;
00179             }
00180 
00181             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (parameter== <span class="stringliteral">"distance"</span>){
00182                 <span class="keywordflow">if</span> (bound == LOWER) 
00183                     iter-&gt;cuts.distance.lower = value;
00184                 <span class="keywordflow">else</span> 
00185                     iter-&gt;cuts.distance.upper = value;
00186             }
00187 
00188             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (parameter== <span class="stringliteral">"max1"</span>){
00189                 <span class="keywordflow">if</span> (bound == LOWER) 
00190                     iter-&gt;cuts.max1.lower = value;
00191                 <span class="keywordflow">else</span> 
00192                     iter-&gt;cuts.max1.upper = value;
00193             }
00194 
00195             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (parameter== <span class="stringliteral">"max2"</span>){
00196                 <span class="keywordflow">if</span> (bound == LOWER) 
00197                     iter-&gt;cuts.max2.lower = value;
00198                 <span class="keywordflow">else</span> 
00199                     iter-&gt;cuts.max2.upper = value;
00200             }
00201 
00202             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (parameter== <span class="stringliteral">"lensize"</span>){
00203                 <span class="keywordflow">if</span> (bound == LOWER) 
00204                     iter-&gt;cuts.lensize.lower = value;
00205                 <span class="keywordflow">else</span> 
00206                     iter-&gt;cuts.lensize.upper = value;
00207             }
00208 
00209             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (parameter== <span class="stringliteral">"dlength"</span>){
00210                 iter-&gt;cuts.dlength = value;
00211             }
00212 
00213             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (parameter== <span class="stringliteral">"dwidth"</span>){
00214                 iter-&gt;cuts.dwidth = value;
00215             }
00216 
00217             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (parameter== <span class="stringliteral">"radialcut"</span>){
00218                 iter-&gt;cuts.smoothing_radius = value;
00219             }
00220 
00221             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (parameter== <span class="stringliteral">"alpha"</span>){
00222                 <span class="keywordflow">if</span> (bound == LOWER) 
00223                     iter-&gt;cuts.alpha.lower = value;
00224                 <span class="keywordflow">else</span> 
00225                     iter-&gt;cuts.alpha.upper = value;
00226             }
00227 
00228             <span class="keywordflow">else</span> {
00229                 <span class="keywordflow">throw</span> <a class="code" href="classAnalysisException.html">AnalysisException</a>(<span class="stringliteral">"unknown or 2D parameter: "</span>+parameter);
00230             }
00231                 
00232             cutter-&gt;<a class="code" href="classCutter.html#a8">process</a>( *iter );
00233             
00234         }
00235         
00236         stats = cutter-&gt;<a class="code" href="classCutter.html#a11">getTotalPairStatistics</a>();
00237         outfile &lt;&lt; setw(10) &lt;&lt; value &lt;&lt;<span class="stringliteral">" "</span>
00238                 &lt;&lt; setw(10) &lt;&lt; stats.significance &lt;&lt;<span class="stringliteral">" "</span>
00239                 &lt;&lt; setw(10) &lt;&lt;stats.excess &lt;&lt;<span class="stringliteral">" "</span>
00240                 &lt;&lt;endl;
00241         outfile.flush();
00242 
00243     }
00244         
00245     progress.<a class="code" href="classProgressBar.html#a3">printClear</a>();
00246     <span class="keyword">delete</span> cutter;
00247     outfile.close();
00248 
00249 }
00250 
00251 
00252 <span class="keywordtype">void</span> 
00253 optimize2DParameter( <a class="code" href="classConfig.html">Config</a> *conf, ofstream &amp;outfile, string parameter, 
00254                      BoundType bound, <span class="keywordtype">int</span> xpix, <span class="keywordtype">int</span> ypix ) {
00255 
00256 
00257     <a class="code" href="classRunInfo.html">RunInfo</a> ri;
00258     <span class="keywordtype">double</span> delta = (High-Low)/(<span class="keywordtype">double</span>)Steps;
00259     <a class="code" href="classProgressBar.html">ProgressBar</a> progress(Steps,<span class="stringliteral">"Optimizing"</span>);
00260 
00261     deque&lt;RunInfo&gt; &amp;runqueue = conf-&gt;<a class="code" href="classConfig.html#a4">getRunQueue</a>();
00262     deque&lt;RunInfo&gt;::iterator iter;   
00263 
00264     <span class="keywordtype">double</span> value;
00265     RunStatistics stats;
00266 
00267     <a class="code" href="classImage2D.html">Image2D</a> excess2d(39,39);
00268     <a class="code" href="classImage2D.html">Image2D</a> signif2d(39,39);
00269 
00270     <a class="code" href="classCutter.html">Cutter</a> *cutter = <span class="keyword">new</span> <a class="code" href="classCutter.html">Cutter</a>;
00271     cutter-&gt;<a class="code" href="classCutter.html#a2">enableOutput</a>(<span class="keyword">false</span>);
00272     cutter-&gt;<a class="code" href="classCutter.html#a5">enable2D</a>(<span class="keyword">true</span>);
00273     cutter-&gt;<a class="code" href="classCutter.html#a7">enableDisplay</a>(<span class="keyword">false</span>);
00274 
00275     cout &lt;&lt; <span class="stringliteral">"DEBUG: parameter="</span>&lt;&lt;parameter&lt;&lt;endl;
00276 
00277     <span class="comment">//--------------------------------------</span>
00278     <span class="comment">// loop over optimization parameter</span>
00279     
00280     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;=Steps; i++) {    
00281 
00282         value = Low + delta*i;
00283         
00284         <span class="comment">// go through each run in the queue...</span>
00285         
00286         cutter-&gt;<a class="code" href="classCutter.html#a25">clear</a>();
00287         <span class="keywordflow">for</span> (iter = runqueue.begin(); iter != runqueue.end(); iter++) {
00288             
00289             progress.<a class="code" href="classProgressBar.html#a2">print</a>(i);
00290             
00291             <span class="keywordflow">if</span> (parameter==<span class="stringliteral">"2d-asymmdist"</span>){
00292                 <span class="keywordflow">if</span> (bound == LOWER) 
00293                     iter-&gt;cuts.asymmdist.lower = value;
00294                 <span class="keywordflow">else</span> 
00295                     iter-&gt;cuts.asymmdist.upper = value;
00296             }
00297             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (parameter==<span class="stringliteral">"2d-radsmooth"</span>){
00298                 iter-&gt;cuts.smoothing_radius = value;
00299             }
00300             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (parameter==<span class="stringliteral">"2d-elongation"</span>){
00301                 iter-&gt;cuts.elongation = value;
00302             }
00303             <span class="keywordflow">else</span> {
00304                 <span class="keywordflow">throw</span> <a class="code" href="classAnalysisException.html">AnalysisException</a>(<span class="stringliteral">"unknown parameter: "</span>+parameter);
00305             }
00306                 
00307             cutter-&gt;<a class="code" href="classCutter.html#a8">process</a>( *iter );
00308             
00309         }
00310 
00311         stats = cutter-&gt;<a class="code" href="classCutter.html#a11">getTotalPairStatistics</a>();       
00312         excess2d.<a class="code" href="classImage2D.html#a8">load</a>( <span class="stringliteral">"Totals/excess.im2d"</span> );
00313         signif2d.<a class="code" href="classImage2D.html#a8">load</a>( <span class="stringliteral">"Totals/signif.im2d"</span> );
00314         outfile &lt;&lt; setw(10) &lt;&lt; value &lt;&lt;<span class="stringliteral">" "</span>
00315                 &lt;&lt; setw(10) &lt;&lt; stats.significance &lt;&lt;<span class="stringliteral">" "</span>
00316                 &lt;&lt; setw(10) &lt;&lt; stats.excess &lt;&lt;<span class="stringliteral">" "</span>
00317                 &lt;&lt; setw(10) &lt;&lt; signif2d.<a class="code" href="classImage2D.html#a14">getPixel</a>(xpix,ypix) &lt;&lt;<span class="stringliteral">" "</span>
00318                 &lt;&lt; setw(10) &lt;&lt; excess2d.<a class="code" href="classImage2D.html#a14">getPixel</a>(xpix,ypix) &lt;&lt;<span class="stringliteral">" "</span>
00319                 &lt;&lt;endl;
00320         outfile.flush();
00321 
00322     }
00323         
00324     progress.<a class="code" href="classProgressBar.html#a3">printClear</a>();
00325     <span class="keyword">delete</span> cutter;
00326     outfile.close();
00327 
00328 }
00329 
00330 
00331 <span class="keywordtype">void</span> 
00332 getWUOptCommandLineOptions(<span class="keywordtype">int</span> argc , <span class="keywordtype">char</span> **argv) {
00333 
00334     <span class="keywordtype">char</span> c=0;
00335     string bound;
00336 
00337 
00338     <span class="keywordflow">if</span> (argc!=7) {
00339         cout &lt;&lt; <span class="stringliteral">"DEBUG: argc = "</span>&lt;&lt; argc &lt;&lt; endl;
00340         showUsage();
00341         exit(1);
00342     }
00343 
00344     What_to_optimize = argv[1];
00345     bound = argv[2];
00346     Low = atof(argv[3]);
00347     High = atof(argv[4]);
00348     Steps = atoi(argv[5]);
00349 
00350 
00351     <span class="keywordflow">if</span> (bound == <span class="stringliteral">"lower"</span>) Bound = LOWER;
00352     <span class="keywordflow">if</span> (bound == <span class="stringliteral">"upper"</span>) Bound = UPPER;
00353     <span class="keywordflow">else</span> {
00354         cout &lt;&lt; <span class="stringliteral">"unknown bound '"</span>&lt;&lt;bound&lt;&lt;<span class="stringliteral">"', using LOWER instead"</span>;
00355         Bound = LOWER;
00356     }
00357 
00358 
00359 
00360 }
00361 
00362 <span class="keywordtype">void</span> showUsage() {
00363 
00364     cerr &lt;&lt; <span class="stringliteral">"USAGE: wuopt &lt;parameter&gt; &lt;bound&gt; &lt;lowvalue&gt; &lt;highvalue&gt; &lt;steps&gt; &lt;config file&gt;"</span>&lt;&lt;endl
00365          &lt;&lt;endl
00366          &lt;&lt; <span class="stringliteral">"\t&lt;parameter&gt;    parameter to optimze:"</span>&lt;&lt;endl
00367          &lt;&lt; <span class="stringliteral">"\t               length, width, size, distance, max1, max2 "</span>&lt;&lt;endl
00368          &lt;&lt; <span class="stringliteral">"\t               lensize, dwidth,dlength,radialcut, alpha"</span>&lt;&lt;endl
00369          &lt;&lt; <span class="stringliteral">"\t               2d-asymmdist 2d-radsmooth 2d-elongation"</span>&lt;&lt;endl
00370          &lt;&lt; <span class="stringliteral">"\t&lt;bound&gt;        lower or upper"</span>&lt;&lt;endl
00371          &lt;&lt; <span class="stringliteral">"\t&lt;lowvalue&gt;     floating point lower value"</span>&lt;&lt;endl
00372          &lt;&lt; <span class="stringliteral">"\t&lt;highvalue&gt;    floating point high value"</span>&lt;&lt;endl
00373          &lt;&lt; <span class="stringliteral">"\t&lt;steps&gt;        number of steps"</span>&lt;&lt;endl
00374          &lt;&lt; endl &lt;&lt; endl
00375          &lt;&lt; <span class="stringliteral">"All options are specified in the config file."</span>&lt;&lt;endl
00376          &lt;&lt;endl;
00377 
00378 }
00379 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Apr 21 10:22:46 2007 for wuparam by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
