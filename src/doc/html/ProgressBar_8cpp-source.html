<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>wuparam: ProgressBar.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>ProgressBar.cpp</h1><div class="fragment"><pre>00001 <span class="comment">// ProgressBar</span>
00002 <span class="comment">// Karl Kosack &lt;kosack@hbar.wustl.edu&gt;</span>
00003 
00004 <span class="preprocessor">#include &lt;iostream&gt;</span>
00005 <span class="preprocessor">#include &lt;iomanip&gt;</span>
00006 <span class="preprocessor">#include &lt;ctime&gt;</span>
00007 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
00008 
00009 <span class="preprocessor">#include "ProgressBar.h"</span>
00010 
00011 <span class="keyword">using</span> std::cout;
00012 <span class="keyword">using</span> std::cerr;
00013 <span class="keyword">using</span> std::endl;
00014 
00015 <span class="preprocessor">#define ANSITERM 1</span>
00016 <span class="preprocessor"></span>
00017 ProgressBar::ProgressBar( <span class="keywordtype">int</span> total, std::string name ) 
00018     : _total(total),_last(0),_spin(0),_name(name),_avgpersec(0) {
00019 
00020     _spinner[0] = <span class="charliteral">'|'</span>;
00021     _spinner[1] = <span class="charliteral">'/'</span>;
00022     _spinner[2] = <span class="charliteral">'-'</span>;
00023     _spinner[3] = <span class="charliteral">'\\'</span>;
00024 
00025 }
00026 
00030 <span class="keywordtype">void</span>
<a name="l00031"></a><a class="code" href="classProgressBar.html#a2">00031</a> <a class="code" href="classProgressBar.html#a2">ProgressBar::print</a>( <span class="keywordtype">int</span> n ) {
00032 
00033     <span class="keywordtype">int</span> i;
00034     <span class="keywordtype">float</span> percent;
00035     <span class="keywordtype">int</span> secleft, minleft;
00036     <span class="keywordtype">double</span> evtpersec;
00037     <span class="keywordtype">int</span> prog;
00038     <span class="keywordtype">double</span> delta = n - _last;
00039     <span class="keyword">const</span> <span class="keywordtype">char</span> ESC = 0x1b;
00040 
00041     <span class="keywordflow">if</span> (n&lt;=0) <span class="keywordflow">return</span>;
00042 
00043     _spin++; <span class="keywordflow">if</span> (_spin&gt;=4) _spin=0;
00044     percent = (<span class="keywordtype">float</span>)n/_total;
00045     prog = (<span class="keywordtype">int</span>)(percent * 30); 
00046     cerr &lt;&lt; _name&lt;&lt;<span class="stringliteral">": "</span>&lt;&lt; _spinner[_spin] &lt;&lt; <span class="stringliteral">" ["</span> ;
00047     <span class="keywordflow">if</span> (_total == 0) {
00048         cerr &lt;&lt; <span class="stringliteral">"please wait...]                       "</span>;
00049         cerr &lt;&lt;<span class="stringliteral">"  \r"</span> &lt;&lt; std::flush;
00050         <span class="keywordflow">return</span>;
00051     }
00052 
00053     <span class="keywordflow">if</span> (ANSITERM) {
00054 
00055         <span class="keywordflow">for</span> (i=0; i&lt;=prog; i++)   cerr&lt;&lt;ESC&lt;&lt;<span class="stringliteral">"[01;47m "</span>&lt;&lt;ESC&lt;&lt;<span class="stringliteral">"[0m"</span>;<span class="comment">//"#";</span>
00056         <span class="keywordflow">for</span> (i=prog+1; i&lt;30; i++) cerr&lt;&lt;ESC&lt;&lt;<span class="stringliteral">"[01;44m "</span>&lt;&lt;ESC&lt;&lt;<span class="stringliteral">"[0m"</span>; <span class="comment">//cerr &lt;&lt; "_";</span>
00057     }
00058     <span class="keywordflow">else</span> {
00059         <span class="keywordflow">for</span> (i=0; i&lt;=prog; i++)   cerr&lt;&lt;<span class="stringliteral">"#"</span>;
00060         <span class="keywordflow">for</span> (i=prog+1; i&lt;30; i++) cerr&lt;&lt;<span class="stringliteral">"_"</span>;
00061     }
00062 
00063     _now = <a class="code" href="classProgressBar.html#a4">getTime</a>();
00064 
00065     <span class="keywordflow">if</span> (delta &gt; 0) {
00066         evtpersec = (_now-_before &gt; 0)? (delta/((_now-_before))):-1;
00067         _before = _now;
00068         _last = n;
00069     }
00070 
00071 
00072     _avgpersec = (evtpersec + _avgpersec)/2.0;
00073     secleft = (_avgpersec&gt;0)?(<span class="keywordtype">int</span>)((_total-n)/_avgpersec):0;
00074     minleft = secleft/60;
00075     secleft = secleft % 60;
00076     cerr &lt;&lt; ESC &lt;&lt; <span class="stringliteral">"[0m"</span>
00077          &lt;&lt; <span class="stringliteral">"] "</span> 
00078          &lt;&lt; std::setw(2) &lt;&lt; (<span class="keywordtype">int</span>)(percent*100) &lt;&lt; <span class="stringliteral">"% "</span>;
00079 
00080 
00081     <span class="keywordflow">if</span> ( evtpersec &gt; 1e8 || evtpersec &lt; 0) 
00082         cerr &lt;&lt; <span class="stringliteral">"??? per sec, "</span>;
00083     <span class="keywordflow">else</span> 
00084         cerr &lt;&lt; std::setw(6) &lt;&lt;std::setprecision(4)&lt;&lt;evtpersec&lt;&lt;<span class="stringliteral">" per sec, "</span>;
00085         
00086     <span class="keywordflow">if</span> ( minleft &lt; 60 &amp;&amp; secleft &gt; 0) {
00087         cerr &lt;&lt; std::setw(2) &lt;&lt; minleft &lt;&lt;<span class="stringliteral">":"</span> 
00088              &lt;&lt; std::setw(2) &lt;&lt; std::setfill(<span class="charliteral">'0'</span>)&lt;&lt; secleft &lt;&lt; <span class="stringliteral">" left"</span>
00089              &lt;&lt; std::setfill(<span class="charliteral">' '</span>);
00090     }
00091     <span class="keywordflow">else</span> {
00092         cerr &lt;&lt; <span class="stringliteral">"           "</span>;
00093     }
00094         
00095 
00096     cerr &lt;&lt;<span class="stringliteral">"  \r"</span> &lt;&lt; std::flush;
00097 
00098     
00099 }
00100 
00101 
00105 <span class="keywordtype">double</span>
<a name="l00106"></a><a class="code" href="classProgressBar.html#a4">00106</a> <a class="code" href="classProgressBar.html#a4">ProgressBar::getTime</a>() {
00107 
00108     <span class="keyword">struct </span>timeval tv;
00109     <span class="keyword">struct </span>timezone tz;
00110 
00111     gettimeofday( &amp;tv,&amp;tz);
00112 
00113     <span class="keywordflow">return</span> (tv.tv_sec + (<span class="keywordtype">double</span>)tv.tv_usec/1.0e6);
00114     
00115 }
00116 
00120 <span class="keywordtype">void</span>
<a name="l00121"></a><a class="code" href="classProgressBar.html#a3">00121</a> <a class="code" href="classProgressBar.html#a3">ProgressBar::printClear</a>() {
00122     
00123     cerr &lt;&lt; <span class="stringliteral">"                                              "</span>
00124         <span class="stringliteral">"                                \r"</span>
00125          &lt;&lt;std::flush;
00126 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Apr 21 10:22:46 2007 for wuparam by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
