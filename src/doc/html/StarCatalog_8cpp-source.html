<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>wuparam: StarCatalog.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>StarCatalog.cpp</h1><div class="fragment"><pre>00001 <span class="preprocessor">#include &lt;iostream&gt;</span>
00002 <span class="preprocessor">#include &lt;fstream&gt;</span>
00003 <span class="preprocessor">#include &lt;list&gt;</span>
00004 <span class="preprocessor">#include &lt;vector&gt;</span>
00005 <span class="preprocessor">#include &lt;string&gt;</span>
00006 <span class="preprocessor">#include &lt;gsl/gsl_math.h&gt;</span>
00007 <span class="preprocessor">#include &lt;iomanip&gt;</span>
00008 
00009 <span class="preprocessor">#include "StarCatalog.h"</span>
00010 <span class="preprocessor">#include "Exceptions.h"</span>
00011 <span class="preprocessor">#include "Image2D.h"</span>
00012 
00013 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00014 
00015 
00016 <span class="keywordtype">bool</span> operator&lt;(<span class="keyword">const</span> <a class="code" href="classStar.html">Star</a> &amp;s1, <span class="keyword">const</span> <a class="code" href="classStar.html">Star</a> &amp;s2 ) {
00017     <span class="keywordflow">return</span> s1.<a class="code" href="classStar.html#o0">name</a> &lt; s2.<a class="code" href="classStar.html#o0">name</a>;
00018 }
00019 <span class="keywordtype">bool</span> operator&gt;(<span class="keyword">const</span> <a class="code" href="classStar.html">Star</a> &amp;s1, <span class="keyword">const</span> <a class="code" href="classStar.html">Star</a> &amp;s2 ) {
00020     <span class="keywordflow">return</span> s1.<a class="code" href="classStar.html#o0">name</a> &gt; s2.<a class="code" href="classStar.html#o0">name</a>;
00021 }
00022 <span class="keywordtype">bool</span> operator==(<span class="keyword">const</span> <a class="code" href="classStar.html">Star</a> &amp;s1, <span class="keyword">const</span> <a class="code" href="classStar.html">Star</a> &amp;s2 ) {
00023     <span class="keywordflow">return</span> s1.<a class="code" href="classStar.html#o0">name</a> == s2.<a class="code" href="classStar.html#o0">name</a>;
00024 }
00025 <span class="keywordtype">bool</span> operator!=(<span class="keyword">const</span> <a class="code" href="classStar.html">Star</a> &amp;s1, <span class="keyword">const</span> <a class="code" href="classStar.html">Star</a> &amp;s2 ) {
00026     <span class="keywordflow">return</span> s1.<a class="code" href="classStar.html#o0">name</a> != s2.<a class="code" href="classStar.html#o0">name</a>;
00027 }
00028 
00029 
00034 <span class="keywordtype">void</span>
00035 <a class="code" href="classStarCatalog.html#a1">StarCatalog::</a>
<a name="l00036"></a><a class="code" href="classStarCatalog.html#a1">00036</a> <a class="code" href="classStarCatalog.html#a1">load</a>( string stardbfilename ) {
00037 
00038     ifstream stardb( stardbfilename.c_str() );
00039     string line;
00040     vector&lt;string&gt; tokens;
00041     vector&lt;string&gt; dhms;
00042     <a class="code" href="classStar.html">Star</a> tmpstar;
00043     <span class="keywordtype">double</span> d,h, m,s;
00044 
00045     tmpstar.<a class="code" href="classStar.html#o10">catalog_id</a> = _cur_catalog_id;
00046 
00047     <span class="keywordflow">if</span> (stardb.fail()){
00048         <span class="keywordflow">throw</span> <a class="code" href="classMildAnalysisException.html">MildAnalysisException</a>(<span class="stringliteral">"Couldn't load star catalog"</span>);
00049     }
00050 
00051     <span class="keywordflow">while</span> ( getline( stardb, line, <span class="charliteral">'\n'</span>) ) {
00052 
00053         <span class="keywordflow">if</span> (line[0]==<span class="charliteral">'#'</span>) <span class="keywordflow">continue</span>;
00054         tokens.clear();
00055         tokenize( line, tokens, <span class="stringliteral">","</span> );
00056 
00057         <span class="keywordflow">if</span> (tokens.size() == 6) {
00058             
00059             tmpstar.<a class="code" href="classStar.html#o0">name</a> = tokens[0];
00060             replaceChar( <span class="charliteral">' '</span>,<span class="charliteral">'_'</span>, tmpstar.<a class="code" href="classStar.html#o0">name</a> );
00061             tmpstar.<a class="code" href="classStar.html#o1">spectclass</a> = tokens[1];
00062             
00063             <span class="comment">// read and convert ra from HMS -&gt; radians</span>
00064 
00065             dhms.clear();
00066             tokenize( tokens[2], dhms, <span class="stringliteral">":"</span> );
00067             <span class="keywordflow">if</span> (dhms.size() == 3) {
00068                 h = atof(dhms[0].c_str());
00069                 m = atof(dhms[1].c_str());
00070                 s = atof(dhms[2].c_str());
00071                 tmpstar.<a class="code" href="classStar.html#o2">ra</a> = (M_PI/12.0) * ( h + m/60.0 + s/3600.0 );
00072                 tmpstar.<a class="code" href="classStar.html#o6">ora</a> = tmpstar.<a class="code" href="classStar.html#o2">ra</a>;
00073             }
00074             <span class="keywordflow">else</span> {
00075                 cerr &lt;&lt; <span class="stringliteral">"Skipping bad line in star catalog..."</span>&lt;&lt; endl;
00076             }
00077 
00078             <span class="comment">// read and convert dec from DMS -&gt; radians</span>
00079 
00080             dhms.clear();
00081             tokenize( tokens[3], dhms, <span class="stringliteral">":"</span> );
00082             <span class="keywordflow">if</span> (dhms.size()==3){
00083                 d = atof(dhms[0].c_str());
00084                 m = atof(dhms[1].c_str());
00085                 s = atof(dhms[2].c_str());
00086             }
00087             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dhms.size() == 2) {
00088                 d = atof(dhms[0].c_str());
00089                 m = atof(dhms[1].c_str());
00090                 s = 0;
00091             }
00092             <span class="keywordflow">else</span> {
00093                 cerr &lt;&lt; <span class="stringliteral">"Skipping bad line in star catalog..."</span>&lt;&lt; endl;
00094                 <span class="keywordflow">continue</span>;
00095             }
00096             tmpstar.<a class="code" href="classStar.html#o3">dec</a> = (M_PI/180.0) * ( d + m/60.0 + s/3600.0 );
00097             tmpstar.<a class="code" href="classStar.html#o7">odec</a> = tmpstar.<a class="code" href="classStar.html#o3">dec</a>;
00098 
00099             <span class="comment">// read in magnitude and epoch</span>
00100 
00101             tmpstar.<a class="code" href="classStar.html#o4">magnitude</a> = atof(tokens[4].c_str()); 
00102             tmpstar.<a class="code" href="classStar.html#o5">epoch</a>     = atoi(tokens[5].c_str()); 
00103             tmpstar.<a class="code" href="classStar.html#o8">tx</a>   = 0; <span class="comment">// tangential coords unknown at this point</span>
00104             tmpstar.<a class="code" href="classStar.html#o9">ty</a>   = 0; <span class="comment">// unknown at this point</span>
00105             
00106             _starcatalog.push_back(tmpstar);
00107 
00108         }
00109 
00110     } 
00111     
00112     _cur_catalog_id++;
00113 
00114 
00115 }
00116 
00134 <span class="keywordtype">void</span> 
00135 <a class="code" href="classStarCatalog.html#a2">StarCatalog::</a>
<a name="l00136"></a><a class="code" href="classStarCatalog.html#a2">00136</a> <a class="code" href="classStarCatalog.html#a2">findNearbyStars</a>( <span class="keywordtype">double</span> ra, <span class="keywordtype">double</span> dec, <span class="keywordtype">double</span> r,list&lt;Star&gt; &amp;nearbystars) {
00137 
00138     list&lt;Star&gt;::iterator star;        
00139     <span class="keywordtype">double</span> rrad = r*M_PI/180.0;
00140     <span class="keywordtype">double</span> denom;
00141 
00142     <span class="keywordflow">for</span> (star=_starcatalog.begin(); star != _starcatalog.end(); star++) {
00143 
00144         <span class="comment">// is the star within radius*2 of the declination</span>
00145         <span class="keywordflow">if</span> ( fabs( star-&gt;dec - dec ) &lt; rrad*2 ) {
00146 
00147             <span class="comment">// calculate the tangential coordinates of the star</span>
00148             denom = (sin(dec)*sin(star-&gt;dec) + 
00149                      cos(dec)*cos(star-&gt;dec)*cos(star-&gt;ra - ra));
00150 
00151             <span class="keywordflow">if</span> (denom&gt;0) {
00152 
00153                 <span class="comment">// Not sure why minus sign is needed for tx, but</span>
00154                 <span class="comment">// seems to be wrong otherwise</span>
00155 
00156                 star-&gt;tx = -(180.0/M_PI)*(cos(star-&gt;dec)*
00157                                          sin(star-&gt;ra-ra))/denom;
00158                 
00159                 star-&gt;ty = (180.0/M_PI)*(cos(dec)*sin(star-&gt;dec)-
00160                                          sin(dec)*cos(star-&gt;dec)*
00161                                          cos(star-&gt;ra-ra))/denom;
00162                 
00163                 
00164                 <span class="comment">// if it's in range:</span>
00165 
00166                 <span class="keywordflow">if</span> (sqrt(pow(star-&gt;tx,2)+pow(star-&gt;ty,2)) &lt; r){
00167 
00168                     nearbystars.push_back( *star );
00169 
00170                 }
00171             }
00172         }
00173     }
00174 
00175 }
00176 
00177 
00187 <span class="keywordtype">void</span>
00188 <a class="code" href="classStarCatalog.html#a3">StarCatalog:: </a>
<a name="l00189"></a><a class="code" href="classStarCatalog.html#a3">00189</a> <a class="code" href="classStarCatalog.html#a3">precessToDate</a>( <span class="keywordtype">int</span> utdate ) {
00190 
00191     <span class="comment">// expansion parameters:</span>
00192     <span class="keyword">const</span> <span class="keywordtype">double</span> ara  = 1.2812323;
00193     <span class="keyword">const</span> <span class="keywordtype">double</span> bra  = 0.0003879;
00194     <span class="keyword">const</span> <span class="keywordtype">double</span> cra  = 0.0000101;
00195     <span class="keyword">const</span> <span class="keywordtype">double</span> adec = 0.5567530;
00196     <span class="keyword">const</span> <span class="keywordtype">double</span> bdec = -0.0001185;
00197     <span class="keyword">const</span> <span class="keywordtype">double</span> cdec = -0.0000116;
00198 
00199     <span class="keywordtype">double</span> yy = (<span class="keywordtype">int</span>)(utdate/10000.0);
00200     <span class="keywordtype">double</span> nn = (<span class="keywordtype">int</span>)((utdate-yy*10000)/100.0);
00201     <span class="keywordtype">double</span> epoch = 2000.0 + yy + nn /12.0;
00202 
00203     <span class="keywordtype">double</span> alpham, deltam, alpha,delta;
00204     <span class="keywordtype">double</span> d2r = 180.0/M_PI;
00205     <span class="keywordtype">double</span> tp=0,np=0,mp=0;
00206     <span class="keywordtype">double</span> lastepoch=0;
00207 
00208     list&lt;Star&gt;::iterator star;        
00209 
00210     <span class="comment">// precess each star</span>
00211 
00212     <span class="keywordflow">for</span> (star=_starcatalog.begin(); star!=_starcatalog.end(); star++) {
00213 
00214         <span class="keywordflow">if</span> (lastepoch != star-&gt;epoch) {
00215             tp = (epoch - star-&gt;epoch)/100.0;
00216             mp = ara*tp  + bra*tp*tp  + cra*tp*tp*tp;
00217             np = adec*tp + bdec*tp*tp + cdec*tp*tp*tp;
00218         }
00219 
00220         <span class="comment">// precess to mid-time point</span>
00221 
00222         alpham = star-&gt;ora*d2r  + 0.5*(mp+np*sin(star-&gt;ora)*tan(star-&gt;odec));
00223         deltam = star-&gt;odec*d2r + 0.5*np*cos(star-&gt;ora);
00224 
00225         <span class="comment">// precess to epoch</span>
00226 
00227         alpha = star-&gt;ora*d2r + mp+np*sin(alpham)*tan(deltam);
00228         delta = star-&gt;odec*d2r + np*cos(alpham);
00229         
00230         star-&gt;ra  = alpha/d2r;
00231         star-&gt;dec = delta/d2r;
00232 
00233         lastepoch = star-&gt;epoch;
00234 
00235         
00236     }
00237     
00238 }
00239 
00243 <span class="keywordtype">void</span> 
00244 StarCatalog::
00245 tokenize(<span class="keyword">const</span> string&amp; str, vector&lt;string&gt;&amp; tokens,
00246          <span class="keyword">const</span> string&amp; delimiters)
00247 {
00248     <span class="comment">// Skip delimiters at beginning.</span>
00249     string::size_type lastPos = str.find_first_not_of(delimiters, 0);
00250     <span class="comment">// Find first "non-delimiter".</span>
00251     string::size_type pos     = str.find_first_of(delimiters, lastPos);
00252 
00253     <span class="keywordflow">while</span> (string::npos != pos || string::npos != lastPos)
00254     {
00255         <span class="comment">// Found a token, add it to the vector.</span>
00256         tokens.push_back(str.substr(lastPos, pos - lastPos));
00257         <span class="comment">// Skip delimiters.  Note the "not_of"</span>
00258         lastPos = str.find_first_not_of(delimiters, pos);
00259         <span class="comment">// Find next "non-delimiter"</span>
00260         pos = str.find_first_of(delimiters, lastPos);
00261     }
00262 }
00263 
00264 <span class="keywordtype">void</span>
00265 StarCatalog::
00266 replaceChar( <span class="keywordtype">char</span> search, <span class="keywordtype">char</span> replace, string &amp;str) {
00267 
00268     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;str.length(); i++) {
00269         <span class="keywordflow">if</span> (str[i] == search)
00270             str[i] = replace;
00271     }
00272 
00273 }
00274 
00275 
00276 ostream&amp; operator&lt;&lt;( ostream &amp;stream, <a class="code" href="classStar.html">Star</a> &amp;star ) {
00277 
00278     stream &lt;&lt; setw(10) &lt;&lt; star.<a class="code" href="classStar.html#o6">ora</a>  &lt;&lt; <span class="charliteral">' '</span>
00279            &lt;&lt; setw(10) &lt;&lt; star.<a class="code" href="classStar.html#o7">odec</a>  &lt;&lt; <span class="charliteral">' '</span>
00280            &lt;&lt; setw(10) &lt;&lt; star.<a class="code" href="classStar.html#o5">epoch</a>  &lt;&lt; <span class="charliteral">' '</span>
00281            &lt;&lt; setw(10) &lt;&lt; star.<a class="code" href="classStar.html#o8">tx</a>   &lt;&lt; <span class="charliteral">' '</span>
00282            &lt;&lt; setw(10) &lt;&lt; star.<a class="code" href="classStar.html#o9">ty</a>   &lt;&lt; <span class="charliteral">' '</span>
00283            &lt;&lt; setw(10) &lt;&lt; star.<a class="code" href="classStar.html#o2">ra</a>   &lt;&lt; <span class="charliteral">' '</span>
00284            &lt;&lt; setw(10) &lt;&lt; star.<a class="code" href="classStar.html#o3">dec</a>  &lt;&lt; <span class="charliteral">' '</span> 
00285            &lt;&lt; setw(10) &lt;&lt; star.<a class="code" href="classStar.html#o4">magnitude</a> &lt;&lt; <span class="charliteral">' '</span>
00286            &lt;&lt; setw(10) &lt;&lt; star.<a class="code" href="classStar.html#o10">catalog_id</a> &lt;&lt; <span class="charliteral">' '</span>
00287            &lt;&lt; setw(10) &lt;&lt; star.<a class="code" href="classStar.html#o0">name</a> &lt;&lt; <span class="charliteral">' '</span>
00288            &lt;&lt; setw(10) &lt;&lt; star.<a class="code" href="classStar.html#o1">spectclass</a> &lt;&lt; <span class="charliteral">' '</span>
00289            &lt;&lt; endl;
00290     
00291     <span class="keywordflow">return</span> stream;
00292 
00293 }
00294 
00295 istream&amp; operator&gt;&gt;( istream &amp;stream, <a class="code" href="classStar.html">Star</a> &amp;star ) {
00296 
00297     stream &gt;&gt; star.<a class="code" href="classStar.html#o6">ora</a>
00298            &gt;&gt; star.<a class="code" href="classStar.html#o7">odec</a>
00299            &gt;&gt; star.<a class="code" href="classStar.html#o5">epoch</a>
00300            &gt;&gt; star.<a class="code" href="classStar.html#o8">tx</a> 
00301            &gt;&gt; star.<a class="code" href="classStar.html#o9">ty</a> 
00302            &gt;&gt; star.<a class="code" href="classStar.html#o2">ra</a> 
00303            &gt;&gt; star.<a class="code" href="classStar.html#o3">dec</a> 
00304            &gt;&gt; star.<a class="code" href="classStar.html#o4">magnitude</a>
00305            &gt;&gt; star.<a class="code" href="classStar.html#o10">catalog_id</a> 
00306            &gt;&gt; star.<a class="code" href="classStar.html#o0">name</a> 
00307            &gt;&gt; star.<a class="code" href="classStar.html#o1">spectclass</a>;
00308 
00309     <span class="keywordflow">return</span> stream;
00310 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Apr 21 10:22:46 2007 for wuparam by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
