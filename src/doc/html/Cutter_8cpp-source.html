<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>wuparam: Cutter.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>Cutter.cpp</h1><div class="fragment"><pre>00001 <span class="comment">// Cutter.cpp</span>
00002 <span class="comment">//</span>
00003 <span class="comment">// Karl Kosack &lt;kosack@hbar.wustl.edu&gt;</span>
00004 <span class="comment">// Checked Li and Ma formula; some slight modifications JB 030617</span>
00005 
00006 <span class="preprocessor">#include &lt;iostream&gt;</span>
00007 <span class="preprocessor">#include &lt;iomanip&gt;</span>
00008 <span class="preprocessor">#include &lt;string&gt;</span>
00009 <span class="preprocessor">#include &lt;fstream&gt;</span>
00010 <span class="preprocessor">#include &lt;list&gt;</span>
00011 <span class="preprocessor">#include &lt;cmath&gt;</span>
00012 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>          <span class="comment">// For POSIX mkdir</span>
00013 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>           <span class="comment">// For POSIX mkdir</span>
00014 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00015 <span class="preprocessor">#include &lt;gsl/gsl_math.h&gt;</span>
00016 
00017 <span class="preprocessor">#include "Exceptions.h"</span>
00018 <span class="preprocessor">#include "Config.h"</span>
00019 <span class="preprocessor">#include "DataReader.h"</span>
00020 <span class="preprocessor">#include "DataWriter.h"</span>
00021 <span class="preprocessor">#include "ParamDataReader.h"</span>
00022 <span class="preprocessor">#include "Histogram.h"</span>
00023 <span class="preprocessor">#include "ProgressBar.h"</span>
00024 <span class="preprocessor">#include "Cutter.h"</span>
00025 <span class="preprocessor">#include "Image2D.h"</span>
00026 <span class="preprocessor">#include "StarCatalog.h"</span>
00027 <span class="preprocessor">#include "PlotMaker.h"</span>
00028 <span class="preprocessor">#include "Log.h"</span>
00029 <span class="preprocessor">#include "Types.h"</span>
00030 <span class="preprocessor">#include "EnergySpectrum.h"</span>
00031 <span class="preprocessor">#include "SuperCutter.h"</span>
00032 <span class="preprocessor">#include "ZCutter.h"</span>
00033 <span class="preprocessor">#include "EZCutter.h"</span>
00034 <span class="preprocessor">#include "SpectralCutter.h"</span>
00035 
00036 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00037 <span class="keyword">using</span> <span class="keyword">namespace </span>Cuts;
00038 
00039 
00040 Cutter::Cutter() 
00041     : _image_xdim(39), _image_ydim(39), _degperpix(0.1), 
00042       _is_2d_enabled(false), _pointing_check_is_enabled(true), 
00043       _display_is_enabled(true),
00044       _outdir("Totals/"), _centroid_range(4), _output_is_enabled(false), 
00045       _output_scaled_parameters(false), 
00046       _fast_image_processing_is_enabled(false),_telescope_id(0)
00047 {
00048 
00049     <span class="keywordtype">double</span> minx, miny, maxx,maxy;
00050 
00051     hline = <span class="stringliteral">"=============================================================================="</span>;
00052 
00053     <span class="comment">// JB 030617 Note that the way histogramming currently is implemented,</span>
00054     <span class="comment">// minx is the lower bound on the minimum x-bin, NOT THE CENTER x-value</span>
00055     <span class="comment">// OF THAT BIN.  Similarly maxx is the upper bound on the largest</span>
00056     <span class="comment">// x-bin.</span>
00057     minx = -_image_xdim*_degperpix/2.0;
00058     maxx = _image_xdim*_degperpix/2.0;
00059     miny = -_image_ydim*_degperpix/2.0;
00060     maxy = _image_ydim*_degperpix/2.0;
00061 
00062     _energy_on = _energy_off = _energy_track = NULL;
00063 
00064     _alpha_on = <span class="keyword">new</span> <a class="code" href="classHistogram.html">Histogram</a>(18,0,90,<span class="stringliteral">"alpha-on"</span>);
00065     _alpha_off = <span class="keyword">new</span> Histogram(18,0,90,<span class="stringliteral">"alpha-off"</span>);
00066 
00067     _size_on = <span class="keyword">new</span> Histogram( 15,1,4,<span class="stringliteral">"log10 Size-ON"</span>);
00068     _size_off = <span class="keyword">new</span> Histogram( 15,1,4,<span class="stringliteral">"log10 Size-OFF"</span>);
00069 
00070     <span class="comment">// Set up output directory:</span>
00071 
00072     <span class="keywordflow">if</span> (mkdir(_outdir.c_str(), S_IRUSR|S_IWUSR|S_IXUSR|S_IXGRP|S_IRGRP )) {
00073         <span class="keywordflow">if</span> (errno != EEXIST) {
00074             perror(<span class="stringliteral">"mkdir"</span>);
00075             <span class="keywordflow">throw</span> <a class="code" href="classCriticalAnalysisException.html">CriticalAnalysisException</a>(<span class="stringliteral">"Couldn't create "</span>+_outdir);
00076         }
00077     }
00078 
00079     <span class="comment">// Load star catalog</span>
00080 
00081     _starcatalog.load( getSupportDir()+<span class="stringliteral">"YBS.edb"</span> );
00082     _starcatalog.load( getSupportDir()+<span class="stringliteral">"SAO.edb"</span> );
00083     _onstars.clear();
00084     _offstars.clear();
00085 
00086     _radial_smoothing_factor = 2.5*_degperpix; <span class="comment">// 2.5*_degperpix</span>
00087     <span class="comment">//    _radial_smoothing_factor = 0.325; // 2.5*degperpix</span>
00088 
00089 
00090     _xplotmaker = NULL;
00091 
00092 
00093     <span class="comment">// initialize the writer.  Eventually, there should be an option</span>
00094     <span class="comment">// to use text vs ntuple, but that may not matter (really should</span>
00095     <span class="comment">// implement an ntuple2text converter). </span>
00096 
00097     _writer_on = <span class="keyword">new</span> <a class="code" href="classParamDataWriterNtuple.html">ParamDataWriterNtuple</a>( _outdir+
00098                                             <span class="stringliteral">"events_passing_cuts-on.ntuple"</span>,
00099                                             <span class="keyword">true</span> );
00100 
00101     _writer_off = <span class="keyword">new</span> ParamDataWriterNtuple( _outdir+
00102                                              <span class="stringliteral">"events_passing_cuts-off.ntuple"</span>,
00103                                              <span class="keyword">true</span> );
00104     
00105 
00106 }
00107 
00108 Cutter::~Cutter() {
00109 
00110     <span class="keywordflow">if</span> (_energy_on != NULL) <span class="keyword">delete</span> _energy_on;
00111     <span class="keywordflow">if</span> (_energy_off != NULL) <span class="keyword">delete</span> _energy_off;
00112     <span class="keywordflow">if</span> (_energy_track != NULL) <span class="keyword">delete</span> _energy_track;
00113     <span class="keyword">delete</span> _alpha_on;
00114     <span class="keyword">delete</span> _alpha_off;
00115     <span class="keyword">delete</span> _size_on;
00116     <span class="keyword">delete</span> _size_off;
00117     <span class="keywordflow">if</span> (_xplotmaker) <span class="keyword">delete</span> _xplotmaker;
00118 
00119     RawHeaderRecord header;
00120     _writer_on-&gt;<a class="code" href="classParamDataWriter.html#a2">writeHeader</a>( header );
00121     _writer_off-&gt;<a class="code" href="classParamDataWriter.html#a2">writeHeader</a>( header );
00122 
00123     <span class="keyword">delete</span> _writer_on;
00124     <span class="keyword">delete</span> _writer_off;
00125     
00126 }
00127 
00128 
00129 <a class="code" href="structCutRecord.html">CutRecord</a>
00130 Cutter::
00131 getTotal( vector&lt;CutRecord&gt; &amp;vec ) {
00132 
00133     <a class="code" href="structCutRecord.html">CutRecord</a> total;
00134 
00135     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;(<span class="keywordtype">int</span>)vec.size(); i++) {
00136         total.<a class="code" href="structCutRecord.html#a2">addValuesFrom</a>( vec[i] );
00137     }
00138 
00139     <span class="keywordflow">return</span> total;
00140 
00141 }
00142  
00156 <span class="keywordtype">double</span> 
00157 <a class="code" href="classCutter.html#a15">Cutter::</a>
<a name="l00158"></a><a class="code" href="classCutter.html#a15">00158</a> <a class="code" href="classCutter.html#a15">maxLikelihoodSignif</a>( <span class="keywordtype">double</span> n_on, <span class="keywordtype">double</span> n_off, <span class="keywordtype">double</span> alpha ) {
00159     <span class="keywordtype">double</span> sum = n_on + n_off;
00160     <span class="keywordtype">double</span> arg1 = (1.0+alpha)/alpha * ( n_on/sum);
00161     <span class="keywordtype">double</span> arg2 = (1.0+alpha)*(n_off/sum);
00162     <span class="keywordtype">double</span> sigsqr;
00163 
00164     <span class="comment">// If more off than on, fall back to approximation to Li and Ma:</span>
00165     <span class="keywordflow">if</span> (alpha*n_off &gt; n_on) {
00166         <span class="keywordflow">if</span> (sum&gt;1e-5) 
00167             <span class="keywordflow">return</span> (n_on-alpha*n_off)/sqrt(alpha*sum);
00168         <span class="keywordflow">else</span>
00169             <span class="keywordflow">return</span> 0;
00170     }
00171 
00172     <span class="comment">// Calculate Li and Ma signif:</span>
00173 
00174     <span class="keywordflow">if</span> (arg1 &gt; 1e-10 &amp;&amp; arg2 &gt; 1e-10) {
00175         sigsqr = fabs(2.0*(n_on*log(arg1) + n_off*log(arg2)));
00176     }
00177     <span class="keywordflow">else</span> {
00178         <span class="keywordflow">if</span> ( sum &gt; 1.0e-5 )
00179             <span class="keywordflow">return</span> (n_on-alpha*n_off)/sqrt(alpha*sum);
00180         <span class="keywordflow">else</span>
00181             <span class="keywordflow">return</span> 0.0;
00182     }
00183 
00184     <span class="keywordflow">if</span> ((n_on - alpha*n_off) &gt; 0.0) 
00185         <span class="keywordflow">return</span> sqrt(sigsqr);
00186     <span class="keywordflow">else</span>
00187         <span class="keywordflow">return</span> -sqrt(sigsqr);
00188     
00189 }
00190 
00191 
00192 
00193 
00194 RunStatistics 
00195 Cutter::
00196 getTrackingStatistics( <a class="code" href="structCutRecord.html">CutRecord</a> &amp;run, <span class="keywordtype">double</span> track_ratio ) {
00197 
00198     RunStatistics stats;
00199     
00200     stats.excess = run.<a class="code" href="structCutRecord.html#o5">orientation</a> - run.<a class="code" href="structCutRecord.html#o6">trackoff</a>/track_ratio;
00201     stats.significance = <a class="code" href="classCutter.html#a15">maxLikelihoodSignif</a>( (<span class="keywordtype">double</span>)run.<a class="code" href="structCutRecord.html#o5">orientation</a>,
00202                                                  (<span class="keywordtype">double</span>)run.<a class="code" href="structCutRecord.html#o6">trackoff</a>,
00203                                                  1.0/track_ratio );
00204 
00205     <span class="keywordflow">return</span> stats;
00206 
00207 }
00208 
00209 
00210 RunStatistics 
00211 Cutter::
00212 getPairStatistics( <a class="code" href="structCutRecord.html">CutRecord</a> &amp;onrun, <a class="code" href="structCutRecord.html">CutRecord</a> &amp;offrun ) {
00213 
00214     RunStatistics stats;
00215     <span class="keywordtype">double</span> a = onrun.<a class="code" href="structCutRecord.html#o7">duration</a> / offrun.<a class="code" href="structCutRecord.html#o7">duration</a>;
00216     <span class="comment">// TODO: maybe put option to use a =</span>
00217     <span class="comment">// onrun.trackoff/offrun.trackoff instead here to be used if there</span>
00218     <span class="comment">// is no matching off source data</span>
00219 
00220     stats.excess = onrun.<a class="code" href="structCutRecord.html#o5">orientation</a> - a*offrun.<a class="code" href="structCutRecord.html#o5">orientation</a>;
00221     stats.significance = <a class="code" href="classCutter.html#a15">maxLikelihoodSignif</a>( (<span class="keywordtype">double</span>)onrun.<a class="code" href="structCutRecord.html#o5">orientation</a>,
00222                                               (<span class="keywordtype">double</span>)offrun.<a class="code" href="structCutRecord.html#o5">orientation</a>, a );
00223     <span class="keywordflow">return</span> stats;
00224 
00225 }
00226 
00227 
00228 RunStatistics
00229 Cutter::
00230 getTotalPairStatistics() {
00231 
00232     RunStatistics prstats;
00233     <a class="code" href="structCutRecord.html">CutRecord</a> total_on,total_off;
00234 
00235     total_on  = getTotal( _onruns );
00236     total_off = getTotal( _offruns );
00237 
00238     <span class="comment">// Generate 2d plots</span>
00239 
00240     prstats = getPairStatistics( total_on, total_off );
00241 
00242     <span class="keywordflow">if</span> (_is_2d_enabled) {
00243 <span class="comment">//      cout &lt;&lt; endl&lt;&lt;endl;</span>
00244 <span class="comment">//      cout &lt;&lt; "Generating total 2D image..." &lt;&lt;endl;</span>
00245             <a class="code" href="classCutter.html#a17">generateImage</a>( total_on, total_off, _outdir, 
00246                            _sourcenames.back(),<span class="keyword">true</span>);
00247     }
00248 
00249     <span class="keywordflow">return</span> prstats;
00250 
00251 }
00252 
00253 
00257 <span class="keywordtype">void</span>
00258 <a class="code" href="classCutter.html#a12">Cutter::</a>
<a name="l00259"></a><a class="code" href="classCutter.html#a12">00259</a> <a class="code" href="classCutter.html#a12">outputStatistics</a>() {
00260 
00261     <span class="keywordtype">double</span> excess, trexcess, alltrexcess;
00262     RunStatistics stats;
00263 
00264     <a class="code" href="classLogger.html">Logger</a> *logger = Logger::instance();
00265 
00266     <span class="keywordflow">if</span> (_onruns.size() != _offruns.size()) {
00267         logger-&gt;<a class="code" href="classLogger.html#a0">printf</a>(<span class="stringliteral">"Number of ON runs does not match OFF runs!"</span>);
00268     }
00269 
00270     <span class="comment">// Print out/save stars in the Field of View:</span>
00271     outputStars();
00272     cout &lt;&lt; endl;
00273     
00274     <span class="comment">// Check for pointing offsets by cross-correlating the sky</span>
00275     <span class="comment">// brightness maps!</span>
00276     
00277     <span class="keywordflow">if</span> (_is_2d_enabled &amp;&amp; _pointing_check_is_enabled) 
00278         <a class="code" href="classCutter.html#a21">checkPointing</a>();
00279 
00280     <span class="comment">// Accumulate total statistics</span>
00281 
00282     <a class="code" href="structCutRecord.html">CutRecord</a> total_on, total_off, total_trk, total_all;
00283 
00284     total_on  = getTotal( _onruns );
00285     total_off = getTotal( _offruns );
00286     total_trk = getTotal( _trackruns );
00287     total_all.<a class="code" href="structCutRecord.html#a2">addValuesFrom</a>(total_on);
00288     total_all.<a class="code" href="structCutRecord.html#a2">addValuesFrom</a>(total_trk);
00289 
00290     <span class="comment">// Per Run summary:</span>
00291 
00292     cout &lt;&lt; <span class="stringliteral">"Pair Analysis: "</span> &lt;&lt; endl;
00293     <span class="keywordflow">if</span> (_onruns.size() &gt;0) {
00294         cout &lt;&lt; hline &lt;&lt; endl;
00295         printCutRecordFields(cout);
00296         cout &lt;&lt; hline &lt;&lt; endl;
00297         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;(<span class="keywordtype">int</span>)_onruns.size(); i++) {
00298             cout &lt;&lt; _onruns[i]  &lt;&lt; endl;
00299             cout &lt;&lt; _offruns[i] &lt;&lt; endl;
00300         }
00301         <span class="comment">//PFR: changed elevation to zenith</span>
00302         cout &lt;&lt; hline &lt;&lt; endl;
00303         cout &lt;&lt; <span class="stringliteral">"PAIR                       EXCESS         SIGNIF     &lt;ZENITH&gt;"</span>&lt;&lt;endl;
00304         cout &lt;&lt; hline &lt;&lt; endl;
00305         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;(<span class="keywordtype">int</span>)_onruns.size(); i++) {
00306             stats = getPairStatistics( _onruns[i], _offruns[i] );
00307             cout &lt;&lt; _onruns[i].runid &lt;&lt;<span class="stringliteral">"/"</span>&lt;&lt;_offruns[i].runid 
00308                  &lt;&lt; setw(15-_onruns[i].runid.length()-_offruns[i].runid.length()) &lt;&lt; <span class="stringliteral">" "</span>
00309                  &lt;&lt; setw(16) &lt;&lt; stats.excess
00310                  &lt;&lt; setw(16) &lt;&lt; stats.significance 
00311                  &lt;&lt; setw(16) &lt;&lt; 90.0 - _onruns[i].average_elevation*180.0/M_PI
00312                  &lt;&lt; endl;
00313         }
00314 
00315     }
00316 
00317     cout &lt;&lt; endl&lt;&lt;endl;
00318     cout &lt;&lt; <span class="stringliteral">"Tracking Analysis: "</span>&lt;&lt; endl;
00319 
00320     <span class="keywordflow">if</span> ( _trackruns.size() &gt; 0 ) {
00321         cout &lt;&lt; hline &lt;&lt; endl;
00322         printCutRecordFields(cout);
00323         cout &lt;&lt; hline &lt;&lt; endl;
00324         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;(<span class="keywordtype">int</span>)_trackruns.size(); i++) {
00325             cout &lt;&lt; _trackruns[i] &lt;&lt; endl;
00326         }
00327 
00328     }
00329     <span class="comment">//PFR: changed elevation to zenith</span>
00330     cout &lt;&lt; hline &lt;&lt; endl;
00331     cout &lt;&lt; <span class="stringliteral">"RUN                        EXCESS         SIGNIF     &lt;ZENITH&gt;"</span>
00332          &lt;&lt; endl;
00333     cout &lt;&lt; hline &lt;&lt; endl;
00334     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;(<span class="keywordtype">int</span>)_trackruns.size(); i++) {
00335         stats = getTrackingStatistics( _trackruns[i], _track_ratio );
00336         cout &lt;&lt; _trackruns[i].runid &lt;&lt; setw(16-_trackruns[i].runid.length())&lt;&lt; <span class="stringliteral">" "</span>
00337              &lt;&lt; setw(16) &lt;&lt; stats.excess 
00338              &lt;&lt; setw(16) &lt;&lt; stats.significance 
00339              &lt;&lt; setw(16) &lt;&lt; 90.0 - _trackruns[i].average_elevation*180.0/M_PI
00340              &lt;&lt; endl;
00341     }
00342     
00343     cout &lt;&lt; <span class="stringliteral">"ON runs analyzed as tracking:"</span>&lt;&lt;endl;
00344     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;(<span class="keywordtype">int</span>)_onruns.size(); i++) {
00345         stats = getTrackingStatistics( _onruns[i], _track_ratio );
00346         cout &lt;&lt; _onruns[i].runid &lt;&lt; setw(16-_onruns[i].runid.length())&lt;&lt; <span class="stringliteral">" "</span>
00347              &lt;&lt; setw(16) &lt;&lt; stats.excess 
00348              &lt;&lt; setw(16) &lt;&lt; stats.significance 
00349              &lt;&lt; setw(16) &lt;&lt; 90.0 - _onruns[i].average_elevation*180.0/M_PI
00350              &lt;&lt; endl;
00351     }
00352     
00353     <a class="code" href="classCutter.html#a22">checkDiagnostics</a>();
00354 
00355     <span class="comment">// print out summary</span>
00356 
00357     cout &lt;&lt; endl;
00358     cout &lt;&lt; <span class="stringliteral">"Combined Analysis:"</span> &lt;&lt; endl;
00359     cout &lt;&lt; <span class="stringliteral">"============================================="</span>
00360          &lt;&lt; <span class="stringliteral">"=================================="</span> &lt;&lt;  endl
00361          &lt;&lt; <span class="stringliteral">"(TOTALS)                    ON            OFF          TRACK   ALL-AS-TRACK"</span>
00362          &lt;&lt; endl
00363          &lt;&lt; <span class="stringliteral">"============================================="</span>
00364          &lt;&lt; <span class="stringliteral">"=================================="</span> &lt;&lt;  endl;
00365     cout &lt;&lt; <span class="stringliteral">"RUNS         : "</span> 
00366          &lt;&lt; setw(15) &lt;&lt; (<span class="keywordtype">int</span>) _onruns.size()
00367          &lt;&lt; setw(15) &lt;&lt; (<span class="keywordtype">int</span>) _offruns.size()
00368          &lt;&lt; setw(15) &lt;&lt; (<span class="keywordtype">int</span>) _trackruns.size()
00369          &lt;&lt; setw(15) &lt;&lt; (<span class="keywordtype">int</span>) _trackruns.size() + (<span class="keywordtype">int</span>)_onruns.size()
00370          &lt;&lt; endl;
00371 
00372     cout &lt;&lt; <span class="stringliteral">"DURATION     : "</span> 
00373          &lt;&lt; setw(15) &lt;&lt; total_on.<a class="code" href="structCutRecord.html#o7">duration</a>
00374          &lt;&lt; setw(15) &lt;&lt; total_off.<a class="code" href="structCutRecord.html#o7">duration</a>
00375          &lt;&lt; setw(15) &lt;&lt; total_trk.<a class="code" href="structCutRecord.html#o7">duration</a>
00376          &lt;&lt; setw(15) &lt;&lt; total_all.<a class="code" href="structCutRecord.html#o7">duration</a>
00377          &lt;&lt; endl;
00378 
00379     cout &lt;&lt; <span class="stringliteral">"TOTAL EVENTS : "</span> 
00380          &lt;&lt; setw(15) &lt;&lt; total_on.<a class="code" href="structCutRecord.html#o1">total</a>
00381          &lt;&lt; setw(15) &lt;&lt; total_off.<a class="code" href="structCutRecord.html#o1">total</a>
00382          &lt;&lt; setw(15) &lt;&lt; total_trk.<a class="code" href="structCutRecord.html#o1">total</a> 
00383          &lt;&lt; setw(15) &lt;&lt; total_all.<a class="code" href="structCutRecord.html#o1">total</a> 
00384          &lt;&lt; endl;
00385 
00386     cout &lt;&lt; <span class="stringliteral">"VALID EVENTS : "</span> 
00387          &lt;&lt; setw(15) &lt;&lt; total_on.<a class="code" href="structCutRecord.html#o2">valid</a>
00388          &lt;&lt; setw(15) &lt;&lt; total_off.<a class="code" href="structCutRecord.html#o2">valid</a>  
00389          &lt;&lt; setw(15) &lt;&lt; total_trk.<a class="code" href="structCutRecord.html#o2">valid</a> 
00390          &lt;&lt; setw(15) &lt;&lt; total_all.<a class="code" href="structCutRecord.html#o2">valid</a> 
00391          &lt;&lt; endl;
00392 
00393     cout &lt;&lt; <span class="stringliteral">"PASS TRIG    : "</span> 
00394          &lt;&lt; setw(15) &lt;&lt; total_on.<a class="code" href="structCutRecord.html#o3">trigger</a>  
00395          &lt;&lt; setw(15) &lt;&lt; total_off.<a class="code" href="structCutRecord.html#o3">trigger</a>  
00396          &lt;&lt; setw(15) &lt;&lt; total_trk.<a class="code" href="structCutRecord.html#o3">trigger</a>  
00397          &lt;&lt; setw(15) &lt;&lt; total_all.<a class="code" href="structCutRecord.html#o3">trigger</a>  
00398          &lt;&lt; endl;
00399 
00400     cout &lt;&lt; <span class="stringliteral">"PASS SHAPE   : "</span> 
00401          &lt;&lt; setw(15) &lt;&lt; total_on.<a class="code" href="structCutRecord.html#o4">shape</a>    
00402          &lt;&lt; setw(15) &lt;&lt; total_off.<a class="code" href="structCutRecord.html#o4">shape</a>    
00403          &lt;&lt; setw(15) &lt;&lt; total_trk.<a class="code" href="structCutRecord.html#o4">shape</a>     
00404          &lt;&lt; setw(15) &lt;&lt; total_all.<a class="code" href="structCutRecord.html#o4">shape</a>     
00405          &lt;&lt; endl;
00406 
00407     cout &lt;&lt; <span class="stringliteral">"PASS ORIENT  : "</span> 
00408          &lt;&lt; setw(15) &lt;&lt; total_on.<a class="code" href="structCutRecord.html#o5">orientation</a>      
00409          &lt;&lt; setw(15) &lt;&lt; total_off.<a class="code" href="structCutRecord.html#o5">orientation</a>
00410          &lt;&lt; setw(15) &lt;&lt; total_trk.<a class="code" href="structCutRecord.html#o5">orientation</a>       
00411          &lt;&lt; setw(15) &lt;&lt; total_all.<a class="code" href="structCutRecord.html#o5">orientation</a>       
00412          &lt;&lt; endl;
00413 
00414     cout &lt;&lt; endl
00415          &lt;&lt;<span class="stringliteral">"TRACK OFF    : "</span> 
00416          &lt;&lt; setw(15) &lt;&lt; total_on.<a class="code" href="structCutRecord.html#o6">trackoff</a>      
00417          &lt;&lt; setw(15) &lt;&lt; total_off.<a class="code" href="structCutRecord.html#o6">trackoff</a>
00418          &lt;&lt; setw(15) &lt;&lt; total_trk.<a class="code" href="structCutRecord.html#o6">trackoff</a>
00419          &lt;&lt; setw(15) &lt;&lt; total_all.<a class="code" href="structCutRecord.html#o6">trackoff</a>
00420          &lt;&lt; endl;
00421 
00422     
00423     cout &lt;&lt; endl
00424          &lt;&lt; <span class="stringliteral">"============================================="</span>
00425          &lt;&lt; <span class="stringliteral">"=================================="</span> &lt;&lt;  endl
00426          &lt;&lt; <span class="stringliteral">"(STATISTICS)            ON/OFF       TRACKING   ALL-AS-TRACK"</span>
00427          &lt;&lt; endl
00428          &lt;&lt; <span class="stringliteral">"============================================="</span>
00429          &lt;&lt; <span class="stringliteral">"=================================="</span> &lt;&lt;  endl;
00430 
00431     RunStatistics allstats, prstats, trstats;
00432 
00433     allstats = getTrackingStatistics( total_all, _track_ratio );
00434     trstats = getTrackingStatistics( total_trk, _track_ratio );
00435     prstats = getPairStatistics( total_on, total_off );
00436   
00437     cout &lt;&lt; <span class="stringliteral">"EXCESS       : "</span>
00438          &lt;&lt; setw(15) &lt;&lt; prstats.excess
00439          &lt;&lt; setw(15) &lt;&lt; trstats.excess
00440          &lt;&lt; setw(15) &lt;&lt; allstats.excess
00441          &lt;&lt;endl;
00442 
00443     cout &lt;&lt; <span class="stringliteral">"SIGNIFICANCE : "</span>
00444          &lt;&lt; setw(15) &lt;&lt; prstats.significance
00445          &lt;&lt; setw(15) &lt;&lt; trstats.significance
00446          &lt;&lt; setw(15) &lt;&lt; allstats.significance
00447          &lt;&lt;endl;
00448 
00449     cout.precision(8);
00450 
00451     cout &lt;&lt; endl
00452          &lt;&lt; <span class="stringliteral">"Tracking results used a tracking ratio of "</span> 
00453          &lt;&lt; _track_ratio &lt;&lt; endl 
00454          &lt;&lt; <span class="stringliteral">"On/Off results used a on/off duration ratio of "</span> 
00455          &lt;&lt; total_on.<a class="code" href="structCutRecord.html#o7">duration</a>/total_off.<a class="code" href="structCutRecord.html#o7">duration</a> &lt;&lt; endl
00456          &lt;&lt; endl;
00457 
00458     <span class="keywordflow">if</span> (_offruns.size() &gt; 0) {
00459         cout &lt;&lt; <span class="stringliteral">"The derived tracking ratio from "</span> &lt;&lt; _offruns.size()
00460              &lt;&lt; <span class="stringliteral">" off runs is "</span>
00461              &lt;&lt; (<span class="keywordtype">double</span>)total_off.<a class="code" href="structCutRecord.html#o6">trackoff</a>/(<span class="keywordtype">double</span>)total_off.<a class="code" href="structCutRecord.html#o5">orientation</a> 
00462              &lt;&lt; endl;
00463         cout &lt;&lt; <span class="stringliteral">"'off-alpha' for ON runs : "</span>&lt;&lt;total_on.<a class="code" href="structCutRecord.html#o6">trackoff</a> &lt;&lt; endl;
00464         cout &lt;&lt; <span class="stringliteral">"'off-alpha' for OFF runs: "</span>&lt;&lt;total_off.<a class="code" href="structCutRecord.html#o6">trackoff</a> &lt;&lt; endl;
00465         cout &lt;&lt; <span class="stringliteral">"'off-alpha' ON/OFF ratio: "</span>
00466              &lt;&lt;(<span class="keywordtype">double</span>)total_on.<a class="code" href="structCutRecord.html#o6">trackoff</a>/(<span class="keywordtype">double</span>)total_off.<a class="code" href="structCutRecord.html#o6">trackoff</a>
00467              &lt;&lt;endl;
00468        }
00469 
00470 
00471     _alpha_on-&gt;<a class="code" href="classHistogram.html#a13">save</a>(_outdir+<span class="stringliteral">"alpha-total-on"</span>);
00472     _alpha_off-&gt;<a class="code" href="classHistogram.html#a13">save</a>(_outdir+<span class="stringliteral">"alpha-total-off"</span>);
00473     _energy_on-&gt;<a class="code" href="classHistogram.html#a13">save</a>(_outdir+<span class="stringliteral">"energy-total-on"</span>);
00474     _energy_track-&gt;save(_outdir+<span class="stringliteral">"energy-total-track"</span>);
00475     _energy_off-&gt;save(_outdir+<span class="stringliteral">"energy-total-off"</span>);
00476     _size_on-&gt;<a class="code" href="classHistogram.html#a13">save</a>(_outdir +<span class="stringliteral">"size-total-on"</span>);
00477     _size_off-&gt;<a class="code" href="classHistogram.html#a13">save</a>(_outdir +<span class="stringliteral">"size-total-off"</span>);
00478 
00479     <span class="comment">// Generate 2d plots</span>
00480 
00481     <span class="keywordflow">if</span> (_is_2d_enabled) {
00482         cout &lt;&lt; endl&lt;&lt;endl;
00483         cout &lt;&lt; <span class="stringliteral">"Generating total 2D image..."</span> &lt;&lt;endl;
00484         <span class="keywordflow">if</span> (_onruns.size()&gt;0) 
00485             <a class="code" href="classCutter.html#a17">generateImage</a>( total_on, total_off, 
00486                            _outdir, _sourcenames.back(),<span class="keyword">true</span>);
00487 
00488         <span class="keywordflow">if</span> (_trackruns.size()&gt;0) {
00489 
00490             <a class="code" href="structCutRecord.html">CutRecord</a> fake;
00491             
00492             fake.<a class="code" href="structCutRecord.html#o7">duration</a> = total_trk.<a class="code" href="structCutRecord.html#o7">duration</a>;
00493 
00494             <a class="code" href="classCutter.html#a17">generateImage</a>( total_trk, fake, 
00495                            _outdir, 
00496                            _sourcenames.back()+<span class="stringliteral">" (tracking)"</span>,<span class="keyword">true</span>);
00497             
00498         }
00499     }
00500 
00501 
00502     <span class="comment">// Sanity checks</span>
00503 
00504     <a class="code" href="classCutter.html#a22">checkDiagnostics</a>();
00505 
00506 }
00507 
00511 <span class="keywordtype">void</span>
00512 <a class="code" href="classCutter.html#a21">Cutter::</a>
<a name="l00513"></a><a class="code" href="classCutter.html#a21">00513</a> <a class="code" href="classCutter.html#a21">checkPointing</a>() {
00514 
00515     <span class="keywordtype">int</span> numruns = _onruns.size();
00516     <a class="code" href="classImage2D.html">Image2D</a> *xcor;
00517     <a class="code" href="classImage2D.html">Image2D</a> *source;
00518     <span class="keywordtype">int</span> ix,iy;
00519     <span class="keywordtype">int</span> ci[numruns][numruns];
00520     <span class="keywordtype">int</span> cj[numruns][numruns];
00521 
00522     <span class="keywordtype">double</span> xsum,ysum;
00523     <span class="keywordtype">int</span> ixp, iyp;
00524     <span class="keywordtype">int</span> n;
00525     <span class="keywordtype">double</span> denom;
00526     <span class="keywordtype">double</span> weight;
00527     <span class="keywordtype">char</span> filename[128];
00528 
00529     <span class="keywordflow">if</span> (numruns &lt;= 0) <span class="keywordflow">return</span>;
00530 
00531     _corr_centroid.resize(numruns);
00532     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;numruns; i++)
00533         _corr_centroid[i].resize(numruns);
00534     
00535 
00536     cout &lt;&lt; <span class="stringliteral">"Cross-correlating the skybrightness maps..."</span> &lt;&lt; endl;
00537     <a class="code" href="classProgressBar.html">ProgressBar</a> prog(((numruns-1)*(numruns-1))/2);
00538     <span class="keywordtype">int</span> count=0;
00539 
00540     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;numruns; i++){
00541         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;numruns; j++){
00542             _corr_centroid[i][j].x = 0;
00543             _corr_centroid[i][j].y = 0;
00544         }
00545     }
00546 
00547     <span class="comment">// Loop over all possible pairs of runs...</span>
00548 
00549     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;numruns-1; i++) {
00550         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=i+1; j&lt;numruns; j++) {
00551 
00552             prog.<a class="code" href="classProgressBar.html#a2">print</a>(count);
00553             count++;
00554             
00555             source = &amp;(_onruns[i].skybright);
00556             xcor = source-&gt;<a class="code" href="classImage2D.html#a27">crossCorrelateWith</a>( _onruns[j].skybright );
00557             xcor-&gt;<a class="code" href="classImage2D.html#a25">getIndexOfMax</a>( ix,iy );
00558 
00559             <span class="keywordflow">if</span> (ix&lt;xcor-&gt;<a class="code" href="classImage2D.html#a21">getXDim</a>() &amp;&amp; iy&lt;xcor-&gt;<a class="code" href="classImage2D.html#a22">getYDim</a>()) {
00560                 ci[i][j] = ix;
00561                 cj[i][j] = iy;
00562             }
00563             <span class="keywordflow">else</span> {
00564                 cout &lt;&lt; <span class="stringliteral">"ERROR: ix="</span>&lt;&lt;ix&lt;&lt;<span class="stringliteral">" iy="</span>&lt;&lt;iy&lt;&lt; endl;
00565                 ci[i][j] = 0;
00566                 cj[i][j] = 0;
00567             }
00568 
00569             <span class="comment">// find the centroid about the max</span>
00570             xsum=0;
00571             ysum=0;
00572             n=0;
00573             denom=0;
00574             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=-_centroid_range; k&lt;=_centroid_range; k++) {
00575                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> l=-_centroid_range; l&lt;=_centroid_range; l++) {
00576 
00577                     ixp = (ix + k + xcor-&gt;<a class="code" href="classImage2D.html#a21">getXDim</a>() ) % xcor-&gt;<a class="code" href="classImage2D.html#a21">getXDim</a>();
00578                     iyp = (iy + l + xcor-&gt;<a class="code" href="classImage2D.html#a22">getYDim</a>() ) % xcor-&gt;<a class="code" href="classImage2D.html#a22">getYDim</a>();
00579 
00580                     weight = xcor-&gt;<a class="code" href="classImage2D.html#a14">getPixel</a>( ixp,iyp );
00581 
00582                     xsum += weight * xcor-&gt;<a class="code" href="classImage2D.html#a2">getXCoord</a>(ixp);
00583                     ysum += weight * xcor-&gt;<a class="code" href="classImage2D.html#a3">getYCoord</a>(iyp);
00584                     denom += weight;
00585   
00586                     n++;
00587         
00588                 }
00589             }
00590 
00591             <span class="comment">// store the centroid positions</span>
00592 
00593             _corr_centroid[i][j].x = xsum/denom;
00594             _corr_centroid[i][j].y = ysum/denom;
00595             _corr_centroid[j][i].x = xsum/denom;
00596             _corr_centroid[j][i].y = ysum/denom;
00597 
00598 
00599             <span class="keywordflow">if</span> (i==0) {
00600                 sprintf(filename, <span class="stringliteral">"%s/cross-corr-%s-%s"</span>, _outdir.c_str(),
00601                         _onruns[i].runid.c_str(), _onruns[j].runid.c_str());
00602                 xcor-&gt;<a class="code" href="classImage2D.html#a9">save</a>(filename);
00603             }
00604 
00605             <span class="keyword">delete</span> xcor;
00606         }
00607     }
00608 
00609     prog.<a class="code" href="classProgressBar.html#a3">printClear</a>();
00610 
00611     string fname = _outdir+<span class="stringliteral">"cross-corr-centers.dat"</span>;
00612     ofstream centfile( fname.c_str() );
00613     centfile &lt;&lt; <span class="stringliteral">"Cross-correlation center pixels: "</span>&lt;&lt; endl;
00614     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;numruns; i++) {
00615         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=i+1; j&lt;numruns; j++) {
00616             centfile &lt;&lt; <span class="stringliteral">"("</span>&lt;&lt;ci[i][j]&lt;&lt;<span class="stringliteral">","</span>&lt;&lt;cj[i][j]&lt;&lt;<span class="stringliteral">")\t"</span>;
00617         }
00618         centfile &lt;&lt; endl;
00619     }
00620 
00621     centfile &lt;&lt; <span class="stringliteral">"Cross-correlation center positions: "</span>&lt;&lt; endl;
00622     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;numruns; i++) {
00623         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=i+1; j&lt;numruns; j++) {
00624             centfile &lt;&lt; <span class="stringliteral">"("</span>&lt;&lt;_corr_centroid[i][j].x&lt;&lt;<span class="stringliteral">","</span>
00625                  &lt;&lt;_corr_centroid[i][j].y&lt;&lt;<span class="stringliteral">")\t"</span>;
00626         }
00627         centfile &lt;&lt; endl;
00628     }
00629     centfile.close();
00630 
00631     <span class="comment">// figure out which runs seem mismatched and output warning</span>
00632     <span class="comment">// messages</span>
00633 
00634     <span class="keywordtype">double</span> offs;
00635     <span class="keywordtype">float</span> badruns[numruns];
00636     <span class="keywordtype">int</span> nbadruns[numruns];
00637     <span class="keywordtype">int</span> bestrun;
00638     <span class="keywordtype">float</span> minbad=99999;
00639     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;numruns; i++) {
00640         badruns[i] = 0;
00641         nbadruns[i] =0;
00642     }
00643 
00644     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;numruns; i++) {
00645         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=i+1; j&lt;numruns; j++) {
00646             offs = hypot(_corr_centroid[i][j].x, _corr_centroid[i][j].y);
00647             <span class="keywordflow">if</span> (offs &gt; 0.1){
00648                 badruns[i]+=offs;
00649                 badruns[j]+=offs;
00650                 nbadruns[i]++;
00651                 nbadruns[j]++;
00652             }
00653         }
00654     }
00655 
00656     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;numruns; i++) {
00657         <span class="keywordflow">if</span> (badruns[i] &lt; minbad) {
00658             minbad = badruns[i];
00659             bestrun=i;
00660         }
00661     }
00662 
00663     cout &lt;&lt; <span class="stringliteral">"Run with least pointing offset: "</span>&lt;&lt;_onruns[bestrun].runid&lt;&lt;endl;
00664         
00665     cout &lt;&lt; <span class="stringliteral">"Pointing offsets relative to "</span>&lt;&lt;_onruns[bestrun].runid
00666          &lt;&lt; <span class="stringliteral">" and  mismatch level:"</span> &lt;&lt; endl;
00667 
00668     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;numruns; i++) {
00669         
00670         offs = hypot(_corr_centroid[bestrun][i].x,
00671                      _corr_centroid[bestrun][i].y);
00672 
00673         cout &lt;&lt; _onruns[i].runid &lt;&lt; <span class="stringliteral">" "</span>
00674              &lt;&lt; setw(10)&lt;&lt; offs
00675              &lt;&lt; setw(10)&lt;&lt; badruns[i]
00676              &lt;&lt; setw(10)&lt;&lt; nbadruns[i];
00677         <span class="keywordflow">if</span> (offs &gt; 0.1){
00678             cout &lt;&lt; <span class="stringliteral">" ** BAD?"</span>;
00679         }
00680         cout &lt;&lt; endl;
00681     }
00682 
00683     <span class="comment">// Output first row of cross correlations to a file</span>
00684     fname = _outdir+<span class="stringliteral">"cross-correlation.dat"</span>;
00685     cout &lt;&lt; <span class="stringliteral">"See "</span>&lt;&lt; fname &lt;&lt; <span class="stringliteral">" for detailed pointing offset data"</span>&lt;&lt; endl;
00686     ofstream corrfile( fname.c_str() );
00687     corrfile &lt;&lt; <span class="stringliteral">"Comparison with run "</span>&lt;&lt;_onruns[bestrun].runid &lt;&lt;endl;
00688     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;numruns; j++) {
00689         corrfile &lt;&lt; <span class="stringliteral">"# "</span>&lt;&lt;_onruns[j].runid  &lt;&lt;endl
00690                  &lt;&lt;<span class="stringliteral">"XAlign="</span> &lt;&lt;_corr_centroid[bestrun][j].x &lt;&lt;endl
00691                  &lt;&lt;<span class="stringliteral">"YAlign="</span> &lt;&lt; _corr_centroid[bestrun][j].y &lt;&lt;endl
00692                  &lt;&lt; endl;
00693     }
00694     corrfile.close();
00695 
00696     <span class="comment">// output again in a machine readable format for alignment</span>
00697     
00698     ofstream alignfile;
00699     
00700     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;numruns; i++) {
00701         fname = _outdir+<span class="stringliteral">"alignment_to_"</span>+_onruns[i].runid+<span class="stringliteral">".align"</span>;
00702         alignfile.open( fname.c_str() );
00703         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;numruns; j++) {
00704             alignfile &lt;&lt; _onruns[j].runid &lt;&lt; <span class="stringliteral">" "</span>
00705                       &lt;&lt;_corr_centroid[i][j].x &lt;&lt; <span class="stringliteral">" "</span>
00706                       &lt;&lt; _corr_centroid[i][j].y 
00707                       &lt;&lt; endl;
00708         }
00709         alignfile.close();
00710     }
00711 
00712 }
00713 
00714 <span class="keywordtype">void</span>
00715 Cutter::
00716 outputStars(){
00717 
00718     list&lt;Star&gt;::iterator star;
00719     string prevname;
00720     <span class="keywordtype">int</span> oncount=0;
00721     <span class="keywordtype">int</span> offcount=0;
00722 
00723     <span class="comment">// First, lets sort the star list by name so we can deal with</span>
00724     <span class="comment">// duplicates easier.</span>
00725 
00726     _onstars.sort();
00727     _offstars.sort();
00728 
00729     <span class="comment">// Mark duplicates by setting their catalog_id to something &gt; 0</span>
00730     <span class="comment">// (Stars with catalog_id==0 are plotted with names in the IDL</span>
00731     <span class="comment">// plotting script)</span>
00732 
00733     <span class="keywordflow">for</span> (star=_onstars.begin(); star!=_onstars.end(); star++) {
00734         <span class="keywordflow">if</span> (star-&gt;name != prevname || star == _onstars.begin()) {
00735             prevname = star-&gt;name;
00736             oncount++;
00737         }
00738         <span class="keywordflow">else</span> {
00739             star-&gt;catalog_id++;
00740         }
00741     }
00742 
00743     <span class="keywordflow">for</span> (star=_offstars.begin(); star!=_offstars.end(); star++) {
00744         <span class="keywordflow">if</span> (star-&gt;name != prevname || star == _offstars.begin()) {
00745             prevname = star-&gt;name;
00746             offcount++;
00747         }
00748         <span class="keywordflow">else</span> {
00749             star-&gt;catalog_id++;
00750         }
00751     }
00752 
00753 
00754     <span class="comment">// Now, write the star positions to a text file, for easy plotting</span>
00755 
00756     writeStarList( _onstars, _outdir+<span class="stringliteral">"nearbystars-on.dat"</span> );
00757     writeStarList( _offstars, _outdir+<span class="stringliteral">"nearbystars-off.dat"</span> );
00758 
00759 
00760     <span class="comment">// Remove duplicates and write star names to screen</span>
00761 
00762     _onstars.unique();
00763     _offstars.unique();
00764 
00765     cout &lt;&lt; <span class="stringliteral">"BRIGHT STARS IN ON-SOURCE FOV:"</span>&lt;&lt; endl;
00766     <span class="keywordflow">for</span> (star=_onstars.begin(); star!=_onstars.end(); star++) {
00767         <span class="keywordflow">if</span> (star-&gt;magnitude &lt; 6) {
00768             cout &lt;&lt; <span class="stringliteral">"\t'"</span>&lt;&lt;star-&gt;name
00769                  &lt;&lt; <span class="stringliteral">"', "</span>&lt;&lt;<span class="stringliteral">"magnitude "</span>&lt;&lt; star-&gt;magnitude
00770                  &lt;&lt; <span class="stringliteral">", "</span>&lt;&lt;<span class="stringliteral">"at "</span>&lt;&lt;setprecision(4)
00771                  &lt;&lt; hypot(star-&gt;tx,star-&gt;ty)&lt;&lt;<span class="stringliteral">" deg from "</span>
00772                  &lt;&lt; <span class="stringliteral">"camera center"</span>
00773                  &lt;&lt; endl;
00774         }
00775     }
00776 
00777     cout &lt;&lt; <span class="stringliteral">"BRIGHT STARS IN OFF-SOURCE FOV:"</span>&lt;&lt; endl;
00778     <span class="keywordflow">for</span> (star=_offstars.begin(); star!=_offstars.end(); star++) {
00779         <span class="keywordflow">if</span> (star-&gt;magnitude &lt; 6) {
00780             cout &lt;&lt; <span class="stringliteral">"\t'"</span>&lt;&lt;star-&gt;name
00781                  &lt;&lt; <span class="stringliteral">"', "</span>&lt;&lt;<span class="stringliteral">"magnitude "</span>&lt;&lt; star-&gt;magnitude
00782                  &lt;&lt; <span class="stringliteral">", "</span>&lt;&lt;<span class="stringliteral">"at "</span>&lt;&lt;setprecision(4)
00783                  &lt;&lt; hypot(star-&gt;tx,star-&gt;ty)&lt;&lt;<span class="stringliteral">" deg from "</span>
00784                  &lt;&lt; <span class="stringliteral">"camera center"</span>
00785                  &lt;&lt; endl;
00786         }
00787     }
00788 
00789 }
00790 
00791 <span class="keywordtype">void</span> 
00792 Cutter::
00793 writeStarList( list&lt;Star&gt; &amp;starlist, string filename ) {
00794 
00795     list&lt;Star&gt;::iterator star;
00796 
00797     ofstream starfile( filename.c_str() );
00798     <span class="keywordflow">if</span> (starfile.fail())
00799         <span class="keywordflow">throw</span> <a class="code" href="classMildAnalysisException.html">MildAnalysisException</a>(<span class="stringliteral">"Couldn't write star file: "</span>+filename);
00800 
00801     <span class="keywordflow">if</span> (starlist.size()==0) <span class="keywordflow">return</span>;
00802 
00803     starfile &lt;&lt; starlist.size() &lt;&lt; endl;
00804 
00805     <span class="keywordflow">for</span> (star=starlist.begin(); star!=starlist.end(); star++) {
00806 
00807         starfile &lt;&lt; *star &lt;&lt; endl;
00808 
00809     }
00810     
00811     starfile.close();
00812 
00813 }
00814 
00815 
00816 
00830 <span class="keywordtype">void</span>
00831 <a class="code" href="classCutter.html#a17">Cutter::</a>
<a name="l00832"></a><a class="code" href="classCutter.html#a17">00832</a> <a class="code" href="classCutter.html#a17">generateImage</a>(<a class="code" href="structCutRecord.html">CutRecord</a> &amp;on, <a class="code" href="structCutRecord.html">CutRecord</a> &amp;off, string dir, string title,
00833               <span class="keywordtype">bool</span> finalimage){
00834 
00835     <span class="keywordtype">int</span> i,j;
00836     <span class="keywordtype">double</span> x,y;
00837     <a class="code" href="classImage2D.html">Image2D</a> excess2d(_image_xdim,_image_ydim);
00838     <a class="code" href="classImage2D.html">Image2D</a> signif2d(_image_xdim,_image_ydim);
00839     <a class="code" href="classImage2D.html">Image2D</a> ra2d(_image_xdim,_image_ydim);
00840     <a class="code" href="classImage2D.html">Image2D</a> dec2d(_image_xdim,_image_ydim);
00841 
00842     <span class="keywordtype">double</span> minx,maxx,miny,maxy;
00843     list&lt;Star&gt;::iterator star;
00844     <a class="code" href="classImage2D.html">Image2D</a> onimage = on.<a class="code" href="structCutRecord.html#o9">im2d</a>;   <span class="comment">// store on and off images so we're</span>
00845     <a class="code" href="classImage2D.html">Image2D</a> offimage = off.<a class="code" href="structCutRecord.html#o9">im2d</a>; <span class="comment">// no smoothing the original</span>
00846     <span class="keywordtype">double</span> a = on.<a class="code" href="structCutRecord.html#o7">duration</a> / off.<a class="code" href="structCutRecord.html#o7">duration</a>; 
00847     <span class="keywordtype">double</span> non, noff;
00848 
00849     <span class="keywordtype">char</span> telid[100];
00850     sprintf( telid, <span class="stringliteral">"%d"</span>, _telescope_id );
00851 
00852 
00853 
00854     <span class="comment">// set up xplotmaker if it is not already there</span>
00855 
00856     <span class="keywordflow">if</span> (_display_is_enabled) {
00857         <span class="keywordflow">if</span> (_xplotmaker == NULL) {
00858             _xplotmaker = <span class="keyword">new</span> <a class="code" href="classPlotMaker.html">PlotMaker</a>( <span class="stringliteral">"X"</span>, <span class="stringliteral">"x.out"</span> );
00859         }
00860     }
00861 
00862     <span class="comment">// set initial values</span>
00863     
00864     minx = -_image_xdim*_degperpix/2.0;
00865     maxx = _image_xdim*_degperpix/2.0;
00866     miny = -_image_ydim*_degperpix/2.0;
00867     maxy = _image_ydim*_degperpix/2.0;
00868  
00869     excess2d.<a class="code" href="classImage2D.html#a1">setCoordinateBox</a>( minx,miny  , maxx,maxy );
00870     signif2d.<a class="code" href="classImage2D.html#a1">setCoordinateBox</a>( minx,miny  , maxx,maxy );
00871     ra2d.<a class="code" href="classImage2D.html#a1">setCoordinateBox</a>( minx,miny  , maxx,maxy );
00872     dec2d.<a class="code" href="classImage2D.html#a1">setCoordinateBox</a>( minx,miny  , maxx,maxy );
00873 
00874     <span class="comment">// If fast processing isn't enabled, rebin all of the points of</span>
00875     <span class="comment">// origin in the poolist vector using the more accurate</span>
00876     <span class="comment">// Image::addHistRadially() function.  Otherwise, just add up the</span>
00877     <span class="comment">// binned images and smooth afterward. The second method is much</span>
00878     <span class="comment">// faster, but works poorly when the smoothing radius is on the</span>
00879     <span class="comment">// order of the image's pixel spacing.</span>
00880 
00881     <span class="keywordflow">if</span> (_fast_image_processing_is_enabled == <span class="keyword">false</span>) {
00882 
00883         <a class="code" href="classImage2D.html">Image2D</a> tempon(_image_xdim,_image_ydim);  
00884         <a class="code" href="classImage2D.html">Image2D</a> tempoff(_image_xdim,_image_ydim);  
00885 
00886         tempon.<a class="code" href="classImage2D.html#a1">setCoordinateBox</a>( minx,miny  , maxx,maxy );
00887         tempoff.<a class="code" href="classImage2D.html#a1">setCoordinateBox</a>( minx,miny  , maxx,maxy );
00888         vector&lt;Coordinate_t&gt;::iterator coord;
00889         <span class="keywordtype">double</span> dist;
00890 
00891         <span class="keywordflow">for</span> (coord=on.<a class="code" href="structCutRecord.html#o12">poolist</a>.begin();coord!=on.<a class="code" href="structCutRecord.html#o12">poolist</a>.end();coord++) {
00892             tempon.<a class="code" href="classImage2D.html#a17">addHistRadially</a>(coord-&gt;x,coord-&gt;y,1.0,
00893                                    _radial_smoothing_factor);
00894         }
00895         <span class="keywordflow">for</span> (coord=off.<a class="code" href="structCutRecord.html#o12">poolist</a>.begin();coord!=off.<a class="code" href="structCutRecord.html#o12">poolist</a>.end();coord++) {
00896             tempoff.<a class="code" href="classImage2D.html#a17">addHistRadially</a>(coord-&gt;x,coord-&gt;y,1.0,
00897                                     _radial_smoothing_factor);
00898         }
00899         
00900         onimage = tempon;
00901         offimage=tempoff;
00902     }
00903     <span class="keywordflow">else</span> {
00904         <span class="comment">// do it the fast, but less accurate way</span>
00905         onimage.<a class="code" href="classImage2D.html#a20">applyRadialSmoothing</a>( _radial_smoothing_factor );
00906         offimage.<a class="code" href="classImage2D.html#a20">applyRadialSmoothing</a>( _radial_smoothing_factor );
00907     }
00908 
00909     <span class="comment">// Do smoothing</span>
00910     
00911 <span class="comment">//     onimage.applyRadialSmoothing( _radial_smoothing_factor );</span>
00912 <span class="comment">//     offimage.applyRadialSmoothing( _radial_smoothing_factor );</span>
00913 
00914     <span class="comment">// Calculate significance and excess:</span>
00915 
00916     <span class="keywordflow">for</span> (i=0; i&lt;_image_xdim; i++) {
00917         <span class="keywordflow">for</span> (j=0; j&lt;_image_ydim; j++) {
00918 
00919             non = onimage.<a class="code" href="classImage2D.html#a14">getPixel</a>(i,j);
00920             noff = offimage.<a class="code" href="classImage2D.html#a14">getPixel</a>(i,j);
00921 
00922             <span class="comment">// Calculate the excess</span>
00923             excess2d.<a class="code" href="classImage2D.html#a13">setPixel</a>( i,j, non-noff*a);
00924 
00925             <span class="comment">// calculate significance for each point </span>
00926             signif2d.<a class="code" href="classImage2D.html#a13">setPixel</a>(i,j, <a class="code" href="classCutter.html#a15">maxLikelihoodSignif</a>(non,noff,a) );
00927 
00928         }
00929     }
00930 
00931 
00932     <span class="comment">// Calculate the RA/DEC coordinates of each gridpoint.  This</span>
00933     <span class="comment">// allows simple contour plotting to show ra/dec lines:</span>
00934 
00935     <span class="keywordflow">for</span> (i=0; i&lt;_image_xdim; i++) {
00936         <span class="keywordflow">for</span> (j=0; j&lt;_image_ydim; j++) {
00937 
00938             x = ra2d.<a class="code" href="classImage2D.html#a2">getXCoord</a>(i) * M_PI/180.0; <span class="comment">// these must be in radians</span>
00939             y = ra2d.<a class="code" href="classImage2D.html#a3">getYCoord</a>(j) * M_PI/180.0;
00940             
00941             dec2d.<a class="code" href="classImage2D.html#a13">setPixel</a>(i,j, (atan( ((sin(_dec) + y*cos(_dec))/
00942                                        (cos(_dec) - y*sin(_dec))) *
00943                                       cos( atan(-1.0*x/
00944                                                 (cos(_dec)-y*sin(_dec)))) ))
00945                            * 180.0/M_PI );
00946                            
00947             ra2d.<a class="code" href="classImage2D.html#a13">setPixel</a>(i,j, (_ra + atan(x/(y*sin(_dec)-cos(_dec))))*
00948                           12.0/M_PI );
00949 
00950         }
00951     }
00952 
00953     <span class="comment">// Output the 2d significance and excess:</span>
00954 
00955     ra2d.<a class="code" href="classImage2D.html#a9">save</a>( dir+<span class="stringliteral">"ra-mesh"</span> );
00956     dec2d.<a class="code" href="classImage2D.html#a9">save</a>( dir+<span class="stringliteral">"dec-mesh"</span> );
00957 
00958     excess2d.<a class="code" href="classImage2D.html#a9">save</a>( dir+<span class="stringliteral">"excess"</span>);
00959     signif2d.<a class="code" href="classImage2D.html#a9">save</a>( dir+<span class="stringliteral">"signif"</span>);
00960 
00961 <span class="comment">//     cout &lt;&lt; "DEBUG: "&lt;&lt;dir&lt;&lt;": 2d CENTER EXC,SIG: "</span>
00962 <span class="comment">//       &lt;&lt;excess2d.getPixel(19,19)&lt;&lt;" "</span>
00963 <span class="comment">//       &lt;&lt;signif2d.getPixel(19,19) &lt;&lt; endl;</span>
00964 
00965     <span class="comment">// Plot the final image to screen and a postscript file:</span>
00966 
00967     excess2d.<a class="code" href="classImage2D.html#a26">expand</a>(); <span class="comment">// make hi-res</span>
00968     signif2d.<a class="code" href="classImage2D.html#a26">expand</a>(); 
00969 
00970     vector&lt;PlotMaker*&gt; pm;
00971     
00972     <span class="keywordflow">if</span> (_display_is_enabled) {
00973         pm.resize(2);
00974         <span class="keywordflow">if</span> (!finalimage) {
00975             pm[0] = _xplotmaker;
00976             pm[1] = <span class="keyword">new</span> <a class="code" href="classPlotMaker.html">PlotMaker</a>( <span class="stringliteral">"PS"</span>, dir+<span class="stringliteral">"image.eps"</span> );
00977         }
00978         <span class="keywordflow">else</span> {
00979             pm[0] = <span class="keyword">new</span> <a class="code" href="classPlotMaker.html">PlotMaker</a>( <span class="stringliteral">"X"</span>, <span class="stringliteral">"x.out"</span> );
00980             pm[1] = <span class="keyword">new</span> PlotMaker( <span class="stringliteral">"PS"</span>, dir+<span class="stringliteral">"image.eps"</span> );
00981         }
00982     }
00983     <span class="keywordflow">else</span> {
00984         pm.resize(1);
00985         pm[0] = <span class="keyword">new</span> <a class="code" href="classPlotMaker.html">PlotMaker</a>( <span class="stringliteral">"PS"</span>, dir+<span class="stringliteral">"image.eps"</span> );
00986     }
00987     
00988     
00989     <span class="keywordflow">for</span> (i=0; i&lt;pm.size(); i++) {
00990 
00991         pm[i]-&gt;<a class="code" href="classPlotMaker.html#a2">setAxisBox</a>( excess2d );
00992         pm[i]-&gt;<a class="code" href="classPlotMaker.html#a20">plot</a>( excess2d );
00993         pm[i]-&gt;<a class="code" href="classPlotMaker.html#a38">setContourColorName</a>( <span class="stringliteral">"black"</span> );
00994         pm[i]-&gt;<a class="code" href="classPlotMaker.html#a40">setContourLineStyle</a>( PlotMaker::LINE_SOLID );
00995         pm[i]-&gt;<a class="code" href="classPlotMaker.html#a18">contourPlot</a>( signif2d, 1.0, 50.0, 1.0 );
00996         pm[i]-&gt;<a class="code" href="classPlotMaker.html#a30">setColorMap</a>( PlotMaker::COLORMAP_BLUES );
00997         pm[i]-&gt;<a class="code" href="classPlotMaker.html#a38">setContourColorName</a>( <span class="stringliteral">"orange"</span> );
00998         pm[i]-&gt;<a class="code" href="classPlotMaker.html#a40">setContourLineStyle</a>( PlotMaker::LINE_DASHED );
00999         pm[i]-&gt;<a class="code" href="classPlotMaker.html#a19">plotRADecGrid</a>( ra2d, dec2d );
01000         pm[i]-&gt;<a class="code" href="classPlotMaker.html#a11">plotAxes</a>();
01001         pm[i]-&gt;<a class="code" href="classPlotMaker.html#a12">plotTitle</a>( <span class="stringliteral">"Significance &amp; Excess"</span>);
01002         pm[i]-&gt;<a class="code" href="classPlotMaker.html#a13">plotSubtitle</a>( title+<span class="stringliteral">" (T"</span>+telid+<span class="stringliteral">")"</span> );
01003 
01004         <span class="comment">// plot the stars:</span>
01005         <span class="keywordflow">for</span> (star=_onstars.begin(); star!=_onstars.end(); star++) {
01006             pm[i]-&gt;<a class="code" href="classPlotMaker.html#a20">plot</a>( *star );
01007         }
01008         <span class="keywordflow">for</span> (star=_offstars.begin(); star!=_offstars.end(); star++) {
01009             pm[i]-&gt;<a class="code" href="classPlotMaker.html#a20">plot</a>( *star, 4 );
01010         }
01011 
01012         pm[i]-&gt;<a class="code" href="classPlotMaker.html#a6">flush</a>();
01013 
01014         <span class="keywordflow">if</span> (pm[i] != _xplotmaker) 
01015             <span class="keyword">delete</span> pm[i];
01016         <span class="keywordflow">else</span> 
01017             pm[i]-&gt;<a class="code" href="classPlotMaker.html#a7">newPage</a>();
01018     }
01019 
01020 
01021     <span class="comment">// Plot the brightness Maps need to generate new copies of them,</span>
01022     <span class="comment">// so the old ones aren't overwritten</span>
01023 
01024     <a class="code" href="classImage2D.html">Image2D</a> skybrightness = on.<a class="code" href="structCutRecord.html#o10">skybright</a>;
01025     <a class="code" href="classImage2D.html">Image2D</a> tubeoffness = on.<a class="code" href="structCutRecord.html#o11">tubeoff</a>;
01026     tubeoffness.<a class="code" href="classImage2D.html#a19">addImage</a>( off.<a class="code" href="structCutRecord.html#o11">tubeoff</a> );
01027 
01028 
01029     <span class="keywordflow">if</span> (finalimage==<span class="keyword">false</span> || _display_is_enabled==<span class="keyword">false</span>) {
01030         pm.resize(1);
01031         pm[0] = <span class="keyword">new</span> <a class="code" href="classPlotMaker.html">PlotMaker</a>( <span class="stringliteral">"PS"</span>, dir+<span class="stringliteral">"skybrightness.eps"</span> );
01032     }
01033     <span class="keywordflow">else</span> {
01034         pm.resize(2);
01035         pm[0] = <span class="keyword">new</span> <a class="code" href="classPlotMaker.html">PlotMaker</a>( <span class="stringliteral">"X"</span>, <span class="stringliteral">".y.out"</span> );
01036         pm[1] = <span class="keyword">new</span> PlotMaker( <span class="stringliteral">"PS"</span>, dir+<span class="stringliteral">"skybrightness.eps"</span> );
01037     }
01038 
01039     skybrightness.<a class="code" href="classImage2D.html#a26">expand</a>();     <span class="comment">// Make higher resolution and interpolate</span>
01040     tubeoffness.<a class="code" href="classImage2D.html#a26">expand</a>();
01041 
01042     <span class="keywordflow">for</span> (i=0; i&lt;pm.size(); i++) {
01043         pm[i]-&gt;<a class="code" href="classPlotMaker.html#a30">setColorMap</a>( PlotMaker::COLORMAP_INVERSEGREY );
01044         pm[i]-&gt;<a class="code" href="classPlotMaker.html#a2">setAxisBox</a>( skybrightness );
01045         pm[i]-&gt;<a class="code" href="classPlotMaker.html#a20">plot</a>( skybrightness );
01046         pm[i]-&gt;<a class="code" href="classPlotMaker.html#a38">setContourColorName</a>( <span class="stringliteral">"LightGreen"</span> );
01047         pm[i]-&gt;<a class="code" href="classPlotMaker.html#a18">contourPlot</a>( tubeoffness,
01048                             tubeoffness.<a class="code" href="classImage2D.html#a23">minValue</a>(),
01049                             tubeoffness.<a class="code" href="classImage2D.html#a24">maxValue</a>(),
01050                             (tubeoffness.<a class="code" href="classImage2D.html#a24">maxValue</a>()-
01051                             tubeoffness.<a class="code" href="classImage2D.html#a23">minValue</a>())/10.0 );
01052         pm[i]-&gt;<a class="code" href="classPlotMaker.html#a38">setContourColorName</a>( <span class="stringliteral">"orange"</span> );
01053         pm[i]-&gt;<a class="code" href="classPlotMaker.html#a40">setContourLineStyle</a>( PlotMaker::LINE_DASHED );
01054         pm[i]-&gt;<a class="code" href="classPlotMaker.html#a19">plotRADecGrid</a>( ra2d, dec2d );
01055         pm[i]-&gt;<a class="code" href="classPlotMaker.html#a11">plotAxes</a>();
01056         pm[i]-&gt;<a class="code" href="classPlotMaker.html#a12">plotTitle</a>( <span class="stringliteral">"Sky Brightness"</span>  );
01057         pm[i]-&gt;<a class="code" href="classPlotMaker.html#a13">plotSubtitle</a>( title+<span class="stringliteral">" (T"</span>+telid+<span class="stringliteral">")"</span> );
01058 
01059         <span class="keywordflow">for</span> (star=_onstars.begin(); star!=_onstars.end(); star++) {
01060             pm[i]-&gt;<a class="code" href="classPlotMaker.html#a20">plot</a>( *star );
01061         }
01062         <span class="keywordflow">for</span> (star=_offstars.begin(); star!=_offstars.end(); star++) {
01063             pm[i]-&gt;<a class="code" href="classPlotMaker.html#a20">plot</a>( *star, 4 );
01064         }
01065 
01066         pm[i]-&gt;<a class="code" href="classPlotMaker.html#a6">flush</a>();
01067         
01068         <span class="keywordflow">if</span> (pm[i] != _xplotmaker) <span class="keyword">delete</span> pm[i];
01069         <span class="keywordflow">else</span>  pm[i]-&gt;<a class="code" href="classPlotMaker.html#a7">newPage</a>();
01070     }
01071 
01072 }
01073 
01079 <span class="keywordtype">void</span> 
01080 <a class="code" href="classCutter.html#a8">Cutter::</a>
<a name="l01081"></a><a class="code" href="classCutter.html#a8">01081</a> <a class="code" href="classCutter.html#a8">process</a>( <a class="code" href="classRunInfo.html">RunInfo</a> &amp;ri ) {
01082     
01083     <a class="code" href="classLogger.html">Logger</a> *logger = Logger::instance();
01084     
01085     _radial_smoothing_factor = ri.<a class="code" href="classRunInfo.html#o22">cuts</a>.<a class="code" href="structCutInfo.html#o15">smoothing_radius</a>;
01086     
01087     <span class="comment">// do some checks</span>
01088 
01089     <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o22">cuts</a>.<a class="code" href="structCutInfo.html#o16">radial_analysis</a> &amp;&amp; _is_2d_enabled==<span class="keyword">false</span>) {
01090         logger-&gt;<a class="code" href="classLogger.html#a0">printf</a>(<span class="stringliteral">"You requested radial analysis, "</span>
01091                        <span class="stringliteral">"but 2D analysis is disabled! Enabling 2D..."</span>);
01092         enable2D(<span class="keyword">true</span>);
01093     }
01094 
01095     <span class="comment">// now process the run.</span>
01096 
01097     <span class="keywordflow">try</span> {
01098         <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o0">type</a> == Config::ONOFF) {
01099 
01100             _onruns.push_back(<a class="code" href="classCutter.html#a16">cut</a>( ri, ri.<a class="code" href="classRunInfo.html#o4">onid</a>, ON ));
01101             _offruns.push_back(<a class="code" href="classCutter.html#a16">cut</a>( ri, ri.<a class="code" href="classRunInfo.html#o5">offid</a>, OFF ));
01102 
01103             <span class="keywordflow">if</span> (_is_2d_enabled) {
01104 
01105                 <a class="code" href="classCutter.html#a17">generateImage</a>( _onruns[_onruns.size()-1],
01106                                _offruns[_offruns.size()-1],
01107                                ri.<a class="code" href="classRunInfo.html#o4">onid</a>+<span class="stringliteral">"/"</span>,ri.<a class="code" href="classRunInfo.html#o4">onid</a>+<span class="stringliteral">"/"</span>+ri.<a class="code" href="classRunInfo.html#o5">offid</a> );
01108             }
01109 
01110         }
01111         <span class="keywordflow">else</span> {
01112             
01113             _trackruns.push_back(<a class="code" href="classCutter.html#a16">cut</a>( ri, ri.<a class="code" href="classRunInfo.html#o4">onid</a>, TRACK ));
01114 
01115             <span class="keywordflow">if</span> (_is_2d_enabled) {
01116                 
01117                 <span class="comment">// make a fake off run so that generateImage works</span>
01118 
01119                 <a class="code" href="structCutRecord.html">CutRecord</a> fake;
01120                 fake.<a class="code" href="structCutRecord.html#o7">duration</a> = _trackruns[_trackruns.size()-1].duration;
01121 
01122                 <a class="code" href="classCutter.html#a17">generateImage</a>( _trackruns[_trackruns.size()-1],
01123                                fake,
01124                                ri.<a class="code" href="classRunInfo.html#o4">onid</a>+<span class="stringliteral">"/"</span>,ri.<a class="code" href="classRunInfo.html#o4">onid</a>+<span class="stringliteral">" (tracking)"</span> );
01125             }
01126 
01127 
01128         }
01129 
01130     } 
01131     <span class="keywordflow">catch</span> (<a class="code" href="classMildAnalysisException.html">MildAnalysisException</a> &amp;e) {
01132         cout &lt;&lt; <span class="stringliteral">"*** WARNING: pair "</span>;
01133         <span class="keywordflow">if</span> ( ri.<a class="code" href="classRunInfo.html#o0">type</a> == Config::ONOFF) 
01134             cout &lt;&lt; ri.<a class="code" href="classRunInfo.html#o4">onid</a> &lt;&lt;<span class="stringliteral">"/"</span>&lt;&lt;ri.<a class="code" href="classRunInfo.html#o5">offid</a>&lt;&lt;<span class="stringliteral">": "</span>;
01135         <span class="keywordflow">else</span> 
01136             cout &lt;&lt; ri.<a class="code" href="classRunInfo.html#o4">onid</a>;
01137 
01138         cout &lt;&lt; e.what() &lt;&lt; endl;
01139         
01140     }
01141 
01142     
01143 }
01144 
01160 <a class="code" href="structCutRecord.html">CutRecord</a>
01161 <a class="code" href="classCutter.html#a16">Cutter::</a>
<a name="l01162"></a><a class="code" href="classCutter.html#a16">01162</a> <a class="code" href="classCutter.html#a16">cut</a>( <a class="code" href="classRunInfo.html">RunInfo</a> &amp;ri, <span class="keyword">const</span> string &amp;id, <span class="keywordtype">char</span> type ) {
01163 
01164     <a class="code" href="structHillasParameterization.html">HillasParameterization</a> param,oldparam;
01165     <a class="code" href="classParamDataReader.html">ParamDataReader</a> *reader;
01166     <a class="code" href="structHeaderRecord.html">HeaderRecord</a> header;
01167     string efilename = id+<span class="stringliteral">"/"</span>+id+<span class="stringliteral">"-energy.dat"</span>;
01168     ofstream energyfile(efilename.c_str());
01169 
01170     <span class="keywordtype">double</span> x;
01171 
01172     <a class="code" href="classImage2D.html">Image2D</a> centroids(39,39);
01173     centroids.<a class="code" href="classImage2D.html#a1">setCoordinateBox</a>( -_image_xdim*_degperpix/2.0, 
01174                            -_image_ydim*_degperpix/2.0,
01175                            _image_xdim*_degperpix/2.0,
01176                            _image_ydim*_degperpix/2.0 );    
01177 
01178     EnergyEstimatorFactory *efactory = EnergyEstimatorFactory::instance();
01179     EnergyEstimator *energy = efactory-&gt;getEstimator(ri.<a class="code" href="classRunInfo.html#o26">energyestimator</a>);
01180 
01181     <span class="comment">// allocate the energy spectrum histograms if needed:</span>
01182 
01183     <span class="keywordflow">if</span> (_energy_on == NULL) 
01184         _energy_on = <span class="keyword">new</span> <a class="code" href="classEnergySpectrum.html">EnergySpectrum</a>(ri,<span class="stringliteral">"EnergyEstimator-on"</span>);
01185     <span class="keywordflow">if</span> (_energy_off == NULL) 
01186         _energy_off= <span class="keyword">new</span> EnergySpectrum(ri,<span class="stringliteral">"EnergyEstimator-off"</span>);
01187     <span class="keywordflow">if</span> (_energy_track == NULL) 
01188         _energy_track = <span class="keyword">new</span> EnergySpectrum(ri,<span class="stringliteral">"EnergyEstimator-track"</span>);
01189       
01190     <span class="comment">// write out cuts that are to be used:</span>
01191 
01192     string cutinfofile = id+<span class="stringliteral">"/"</span>+id+<span class="stringliteral">"-cuts.txt"</span>;
01193     ofstream cutinfo(cutinfofile.c_str());
01194     <span class="keywordflow">if</span> (!cutinfo.fail()) {
01195         cutinfo &lt;&lt; ri.<a class="code" href="classRunInfo.html#o22">cuts</a> &lt;&lt; endl;
01196         cutinfo.close();
01197     }
01198     <span class="keywordflow">else</span> {
01199         <span class="keywordflow">throw</span> <a class="code" href="classAnalysisException.html">AnalysisException</a>(<span class="stringliteral">"Couldn't write to "</span>+cutinfofile);
01200     }
01201 
01202     <span class="comment">// open data</span>
01203 
01204     reader = <span class="keyword">new</span> <a class="code" href="classParamDataReader.html">ParamDataReader</a>(id+<span class="stringliteral">"/"</span>+id+<span class="stringliteral">"-param.ntuple"</span>);
01205     reader-&gt;<a class="code" href="classParamDataReader.html#a2">getHeaderRecord</a>( header );
01206 
01207     <span class="comment">// throw error if the user specified a telescope which is not</span>
01208     <span class="comment">// specified in the header:</span>
01209     <span class="keywordflow">if</span> (_telescope_id &gt;= header.<a class="code" href="structHeaderRecord.html#o0">num_telescopes</a>) {
01210         cout &lt;&lt; <span class="stringliteral">"NOTE: you specified telescope number "</span>&lt;&lt;_telescope_id
01211              &lt;&lt; <span class="stringliteral">" but there are only "</span> &lt;&lt; header.<a class="code" href="structHeaderRecord.html#o0">num_telescopes</a> &lt;&lt;endl
01212              &lt;&lt; <span class="stringliteral">"      telescopes in the array (the numbers start at 0)!"</span> 
01213              &lt;&lt; endl;
01214         <span class="keyword">delete</span> reader;
01215         <span class="keyword">delete</span> energy;
01216         <span class="keywordflow">throw</span> <a class="code" href="classCriticalAnalysisException.html">CriticalAnalysisException</a>( <span class="stringliteral">"Invalid telescope number"</span>);
01217     }
01218 
01219     
01220     <span class="keywordflow">if</span> (type == ON || type == TRACK) {
01221         _ra = header.<a class="code" href="structHeaderRecord.html#o2">ra</a>;
01222         _dec = header.<a class="code" href="structHeaderRecord.html#o3">dec</a>;
01223     }
01224 
01225     <span class="comment">// add source name to list for sanity check:</span>
01226     _sourcenames.push_back( header.<a class="code" href="structHeaderRecord.html#o8">sourcename</a> );
01227 
01228     <span class="keywordflow">if</span> (type == ON) {
01229         _on_ra.push_back(header.<a class="code" href="structHeaderRecord.html#o2">ra</a>);
01230         _on_dec.push_back(header.<a class="code" href="structHeaderRecord.html#o3">dec</a>);
01231     }
01232     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == OFF) {
01233         _off_ra.push_back(header.<a class="code" href="structHeaderRecord.html#o2">ra</a>);
01234         _off_dec.push_back(header.<a class="code" href="structHeaderRecord.html#o3">dec</a>);
01235     }
01236 
01237 
01238     _track_ratio = ri.<a class="code" href="classRunInfo.html#o22">cuts</a>.<a class="code" href="structCutInfo.html#o0">tracking_ratio</a>;
01239 
01240     <span class="comment">//============================================================</span>
01241     <span class="comment">// Initialize Histograms</span>
01242 
01243     Histogram relrate( 30, 0,30, <span class="stringliteral">"Rate"</span> );
01244     Histogram alpha( 18, 0,90, <span class="stringliteral">"alpha"</span> );
01245     Histogram sizehist( 30,0,1000, <span class="stringliteral">"Size"</span> );
01246     Histogram ehist( 18,-1.0,2.0, <span class="stringliteral">"EnergyEstimator"</span>);
01247     
01248     <span class="comment">//============================================================</span>
01249     <span class="comment">// Determine the lightcurve binning start and end times based </span>
01250     <span class="comment">// on the preset timebase.</span>
01251     
01252     <span class="keyword">const</span> <span class="keywordtype">double</span> MJD_TO_MIN = 24*60;
01253     <span class="keywordtype">double</span> tstartmin = header.<a class="code" href="structHeaderRecord.html#o4">starttime</a> * MJD_TO_MIN;
01254     <span class="keywordtype">double</span> tendmin   = header.<a class="code" href="structHeaderRecord.html#o5">endtime</a> * MJD_TO_MIN;
01255     <span class="keywordtype">double</span> tbasemin  = ri.<a class="code" href="classRunInfo.html#o16">utbase</a> * MJD_TO_MIN;
01256     <span class="keywordtype">double</span> diff1     = tstartmin - tendmin;
01257     <span class="keywordtype">double</span> delta1    = diff1 - floor(diff1);
01258     <span class="keywordtype">double</span> tbinstart = tstartmin - delta1;
01259     <span class="keywordtype">double</span> diff2     = tendmin - tbinstart;
01260     <span class="keywordtype">double</span> delta2    = ceil(diff2) - diff2;
01261     <span class="keywordtype">double</span> tbinend   = tendmin + delta2;
01262 
01263     <span class="keywordtype">int</span> nminutes = (<span class="keywordtype">int</span>) (tbinend - tbinstart);
01264 
01265     <span class="keywordflow">if</span> (nminutes&lt;1) nminutes = 1;
01266 
01267     tbinstart /= MJD_TO_MIN;
01268     tbinend  /= MJD_TO_MIN;
01269 
01270     <span class="keywordflow">if</span> (tbinstart&gt;tbinend) {
01271         <span class="keywordtype">double</span> tmp = tbinstart;
01272         tbinstart = tbinend;
01273         tbinend = tmp;
01274     }
01275 
01276     <span class="comment">// Now tbinstart and tbinend are the start end end times</span>
01277     <span class="comment">// normalized to the base time (ri.utbase) assuming 1 minute bins.</span>
01278     <span class="comment">// The first and last bins are going to be partially filled, by</span>
01279     <span class="comment">// (1-delta1) and (1-delta2) minutes respectively.</span>
01280     
01281     Histogram rate( nminutes, tbinstart, tbinend, <span class="stringliteral">"Absolute Rate"</span> );
01282     Histogram toffrate( nminutes, tbinstart, tbinend, 
01283                               <span class="stringliteral">"TrackOff Rate"</span> );
01284 <span class="comment">//     rate.setBinFillFraction( 0, 1.0-delta1 );</span>
01285 <span class="comment">//     rate.setBinFillFraction( nminutes-1, 1.0-delta2 );</span>
01286 <span class="comment">//     toffrate.setBinFillFraction( 0, 1.0-delta1 );</span>
01287 <span class="comment">//     toffrate.setBinFillFraction( nminutes-1, 1.0-delta2 );</span>
01288 <span class="comment">//     toffrate.setScaleFactor( 1.0/ri.cuts.tracking_ratio );</span>
01289 
01290 
01291     <span class="comment">//============================================================</span>
01292     <span class="comment">// Loop over events and cut the data</span>
01293 
01294     <span class="keywordtype">bool</span> first = <span class="keyword">true</span>;
01295     <span class="keywordtype">double</span> elapsed  = 0;
01296     <span class="keywordtype">double</span> starttime = 0;
01297     <span class="keywordtype">bool</span> pass_radial;
01298     <span class="keywordtype">double</span> dista,distb;
01299     <span class="keywordtype">int</span> n_too_close=0;
01300 
01301     <a class="code" href="structCutRecord.html">CutRecord</a> thisrun;          <span class="comment">// initialized to 0 in constructor</span>
01302     thisrun.<a class="code" href="structCutRecord.html#o0">runid</a>=id;     
01303     thisrun.<a class="code" href="structCutRecord.html#o8">average_elevation</a> = header.<a class="code" href="structHeaderRecord.html#o6">average_elevation</a>;
01304 
01305     <span class="comment">// set up the requested cut method:</span>
01306 
01307     <a class="code" href="classSuperCutter.html">SuperCutter</a> *cutter;
01308     <a class="code" href="classCutFactory.html">CutFactory</a> *cutfactory = <a class="code" href="classCutFactory.html#e0">CutFactory::instance</a>();
01309     cutter = cutfactory-&gt;<a class="code" href="classCutFactory.html#a0">newCutter</a>( ri );
01310     
01311     cutter-&gt;<a class="code" href="classSuperCutter.html#a0">setCuts</a>( ri.<a class="code" href="classRunInfo.html#o22">cuts</a> );
01312 
01313     <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o24">cuttype</a> == Config::ZCUTTER || ri.<a class="code" href="classRunInfo.html#o24">cuttype</a> == Config::EZCUTTER) {
01314         ((<a class="code" href="classZCutter.html">ZCutter</a>*)(cutter))-&gt;setCamera(header.<a class="code" href="structHeaderRecord.html#o1">nadc</a>[_telescope_id],atoi(ri.<a class="code" href="classRunInfo.html#o7">utdate</a>.c_str()));
01315     }
01316 
01317     <span class="comment">// loop over data</span>
01318 
01319     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;reader-&gt;<a class="code" href="classParamDataReader.html#a4">size</a>(); i++) {
01320 
01321         reader-&gt;<a class="code" href="classParamDataReader.html#a3">getNextEventRecord</a>( param );
01322 
01323         <span class="comment">// skip events which aren't from the specified telescope</span>
01324         <span class="comment">// (wucut is not designed for array analysis)</span>
01325         <span class="keywordflow">if</span> (param.<a class="code" href="structImageParameterization.html#o0">telescope_id</a> != _telescope_id) <span class="keywordflow">continue</span>;
01326 
01327         <span class="comment">// Sotre info about the first event for time calculations later...</span>
01328         <span class="keywordflow">if</span> (first==<span class="keyword">true</span>) {
01329             starttime = param.<a class="code" href="structImageParameterization.html#o2">gpstime</a>;
01330             first = <span class="keyword">false</span>;
01331         }
01332 
01333         elapsed = param.<a class="code" href="structImageParameterization.html#o2">gpstime</a>-starttime;
01334 
01335         thisrun.<a class="code" href="structCutRecord.html#o1">total</a>++;
01336         thisrun.<a class="code" href="structCutRecord.html#o2">valid</a>++;
01337 
01338         <span class="comment">// Apply elongation and other corrections to the parameters</span>
01339         <span class="comment">// (specific to the type of cutter used). Store original</span>
01340         <span class="comment">// uncorrected parameters for later use. </span>
01341 
01342         oldparam=param; 
01343         cutter-&gt;<a class="code" href="classSuperCutter.html#a1">applyCorrections</a>( param );
01344 
01345         <span class="comment">// shift points of origin for alignment if requested.  This is</span>
01346         <span class="comment">// used for stacking a bunch of runs that may have pointing</span>
01347         <span class="comment">// errors, and of course only works with 2D analysis (alpha</span>
01348         <span class="comment">// cut is unaffected)</span>
01349 
01350         <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o22">cuts</a>.<a class="code" href="structCutInfo.html#o18">alignment</a> == <span class="keyword">true</span>) {
01351             
01352             param.point_of_origin_a.x -= ri.<a class="code" href="classRunInfo.html#o22">cuts</a>.<a class="code" href="structCutInfo.html#o19">align_offset</a>.<a class="code" href="structCoordinate__t.html#o0">x</a>;
01353             param.point_of_origin_b.x -= ri.<a class="code" href="classRunInfo.html#o22">cuts</a>.<a class="code" href="structCutInfo.html#o19">align_offset</a>.<a class="code" href="structCoordinate__t.html#o0">x</a>;
01354 
01355             param.point_of_origin_a.y -= ri.<a class="code" href="classRunInfo.html#o22">cuts</a>.<a class="code" href="structCutInfo.html#o19">align_offset</a>.<a class="code" href="structCoordinate__t.html#o1">y</a>;
01356             param.point_of_origin_b.y -= ri.<a class="code" href="classRunInfo.html#o22">cuts</a>.<a class="code" href="structCutInfo.html#o19">align_offset</a>.<a class="code" href="structCoordinate__t.html#o1">y</a>;
01357         }
01358         
01359         <span class="comment">// ----------------------------------------------------</span>
01360         <span class="comment">// Trigger and Muon Cut:</span>
01361         
01362         <span class="keywordflow">if</span> (cutter-&gt;<a class="code" href="classSuperCutter.html#a2">pass</a>( param, SIZE|MAX|FRAC|LENSIZE )) {
01363             
01364             thisrun.<a class="code" href="structCutRecord.html#o3">trigger</a>++;
01365 
01366             <span class="comment">// ----------------------------------------------------</span>
01367             <span class="comment">// Shape Cut:</span>
01368             <span class="keywordflow">if</span> (cutter-&gt;<a class="code" href="classSuperCutter.html#a2">pass</a>( param, DISTANCE|LENGTH|WIDTH )) {
01369                 
01370                 thisrun.<a class="code" href="structCutRecord.html#o4">shape</a>++;
01371                 
01372                 <span class="comment">// Update "alpha total" plot</span>
01373                 
01374                 <span class="keywordflow">if</span> (type == ON || type == TRACK)
01375                     _alpha_on-&gt;<a class="code" href="classHistogram.html#a3">increment</a>(param.alpha*180.0/M_PI);
01376                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == OFF)
01377                     _alpha_off-&gt;<a class="code" href="classHistogram.html#a3">increment</a>(param.alpha*180.0/M_PI);
01378                 <span class="keywordflow">else</span> 
01379                     cout &lt;&lt; <span class="stringliteral">"** Cutter: unknown run type "</span> &lt;&lt; type &lt;&lt; endl;
01380                 
01381                 alpha.<a class="code" href="classHistogram.html#a3">increment</a>(param.alpha*180.0/M_PI);
01382                 
01383                 <span class="comment">// For tracking analysis, count events in the</span>
01384                 <span class="comment">// "off" alpha region</span>
01385                 
01386                 <span class="keywordflow">if</span> (param.alpha*180.0/M_PI &gt;= 20.0 &amp;&amp;
01387                     param.alpha*180.0/M_PI &lt;= 65.0) {
01388                     thisrun.<a class="code" href="structCutRecord.html#o6">trackoff</a>++;
01389                     toffrate.<a class="code" href="classHistogram.html#a3">increment</a>( param.gpstime );
01390                 }
01391                 
01392                 
01393                 <span class="comment">// update 2D analysis...</span>
01394                 
01395                 <span class="keywordflow">if</span> (_is_2d_enabled){
01396                     
01397 
01398                     <span class="comment">// Accept the preferred point of origin "a". It's</span>
01399                     <span class="comment">// preferred in the sense that the asymmetry seems</span>
01400                     <span class="comment">// to point that way (see HillasImageAnalyzer)</span>
01401 
01402                     <span class="keywordflow">if</span> (_fast_image_processing_is_enabled) {
01403                         thisrun.<a class="code" href="structCutRecord.html#o9">im2d</a>.<a class="code" href="classImage2D.html#a16">addHist</a>(param.point_of_origin_a.x, 
01404                                              param.point_of_origin_a.y, 1);
01405                     }
01406                     <span class="keywordflow">else</span> {
01407                         thisrun.<a class="code" href="structCutRecord.html#o12">poolist</a>.push_back(param.point_of_origin_a);
01408                     }
01409 
01410                     <span class="comment">// if it's not within the valid asymmetry region,</span>
01411                     <span class="comment">// then accept the second point of origin too</span>
01412                     <span class="comment">// since we can't trust asymmetry</span>
01413 
01414                     <span class="keywordflow">if</span> ( cutter-&gt;<a class="code" href="classSuperCutter.html#a2">pass</a>(param,ASYMM) == <span class="keyword">false</span>) {
01415 
01416                         <span class="comment">// Since this method could lead to double</span>
01417                         <span class="comment">// counting, we need to check if the points of</span>
01418                         <span class="comment">// origin are too close to one another:</span>
01419                         
01420                         <span class="keywordflow">if</span> ( hypot(param.point_of_origin_a.x-
01421                                    param.point_of_origin_b.x,
01422                                    param.point_of_origin_a.y-
01423                                    param.point_of_origin_b.y) 
01424                              &gt; 2.0*ri.<a class="code" href="classRunInfo.html#o22">cuts</a>.<a class="code" href="structCutInfo.html#o15">smoothing_radius</a>) {
01425 
01426                             <span class="keywordflow">if</span> (_fast_image_processing_is_enabled) {
01427                                 thisrun.<a class="code" href="structCutRecord.html#o9">im2d</a>.<a class="code" href="classImage2D.html#a16">addHist</a>(param.point_of_origin_b.x,
01428                                                      param.point_of_origin_b.y,
01429                                                      1);
01430                             }
01431                             <span class="keywordflow">else</span> {
01432                                 thisrun.<a class="code" href="structCutRecord.html#o12">poolist</a>.push_back(param.point_of_origin_b);
01433                             }
01434                         }
01435                         <span class="keywordflow">else</span> {
01436                             n_too_close++;
01437                         }
01438 
01439 
01440                     }
01441 
01442                     <span class="comment">// If an radial-analysis is enabled, see if</span>
01443                     <span class="comment">// distance beteween point of origin and offset</span>
01444                     <span class="comment">// position is &lt; smoothing_radius (actually</span>
01445                     <span class="comment">// functioning as a radius cut, not an alpha cut).</span>
01446                     <span class="comment">// otherwise, do standard alpha cut</span>
01447 
01448                     pass_radial = <span class="keyword">false</span>;
01449 
01450                     <span class="keywordflow">if</span> (ri.<a class="code" href="classRunInfo.html#o22">cuts</a>.<a class="code" href="structCutInfo.html#o16">radial_analysis</a>) {
01451 
01452                         dista = hypot( param.point_of_origin_a.x 
01453                                       - ri.<a class="code" href="classRunInfo.html#o22">cuts</a>.<a class="code" href="structCutInfo.html#o17">radial_offset</a>.<a class="code" href="structCoordinate__t.html#o0">x</a>, 
01454                                       param.point_of_origin_a.y 
01455                                       - ri.<a class="code" href="classRunInfo.html#o22">cuts</a>.<a class="code" href="structCutInfo.html#o17">radial_offset</a>.<a class="code" href="structCoordinate__t.html#o1">y</a>);
01456 
01457                         <span class="keywordflow">if</span> (cutter-&gt;<a class="code" href="classSuperCutter.html#a2">pass</a>(param,ASYMM) == <span class="keyword">true</span>) {
01458 
01459                             <span class="comment">// asymmetry is valid, so just look at A</span>
01460 
01461                             <span class="keywordflow">if</span> (dista &lt;= ri.<a class="code" href="classRunInfo.html#o22">cuts</a>.<a class="code" href="structCutInfo.html#o15">smoothing_radius</a>) 
01462                             pass_radial = <span class="keyword">true</span>;
01463                         }
01464                         <span class="keywordflow">else</span> {
01465 
01466                             <span class="comment">// otherwise, check both A and B</span>
01467 
01468                             distb = hypot( param.point_of_origin_b.x 
01469                                            - ri.<a class="code" href="classRunInfo.html#o22">cuts</a>.<a class="code" href="structCutInfo.html#o17">radial_offset</a>.<a class="code" href="structCoordinate__t.html#o0">x</a>, 
01470                                            param.point_of_origin_b.y 
01471                                            - ri.<a class="code" href="classRunInfo.html#o22">cuts</a>.<a class="code" href="structCutInfo.html#o17">radial_offset</a>.<a class="code" href="structCoordinate__t.html#o1">y</a>);
01472                             
01473                             <span class="keywordflow">if</span> ((dista &lt;= ri.<a class="code" href="classRunInfo.html#o22">cuts</a>.<a class="code" href="structCutInfo.html#o15">smoothing_radius</a>) || 
01474                                 (distb &lt;= ri.<a class="code" href="classRunInfo.html#o22">cuts</a>.<a class="code" href="structCutInfo.html#o15">smoothing_radius</a>)) 
01475                                 pass_radial = <span class="keyword">true</span>;
01476                         }
01477                         
01478                     }
01479 
01480                     
01481                 }
01482                 
01483                 <span class="comment">// ----------------------------------------------------</span>
01484                 <span class="comment">// final Orientation cut.  This is either an alpha cut</span>
01485                 <span class="comment">// or a radius cut depending on whether "offset</span>
01486                 <span class="comment">// analysis" is enabled.</span>
01487                 
01488                 <span class="keywordflow">if</span> ( (ri.<a class="code" href="classRunInfo.html#o22">cuts</a>.<a class="code" href="structCutInfo.html#o16">radial_analysis</a>==<span class="keyword">true</span> &amp;&amp; pass_radial) || 
01489                      (ri.<a class="code" href="classRunInfo.html#o22">cuts</a>.<a class="code" href="structCutInfo.html#o16">radial_analysis</a>==<span class="keyword">false</span> &amp;&amp; 
01490                       cutter-&gt;<a class="code" href="classSuperCutter.html#a2">pass</a>( param, ALPHA )  )) {
01491                     
01492                     thisrun.<a class="code" href="structCutRecord.html#o5">orientation</a>++;
01493 
01494                     <span class="comment">// update the energy estimator histograms</span>
01495 
01496                     <span class="comment">// WARNING: tracking runs may not work for</span>
01497                     <span class="comment">// spectral analysis, but they're implemented</span>
01498                     <span class="comment">// anyway!</span>
01499 
01500                     <span class="comment">// NOTE: When we decided to use the older ZCuts</span>
01501                     <span class="comment">// over EZCuts for the SgrA spectrum, we realized</span>
01502                     <span class="comment">// that we had derived the energy estimator</span>
01503                     <span class="comment">// function using EZCuts (which modifies size but</span>
01504                     <span class="comment">// not distance), while ZCuts modifies both.  To</span>
01505                     <span class="comment">// allow the energyestimator to work in both</span>
01506                     <span class="comment">// cases, I pass oldparam.distance (the unscaled</span>
01507                     <span class="comment">// distance) to the estimator instead of</span>
01508                     <span class="comment">// param.distance!</span>
01509 
01510                     x = energy-&gt;getEstimate(param.size,oldparam.<a class="code" href="structHillasParameterization.html#o7">distance</a>,
01511                                             param.zenith);
01512 
01513                     <span class="comment">// x is log10(Energy)</span>
01514 
01515 <span class="comment">//                  cout &lt;&lt; "DEBUG: E= "&lt;&lt;param.sim.primary_energy</span>
01516 <span class="comment">//                       &lt;&lt;" Est= "&lt;&lt;pow(10,x)</span>
01517 <span class="comment">//                       &lt;&lt;" error= "</span>
01518 <span class="comment">//                       &lt;&lt;(log10(param.sim.primary_energy) - x)</span>
01519 <span class="comment">//                       &lt;&lt;endl;</span>
01520                     
01521                     <span class="comment">// store the energy estimate in case output is</span>
01522                     <span class="comment">// enabled (then it can be plotted against true</span>
01523                     <span class="comment">// energy for spectral resolution plots)</span>
01524                     
01525                     param.energy_estimate = 
01526                         oldparam.<a class="code" href="structHillasParameterization.html#o20">energy_estimate</a> = pow(10,x);
01527 
01528                     <span class="keywordflow">if</span> (type == ON)
01529                         _energy_on-&gt;<a class="code" href="classHistogram.html#a3">increment</a>( x );
01530                     <span class="keywordflow">if</span> (type == TRACK)
01531                         _energy_track-&gt;increment( x );
01532                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == OFF)
01533                         _energy_off-&gt;increment( x );
01534 
01535                     <span class="comment">// update the diagnostic histograms</span>
01536 
01537                     relrate.<a class="code" href="classHistogram.html#a3">increment</a>( elapsed*24*60 );
01538                     rate.<a class="code" href="classHistogram.html#a3">increment</a>( param.gpstime );
01539                     sizehist.<a class="code" href="classHistogram.html#a3">increment</a>( param.size );
01540 
01541                     <span class="keywordflow">if</span> (type==ON) 
01542                         _size_on-&gt;<a class="code" href="classHistogram.html#a3">increment</a>( log10(param.size) );
01543                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == OFF)
01544                         _size_off-&gt;<a class="code" href="classHistogram.html#a3">increment</a>( log10(param.size) );
01545 
01546                     energyfile &lt;&lt; setw(20) &lt;&lt; x
01547                                &lt;&lt; setw(20) &lt;&lt; param.size
01548                                &lt;&lt; setw(20) &lt;&lt; param.distance
01549                                &lt;&lt; endl;
01550                     ehist.<a class="code" href="classHistogram.html#a3">increment</a>( x );
01551                     centroids.<a class="code" href="classImage2D.html#a16">addHist</a>( param.centroid.x, 
01552                                        param.centroid.y,1);
01553                     
01554                     <span class="comment">// write out the parameters (if requested).</span>
01555                     <span class="comment">// Writes out the unscaled parameters by default,</span>
01556                     <span class="comment">// or the parameters scaled by the particular cut</span>
01557                     <span class="comment">// technique if the</span>
01558                     <span class="comment">// enableCorrectedParameterOutput(true) function</span>
01559                     <span class="comment">// has been called.</span>
01560                     <span class="keywordflow">if</span> (_output_is_enabled) {
01561                         <span class="keywordflow">if</span> (type==ON || type==TRACK){
01562                             <span class="keywordflow">if</span> (_output_scaled_parameters)
01563                                 _writer_on-&gt;<a class="code" href="classParamDataWriter.html#a3">writeParameterization</a>( param );
01564                             <span class="keywordflow">else</span>
01565                                 _writer_on-&gt;<a class="code" href="classParamDataWriter.html#a3">writeParameterization</a>( oldparam );
01566                         }
01567                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type==OFF) {
01568                             <span class="keywordflow">if</span> (_output_scaled_parameters) 
01569                                 _writer_off-&gt;<a class="code" href="classParamDataWriter.html#a3">writeParameterization</a>( param );
01570                             <span class="keywordflow">else</span>
01571                                 _writer_off-&gt;<a class="code" href="classParamDataWriter.html#a3">writeParameterization</a>( oldparam );
01572                         }
01573                     }
01574                     
01575                     
01576                 }
01577             }
01578         }
01579         
01580     } <span class="comment">// end loop over events</span>
01581 
01582     
01583     <span class="comment">//============================================================</span>
01584     <span class="comment">// Run duration is total elapsed time </span>
01585 
01586     thisrun.<a class="code" href="structCutRecord.html#o7">duration</a> = elapsed*24*60;
01587 
01588     <span class="comment">//============================================================</span>
01589     <span class="comment">// Update the sky brightness and tubeoffness maps</span>
01590 
01591     <span class="keywordflow">if</span> ((type==ON || type==TRACK)) {
01592         <span class="keywordflow">try</span> {
01593             
01594             <span class="keywordtype">char</span> telid[100];
01595             sprintf( telid, <span class="stringliteral">"-%03d"</span>, _telescope_id );
01596             thisrun.<a class="code" href="structCutRecord.html#o10">skybright</a>.<a class="code" href="classImage2D.html#a8">load</a>(id+<span class="stringliteral">"/"</span>+id+telid+<span class="stringliteral">"-sky_brightness.im2d"</span>);
01597             thisrun.<a class="code" href="structCutRecord.html#o11">tubeoff</a>.<a class="code" href="classImage2D.html#a8">load</a>(id+<span class="stringliteral">"/"</span>+id+telid+<span class="stringliteral">"-tubeoffness.im2d"</span>);
01598         }
01599         <span class="keywordflow">catch</span> (<a class="code" href="classMildAnalysisException.html">MildAnalysisException</a> &amp;e) {
01600             
01601             <span class="comment">// clear the image if file doesn't exist (probably a sim run)</span>
01602             thisrun.<a class="code" href="structCutRecord.html#o10">skybright</a>.<a class="code" href="classImage2D.html#a12">clear</a>();
01603             thisrun.<a class="code" href="structCutRecord.html#o11">tubeoff</a>.<a class="code" href="classImage2D.html#a12">clear</a>();
01604 
01605         }
01606     }
01607 
01608     <span class="comment">//============================================================</span>
01609     <span class="comment">// Save histograms</span>
01610     relrate.<a class="code" href="classHistogram.html#a13">save</a>( id+<span class="stringliteral">"/"</span>+id+<span class="stringliteral">"-relative-rate"</span> );
01611     sizehist.<a class="code" href="classHistogram.html#a13">save</a>( id+<span class="stringliteral">"/"</span>+id+<span class="stringliteral">"-size"</span> );
01612     rate.<a class="code" href="classHistogram.html#a13">save</a>( id+<span class="stringliteral">"/"</span>+id+<span class="stringliteral">"-rate"</span> );
01613     toffrate.<a class="code" href="classHistogram.html#a13">save</a>( id+<span class="stringliteral">"/"</span>+id+<span class="stringliteral">"-rate-trackoff"</span> );
01614     alpha.<a class="code" href="classHistogram.html#a13">save</a>( id+<span class="stringliteral">"/"</span>+id+<span class="stringliteral">"-alpha"</span> );
01615     ehist.<a class="code" href="classHistogram.html#a13">save</a>( id+<span class="stringliteral">"/"</span>+id+<span class="stringliteral">"-energy"</span> );
01616 
01617     <span class="comment">// Write out centroids plot:</span>
01618 
01619     centroids.<a class="code" href="classImage2D.html#a9">save</a>(id+<span class="stringliteral">"/"</span>+id+<span class="stringliteral">"-cut-centroids"</span>);
01620     <a class="code" href="classPlotMaker.html">PlotMaker</a> pm( <span class="stringliteral">"PS"</span>, id+<span class="stringliteral">"/"</span>+id+<span class="stringliteral">"-cut-centroids.eps"</span> );
01621     pm.<a class="code" href="classPlotMaker.html#a2">setAxisBox</a>( centroids );
01622     pm.<a class="code" href="classPlotMaker.html#a30">setColorMap</a>( PlotMaker::COLORMAP_INVERSEGREY );
01623     pm.<a class="code" href="classPlotMaker.html#a20">plot</a>( centroids );
01624     pm.<a class="code" href="classPlotMaker.html#a11">plotAxes</a>();
01625     pm.<a class="code" href="classPlotMaker.html#a12">plotTitle</a>( <span class="stringliteral">"Centroid Positions for "</span> + id );
01626     pm.<a class="code" href="classPlotMaker.html#a6">flush</a>();
01627 
01628     <span class="comment">//============================================================</span>
01629     <span class="comment">// Locate and save field stars</span>
01630 
01631 
01632 <span class="comment">// KPK removed precession because it's not doing the right thing (the</span>
01633 <span class="comment">// algorithm is fine, but the RA and DEC are already in j2000 epoch,</span>
01634 <span class="comment">// which is what the stars are in so precessing doesn't make sense).</span>
01635 <span class="comment">// Only need to precess if the star catalog is different from j2000.</span>
01636 <span class="comment">// So really, should just precess to j2000 here always!</span>
01637 
01638     _starcatalog.<a class="code" href="classStarCatalog.html#a3">precessToDate</a>( atoi(ri.<a class="code" href="classRunInfo.html#o7">utdate</a>.c_str()) );
01639     
01640     <span class="keywordflow">if</span> (type == ON || type == TRACK) {
01641         _onstars.clear();
01642         _starcatalog.<a class="code" href="classStarCatalog.html#a2">findNearbyStars</a>( header.<a class="code" href="structHeaderRecord.html#o2">ra</a>, header.<a class="code" href="structHeaderRecord.html#o3">dec</a>, 2.0, _onstars );
01643     }
01644    
01645     <span class="keywordflow">else</span>{
01646         _offstars.clear();
01647         _starcatalog.<a class="code" href="classStarCatalog.html#a2">findNearbyStars</a>( header.<a class="code" href="structHeaderRecord.html#o2">ra</a>, header.<a class="code" href="structHeaderRecord.html#o3">dec</a>, 2.0, _offstars );
01648     }
01649     energyfile.close();
01650     <span class="keyword">delete</span> reader;
01651     <span class="keyword">delete</span> cutter;
01652     <span class="keyword">delete</span> energy;
01653     <span class="keywordflow">return</span> thisrun;
01654 
01655 }
01656 
01657 
01662 <span class="keywordtype">double</span> 
01663 <a class="code" href="classCutter.html#a13">Cutter::</a>
<a name="l01664"></a><a class="code" href="classCutter.html#a13">01664</a> <a class="code" href="classCutter.html#a13">energyEstimator</a>( <span class="keywordtype">double</span> size, <span class="keywordtype">double</span> dist ) { 
01665 
01666     <span class="keywordtype">double</span> x;
01667     <span class="keywordtype">double</span> lnsize = log(size);
01668     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> A = -8.11;
01669     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> B = 2.56;
01670     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> C = -9.25;
01671     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> D = 0.120;
01672     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> E = 6.26;
01673     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> F = 0.0105;
01674     
01675     x  = (A + B*lnsize + C*dist - D*lnsize*lnsize +
01676           E*dist*dist + F*lnsize*dist);
01677 
01678     <span class="keywordflow">return</span> x;
01679 
01680 }
01681 
01682 
01686 <span class="keywordtype">double</span>
<a name="l01687"></a><a class="code" href="classCutter.html#a23">01687</a> <a class="code" href="classCutter.html#a23">Cutter::getElongationFactor</a>( <span class="keywordtype">double</span> zen ) {
01688 
01689     <span class="keyword">const</span> <span class="keywordtype">double</span> A=0.912865;
01690     <span class="keyword">const</span> <span class="keywordtype">double</span> B=0.717872;
01691     
01692     <span class="keywordflow">return</span> A*cos(zen) + B;
01693 
01694     <span class="comment">// old constant value was 1.65    </span>
01695     <span class="comment">//     return 1.65;</span>
01696    
01697 }
01698 
01699 
01703 <span class="keywordtype">void</span>
<a name="l01704"></a><a class="code" href="classCutter.html#a22">01704</a> <a class="code" href="classCutter.html#a22">Cutter::checkDiagnostics</a>() {
01705 
01706     <a class="code" href="classLogger.html">Logger</a> *logger = Logger::instance();
01707 
01708     <span class="comment">// As sanity check, make sure there aren't multiple source </span>
01709     <span class="comment">// names listed!</span>
01710 
01711     _sourcenames.sort();
01712     _sourcenames.unique();
01713 
01714     <span class="keywordflow">if</span> (_sourcenames.size() &gt; 1 ) {
01715         logger-&gt;<a class="code" href="classLogger.html#a0">printf</a>(<span class="stringliteral">"You may have combined multiple sources!"</span>);
01716         logger-&gt;<a class="code" href="classLogger.html#a0">printf</a>(<span class="stringliteral">"         the following were used:"</span>);
01717                 list&lt;string&gt;::iterator it;
01718         <span class="keywordflow">for</span> (it = _sourcenames.begin(); it!=_sourcenames.end(); it++){
01719             logger-&gt;<a class="code" href="classLogger.html#a0">printf</a>(<span class="stringliteral">"\t%s"</span>, it-&gt;c_str() );
01720         }
01721     }
01722     
01723     <span class="comment">// Look at the OFF-ALPHA values for on and off runs in a pair and</span>
01724     <span class="comment">// check that they are somewhat close to eachother, otherwise warn</span>
01725     <span class="comment">// the user that there may be a mismatch</span>
01726 
01727     <span class="keywordtype">double</span> percentdiff;
01728 
01729     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;_onruns.size(); i++) {
01730         
01731         percentdiff = std::fabs((_onruns[i].trackoff - _offruns[i].trackoff) 
01732             / (<span class="keywordtype">double</span>)(_onruns[i].trackoff));
01733         
01734         <span class="keywordflow">if</span> (percentdiff &gt; 0.2) {
01735             logger-&gt;<a class="code" href="classLogger.html#a0">printf</a>(<span class="stringliteral">"%s has an OFF-ALPHA value %2.0f%% different from "</span>
01736                            <span class="stringliteral">"%s - check they are a valid pair"</span>,
01737                            _onruns[i].runid.c_str(),
01738                            percentdiff*100.0,
01739                            _offruns[i].runid.c_str()); 
01740         }
01741         
01742     }
01743 
01744 
01745     <span class="comment">// check that all of the RAs and DECs make sense:</span>
01746 
01747     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;_on_ra.size(); i++) {
01748         <span class="keywordtype">double</span> delta = fabs(_on_ra[i] - _off_ra[i]);
01749         
01750         delta *= 12.0/M_PI*60.0;
01751         
01752         <span class="keywordflow">if</span> ( fabs(delta-30.0)&gt;2.0 ) {
01753             logger-&gt;<a class="code" href="classLogger.html#a0">printf</a>(<span class="stringliteral">"%s and %s have RAs which are different by %.1dmin! (should be 30min)"</span>,
01754                            _onruns[i].runid.c_str(),
01755                            _offruns[i].runid.c_str(),
01756                            delta );
01757         }
01758         
01759     }
01760 
01761 
01762 }
01763 
01764 
01765 ostream&amp; operator&lt;&lt;( ostream &amp;stream, <a class="code" href="structCutRecord.html">CutRecord</a> &amp;c ) {
01766 
01767     stream &lt;&lt; setw(15-c.<a class="code" href="structCutRecord.html#o0">runid</a>.size()) &lt;&lt; c.<a class="code" href="structCutRecord.html#o0">runid</a> &lt;&lt; <span class="stringliteral">": "</span>  
01768            &lt;&lt; setw(10) &lt;&lt; c.<a class="code" href="structCutRecord.html#o1">total</a>
01769            &lt;&lt; setw(10) &lt;&lt; c.<a class="code" href="structCutRecord.html#o2">valid</a>
01770            &lt;&lt; setw(10) &lt;&lt; c.<a class="code" href="structCutRecord.html#o3">trigger</a>
01771            &lt;&lt; setw(10) &lt;&lt; c.<a class="code" href="structCutRecord.html#o4">shape</a>
01772            &lt;&lt; setw(10) &lt;&lt; c.<a class="code" href="structCutRecord.html#o5">orientation</a>
01773            &lt;&lt; setw(10) &lt;&lt; c.<a class="code" href="structCutRecord.html#o6">trackoff</a>;
01774 
01775     <span class="keywordflow">return</span> stream;
01776 
01777 }
01778 
01779 <span class="keywordtype">void</span>
01780 Cutter::printCutRecordFields( ostream &amp;stream ) {
01781     stream &lt;&lt; <span class="stringliteral">"ID"</span>  &lt;&lt; setw(8) &lt;&lt; <span class="stringliteral">" "</span>
01782            &lt;&lt; setw(10) &lt;&lt; <span class="stringliteral">"TOTAL"</span>
01783            &lt;&lt; setw(10) &lt;&lt; <span class="stringliteral">" VALID"</span>
01784            &lt;&lt; setw(10) &lt;&lt; <span class="stringliteral">" TRIGGER"</span>
01785            &lt;&lt; setw(10) &lt;&lt; <span class="stringliteral">" SHAPE"</span>
01786            &lt;&lt; setw(10) &lt;&lt; <span class="stringliteral">" ORIENT"</span> 
01787            &lt;&lt; setw(10) &lt;&lt; <span class="stringliteral">" OFFALPHA"</span> 
01788            &lt;&lt; endl;
01789 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Apr 21 10:22:45 2007 for wuparam by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
