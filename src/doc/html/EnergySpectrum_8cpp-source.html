<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>wuparam: EnergySpectrum.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>EnergySpectrum.cpp</h1><div class="fragment"><pre>00001 <span class="preprocessor">#include &lt;iostream&gt;</span>
00002 <span class="preprocessor">#include &lt;cmath&gt;</span>
00003 <span class="preprocessor">#include &lt;gsl/gsl_math.h&gt;</span>
00004 <span class="preprocessor">#include "EnergySpectrum.h"</span>
00005 <span class="preprocessor">#include "Exceptions.h"</span>
00006 
00007 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00008 
00009 EnergyEstimatorFactory* EnergyEstimatorFactory::pinstance = NULL;
00010 
00017 <span class="keywordtype">double</span> 
00018 LZAEnergyEstimator::getEstimate(<span class="keyword">const</span> <span class="keywordtype">double</span> size, <span class="keyword">const</span> <span class="keywordtype">double</span> dist, 
00019                                 <span class="keyword">const</span> <span class="keywordtype">double</span> zenith ) {
00020     
00021 
00022     <span class="keywordtype">double</span> lnsize = log(size);
00023     <span class="keywordtype">double</span> e1,e2;
00024 
00025 
00026     <span class="comment">// from fit of log(size) vs log(true energy)</span>
00027     <span class="comment">// third order poly in log(SIZE)</span>
00028     <span class="keyword">const</span> <span class="keywordtype">double</span> A = 0.34821;
00029     <span class="keyword">const</span> <span class="keywordtype">double</span> B = -0.32983;
00030     <span class="keyword">const</span> <span class="keywordtype">double</span> C = 0.084692;
00031     
00032     <span class="comment">// from fit of distance vs (e1 - true energy)</span>
00033     <span class="comment">// two linear fits of DISTANCE (not log)</span>
00034     <span class="keyword">const</span> <span class="keywordtype">double</span> DA1 = 0.39281;
00035     <span class="keyword">const</span> <span class="keywordtype">double</span> DB1 = -0.79686;
00036     <span class="keyword">const</span> <span class="keywordtype">double</span> DA2 = -3.0901;
00037     <span class="keyword">const</span> <span class="keywordtype">double</span> DB2 = 3.8822;
00038     
00039     <span class="comment">// distance at which we should use the second fit line instead of</span>
00040     <span class="comment">// the first</span>
00041     <span class="keyword">const</span> <span class="keywordtype">double</span> distbreak = 0.75;
00042 
00043 
00044     <span class="keywordflow">if</span> ( (size&gt;0) &amp;&amp; (dist&gt;0)) {
00045 
00046         <span class="comment">// The lowest order energy estimator is just a function of log(SIZE)</span>
00047         e1 = A + B*lnsize + C*lnsize*lnsize;
00048         
00049         <span class="comment">// The first order correction is a function of DISTANCE</span>
00050         <span class="keywordflow">if</span> (dist &lt;= distbreak) {
00051             e2 = DA1 + DB1*dist;
00052         }
00053         <span class="keywordflow">else</span> {
00054             e2 = DA2 + DB2*dist;
00055         }
00056 
00057         <span class="comment">// Finally, the log(energyEstimate) is e1+e2.  To be</span>
00058         <span class="comment">// equivalent to Henric Krawczinski's original function, this</span>
00059         <span class="comment">// needs to return log10(energyEstimate) not the natural log,</span>
00060         <span class="comment">// so we need to multiply by a conversion factor. log10(x) =</span>
00061         <span class="comment">// ln(x)/ln(10)</span>
00062         
00063         <span class="keywordflow">return</span> (e1+e2)/log(10.0);
00064 
00065     }
00066     <span class="keywordflow">else</span>
00067         <span class="keywordflow">return</span> -100;
00068 
00069 
00070 };
00071 
00072 
00079 <span class="keywordtype">double</span> 
00080 SZAEnergyEstimator::getEstimate(<span class="keyword">const</span> <span class="keywordtype">double</span> size, <span class="keyword">const</span> <span class="keywordtype">double</span> dist,
00081                                 <span class="keyword">const</span> <span class="keywordtype">double</span> zenith) {
00082     
00083     <span class="keywordtype">double</span> lnsize;
00084     <span class="keywordtype">double</span> e1,e2;
00085 
00086     <span class="comment">// scale SIZE by zenith angle (fit by eye shows scaling goes like cos^3)</span>
00087     <span class="comment">//double size_correction = pow( cos(21*M_PI/180.0)/cos(zenith), 3);</span>
00088     <span class="keywordtype">double</span> size_correction = 1.0;
00089     lnsize = log(size*size_correction);
00090 
00091     
00092     <span class="comment">// from fit of log(size) vs log(true energy)</span>
00093     <span class="comment">// third order poly in log(SIZE)</span>
00094     <span class="comment">// logE' = A + Bx + Cx^2</span>
00095 
00096      <span class="keyword">const</span> <span class="keywordtype">double</span> A = -7.0527;
00097      <span class="keyword">const</span> <span class="keywordtype">double</span> B = 1.2952;
00098      <span class="keyword">const</span> <span class="keywordtype">double</span> C = -0.034273;
00099     
00100     <span class="comment">//my z=21deg fits to the MC data with scaled electronics factors</span>
00101     <span class="comment">//const double A = -5.386;</span>
00102     <span class="comment">//const double B = 0.73754;</span>
00103     <span class="comment">//const double C = 5.6625e-3;</span>
00104 
00105     <span class="comment">// from fit of distance vs (e1 - log(true energy))</span>
00106     <span class="comment">// two linear fits of DISTANCE (not log)</span>
00107 
00108      <span class="keyword">const</span> <span class="keywordtype">double</span> DA1 = 0.057208;
00109      <span class="keyword">const</span> <span class="keywordtype">double</span> DB1 = -0.19915;
00110      <span class="keyword">const</span> <span class="keywordtype">double</span> DA2 = -1.9642;
00111      <span class="keyword">const</span> <span class="keywordtype">double</span> DB2 = 2.4432;
00112     
00113     <span class="comment">//my z=21deg fits to the MC data with scaled electronics factors</span>
00114     <span class="comment">//const double DA1 = 0.4433;</span>
00115     <span class="comment">//const double DB1 = -5.846e-2;</span>
00116     <span class="comment">//const double DA2 = -3.6807;</span>
00117     <span class="comment">//const double DB2 = 5.1725;</span>
00118     
00119     <span class="comment">// distance at which we should use the second fit line instead of</span>
00120     <span class="comment">// the first</span>
00121 
00122      <span class="keyword">const</span> <span class="keywordtype">double</span> distbreak = 0.75;
00123    
00124     <span class="comment">//my z=21deg fits to the MC data with scaled electronics factors</span>
00125     <span class="comment">//const double distbreak = 0.81;</span>
00126 
00127     <span class="keywordflow">if</span> ( (size&gt;0) &amp;&amp; (dist&gt;0)) {
00128 
00129         <span class="comment">// The lowest order energy estimator is just a function of log(SIZE)</span>
00130         e1 = A + B*lnsize + C*lnsize*lnsize;
00131         
00132         <span class="comment">// The first order correction is a function of DISTANCE</span>
00133         <span class="keywordflow">if</span> (dist &lt;= distbreak) {
00134             e2 = DA1 + DB1*dist;
00135         }
00136         <span class="keywordflow">else</span> {
00137             e2 = DA2 + DB2*dist;
00138         }
00139 
00140         <span class="comment">// Finally, the log(energyEstimate) is e1+e2.  To be</span>
00141         <span class="comment">// equivalent to Henric Krawczinski's original function, this</span>
00142         <span class="comment">// needs to return log10(energyEstimate) not the natural log,</span>
00143         <span class="comment">// so we need to multiply by a conversion factor. log10(x) =</span>
00144         <span class="comment">// ln(x)/ln(10)</span>
00145         
00146         <span class="keywordflow">return</span> (e1+e2)/log(10.0);
00147 
00148     }
00149     <span class="keywordflow">else</span>
00150         <span class="keywordflow">return</span> -100;
00151 
00152 };
00153 
00154 
00161 <span class="keywordtype">double</span>
00162 Z40EnergyEstimator::getEstimate(<span class="keyword">const</span> <span class="keywordtype">double</span> size, <span class="keyword">const</span> <span class="keywordtype">double</span> dist,
00163                                 <span class="keyword">const</span> <span class="keywordtype">double</span> zenith) {
00164     
00165     <span class="keywordtype">double</span> logsize;
00166     <span class="keywordtype">double</span> e1,e2;
00167 
00168     <span class="comment">// scale SIZE by zenith angle (fit by eye shows scaling goes like cos^3)</span>
00169     <span class="comment">//double size_correction = pow( cos(21*M_PI/180.0)/cos(zenith), 3);</span>
00170     <span class="keywordtype">double</span> size_correction = 1.0;
00171     logsize = log(size*size_correction);
00172     
00173     <span class="comment">// from fit of log(size) vs log(true energy)</span>
00174     <span class="comment">// third order poly in log(SIZE)</span>
00175     <span class="comment">// logE' = A + Bx + Cx^2</span>
00176 
00177     <span class="keyword">const</span> <span class="keywordtype">double</span> A = -4.2;
00178     <span class="keyword">const</span> <span class="keywordtype">double</span> B = 0.59432;
00179     <span class="keyword">const</span> <span class="keywordtype">double</span> C = 0.01855;
00180 
00181     
00182     <span class="comment">// from fit of distance vs (e1 - log(true energy))</span>
00183     <span class="comment">// two linear fits of DISTANCE (not log)</span>
00184 
00185     <span class="keyword">const</span> <span class="keywordtype">double</span> DA1 = 0.1238;
00186     <span class="keyword">const</span> <span class="keywordtype">double</span> DB1 = -0.3477;
00187     <span class="keyword">const</span> <span class="keywordtype">double</span> DA2 = -4.924;
00188     <span class="keyword">const</span> <span class="keywordtype">double</span> DB2 = 5.9146;
00189     
00190     <span class="comment">// distance at which we should use the second fit line instead of</span>
00191     <span class="comment">// the first</span>
00192     <span class="keyword">const</span> <span class="keywordtype">double</span> distbreak = 0.8;
00193 
00194     <span class="keywordflow">if</span> ( (size&gt;0) &amp;&amp; (dist&gt;0)) {
00195 
00196         <span class="comment">// The lowest order energy estimator is just a function of log(SIZE)</span>
00197         e1 = A + B*logsize + C*logsize*logsize;
00198         
00199         <span class="comment">// The first order correction is a function of DISTANCE</span>
00200         <span class="keywordflow">if</span> (dist &lt;= distbreak) {
00201             e2 = DA1 + DB1*dist;
00202         }
00203         <span class="keywordflow">else</span> {
00204             e2 = DA2 + DB2*dist;
00205         }
00206 
00207         <span class="comment">// Finally, the log(energyEstimate) is e1+e2.  To be</span>
00208         <span class="comment">// equivalent to Henric Krawczinski's original function, this</span>
00209         <span class="comment">// needs to return log10(energyEstimate) not the natural log:</span>
00210         
00211         <span class="keywordflow">return</span> (e1+e2);
00212 
00213     }
00214     <span class="keywordflow">else</span>
00215         <span class="keywordflow">return</span> -100;
00216     
00217 }
00218 
00219 
00226 <span class="keywordtype">double</span> 
00227 Z50EnergyEstimator::getEstimate(<span class="keyword">const</span> <span class="keywordtype">double</span> size, <span class="keyword">const</span> <span class="keywordtype">double</span> dist,
00228                                 <span class="keyword">const</span> <span class="keywordtype">double</span> zenith) {
00229     
00230     <span class="keywordtype">double</span> logsize;
00231     <span class="keywordtype">double</span> e1,e2;
00232     
00233     <span class="comment">// scale SIZE by zenith angle (fit by eye shows scaling goes like cos^3)</span>
00234     <span class="comment">//double size_correction = pow( cos(21*M_PI/180.0)/cos(zenith), 3);</span>
00235     <span class="keywordtype">double</span> size_correction = 1.0;
00236     logsize = log(size*size_correction);
00237     
00238     <span class="comment">// from fit of log(size) vs log(true energy)</span>
00239     <span class="comment">// third order poly in log(SIZE)</span>
00240     <span class="comment">// logE' = A + Bx + Cx^2</span>
00241 
00242     <span class="keyword">const</span> <span class="keywordtype">double</span> A = -4.00526;
00243     <span class="keyword">const</span> <span class="keywordtype">double</span> B = 0.701737;
00244     <span class="keyword">const</span> <span class="keywordtype">double</span> C = 0.0103804;
00245 
00246     
00247     <span class="comment">// from fit of distance vs (e1 - log(true energy))</span>
00248     <span class="comment">// two linear fits of DISTANCE (not log)</span>
00249 
00250     <span class="keyword">const</span> <span class="keywordtype">double</span> DA1 = 0.263418;
00251     <span class="keyword">const</span> <span class="keywordtype">double</span> DB1 = -0.537669;
00252     <span class="keyword">const</span> <span class="keywordtype">double</span> DA2 = -4.64593;
00253     <span class="keyword">const</span> <span class="keywordtype">double</span> DB2 = 5.66858;
00254     
00255     <span class="comment">// distance at which we should use the second fit line instead of</span>
00256     <span class="comment">// the first</span>
00257     <span class="keyword">const</span> <span class="keywordtype">double</span> distbreak = 0.78;
00258 
00259     <span class="keywordflow">if</span> ( (size&gt;0) &amp;&amp; (dist&gt;0)) {
00260 
00261         <span class="comment">// The lowest order energy estimator is just a function of log(SIZE)</span>
00262         e1 = A + B*logsize + C*logsize*logsize;
00263         
00264         <span class="comment">// The first order correction is a function of DISTANCE</span>
00265         <span class="keywordflow">if</span> (dist &lt;= distbreak) {
00266             e2 = DA1 + DB1*dist;
00267         }
00268         <span class="keywordflow">else</span> {
00269             e2 = DA2 + DB2*dist;
00270         }
00271 
00272         <span class="comment">// Finally, the log(energyEstimate) is e1+e2.  To be</span>
00273         <span class="comment">// equivalent to Henric Krawczinski's original function, this</span>
00274         <span class="comment">// needs to return log10(energyEstimate) not the natural log:</span>
00275         
00276         <span class="keywordflow">return</span> (e1+e2)/log(10.0);
00277 
00278     }
00279     <span class="keywordflow">else</span>
00280         <span class="keywordflow">return</span> -100;
00281 
00282 }
00283 
00284 
00285 
00286 
00290 EnergyEstimatorFactory* 
00291 EnergyEstimatorFactory::
00292 instance() {
00293 
00294     <span class="keywordflow">if</span> (pinstance == NULL)
00295         pinstance = <span class="keyword">new</span> EnergyEstimatorFactory();
00296     
00297     <span class="keywordflow">return</span> pinstance;
00298 
00299 }
00300 
00301 EnergyEstimatorFactory::EnergyEstimatorFactory() { ;}
00302 
00303 EnergyEstimator*
00304 EnergyEstimatorFactory::getEstimator( string type ) {
00305     <span class="keywordflow">if</span> (type == <span class="stringliteral">"LZA"</span> ) {
00306         <span class="keywordflow">return</span> <span class="keyword">new</span> LZAEnergyEstimator();
00307     }
00308     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <span class="stringliteral">"SZA"</span> ) {
00309         <span class="keywordflow">return</span> <span class="keyword">new</span> SZAEnergyEstimator();
00310     }
00311     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <span class="stringliteral">"Z40"</span>) {
00312         <span class="keywordflow">return</span> <span class="keyword">new</span> Z40EnergyEstimator();
00313     }
00314     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <span class="stringliteral">"Z50"</span>) {
00315         <span class="keywordflow">return</span> <span class="keyword">new</span> Z50EnergyEstimator();
00316     }
00317     <span class="keywordflow">else</span>
00318         <span class="keywordflow">throw</span> <a class="code" href="classCriticalAnalysisException.html">CriticalAnalysisException</a>(<span class="stringliteral">"Unknown EnergyEstimator type: '"</span>
00319                                         +type+<span class="stringliteral">"'"</span>);
00320 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Apr 21 10:22:45 2007 for wuparam by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
